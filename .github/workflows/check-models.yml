# ABOUTME: Scheduled workflow that checks models.json for stale/deprecated LLM models
# ABOUTME: Checks live provider APIs and deprecation dates, opens a GitHub Issue when updates needed

name: Check LLM Models

on:
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9am UTC
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  check-models:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install

      - name: Check model availability against provider APIs
        id: api-check
        continue-on-error: true
        run: bun scripts/check-models.ts 2>&1 | tee check-output.txt

      - name: Open or update issue if models need attention
        if: steps.api-check.outcome == 'failure'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TODAY=$(date +%Y-%m-%d)
          OUTPUT=$(cat check-output.txt)

          BODY="## LLM Model Check — $TODAY

          \`\`\`
          $OUTPUT
          \`\`\`

          ### How to fix

          1. Edit \`models.json\` — remove deprecated models, update defaults, add new models
          2. Run \`bun test src/models.test.ts\` to validate
          3. Provider docs: [Anthropic](https://docs.anthropic.com/en/docs/about-claude/models) · [OpenAI](https://platform.openai.com/docs/models) · [Gemini](https://ai.google.dev/gemini-api/docs/models) · [OpenRouter](https://openrouter.ai/models)"

          EXISTING=$(gh issue list --label "model-maintenance" --state open --json number --jq '.[0].number // empty' 2>/dev/null || true)

          if [ -n "$EXISTING" ]; then
            echo "Updating existing issue #$EXISTING"
            gh issue comment "$EXISTING" --body "$BODY"
          else
            echo "Creating new issue"
            gh issue create \
              --title "LLM models need updating ($TODAY)" \
              --body "$BODY" \
              --label "model-maintenance"
          fi
