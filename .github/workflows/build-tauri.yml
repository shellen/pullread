# ABOUTME: CI/CD pipeline for building, signing, notarizing, and releasing the Tauri app
# ABOUTME: Handles CI builds on push/PR, tagged releases, and rolling "latest" pre-releases

name: Build Tauri App

on:
  push:
    branches: [main]
    tags: ['v*']
    paths:
      - 'src/**'
      - 'src-tauri/**'
      - 'scripts/**'
      - 'package.json'
      - 'bun.lockb'
      - 'viewer.html'
      - '.github/workflows/build-tauri.yml'
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'src-tauri/**'
      - 'scripts/**'
      - 'package.json'
      - 'bun.lockb'
      - 'viewer.html'
      - '.github/workflows/build-tauri.yml'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g. 2.0.1)'
        required: false
      debug:
        description: 'Build in debug mode'
        required: false
        default: 'false'

permissions:
  contents: write

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            target: aarch64-apple-darwin
            bun_target: bun-darwin-arm64
          - platform: macos-latest
            target: x86_64-apple-darwin
            bun_target: bun-darwin-x64

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Install Node dependencies
        run: bun install

      - name: Embed viewer
        run: bun scripts/embed-viewer.ts

      - name: Build Bun sidecar
        run: bun build src/index.ts --compile --target=${{ matrix.bun_target }} --outfile dist/pullread

      - name: Prepare sidecar
        run: bash scripts/prepare-sidecar.sh ${{ matrix.target }}

      - name: Download Kokoro TTS model
        run: bash scripts/download-kokoro-model.sh

      - name: Copy Kokoro model to Tauri resources
        run: |
          mkdir -p src-tauri/resources/kokoro-model
          cp -R dist/kokoro-model/* src-tauri/resources/kokoro-model/

      - name: Import Apple certificate
        if: startsWith(matrix.platform, 'macos')
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
        run: |
          if [ -z "$APPLE_CERTIFICATE" ]; then
            echo "No signing certificate available â€” skipping"
            exit 0
          fi

          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          echo "KEYCHAIN_PASSWORD=$KEYCHAIN_PASSWORD" >> $GITHUB_ENV

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          echo "$APPLE_CERTIFICATE" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 \
            -P "$APPLE_CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 \
            -k "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"

          rm $RUNNER_TEMP/certificate.p12
          echo "HAS_SIGNING_CERT=true" >> $GITHUB_ENV

      - name: Sign sidecar with entitlements
        if: env.HAS_SIGNING_CERT == 'true'
        run: |
          codesign --force --options runtime --timestamp \
            --sign "Developer ID Application" \
            --entitlements src-tauri/entitlements.plist \
            src-tauri/binaries/pullread-cli-${{ matrix.target }}

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: "Developer ID Application"
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        with:
          tagName: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || '' }}
          releaseName: ${{ startsWith(github.ref, 'refs/tags/') && format('PullRead {0}', github.ref_name) || '' }}
          releaseBody: 'See the assets to download and install this version.'
          releaseDraft: ${{ startsWith(github.ref, 'refs/tags/') }}
          prerelease: false
          args: --target ${{ matrix.target }}

      - name: Upload build artifacts
        if: "!startsWith(github.ref, 'refs/tags/')"
        uses: actions/upload-artifact@v4
        with:
          name: pullread-${{ matrix.target }}
          path: |
            src-tauri/target/${{ matrix.target }}/release/bundle/dmg/*.dmg
            src-tauri/target/${{ matrix.target }}/release/bundle/macos/*.app
          retention-days: 30

      - name: Clean up keychain
        if: always() && env.HAS_SIGNING_CERT == 'true'
        run: security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true

  # Sign update bundles, build updater manifest, and publish the release
  publish-updater:
    needs: build
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Tauri CLI
        run: npm install -g @tauri-apps/cli

      - name: Download update bundles from release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.ref_name }}"
          mkdir -p ./bundles
          gh release download "$TAG" -p '*.app.tar.gz' -D ./bundles
          ls -la ./bundles/

      - name: Sign bundles and build latest.json
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: |
          TAG="${{ github.ref_name }}"
          VERSION=$(node -p "require('./package.json').version")
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          BASE="https://github.com/${{ github.repository }}/releases/download/${TAG}"

          # Sign each bundle
          for bundle in ./bundles/*.tar.gz; do
            echo "Signing $bundle..."
            tauri signer sign -k "$TAURI_SIGNING_PRIVATE_KEY" -p "$TAURI_SIGNING_PRIVATE_KEY_PASSWORD" "$bundle"
            echo "Signature:"
            cat "${bundle}.sig"
            echo ""
          done

          # Read signatures
          ARM_SIG=$(cat ./bundles/Pull.Read_aarch64.app.tar.gz.sig)
          X64_SIG=$(cat ./bundles/Pull.Read_x64.app.tar.gz.sig)

          # Build latest.json
          jq -n \
            --arg ver "$VERSION" \
            --arg date "$DATE" \
            --arg arm_sig "$ARM_SIG" \
            --arg arm_url "${BASE}/Pull.Read_aarch64.app.tar.gz" \
            --arg x64_sig "$X64_SIG" \
            --arg x64_url "${BASE}/Pull.Read_x64.app.tar.gz" \
            '{
              version: $ver,
              notes: "See the assets to download and install this version.",
              pub_date: $date,
              platforms: {
                "darwin-aarch64": { signature: $arm_sig, url: $arm_url },
                "darwin-x86_64": { signature: $x64_sig, url: $x64_url }
              }
            }' > latest.json

          echo "Generated latest.json:"
          cat latest.json

      - name: Upload latest.json and publish release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.ref_name }}"
          gh release upload "$TAG" latest.json --clobber
          gh release edit "$TAG" --draft=false
          echo "Published release $TAG"

  # Auto-update "latest" pre-release on every push to main
  latest-release:
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download arm64 artifacts
        uses: actions/download-artifact@v4
        with:
          name: pullread-aarch64-apple-darwin
          path: ./artifacts/arm64

      - name: Download x64 artifacts
        uses: actions/download-artifact@v4
        with:
          name: pullread-x86_64-apple-darwin
          path: ./artifacts/x64

      - name: Rename DMGs to stable filenames
        run: |
          mkdir -p ./release
          find ./artifacts/arm64 -name '*.dmg' -exec cp {} ./release/PullRead.dmg \;
          find ./artifacts/x64 -name '*.dmg' -exec cp {} ./release/PullRead_Intel.dmg \;
          ls -la ./release/

      - name: Update latest release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: Latest Build
          body: |
            Rolling build of Pull Read from the main branch.

            **Apple Silicon:** [PullRead.dmg](https://github.com/shellen/pullread/releases/download/latest/PullRead.dmg)
            **Intel:** [PullRead_Intel.dmg](https://github.com/shellen/pullread/releases/download/latest/PullRead_Intel.dmg)

            _Commit: ${{ github.sha }}_
            _Updated: ${{ github.event.head_commit.timestamp }}_
          files: |
            ./release/PullRead.dmg
            ./release/PullRead_Intel.dmg
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
