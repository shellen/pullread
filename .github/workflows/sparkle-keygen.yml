# ABOUTME: One-time workflow to generate Sparkle Ed25519 signing keys
# ABOUTME: Run once, then add the public key to Info.plist and private key as a secret

name: Sparkle Key Generation (one-time)

on:
  workflow_dispatch:

jobs:
  generate-keys:
    runs-on: macos-14

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Sparkle
        run: |
          # Fetch latest Sparkle release tag dynamically to avoid hardcoded version mismatch
          SPARKLE_TAG=$(curl -s https://api.github.com/repos/sparkle-project/Sparkle/releases/latest | python3 -c "import sys,json; print(json.load(sys.stdin)['tag_name'])")
          echo "Downloading Sparkle ${SPARKLE_TAG}"
          curl -L -o Sparkle.tar.xz "https://github.com/sparkle-project/Sparkle/releases/download/${SPARKLE_TAG}/Sparkle-${SPARKLE_TAG}.tar.xz"
          mkdir -p sparkle-tools
          tar -xf Sparkle.tar.xz -C sparkle-tools

      - name: Generate Ed25519 keys
        run: |
          # Generate new Ed25519 keypair (stores in Keychain)
          sparkle-tools/bin/generate_keys 2>&1

          # Export the private key from the Keychain so it can be saved
          # as a GitHub secret before the ephemeral runner is destroyed
          echo ""
          echo "============================================"
          echo "  PRIVATE KEY (save as SPARKLE_PRIVATE_KEY secret)"
          echo "============================================"
          sparkle-tools/bin/generate_keys -p 2>&1
          echo "============================================"
          echo ""
          echo "Copy EVERYTHING between the lines above and save it as:"
          echo "  GitHub repo > Settings > Secrets and variables > Actions"
          echo "  Secret name: SPARKLE_PRIVATE_KEY"
          echo ""
          echo "The public key (SUPublicEDKey) is already set in Info.plist."
          echo "Steps 2-4 from the original instructions are already done."
          echo ""
          echo "Remaining manual step:"
          echo "  5. Enable GitHub Pages: Settings > Pages > Deploy from branch (gh-pages / root)"
          echo "============================================"
