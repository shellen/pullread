# ABOUTME: GitHub Actions workflow to build and test PullReadTray macOS app
# ABOUTME: Builds once, runs tests with built artifacts, creates .app bundle and .dmg

name: Build macOS App

on:
  push:
    branches: [main, 'claude/**']
    paths:
      - 'PullReadTray/**'
      - 'src/**'
      - 'viewer.html'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/build-macos-app.yml'
  pull_request:
    branches: [main]
    paths:
      - 'PullReadTray/**'
      - 'src/**'
      - 'viewer.html'
      - 'package.json'
      - 'package-lock.json'
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a release with the built app'
        required: false
        default: 'false'
        type: boolean
      skip_tests:
        description: 'Skip running tests'
        required: false
        default: 'false'
        type: boolean

jobs:
  build-and-test:
    runs-on: macos-14

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # For PRs, checkout the PR head commit (not the merge commit) to match push behavior
          ref: ${{ github.event.pull_request.head.sha || github.sha }}

      - name: Free disk space
        run: |
          # Remove large pre-installed tools we don't need
          sudo rm -rf /usr/local/lib/android || true
          sudo rm -rf /usr/share/dotnet || true
          sudo rm -rf /Library/Developer/CoreSimulator/Volumes/* || true
          sudo rm -rf /Library/Developer/CoreSimulator/Caches/* || true
          df -h .

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer

      - name: Install Bun
        uses: oven-sh/setup-bun@v2

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb', '**/package-lock.json') }}
          restore-keys: ${{ runner.os }}-bun-

      - name: Build PullRead CLI binary
        run: |
          bun install
          bun scripts/embed-viewer.ts

          # Only build arm64 on CI (runner is arm64). Universal binary built in release workflow.
          mkdir -p dist
          bun build src/index.ts --compile --target=bun-darwin-arm64 --outfile dist/pullread

          file dist/pullread

          # Free space: remove node_modules and bun cache immediately
          rm -rf node_modules

      - name: Install xcpretty
        run: gem install xcpretty

      - name: Build release app
        working-directory: PullReadTray
        run: |
          # Single build: Release with testing enabled (satisfies both test and release needs)
          set -o pipefail
          xcodebuild build-for-testing \
            -project PullReadTray.xcodeproj \
            -scheme PullReadTray \
            -configuration Release \
            -derivedDataPath build \
            -destination 'platform=macOS,arch=arm64' \
            CODE_SIGNING_ALLOWED=NO \
            2>&1 | xcpretty --color

      - name: Run unit tests (without rebuilding)
        if: github.event.inputs.skip_tests != 'true'
        continue-on-error: true  # Don't block build if tests fail/timeout
        working-directory: PullReadTray
        timeout-minutes: 5
        env:
          # Signal to test host app that we're running tests (prevents UI initialization)
          RUNNING_XCTEST: '1'
        run: |
          set -o pipefail
          xcodebuild test-without-building \
            -project PullReadTray.xcodeproj \
            -scheme PullReadTray \
            -destination 'platform=macOS,arch=arm64' \
            -derivedDataPath build \
            -only-testing:PullReadTrayTests \
            -skip-testing:PullReadTrayTests/SyncServiceTests/testSyncCompletesWithResult \
            -skip-testing:PullReadTrayTests/SyncServiceTests/testSyncRetryFailedCompletesWithResult \
            -skip-testing:PullReadTrayTests/SyncServiceTests/testConfigPathPerformance \
            -skip-testing:PullReadTrayTests/SyncServiceTests/testOutputPathPerformance \
            -resultBundlePath TestResults \
            2>&1 | xcpretty --test --color

      - name: Upload test results
        if: always() && github.event.inputs.skip_tests != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: PullReadTray/TestResults
          retention-days: 7
          if-no-files-found: ignore

      - name: Create app bundle with CLI
        working-directory: PullReadTray
        run: |
          mkdir -p artifacts
          APP_PATH="build/Build/Products/Release/Pull Read.app"

          # Copy app to artifacts
          cp -R "$APP_PATH" artifacts/

          # Bundle CLI binary into app resources
          cp ../dist/pullread "artifacts/Pull Read.app/Contents/Resources/"

          # Verify
          ls -la "artifacts/Pull Read.app/Contents/Resources/"

          # Free disk space: remove everything we no longer need
          rm -rf ../dist
          rm -rf build
          df -h .

      - name: Create DMG
        working-directory: PullReadTray
        run: |
          # Create a temporary directory for DMG contents
          mkdir -p dmg-contents
          cp -R "artifacts/Pull Read.app" dmg-contents/

          # Create a symlink to Applications
          ln -s /Applications dmg-contents/Applications

          # Create the DMG (volume name shows as "Pull Read" to users)
          hdiutil create -volname "Pull Read" \
            -srcfolder dmg-contents \
            -ov -format UDZO \
            artifacts/PullRead.dmg

          # Clean up
          rm -rf dmg-contents

      - name: Upload app artifact
        uses: actions/upload-artifact@v4
        with:
          name: PullRead-app
          path: PullReadTray/artifacts/Pull Read.app
          retention-days: 30

      - name: Upload DMG artifact
        uses: actions/upload-artifact@v4
        with:
          name: PullRead-dmg
          path: PullReadTray/artifacts/PullRead.dmg
          retention-days: 30

  release:
    needs: build-and-test
    if: always() && needs.build-and-test.result == 'success' && (github.event.inputs.create_release == 'true' || startsWith(github.ref, 'refs/tags/v'))
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download DMG artifact
        uses: actions/download-artifact@v4
        with:
          name: PullRead-dmg
          path: ./

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: PullRead.dmg
          generate_release_notes: true
          draft: ${{ github.event.inputs.create_release == 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Auto-update "latest" release on every push to main
  latest-release:
    needs: build-and-test
    if: always() && needs.build-and-test.result == 'success' && github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Download DMG artifact
        uses: actions/download-artifact@v4
        with:
          name: PullRead-dmg
          path: ./

      - name: Update latest release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          name: Latest Build
          body: |
            This is the latest build of Pull Read from the main branch.

            The app is self-contained with the CLI binary bundledâ€”no Node.js required.

            **Download:** [PullRead.dmg](https://github.com/${{ github.repository }}/releases/download/latest/PullRead.dmg)

            _Last updated: ${{ github.event.head_commit.timestamp }}_
            _Commit: ${{ github.sha }}_
          files: PullRead.dmg
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
