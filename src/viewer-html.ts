// Auto-generated by scripts/embed-viewer.ts — do not edit
// Source: viewer.html
export const VIEWER_HTML = "<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n<meta charset=\"UTF-8\">\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n<title>PullRead</title>\n<link rel=\"manifest\" href=\"/manifest.json\">\n<meta name=\"apple-mobile-web-app-capable\" content=\"yes\">\n<meta name=\"apple-mobile-web-app-status-bar-style\" content=\"default\">\n<meta name=\"apple-mobile-web-app-title\" content=\"PullRead\">\n<link rel=\"apple-touch-icon\" href=\"/icon-256.png\">\n<link rel=\"icon\" type=\"image/png\" sizes=\"256x256\" href=\"/icon-256.png\">\n<script src=\"https://cdn.jsdelivr.net/npm/marked/marked.min.js\"></script>\n<link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11/build/styles/github.min.css\" media=\"(prefers-color-scheme: light)\" id=\"hljs-light\">\n<link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11/build/styles/github-dark.min.css\" media=\"(prefers-color-scheme: dark)\" id=\"hljs-dark\">\n<script src=\"https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11/build/highlight.min.js\"></script>\n<link rel=\"preconnect\" href=\"https://fonts.googleapis.com\">\n<link rel=\"preconnect\" href=\"https://fonts.gstatic.com\" crossorigin>\n<link href=\"https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Literata:ital,wght@0,400;0,700;1,400&family=Lora:ital,wght@0,400;0,700;1,400&family=Source+Serif+4:ital,wght@0,400;0,700;1,400&display=swap\" rel=\"stylesheet\">\n<link href=\"https://fonts.cdnfonts.com/css/opendyslexic\" rel=\"stylesheet\">\n<style>\n  :root {\n    --bg: #ffffff;\n    --fg: #1a1a1a;\n    --muted: #666666;\n    --border: #e0e0e0;\n    --code-bg: #f5f5f5;\n    --link: #1a6daa;\n    --toolbar-bg: #fafafa;\n    --sidebar-bg: #f7f7f7;\n    --sidebar-hover: #eeeeee;\n    --sidebar-active: #e4e4e4;\n  }\n  [data-theme=\"dark\"] {\n    --bg: #1a1a1a;\n    --fg: #e0e0e0;\n    --muted: #999999;\n    --border: #333333;\n    --code-bg: #2a2a2a;\n    --link: #6db3e8;\n    --toolbar-bg: #222222;\n    --sidebar-bg: #1e1e1e;\n    --sidebar-hover: #2a2a2a;\n    --sidebar-active: #333333;\n  }\n  [data-theme=\"sepia\"] {\n    --bg: #f4ecd8;\n    --fg: #433422;\n    --muted: #7a6a52;\n    --border: #d4c9b0;\n    --code-bg: #ebe3cf;\n    --link: #6b4226;\n    --toolbar-bg: #efe6d0;\n    --sidebar-bg: #ede4cd;\n    --sidebar-hover: #e5dbc2;\n    --sidebar-active: #ddd1b6;\n  }\n  [data-theme=\"high-contrast\"] {\n    --bg: #000000;\n    --fg: #ffffff;\n    --muted: #cccccc;\n    --border: #666666;\n    --code-bg: #1a1a1a;\n    --link: #6ec6ff;\n    --toolbar-bg: #111111;\n    --sidebar-bg: #0a0a0a;\n    --sidebar-hover: #1a1a1a;\n    --sidebar-active: #2a2a2a;\n  }\n\n  * { box-sizing: border-box; margin: 0; padding: 0; }\n\n  .skip-link {\n    position: absolute;\n    top: -100%;\n    left: 8px;\n    padding: 8px 16px;\n    background: var(--fg);\n    color: var(--bg);\n    border-radius: 0 0 6px 6px;\n    z-index: 200;\n    font-size: 14px;\n    font-weight: 600;\n    text-decoration: none;\n  }\n  .skip-link:focus {\n    top: 0;\n  }\n\n  .sr-only {\n    position: absolute;\n    width: 1px;\n    height: 1px;\n    padding: 0;\n    margin: -1px;\n    overflow: hidden;\n    clip: rect(0, 0, 0, 0);\n    white-space: nowrap;\n    border: 0;\n  }\n\n  body {\n    background: var(--bg);\n    color: var(--fg);\n    transition: background 0.2s, color 0.2s;\n    font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n    height: 100vh;\n    overflow: hidden;\n  }\n\n  /* Layout */\n  .app {\n    display: flex;\n    height: 100vh;\n    flex-direction: column;\n  }\n\n  .toolbar {\n    flex-shrink: 0;\n    z-index: 10;\n    background: var(--sidebar-bg);\n    border-bottom: 1px solid var(--border);\n    padding: 6px 12px;\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    font-size: 13px;\n  }\n\n  .toolbar label {\n    color: var(--muted);\n    font-size: 10px;\n    text-transform: uppercase;\n    letter-spacing: 0.5px;\n  }\n\n  .toolbar-group {\n    display: flex;\n    align-items: center;\n    gap: 4px;\n  }\n\n  .toolbar button, .toolbar select {\n    background: var(--bg);\n    color: var(--fg);\n    border: 1px solid var(--border);\n    border-radius: 4px;\n    padding: 3px 8px;\n    font-size: 12px;\n    cursor: pointer;\n    line-height: 1.4;\n  }\n  .toolbar button:hover, .toolbar select:hover {\n    border-color: var(--muted);\n  }\n  .toolbar button.active {\n    background: var(--fg);\n    color: var(--bg);\n    border-color: var(--fg);\n  }\n\n  .brand {\n    font-weight: 600;\n    font-size: 14px;\n    color: var(--fg);\n    cursor: pointer;\n  }\n\n  .toolbar-spacer { flex: 1; }\n\n  .sidebar-toggle {\n    background: none !important;\n    border: none !important;\n    font-size: 18px !important;\n    padding: 2px 6px !important;\n    color: var(--fg) !important;\n    cursor: pointer;\n  }\n  .sidebar-toggle:hover {\n    color: var(--link) !important;\n  }\n\n  /* Share dropdown */\n  .share-dropdown {\n    position: relative;\n    display: inline-block;\n  }\n  .share-dropdown-panel {\n    position: absolute;\n    top: 100%;\n    right: 0;\n    width: 200px;\n    background: var(--bg);\n    border: 1px solid var(--border);\n    border-radius: 8px;\n    box-shadow: 0 8px 24px rgba(0,0,0,0.12);\n    padding: 6px;\n    z-index: 55;\n    animation: fadeIn 0.12s ease;\n    font-size: 13px;\n  }\n  .share-dropdown-panel a,\n  .share-dropdown-panel button {\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    width: 100%;\n    padding: 7px 10px;\n    border: none;\n    background: none;\n    color: var(--fg);\n    font-size: 13px;\n    text-decoration: none;\n    border-radius: 5px;\n    cursor: pointer;\n    text-align: left;\n  }\n  .share-dropdown-panel a:hover,\n  .share-dropdown-panel button:hover {\n    background: var(--sidebar-hover);\n  }\n  .share-dropdown-panel .share-icon {\n    width: 16px;\n    text-align: center;\n    flex-shrink: 0;\n    opacity: 0.7;\n  }\n  .share-dropdown-panel hr {\n    border: none;\n    border-top: 1px solid var(--border);\n    margin: 4px 0;\n  }\n\n  .toolbar-icon-btn {\n    background: none !important;\n    border: 1px solid transparent !important;\n    font-size: 15px !important;\n    padding: 2px 6px !important;\n    color: var(--muted) !important;\n    cursor: pointer;\n  }\n  .toolbar-icon-btn:hover { color: var(--fg) !important; }\n  .toolbar-icon-btn.spinning svg { animation: spin 0.8s linear infinite; }\n  @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }\n\n  /* Settings dropdown (replaces many toolbar groups) */\n  .settings-dropdown {\n    position: relative;\n  }\n  .settings-dropdown-btn {\n    background: none !important;\n    border: 1px solid transparent !important;\n    font-size: 15px !important;\n    padding: 2px 6px !important;\n    color: var(--muted) !important;\n    cursor: pointer;\n  }\n  .settings-dropdown-btn:hover { color: var(--fg) !important; }\n  .settings-dropdown-panel {\n    position: absolute;\n    top: 100%;\n    right: 0;\n    width: 260px;\n    background: var(--bg);\n    border: 1px solid var(--border);\n    border-radius: 8px;\n    box-shadow: 0 8px 24px rgba(0,0,0,0.12);\n    padding: 12px;\n    z-index: 55;\n    animation: fadeIn 0.12s ease;\n    font-size: 12px;\n  }\n  .settings-dropdown-panel label {\n    display: block;\n    font-size: 10px;\n    text-transform: uppercase;\n    letter-spacing: 0.5px;\n    color: var(--muted);\n    margin-bottom: 4px;\n    margin-top: 10px;\n  }\n  .settings-dropdown-panel label:first-child { margin-top: 0; }\n  .settings-dropdown-panel .setting-row {\n    display: flex;\n    gap: 4px;\n    align-items: center;\n  }\n  .settings-dropdown-panel button {\n    background: var(--bg);\n    color: var(--fg);\n    border: 1px solid var(--border);\n    border-radius: 4px;\n    padding: 3px 8px;\n    font-size: 12px;\n    cursor: pointer;\n  }\n  .settings-dropdown-panel button:hover { border-color: var(--muted); }\n  .settings-dropdown-panel button.active {\n    background: var(--fg);\n    color: var(--bg);\n    border-color: var(--fg);\n  }\n  .settings-dropdown-panel select {\n    flex: 1;\n    padding: 4px 6px;\n    border: 1px solid var(--border);\n    border-radius: 4px;\n    background: var(--bg);\n    color: var(--fg);\n    font-size: 12px;\n  }\n  .settings-dropdown-panel hr {\n    border: none;\n    border-top: 1px solid var(--border);\n    margin: 10px 0;\n  }\n\n  /* Main area */\n  .main {\n    flex: 1;\n    display: flex;\n    overflow: hidden;\n  }\n\n  /* Sidebar */\n  .sidebar {\n    width: 300px;\n    min-width: 300px;\n    background: var(--sidebar-bg);\n    border-right: 1px solid var(--border);\n    display: flex;\n    flex-direction: column;\n    transition: margin-left 0.2s ease, opacity 0.2s ease;\n    overflow: hidden;\n  }\n  .sidebar.collapsed {\n    margin-left: -300px;\n    opacity: 0;\n    pointer-events: none;\n  }\n\n  .sidebar-search {\n    padding: 10px;\n    border-bottom: 1px solid var(--border);\n  }\n  .sidebar-search input {\n    width: 100%;\n    padding: 6px 10px;\n    border: 1px solid var(--border);\n    border-radius: 5px;\n    background: var(--bg);\n    color: var(--fg);\n    font-size: 13px;\n    outline: none;\n  }\n  .sidebar-search input:focus {\n    border-color: var(--link);\n  }\n  .sidebar-search input::placeholder {\n    color: var(--muted);\n  }\n\n  .file-list {\n    flex: 1;\n    overflow-y: auto;\n    overflow-x: hidden;\n  }\n\n  .file-item {\n    padding: 10px 12px;\n    border-bottom: 1px solid var(--border);\n    cursor: pointer;\n    transition: background 0.1s;\n  }\n  .file-item:hover {\n    background: var(--sidebar-hover);\n  }\n  .file-item.active {\n    background: var(--sidebar-active);\n  }\n  .file-item.read .file-item-title {\n    opacity: 0.6;\n  }\n  .file-item-title {\n    font-size: 13px;\n    font-weight: 500;\n    line-height: 1.3;\n    margin-bottom: 3px;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    display: -webkit-box;\n    -webkit-line-clamp: 2;\n    -webkit-box-orient: vertical;\n  }\n  .file-item-meta {\n    font-size: 11px;\n    color: var(--muted);\n    display: flex;\n    gap: 6px;\n  }\n\n  .file-count {\n    padding: 8px 12px;\n    font-size: 11px;\n    color: var(--muted);\n    border-bottom: 1px solid var(--border);\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n  }\n  .hide-read-toggle {\n    display: flex;\n    align-items: center;\n    gap: 3px;\n    cursor: pointer;\n    font-size: 10px;\n    color: var(--muted);\n  }\n  .hide-read-toggle input {\n    width: 12px;\n    height: 12px;\n    margin: 0;\n    cursor: pointer;\n  }\n\n  /* Favicon in sidebar */\n  .file-item-favicon {\n    width: 14px;\n    height: 14px;\n    border-radius: 2px;\n    margin-right: 2px;\n    vertical-align: -2px;\n    opacity: 0.7;\n  }\n\n  /* Content pane */\n  .content-pane {\n    flex: 1;\n    overflow-y: auto;\n    overflow-x: hidden;\n    background: var(--bg);\n    position: relative;\n  }\n\n  .content-wrap {\n    max-width: 720px;\n    margin: 0 auto;\n    padding: 32px 28px 96px;\n  }\n\n  .empty-state {\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n    justify-content: center;\n    height: 100%;\n    color: var(--muted);\n    text-align: center;\n    gap: 12px;\n  }\n  .empty-state .hint {\n    font-size: 18px;\n  }\n  .empty-state .subhint {\n    font-size: 14px;\n  }\n\n  /* Typography classes */\n  .font-sans .content-wrap { font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Helvetica, sans-serif; }\n  .font-serif .content-wrap { font-family: \"Georgia\", \"Times New Roman\", \"Iowan Old Style\", serif; }\n  .font-mono .content-wrap { font-family: \"SF Mono\", \"Fira Code\", \"Menlo\", monospace; }\n  .font-system .content-wrap { font-family: \"Charter\", \"Bitstream Charter\", \"Sitka Text\", Cambria, serif; }\n  .font-inter .content-wrap { font-family: \"Inter\", -apple-system, BlinkMacSystemFont, sans-serif; }\n  .font-lora .content-wrap { font-family: \"Lora\", \"Georgia\", serif; }\n  .font-literata .content-wrap { font-family: \"Literata\", \"Georgia\", serif; }\n  .font-source-serif .content-wrap { font-family: \"Source Serif 4\", \"Georgia\", serif; }\n\n  .content-wrap {\n    line-height: 1.7;\n    font-size: 17px;\n  }\n  .size-small .content-wrap { font-size: 15px; }\n  .size-medium .content-wrap { font-size: 17px; }\n  .size-large .content-wrap { font-size: 20px; }\n\n  /* Article content */\n  .content-wrap h1 { font-size: 1.8em; margin: 0.5em 0 0.3em; line-height: 1.2; }\n  .content-wrap h2 { font-size: 1.4em; margin: 1.2em 0 0.3em; line-height: 1.3; }\n  .content-wrap h3 { font-size: 1.15em; margin: 1em 0 0.3em; }\n  .content-wrap p { margin: 0.8em 0; }\n  .content-wrap a { color: var(--link); text-decoration: none; }\n  .content-wrap a:hover { text-decoration: underline; }\n  .content-wrap img { max-width: 100%; height: auto; border-radius: 4px; margin: 1em 0; display: block; }\n  .content-wrap blockquote {\n    border-left: 3px solid var(--border);\n    padding-left: 16px;\n    margin: 1em 0;\n    color: var(--muted);\n  }\n  .content-wrap pre {\n    background: var(--code-bg);\n    padding: 14px;\n    border-radius: 6px;\n    overflow-x: auto;\n    margin: 1em 0;\n    font-size: 14px;\n    line-height: 1.5;\n  }\n  .content-wrap code {\n    background: var(--code-bg);\n    padding: 2px 5px;\n    border-radius: 3px;\n    font-size: 0.9em;\n  }\n  .content-wrap pre code { background: none; padding: 0; }\n  .content-wrap ul, .content-wrap ol { padding-left: 1.5em; margin: 0.8em 0; }\n  .content-wrap li { margin: 0.3em 0; }\n  .content-wrap hr { border: none; border-top: 1px solid var(--border); margin: 2em 0; }\n  .content-wrap table { border-collapse: collapse; width: 100%; margin: 1em 0; }\n  .content-wrap th, .content-wrap td { border: 1px solid var(--border); padding: 8px 12px; text-align: left; }\n  .content-wrap th { background: var(--code-bg); }\n\n  .article-header {\n    margin-bottom: 24px;\n    padding-bottom: 16px;\n    border-bottom: 1px solid var(--border);\n    font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n  }\n  .article-header h1 {\n    font-size: 1.6em;\n    line-height: 1.25;\n    margin: 0 0 8px;\n    color: var(--fg);\n    font-weight: 700;\n  }\n  .article-byline {\n    font-size: 14px;\n    color: var(--muted);\n    line-height: 1.5;\n  }\n  .article-byline a { color: var(--link); text-decoration: none; }\n  .article-byline a:hover { text-decoration: underline; }\n  .article-byline .author { color: var(--fg); font-weight: 500; }\n  .article-byline .sep { margin: 0 6px; opacity: 0.4; }\n  .article-actions {\n    display: flex;\n    gap: 6px;\n    margin-top: 10px;\n    align-items: center;\n  }\n  .article-actions button {\n    display: inline-flex;\n    align-items: center;\n    gap: 4px;\n    padding: 4px 10px;\n    font-size: 12px;\n    border: 1px solid var(--border);\n    border-radius: 4px;\n    background: var(--bg);\n    color: var(--muted);\n    cursor: pointer;\n    font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n    transition: color 0.15s, border-color 0.15s;\n  }\n  .article-actions button:hover { color: var(--fg); border-color: var(--muted); }\n  .article-actions button.active-fav { color: #e91e63; border-color: #e91e63; }\n  .article-actions button:disabled { opacity: 0.5; cursor: not-allowed; }\n\n  /* Margin notes (Google Docs-style) */\n  .margin-notes {\n    position: absolute;\n    top: 0;\n    right: 0;\n    width: 240px;\n    pointer-events: none;\n    z-index: 5;\n  }\n  .margin-note {\n    position: absolute;\n    right: 12px;\n    width: 216px;\n    padding: 8px 10px;\n    background: var(--code-bg);\n    border-left: 2px solid var(--link);\n    border-radius: 0 4px 4px 0;\n    font-size: 12px;\n    line-height: 1.5;\n    color: var(--fg);\n    font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n    pointer-events: all;\n    cursor: pointer;\n    transition: box-shadow 0.15s;\n  }\n  .margin-note:hover {\n    box-shadow: 0 2px 8px rgba(0,0,0,0.1);\n  }\n  .margin-note .mn-text {\n    color: var(--muted);\n    font-size: 11px;\n    margin-bottom: 3px;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n  }\n  .margin-note .mn-body {\n    white-space: pre-wrap;\n    word-break: break-word;\n  }\n  @media (max-width: 1100px) {\n    .margin-notes { display: none; }\n  }\n\n  /* Tablet */\n  @media (max-width: 768px) {\n    .sidebar {\n      position: absolute;\n      z-index: 20;\n      height: calc(100vh - 42px);\n      box-shadow: 4px 0 16px rgba(0,0,0,0.1);\n    }\n    .sidebar.collapsed {\n      margin-left: -300px;\n    }\n    .content-wrap {\n      padding: 24px 20px 80px;\n    }\n    .article-header h1 {\n      font-size: 1.35em;\n    }\n    .settings-dropdown-panel {\n      position: fixed;\n      top: 42px;\n      right: 8px;\n      left: 8px;\n      width: auto;\n    }\n    .annotation-popover {\n      width: 240px;\n    }\n    .modal-card {\n      padding: 20px 20px;\n      width: 94%;\n    }\n  }\n\n  /* Mobile */\n  @media (max-width: 480px) {\n    .toolbar {\n      padding: 4px 8px;\n    }\n    .brand {\n      font-size: 13px;\n    }\n    .sidebar {\n      width: 260px;\n      min-width: 260px;\n    }\n    .sidebar.collapsed {\n      margin-left: -260px;\n    }\n    .content-wrap {\n      padding: 16px 14px 72px;\n    }\n    .article-header h1 {\n      font-size: 1.2em;\n    }\n    .article-byline {\n      font-size: 12px;\n    }\n    .article-actions {\n      flex-wrap: wrap;\n    }\n    .content-wrap table {\n      font-size: 13px;\n    }\n    .content-wrap th, .content-wrap td {\n      padding: 6px 8px;\n    }\n    .annotation-popover {\n      position: fixed;\n      left: 8px;\n      right: 8px;\n      bottom: 8px;\n      top: auto;\n      width: auto;\n    }\n    .hl-toolbar {\n      padding: 4px 6px;\n    }\n    .hl-toolbar button {\n      width: 28px;\n      height: 28px;\n    }\n    .notes-panel textarea {\n      min-height: 60px;\n      font-size: 16px;\n    }\n  }\n\n  /* Focus indicators (a11y) */\n  :focus-visible {\n    outline: 2px solid var(--link);\n    outline-offset: 2px;\n  }\n  .toolbar button:focus-visible,\n  .sidebar-footer-btn:focus-visible {\n    outline: 2px solid var(--link);\n    outline-offset: 1px;\n    border-radius: 4px;\n  }\n\n  /* Reduced motion (a11y) */\n  @media (prefers-reduced-motion: reduce) {\n    *, *::before, *::after {\n      animation-duration: 0.01ms !important;\n      animation-iteration-count: 1 !important;\n      transition-duration: 0.01ms !important;\n      scroll-behavior: auto !important;\n    }\n  }\n\n  /* Line height options */\n  .leading-compact .content-wrap { line-height: 1.5; }\n  .leading-relaxed .content-wrap { line-height: 2.0; }\n  .leading-loose .content-wrap { line-height: 2.4; }\n\n  /* Letter spacing options */\n  .spacing-wide .content-wrap { letter-spacing: 0.03em; }\n  .spacing-wider .content-wrap { letter-spacing: 0.06em; }\n\n  /* Content width options */\n  .width-narrow .content-wrap { max-width: 560px; }\n  .width-wide .content-wrap { max-width: 900px; }\n\n  /* Dyslexia-friendly font */\n  .font-opendyslexic .content-wrap {\n    font-family: 'OpenDyslexic', 'Comic Sans MS', cursive, sans-serif;\n    letter-spacing: 0.04em;\n    word-spacing: 0.1em;\n  }\n\n  /* Sidebar footer buttons */\n  .sidebar-footer {\n    display: flex;\n    gap: 4px;\n    padding: 8px 12px;\n    border-top: 1px solid var(--border);\n  }\n  .sidebar-footer-btn {\n    flex: 1;\n    padding: 4px 0;\n    font-size: 11px;\n    color: var(--muted);\n    background: var(--code-bg);\n    border: 1px solid var(--border);\n    border-radius: 4px;\n    cursor: pointer;\n    font-family: inherit;\n    transition: color 0.15s, border-color 0.15s;\n  }\n  .sidebar-footer-btn:hover {\n    color: var(--fg);\n    border-color: var(--muted);\n  }\n\n  /* Generic modal overlay */\n  .modal-overlay {\n    position: fixed;\n    top: 0; left: 0; right: 0; bottom: 0;\n    background: rgba(0, 0, 0, 0.55);\n    z-index: 100;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    animation: fadeIn 0.15s ease;\n  }\n  .modal-card {\n    background: var(--bg);\n    border: 1px solid var(--border);\n    border-radius: 12px;\n    padding: 28px 32px;\n    max-width: 480px;\n    width: 90%;\n    max-height: 85vh;\n    overflow-y: auto;\n    box-shadow: 0 16px 48px rgba(0,0,0,0.2);\n    font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n  }\n  .modal-card h2 {\n    font-size: 18px;\n    margin: 0 0 14px;\n    color: var(--fg);\n  }\n  .modal-card h3 {\n    font-size: 14px;\n    margin: 18px 0 6px;\n    color: var(--fg);\n    font-weight: 600;\n  }\n  .modal-card h3:first-of-type { margin-top: 8px; }\n  .modal-card p {\n    font-size: 13px;\n    line-height: 1.6;\n    color: var(--muted);\n    margin: 0 0 8px;\n  }\n  .modal-close {\n    display: block;\n    margin: 18px auto 0;\n    padding: 7px 24px;\n    background: var(--fg);\n    color: var(--bg);\n    border: none;\n    border-radius: 6px;\n    font-size: 13px;\n    cursor: pointer;\n  }\n  .modal-close:hover { opacity: 0.85; }\n  .modal-updated {\n    font-size: 11px;\n    color: var(--muted);\n    margin-bottom: 12px;\n  }\n  .shortcuts-grid {\n    display: grid;\n    grid-template-columns: auto 1fr;\n    gap: 6px 14px;\n    margin: 12px 0;\n    font-size: 13px;\n  }\n  .shortcuts-grid kbd {\n    background: var(--code-bg);\n    border: 1px solid var(--border);\n    border-radius: 3px;\n    padding: 2px 7px;\n    font-size: 12px;\n    font-family: inherit;\n    text-align: center;\n  }\n  .shortcuts-grid span { color: var(--fg); }\n\n  /* Drop file highlight */\n  .drop-highlight .content-pane {\n    outline: 3px dashed var(--link);\n    outline-offset: -3px;\n  }\n\n  /* Onboarding overlay */\n  .onboarding-overlay {\n    position: fixed;\n    top: 0; left: 0; right: 0; bottom: 0;\n    background: rgba(0, 0, 0, 0.55);\n    z-index: 100;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    animation: fadeIn 0.3s ease;\n  }\n  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }\n  .onboarding-card {\n    background: var(--bg);\n    border: 1px solid var(--border);\n    border-radius: 12px;\n    padding: 32px 36px;\n    max-width: 440px;\n    width: 90%;\n    box-shadow: 0 16px 48px rgba(0,0,0,0.2);\n  }\n  .onboarding-card h2 {\n    font-size: 20px;\n    margin-bottom: 16px;\n    color: var(--fg);\n  }\n  .onboarding-card p {\n    font-size: 14px;\n    line-height: 1.6;\n    color: var(--muted);\n    margin-bottom: 12px;\n  }\n  .onboarding-shortcuts {\n    display: grid;\n    grid-template-columns: auto 1fr;\n    gap: 6px 14px;\n    margin: 16px 0;\n    font-size: 13px;\n  }\n  .onboarding-shortcuts kbd {\n    background: var(--code-bg);\n    border: 1px solid var(--border);\n    border-radius: 3px;\n    padding: 2px 7px;\n    font-size: 12px;\n    font-family: inherit;\n    text-align: center;\n  }\n  .onboarding-shortcuts span {\n    color: var(--fg);\n  }\n  .onboarding-dismiss {\n    display: block;\n    margin: 20px auto 0;\n    padding: 8px 24px;\n    background: var(--fg);\n    color: var(--bg);\n    border: none;\n    border-radius: 6px;\n    font-size: 14px;\n    cursor: pointer;\n  }\n  .onboarding-dismiss:hover {\n    opacity: 0.85;\n  }\n\n  /* Highlights */\n  mark.pr-highlight {\n    border-radius: 2px;\n    padding: 1px 0;\n    cursor: pointer;\n    transition: opacity 0.15s;\n  }\n  mark.pr-highlight:hover { opacity: 0.75; }\n  .pr-highlight.hl-yellow { background: rgba(255, 235, 59, 0.45); }\n  .pr-highlight.hl-green { background: rgba(76, 175, 80, 0.35); }\n  .pr-highlight.hl-blue { background: rgba(66, 165, 245, 0.3); }\n  .pr-highlight.hl-pink { background: rgba(236, 64, 122, 0.3); }\n  [data-theme=\"dark\"] .pr-highlight.hl-yellow { background: rgba(255, 235, 59, 0.3); }\n  [data-theme=\"dark\"] .pr-highlight.hl-green { background: rgba(76, 175, 80, 0.25); }\n  [data-theme=\"dark\"] .pr-highlight.hl-blue { background: rgba(66, 165, 245, 0.25); }\n  [data-theme=\"dark\"] .pr-highlight.hl-pink { background: rgba(236, 64, 122, 0.25); }\n\n  /* Highlight toolbar (floating) */\n  .hl-toolbar {\n    position: absolute;\n    z-index: 50;\n    display: flex;\n    gap: 4px;\n    padding: 5px 8px;\n    background: var(--toolbar-bg);\n    border: 1px solid var(--border);\n    border-radius: 8px;\n    box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n    animation: fadeIn 0.15s ease;\n  }\n  .hl-toolbar button {\n    width: 22px;\n    height: 22px;\n    border-radius: 50%;\n    border: 2px solid var(--border);\n    cursor: pointer;\n    padding: 0;\n    transition: transform 0.1s;\n  }\n  .hl-toolbar button:hover { transform: scale(1.2); }\n  .hl-toolbar .hl-yellow-btn { background: #ffeb3b; }\n  .hl-toolbar .hl-green-btn { background: #4caf50; }\n  .hl-toolbar .hl-blue-btn { background: #42a5f5; }\n  .hl-toolbar .hl-pink-btn { background: #ec407a; }\n  .hl-toolbar .hl-note-btn {\n    background: var(--bg);\n    width: auto;\n    border-radius: 4px;\n    padding: 0 8px;\n    font-size: 11px;\n    color: var(--fg);\n  }\n\n  /* Notes panel */\n  .notes-panel {\n    border-top: 1px solid var(--border);\n    margin-top: 24px;\n    padding-top: 16px;\n  }\n  .notes-panel summary {\n    cursor: pointer;\n    font-size: 13px;\n    font-weight: 600;\n    color: var(--muted);\n    font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n    user-select: none;\n  }\n  .notes-panel summary:hover { color: var(--fg); }\n  .notes-panel textarea {\n    width: 100%;\n    min-height: 80px;\n    margin-top: 10px;\n    padding: 10px;\n    border: 1px solid var(--border);\n    border-radius: 6px;\n    background: var(--bg);\n    color: var(--fg);\n    font-family: inherit;\n    font-size: 14px;\n    line-height: 1.6;\n    resize: vertical;\n    outline: none;\n  }\n  .notes-panel textarea:focus { border-color: var(--link); }\n  .notes-save-hint {\n    font-size: 11px;\n    color: var(--muted);\n    margin-top: 4px;\n    font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n  }\n\n  /* Inline annotation indicator */\n  .annotation-marker {\n    display: inline-block;\n    width: 14px;\n    height: 14px;\n    background: var(--link);\n    color: var(--bg);\n    border-radius: 50%;\n    font-size: 9px;\n    text-align: center;\n    line-height: 14px;\n    cursor: pointer;\n    vertical-align: super;\n    margin-left: 2px;\n    font-family: -apple-system, sans-serif;\n  }\n  .annotation-marker:hover { opacity: 0.8; }\n\n  /* Annotation popover */\n  .annotation-popover {\n    position: absolute;\n    z-index: 51;\n    width: 280px;\n    background: var(--bg);\n    border: 1px solid var(--border);\n    border-radius: 8px;\n    box-shadow: 0 4px 16px rgba(0,0,0,0.15);\n    padding: 12px;\n    animation: fadeIn 0.15s ease;\n  }\n  .annotation-popover textarea {\n    width: 100%;\n    min-height: 60px;\n    padding: 8px;\n    border: 1px solid var(--border);\n    border-radius: 4px;\n    background: var(--bg);\n    color: var(--fg);\n    font-family: inherit;\n    font-size: 13px;\n    resize: vertical;\n    outline: none;\n  }\n  .annotation-popover textarea:focus { border-color: var(--link); }\n  .annotation-popover .btn-row {\n    display: flex;\n    justify-content: flex-end;\n    gap: 6px;\n    margin-top: 8px;\n  }\n  .annotation-popover button {\n    padding: 4px 12px;\n    border: 1px solid var(--border);\n    border-radius: 4px;\n    background: var(--bg);\n    color: var(--fg);\n    font-size: 12px;\n    cursor: pointer;\n  }\n  .annotation-popover button.primary {\n    background: var(--fg);\n    color: var(--bg);\n    border-color: var(--fg);\n  }\n\n  /* Highlight indicator dot on sidebar items */\n  .file-item-indicators {\n    display: flex;\n    gap: 3px;\n    margin-top: 2px;\n  }\n  .file-item-indicators .dot {\n    width: 6px;\n    height: 6px;\n    border-radius: 50%;\n  }\n  .dot-highlight { background: #ffeb3b; }\n  .dot-note { background: var(--link); }\n  .dot-summary { background: #ab47bc; }\n  .dot-favorite { color: #e91e63; font-size: 8px; line-height: 6px; }\n\n  /* Highlight note marker (small icon after highlighted text) */\n  .hl-note-marker {\n    display: inline-block;\n    width: 13px;\n    height: 13px;\n    background: var(--muted);\n    color: var(--bg);\n    border-radius: 50%;\n    font-size: 8px;\n    text-align: center;\n    line-height: 13px;\n    cursor: pointer;\n    vertical-align: super;\n    margin-left: 1px;\n    font-family: -apple-system, sans-serif;\n    opacity: 0.7;\n  }\n  .hl-note-marker:hover { opacity: 1; }\n\n  /* Tags input */\n  .tags-row {\n    display: flex;\n    align-items: center;\n    gap: 6px;\n    margin-top: 10px;\n    flex-wrap: wrap;\n  }\n  .tags-row .tag {\n    display: inline-flex;\n    align-items: center;\n    gap: 3px;\n    padding: 2px 8px;\n    background: var(--code-bg);\n    border: 1px solid var(--border);\n    border-radius: 12px;\n    font-size: 11px;\n    color: var(--fg);\n    font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n  }\n  .tags-row .tag .tag-remove {\n    cursor: pointer;\n    opacity: 0.5;\n    font-size: 13px;\n    line-height: 1;\n  }\n  .tags-row .tag .tag-remove:hover { opacity: 1; }\n  .tags-row input {\n    border: none;\n    background: transparent;\n    color: var(--fg);\n    font-size: 12px;\n    outline: none;\n    width: 100px;\n    font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n  }\n\n  /* Favorite toggle */\n  .favorite-row {\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    margin-top: 8px;\n    font-size: 13px;\n    font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n  }\n  .favorite-btn {\n    background: none;\n    border: none;\n    cursor: pointer;\n    font-size: 18px;\n    padding: 0;\n    line-height: 1;\n    color: var(--muted);\n  }\n  .favorite-btn.active { color: #e91e63; }\n  .favorite-btn:hover { opacity: 0.8; }\n\n  /* Summary display — theme-aware complementary colors */\n  .article-summary {\n    background: rgba(171, 71, 188, 0.06);\n    border-left: 3px solid #ab47bc;\n    padding: 12px 16px;\n    margin: 12px 0 20px;\n    font-size: 14px;\n    line-height: 1.6;\n    color: var(--fg);\n    border-radius: 0 6px 6px 0;\n    font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n  }\n  [data-theme=\"dark\"] .article-summary {\n    background: rgba(171, 71, 188, 0.1);\n  }\n  [data-theme=\"sepia\"] .article-summary {\n    background: rgba(171, 71, 188, 0.06);\n    border-left-color: #9c5ba0;\n  }\n  [data-theme=\"high-contrast\"] .article-summary {\n    background: rgba(171, 71, 188, 0.15);\n    border-left-color: #ce93d8;\n  }\n  .article-summary .summary-label {\n    font-size: 11px;\n    text-transform: uppercase;\n    letter-spacing: 0.5px;\n    color: var(--muted);\n    margin-bottom: 4px;\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n  }\n  .article-summary .summary-actions {\n    display: flex;\n    gap: 6px;\n    align-items: center;\n  }\n  .article-summary .summary-actions button {\n    background: none;\n    border: none;\n    color: var(--muted);\n    cursor: pointer;\n    font-size: 12px;\n    padding: 0 2px;\n    line-height: 1;\n  }\n  .article-summary .summary-actions button:hover { color: var(--fg); }\n  .summarize-btn {\n    display: inline-block;\n    padding: 3px 10px;\n    font-size: 12px;\n    border: 1px solid var(--border);\n    border-radius: 4px;\n    background: var(--bg);\n    color: var(--fg);\n    cursor: pointer;\n    margin-left: 8px;\n    vertical-align: middle;\n    font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n  }\n  .summarize-btn:hover { border-color: #ab47bc; color: #ab47bc; }\n  .summarize-btn:disabled { opacity: 0.5; cursor: not-allowed; }\n\n  /* Inline SVG icons */\n  .icon { width: 1em; height: 1em; vertical-align: -0.125em; fill: currentColor; display: inline-block; }\n  .icon-sm { width: 0.85em; height: 0.85em; }\n  .icon-lg { width: 1.15em; height: 1.15em; }\n\n  /* YouTube video embed */\n  .yt-embed { position: relative; width: 100%; padding-bottom: 56.25%; height: 0; overflow: hidden; margin: 1em 0; border-radius: 8px; }\n  .yt-embed iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; border-radius: 8px; }\n\n  /* Reading progress bar */\n  .reading-progress {\n    position: sticky;\n    top: 0;\n    left: 0;\n    right: 0;\n    height: 3px;\n    background: transparent;\n    z-index: 8;\n    pointer-events: none;\n  }\n  .reading-progress-bar {\n    height: 100%;\n    width: 0%;\n    background: var(--link);\n    transition: width 0.1s linear;\n    border-radius: 0 2px 2px 0;\n    opacity: 0.8;\n  }\n\n  /* Read time & word count badge */\n  .read-stats {\n    display: inline-flex;\n    align-items: center;\n    gap: 4px;\n    font-size: 12px;\n    color: var(--muted);\n    font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n  }\n  .read-stats .stat-divider {\n    opacity: 0.4;\n  }\n\n  /* Focus mode: dim all paragraphs except the one closest to center */\n  .focus-mode .content-wrap > p,\n  .focus-mode .content-wrap > blockquote,\n  .focus-mode .content-wrap > ul,\n  .focus-mode .content-wrap > ol,\n  .focus-mode .content-wrap > pre,\n  .focus-mode .content-wrap > h2,\n  .focus-mode .content-wrap > h3,\n  .focus-mode .content-wrap > h4,\n  .focus-mode .content-wrap > table {\n    opacity: 0.2;\n    transition: opacity 0.3s ease;\n  }\n  .focus-mode .content-wrap > .focus-active,\n  .focus-mode .content-wrap > .focus-active + p,\n  .focus-mode .content-wrap > .focus-adjacent {\n    opacity: 1;\n  }\n  .focus-mode .content-wrap > .article-header,\n  .focus-mode .content-wrap > .article-summary,\n  .focus-mode .content-wrap > .notes-panel {\n    opacity: 1;\n  }\n\n  /* Table of Contents */\n  .toc-panel {\n    position: sticky;\n    top: 16px;\n    max-height: calc(100vh - 80px);\n    overflow-y: auto;\n    padding: 12px 0;\n    font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n  }\n  .toc-container {\n    position: absolute;\n    left: 12px;\n    top: 0;\n    width: 200px;\n    pointer-events: none;\n    z-index: 4;\n  }\n  .toc-container .toc-panel {\n    pointer-events: all;\n  }\n  .toc-label {\n    font-size: 10px;\n    text-transform: uppercase;\n    letter-spacing: 0.5px;\n    color: var(--muted);\n    margin-bottom: 8px;\n    font-weight: 600;\n  }\n  .toc-list {\n    list-style: none;\n    padding: 0;\n    margin: 0;\n  }\n  .toc-list li {\n    margin: 0;\n  }\n  .toc-list a {\n    display: block;\n    padding: 3px 0;\n    font-size: 12px;\n    line-height: 1.4;\n    color: var(--muted);\n    text-decoration: none;\n    border-left: 2px solid transparent;\n    padding-left: 8px;\n    transition: color 0.15s, border-color 0.15s;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n  }\n  .toc-list a:hover {\n    color: var(--fg);\n  }\n  .toc-list a.toc-active {\n    color: var(--link);\n    border-left-color: var(--link);\n    font-weight: 500;\n  }\n  .toc-list .toc-h3 {\n    padding-left: 20px;\n    font-size: 11px;\n  }\n  @media (max-width: 1400px) {\n    .toc-container { display: none; }\n  }\n\n  /* Resume position indicator */\n  .resume-indicator {\n    position: fixed;\n    bottom: 20px;\n    right: 20px;\n    background: var(--fg);\n    color: var(--bg);\n    padding: 8px 16px;\n    border-radius: 8px;\n    font-size: 13px;\n    font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n    box-shadow: 0 4px 12px rgba(0,0,0,0.2);\n    cursor: pointer;\n    z-index: 50;\n    animation: fadeIn 0.3s ease;\n    opacity: 0.95;\n  }\n  .resume-indicator:hover {\n    opacity: 1;\n  }\n\n  /* Syntax highlighting theme sync */\n  .content-wrap pre code.hljs {\n    background: var(--code-bg);\n    padding: 14px;\n    border-radius: 6px;\n    font-size: 14px;\n    line-height: 1.5;\n  }\n  [data-theme=\"dark\"] .content-wrap pre code.hljs,\n  [data-theme=\"high-contrast\"] .content-wrap pre code.hljs {\n    background: var(--code-bg);\n  }\n  [data-theme=\"sepia\"] .content-wrap pre code.hljs {\n    background: var(--code-bg);\n  }\n\n  /* Code block language label */\n  .content-wrap pre {\n    position: relative;\n  }\n  .code-lang-label {\n    position: absolute;\n    top: 0;\n    right: 0;\n    padding: 2px 8px;\n    font-size: 10px;\n    text-transform: uppercase;\n    letter-spacing: 0.5px;\n    color: var(--muted);\n    background: var(--code-bg);\n    border-radius: 0 6px 0 4px;\n    border-bottom: 1px solid var(--border);\n    border-left: 1px solid var(--border);\n    font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n    opacity: 0.7;\n  }\n\n  /* Tag cloud modal */\n  .tag-cloud {\n    display: flex;\n    flex-wrap: wrap;\n    gap: 6px;\n    margin: 12px 0;\n    justify-content: center;\n  }\n  .tag-cloud-item {\n    display: inline-block;\n    padding: 4px 12px;\n    background: var(--code-bg);\n    border: 1px solid var(--border);\n    border-radius: 16px;\n    color: var(--fg);\n    cursor: pointer;\n    transition: background 0.15s, border-color 0.15s;\n    font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n    text-decoration: none;\n    white-space: nowrap;\n  }\n  .tag-cloud-item:hover {\n    background: var(--sidebar-hover);\n    border-color: var(--link);\n  }\n  .domain-group {\n    margin: 16px 0 8px;\n    padding: 0;\n  }\n  .domain-group-header {\n    display: flex;\n    align-items: center;\n    gap: 6px;\n    font-size: 13px;\n    font-weight: 600;\n    color: var(--fg);\n    margin-bottom: 6px;\n    cursor: pointer;\n  }\n  .domain-group-header:hover { color: var(--link); }\n  .domain-group-count {\n    font-weight: 400;\n    color: var(--muted);\n    font-size: 11px;\n  }\n  .domain-group-articles {\n    padding-left: 8px;\n    font-size: 12px;\n  }\n  .domain-group-articles a {\n    display: block;\n    padding: 2px 0;\n    color: var(--muted);\n    text-decoration: none;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n  }\n  .domain-group-articles a:hover { color: var(--link); }\n\n  /* Focus mode toggle button in toolbar */\n  .focus-btn {\n    background: none !important;\n    border: 1px solid transparent !important;\n    font-size: 14px !important;\n    padding: 2px 6px !important;\n    color: var(--muted) !important;\n    cursor: pointer;\n    transition: color 0.15s;\n  }\n  .focus-btn:hover { color: var(--fg) !important; }\n  .focus-btn.active { color: var(--link) !important; }\n\n  /* Print styles */\n  @media print {\n    .toolbar, .sidebar, .skip-link, .margin-notes, .toc-container,\n    .reading-progress, .hl-toolbar, .annotation-popover, .resume-indicator,\n    .article-actions, .notes-panel summary, .notes-panel .favorite-row,\n    .notes-panel .tags-row, .notes-panel textarea, .notes-save-hint,\n    .onboarding-overlay, .modal-overlay, .settings-dropdown-panel { display: none !important; }\n\n    body, .app, .main, .content-pane {\n      height: auto !important;\n      overflow: visible !important;\n      background: white !important;\n      color: black !important;\n    }\n    .content-pane {\n      position: static !important;\n    }\n    .content-wrap {\n      max-width: 100% !important;\n      padding: 0 !important;\n      font-size: 12pt !important;\n      line-height: 1.6 !important;\n      color: black !important;\n    }\n    .content-wrap a { color: #333 !important; text-decoration: underline !important; }\n    .content-wrap a::after { content: \" (\" attr(href) \")\"; font-size: 9pt; color: #666; }\n    .content-wrap a[href^=\"#\"]::after, .content-wrap a[href^=\"javascript\"]::after { content: none; }\n    .content-wrap img { max-width: 100% !important; break-inside: avoid; }\n    .content-wrap pre { break-inside: avoid; border: 1px solid #ddd !important; background: #f9f9f9 !important; }\n    .content-wrap blockquote { border-left-color: #999 !important; color: #333 !important; }\n    .article-header { border-bottom: 1px solid #ccc !important; }\n    .article-summary { border-left-color: #999 !important; background: #f5f5f5 !important; break-inside: avoid; }\n    mark.pr-highlight { background: #ff0 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }\n\n    /* Print notes section at end */\n    .notes-panel {\n      display: block !important;\n      border-top: 1px solid #ccc !important;\n      page-break-before: auto;\n    }\n    .notes-panel > div[style] { display: block !important; }\n\n    @page {\n      margin: 2cm;\n      @bottom-center { content: counter(page); }\n    }\n  }\n\n</style>\n</head>\n<body data-theme=\"light\" class=\"font-serif size-medium\">\n<a href=\"#content-pane\" class=\"skip-link\">Skip to content</a>\n<!-- SVG icon sprite (FontAwesome Free solid/regular, inlined for fully offline use) -->\n<svg xmlns=\"http://www.w3.org/2000/svg\" style=\"display:none\" aria-hidden=\"true\">\n  <symbol id=\"i-bars\" viewBox=\"0 0 448 512\"><path d=\"M0 96C0 78.3 14.3 64 32 64h384c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zm0 160c0-17.7 14.3-32 32-32h384c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zm448 160c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32h384c17.7 0 32 14.3 32 32z\"/></symbol>\n  <symbol id=\"i-gear\" viewBox=\"0 0 512 512\"><path d=\"M495.9 166.6c3.2 8.7.5 18.4-6.4 24.6l-43.3 39.4c1.1 8.3 1.7 16.8 1.7 25.4s-.6 17.1-1.7 25.4l43.3 39.4c6.9 6.2 9.6 15.9 6.4 24.6-4.4 11.9-9.7 23.3-15.8 34.3l-4.7 8.1c-6.6 11-14 21.4-22.1 31.2-5.9 7.2-15.7 9.6-24.5 6.8l-55.7-17.7c-13.4 10.1-28.2 18.3-44 24.4l-12.5 57.1c-2 9.1-9.3 15.5-18.4 17.4-12.2 2.5-24.8 3.8-37.6 3.8s-25.5-1.3-37.6-3.8c-9.2-1.9-16.5-8.3-18.4-17.4l-12.5-57.1c-15.8-6.1-30.6-14.3-44-24.4l-55.7 17.7c-8.8 2.8-18.6.3-24.5-6.8-8.1-9.8-15.5-20.2-22.1-31.2l-4.7-8.1c-6.1-11-11.4-22.4-15.8-34.3-3.2-8.7-.5-18.4 6.4-24.6l43.3-39.4C64.6 273.1 64 264.6 64 256s.6-17.1 1.7-25.4L22.4 191.2c-6.9-6.2-9.6-15.9-6.4-24.6 4.4-11.9 9.7-23.3 15.8-34.3l4.7-8.1c6.6-11 14-21.4 22.1-31.2 5.9-7.2 15.7-9.6 24.5-6.8l55.7 17.7c13.4-10.1 28.2-18.3 44-24.4l12.5-57.1c2-9.1 9.3-15.5 18.4-17.4C226.5 1.3 239.2 0 252 0s25.5 1.3 37.6 3.8c9.2 1.9 16.5 8.3 18.4 17.4l12.5 57.1c15.8 6.1 30.6 14.3 44 24.4l55.7-17.7c8.8-2.8 18.6-.3 24.5 6.8 8.1 9.8 15.5 20.2 22.1 31.2l4.7 8.1c6.1 11 11.4 22.4 15.8 34.3zM256 336a80 80 0 1 0 0-160 80 80 0 1 0 0 160z\"/></symbol>\n  <symbol id=\"i-heart\" viewBox=\"0 0 512 512\"><path d=\"M47.6 300.4L228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6 0 115.2 0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z\"/></symbol>\n  <symbol id=\"i-heart-o\" viewBox=\"0 0 512 512\"><path d=\"M225.8 468.2l-2.5-2.3L48.1 303.2C17.4 274.7 0 234.7 0 192.8v-3.3c0-70.4 50-130.8 119.2-144C158.6 37.9 198.9 47 231 69.6c9 6.3 17.3 13.6 25 21.5 7.7-7.9 16-15.2 25-21.5 32.1-22.6 72.4-31.7 111.8-24.2C461.2 58.7 512 119.1 512 189.5v3.3c0 41.9-17.4 81.9-48.1 110.4L288.7 465.9l-2.5 2.3c-8.2 7.6-19 11.9-30.2 11.9s-22-4.2-30.2-11.9zM239.1 145c-25.9-26.4-60.9-41.2-97.5-34.8-47.6 8.4-83.7 51.3-83.7 100.1v3.3c0 29.4 12.2 57.7 33.6 77.8l166.3 152.2.5.5c2.5 2.3 5.7 3.5 9 3.5s6.5-1.2 9-3.5l.5-.5 166.3-152.2c21.5-20.1 33.6-48.4 33.6-77.8v-3.3c0-48.8-36.1-91.8-83.7-100.1-36.6-6.5-71.6 8.3-97.5 34.8l-17.8 18.2-17.8-18.2z\"/></symbol>\n  <symbol id=\"i-pen\" viewBox=\"0 0 512 512\"><path d=\"M362.7 19.3L314.3 67.7 444.3 197.7l48.4-48.4c25-25 25-65.5 0-90.5L453.3 19.3c-25-25-65.5-25-90.5 0zm-71 71L58.6 323.5c-10.4 10.4-18 23.3-22.2 37.4L1 481.2C-1.5 489.7.8 498.8 7 505s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L421.7 220.3 291.7 90.3z\"/></symbol>\n  <symbol id=\"i-wand\" viewBox=\"0 0 576 512\"><path d=\"M234.7 42.7L197 56.8c-3 1.1-5 4-5 7.2s2 6.1 5 7.2l37.7 14.1L248.8 123c1.1 3 4 5 7.2 5s6.1-2 7.2-5l14.1-37.7L315 71.2c3-1.1 5-4 5-7.2s-2-6.1-5-7.2L277.3 42.7 263.2 5c-1.1-3-4-5-7.2-5s-6.1 2-7.2 5L234.7 42.7zM46.1 395.4c-18.7 18.7-18.7 49.1 0 67.9l34.6 34.6c18.7 18.7 49.1 18.7 67.9 0L529.9 116.5c18.7-18.7 18.7-49.1 0-67.9L495.3 14c-18.7-18.7-49.1-18.7-67.9 0L46.1 395.4zM484.6 82.6l-105 105-23.3-23.3 105-105 23.3 23.3zM7.5 117.2C3 118.9 0 123.2 0 128s3 9.1 7.5 10.8L64 160l21.2 56.5c1.7 4.5 6 7.5 10.8 7.5s9.1-3 10.8-7.5L128 160l56.5-21.2c4.5-1.7 7.5-6 7.5-10.8s-3-9.1-7.5-10.8L128 96 106.8 39.5C105.1 35 100.8 32 96 32s-9.1 3-10.8 7.5L64 96 7.5 117.2zm352 256c-4.5 1.7-7.5 6-7.5 10.8s3 9.1 7.5 10.8L416 416l21.2 56.5c1.7 4.5 6 7.5 10.8 7.5s9.1-3 10.8-7.5L480 416l56.5-21.2c4.5-1.7 7.5-6 7.5-10.8s-3-9.1-7.5-10.8L480 352l-21.2-56.5c-1.7-4.5-6-7.5-10.8-7.5s-9.1 3-10.8 7.5L416 352l-56.5 21.2z\"/></symbol>\n  <symbol id=\"i-globe\" viewBox=\"0 0 512 512\"><path d=\"M352 256c0 22.2-1.2 43.6-3.3 64H163.3c-2.2-20.4-3.3-41.8-3.3-64s1.2-43.6 3.3-64h185.4c2.2 20.4 3.3 41.8 3.3 64zm28.8-64h123.1c5.3 20.5 8.1 41.9 8.1 64s-2.8 43.5-8.1 64H380.8c2.1-20.6 3.2-42 3.2-64s-1.1-43.4-3.2-64zm112.6-32H376.7c-10-63.9-29.8-117.4-55.3-151.6C399.6 29 467.7 90.2 493.4 160zM256 16c30.6 0 66.7 56.5 82.3 144H173.7C189.3 72.5 225.4 16 256 16zM135.3 160H18.6c25.7-69.8 93.8-131 172-151.6-25.5 34.2-45.3 87.7-55.3 151.6zM8.1 192H131.2c-2.1 20.6-3.2 42-3.2 64s1.1 43.4 3.2 64H8.1C2.8 299.5 0 278.1 0 256s2.8-43.5 8.1-64zm10.5 160h116.7c10 63.9 29.8 117.4 55.3 151.6C112.4 483 44.3 421.8 18.6 352zM256 496c-30.6 0-66.7-56.5-82.3-144h164.7C322.7 439.5 286.6 496 256 496zm120.7 7.6c25.5-34.2 45.3-87.7 55.3-151.6h116.7c-25.7 69.8-93.8 131-172 151.6z\"/></symbol>\n  <symbol id=\"i-xmark\" viewBox=\"0 0 384 512\"><path d=\"M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3l105.4 105.3c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256l105.3-105.4z\"/></symbol>\n  <symbol id=\"i-keyboard\" viewBox=\"0 0 576 512\"><path d=\"M64 64C28.7 64 0 92.7 0 128v256c0 35.3 28.7 64 64 64h448c35.3 0 64-28.7 64-64V128c0-35.3-28.7-64-64-64H64zm16 64h32c8.8 0 16 7.2 16 16v32c0 8.8-7.2 16-16 16H80c-8.8 0-16-7.2-16-16v-32c0-8.8 7.2-16 16-16zm112 0h32c8.8 0 16 7.2 16 16v32c0 8.8-7.2 16-16 16h-32c-8.8 0-16-7.2-16-16v-32c0-8.8 7.2-16 16-16zm112 0h32c8.8 0 16 7.2 16 16v32c0 8.8-7.2 16-16 16h-32c-8.8 0-16-7.2-16-16v-32c0-8.8 7.2-16 16-16zm112 0h32c8.8 0 16 7.2 16 16v32c0 8.8-7.2 16-16 16h-32c-8.8 0-16-7.2-16-16v-32c0-8.8 7.2-16 16-16zM80 192h32c8.8 0 16 7.2 16 16v32c0 8.8-7.2 16-16 16H80c-8.8 0-16-7.2-16-16v-32c0-8.8 7.2-16 16-16zm384 0h32c8.8 0 16 7.2 16 16v32c0 8.8-7.2 16-16 16h-32c-8.8 0-16-7.2-16-16v-32c0-8.8 7.2-16 16-16zM80 320h32c8.8 0 16 7.2 16 16v32c0 8.8-7.2 16-16 16H80c-8.8 0-16-7.2-16-16v-32c0-8.8 7.2-16 16-16zm384 0h32c8.8 0 16 7.2 16 16v32c0 8.8-7.2 16-16 16h-32c-8.8 0-16-7.2-16-16v-32c0-8.8 7.2-16 16-16zm-288 0h224c8.8 0 16 7.2 16 16v32c0 8.8-7.2 16-16 16H176c-8.8 0-16-7.2-16-16v-32c0-8.8 7.2-16 16-16z\"/></symbol>\n  <symbol id=\"i-tags\" viewBox=\"0 0 512 512\"><path d=\"M345 39.1L472.8 168.4c52.4 53 52.4 138.2 0 191.2L360.8 472.9c-9.3 9.4-24.5 9.5-33.9.2s-9.5-24.5-.2-33.9L438.6 325.9c33.9-34.3 33.9-89.4 0-123.7L310.9 72.9c-9.3-9.4-9.2-24.6.2-33.9s24.6-9.2 33.9.2zM0 229.5V80C0 53.5 21.5 32 48 32H197.5c17 0 33.3 6.7 45.3 18.7l168 168c25 25 25 65.5 0 90.5L277.3 442.7c-25 25-65.5 25-90.5 0l-168-168C6.7 262.7 0 246.5 0 229.5zM144 144a32 32 0 1 0-64 0 32 32 0 1 0 64 0z\"/></symbol>\n  <symbol id=\"i-book\" viewBox=\"0 0 448 512\"><path d=\"M96 0C43 0 0 43 0 96v320c0 53 43 96 96 96h320c17.7 0 32-14.3 32-32s-14.3-32-32-32v-64c17.7 0 32-14.3 32-32V32c0-17.7-14.3-32-32-32H96zm0 384h256v64H96c-17.7 0-32-14.3-32-32s14.3-32 32-32zm32-240c0-8.8 7.2-16 16-16h192c8.8 0 16 7.2 16 16s-7.2 16-16 16H144c-8.8 0-16-7.2-16-16zm16 48h192c8.8 0 16 7.2 16 16s-7.2 16-16 16H144c-8.8 0-16-7.2-16-16s7.2-16 16-16z\"/></symbol>\n  <symbol id=\"i-calendar\" viewBox=\"0 0 448 512\"><path d=\"M152 24c0-13.3-10.7-24-24-24s-24 10.7-24 24v40H64C28.7 64 0 92.7 0 128v16 48V448c0 35.3 28.7 64 64 64h320c35.3 0 64-28.7 64-64V192 144 128c0-35.3-28.7-64-64-64h-40V24c0-13.3-10.7-24-24-24s-24 10.7-24 24v40H152V24zM48 192h352V448c0 8.8-7.2 16-16 16H64c-8.8 0-16-7.2-16-16V192z\"/></symbol>\n  <symbol id=\"i-refresh\" viewBox=\"0 0 512 512\"><path d=\"M105.1 202.6c7.7-21.8 20.2-42.3 37.8-59.8c62.5-62.5 163.8-62.5 226.3 0L386.3 160H352c-17.7 0-32 14.3-32 32s14.3 32 32 32h111.5c0 0 .1 0 .1 0c.4 0 .8 0 1.2 0H480c17.7 0 32-14.3 32-32V80c0-17.7-14.3-32-32-32s-32 14.3-32 32v35.2L430.9 99.9C349.7 18.7 221.5 4.2 126 69.3c-9.2 6.3-13.5 18.1-8.3 28.4c5.2 10.4 17.5 15.3 28.5 10.8c1.5-.6 3-1.4 4.5-2.2c-16.2 27.2-27.3 58-31.5 90.3H105.1zm16.5 116.9c-7.7 21.8-20.2 42.3-37.8 59.8c-62.5 62.5-163.8 62.5-226.3 0L125.7 352H160c17.7 0 32-14.3 32-32s-14.3-32-32-32H48.5c0 0-.1 0-.1 0c-.4 0-.8 0-1.2 0H32c-17.7 0-32 14.3-32 32v112c0 17.7 14.3 32 32 32s32-14.3 32-32v-35.2L81.1 412.1c81.2 81.2 209.4 95.6 304.9 30.5c9.2-6.3 13.5-18.1 8.3-28.4c-5.2-10.4-17.5-15.3-28.5-10.8c-1.5 .6-3 1.4-4.5 2.2c16.2-27.2 27.3-58 31.5-90.3h13.9z\"/></symbol>\n  <symbol id=\"i-share\" viewBox=\"0 0 512 512\"><path d=\"M307 34.8c-11.5 5.1-19 16.6-19 29.2v64H176C78.8 128 0 206.8 0 304C0 417.3 81.5 467.9 100.2 478.1c2.5 1.4 5.3 1.9 8.1 1.9c10.9 0 19.7-8.9 19.7-19.7c0-7.5-4.3-14.4-9.8-19.5C108.8 431.9 96 414.4 96 384c0-53 43-96 96-96h96v64c0 12.6 7.4 24.1 19 29.2s25 3 34.4-5.4l160-144c6.7-6.1 10.6-14.7 10.6-23.8s-3.8-17.7-10.6-23.8l-160-144c-9.4-8.5-22.9-10.6-34.4-5.4z\"/></symbol>\n</svg>\n<div class=\"app\" role=\"application\" aria-label=\"PullRead article reader\">\n\n  <nav class=\"toolbar\" aria-label=\"Reader toolbar\">\n    <button class=\"sidebar-toggle\" onclick=\"toggleSidebar()\" aria-label=\"Toggle sidebar\" aria-expanded=\"true\" id=\"sidebar-toggle-btn\"><svg class=\"icon\" aria-hidden=\"true\"><use href=\"#i-bars\"/></svg></button>\n    <span class=\"brand\" onclick=\"toggleSidebar()\" role=\"heading\" aria-level=\"1\">PullRead</span>\n\n    <div class=\"toolbar-spacer\"></div>\n\n    <button class=\"focus-btn\" onclick=\"toggleFocusMode()\" aria-label=\"Toggle focus mode\" title=\"Focus mode (f)\" id=\"focus-btn\">&#9681;</button>\n    <button class=\"toolbar-icon-btn\" onclick=\"refreshArticleList()\" aria-label=\"Refresh articles\" title=\"Refresh\" id=\"refresh-btn\"><svg class=\"icon\" aria-hidden=\"true\"><use href=\"#i-refresh\"/></svg></button>\n    <div class=\"settings-dropdown\">\n      <button class=\"settings-dropdown-btn\" onclick=\"toggleSettingsDropdown()\" aria-label=\"Reader settings\" aria-expanded=\"false\" id=\"settings-toggle-btn\"><svg class=\"icon\" aria-hidden=\"true\"><use href=\"#i-gear\"/></svg></button>\n    </div>\n  </nav>\n\n  <div class=\"main\">\n    <aside class=\"sidebar\" id=\"sidebar\" aria-label=\"Article list\">\n      <div class=\"sidebar-search\" role=\"search\">\n        <label for=\"search\" class=\"sr-only\">Search articles</label>\n        <input type=\"text\" id=\"search\" placeholder=\"Search articles...\" oninput=\"filterFiles()\" />\n      </div>\n      <div class=\"file-count\" id=\"file-count\" aria-live=\"polite\" aria-atomic=\"true\">\n        <span id=\"file-count-text\"></span>\n        <label class=\"hide-read-toggle\" title=\"Hide viewed articles\">\n          <input type=\"checkbox\" id=\"hide-read-toggle\" onchange=\"toggleHideRead()\" />\n          <span class=\"hide-read-label\">Hide read</span>\n        </label>\n      </div>\n      <div class=\"file-list\" id=\"file-list\" role=\"listbox\" aria-label=\"Articles\"></div>\n      <div class=\"sidebar-footer\">\n        <button class=\"sidebar-footer-btn\" onclick=\"showShortcutsModal()\" aria-label=\"Keyboard shortcuts\"><svg class=\"icon icon-sm\" aria-hidden=\"true\" style=\"opacity:0.5;vertical-align:-1px\"><use href=\"#i-keyboard\"/></svg> Shortcuts</button>\n        <button class=\"sidebar-footer-btn\" onclick=\"showTagCloud()\" aria-label=\"Explore tags\"><svg class=\"icon icon-sm\" aria-hidden=\"true\" style=\"opacity:0.5;vertical-align:-1px\"><use href=\"#i-tags\"/></svg> Explore</button>\n        <button class=\"sidebar-footer-btn\" onclick=\"showGuideModal()\" aria-label=\"Features guide\"><svg class=\"icon icon-sm\" aria-hidden=\"true\" style=\"opacity:0.5;vertical-align:-1px\"><use href=\"#i-book\"/></svg> Guide</button>\n        <button class=\"sidebar-footer-btn\" onclick=\"batchAutotagAll()\" aria-label=\"Auto-tag all articles\" id=\"batch-tag-btn\"><svg class=\"icon icon-sm\" aria-hidden=\"true\" style=\"opacity:0.5;vertical-align:-1px\"><use href=\"#i-wand\"/></svg> Tag All</button>\n      </div>\n    </aside>\n\n    <main class=\"content-pane\" id=\"content-pane\" aria-label=\"Article content\">\n      <div class=\"reading-progress\" aria-hidden=\"true\"><div class=\"reading-progress-bar\" id=\"reading-progress-bar\"></div></div>\n      <div class=\"empty-state\" id=\"empty-state\">\n        <p class=\"hint\">Select an article</p>\n        <p class=\"subhint\">or drop a .md file here</p>\n      </div>\n      <article class=\"content-wrap\" id=\"content\" style=\"display:none;\" aria-live=\"polite\"></article>\n      <div class=\"margin-notes\" id=\"margin-notes\" aria-hidden=\"true\"></div>\n      <div class=\"toc-container\" id=\"toc-container\" aria-label=\"Table of contents\"></div>\n    </main>\n  </div>\n\n</div>\n\n<div class=\"onboarding-overlay\" id=\"onboarding\" style=\"display:none\" onclick=\"dismissOnboarding(event)\" role=\"dialog\" aria-modal=\"true\" aria-label=\"Welcome to PullRead\">\n  <div class=\"onboarding-card\" onclick=\"event.stopPropagation()\">\n    <h2>Welcome to PullRead</h2>\n    <p>Browse your synced articles in a clean, distraction-free reader. Select text to highlight passages, or add notes to articles. Use the sidebar to search and select articles, or customize the theme and font above.</p>\n    <div class=\"onboarding-shortcuts\">\n      <kbd>j</kbd> / <kbd>&rarr;</kbd> <span>Next article</span>\n      <kbd>k</kbd> / <kbd>&larr;</kbd> <span>Previous article</span>\n      <kbd>&uarr;</kbd> <kbd>&darr;</kbd> <span>Scroll (jumps articles at edges)</span>\n      <kbd>/</kbd> <span>Search articles</span>\n      <kbd>[</kbd> <span>Toggle sidebar</span>\n      <kbd>h</kbd> <span>Highlight selected text</span>\n      <kbd>n</kbd> <span>Toggle article notes</span>\n      <kbd>f</kbd> <span>Toggle focus mode</span>\n      <kbd>p</kbd> <span>Print article</span>\n      <kbd>Esc</kbd> <span>Clear search</span>\n    </div>\n    <button class=\"onboarding-dismiss\" onclick=\"dismissOnboarding()\">Got it</button>\n  </div>\n</div>\n\n<script>\n// State\nlet allFiles = [];\nlet filteredFiles = [];\nlet displayFiles = []; // after hide-read filter\nlet activeFile = null;\nlet serverMode = false;\nlet hideRead = false;\nlet readArticles = new Set(JSON.parse(localStorage.getItem('pr-read-articles') || '[]'));\nconst PAGE_SIZE = 200; // pagination chunk\nlet displayedCount = 0;\n\n// Highlights & Notes state\nlet articleHighlights = []; // highlights for current article\nlet articleNotes = { articleNote: '', annotations: [], tags: [], isFavorite: false }; // notes for current article\nlet allHighlightsIndex = {}; // { filename: [...] } for sidebar indicators\nlet allNotesIndex = {}; // { filename: { articleNote, annotations } } for sidebar indicators\n\n// Preferences\nfunction setTheme(theme) {\n  document.body.setAttribute('data-theme', theme);\n  document.querySelectorAll('[data-theme-btn]').forEach(b =>\n    b.classList.toggle('active', b.getAttribute('data-theme-btn') === theme)\n  );\n  localStorage.setItem('pr-theme', theme);\n  updateHljsTheme();\n}\n\nfunction setFont(font) {\n  document.body.className = document.body.className.replace(/font-[\\w-]+/, 'font-' + font);\n  localStorage.setItem('pr-font', font);\n}\n\nfunction setSize(size) {\n  document.body.className = document.body.className.replace(/size-\\w+/, 'size-' + size);\n  document.querySelectorAll('[data-size-btn]').forEach(b =>\n    b.classList.toggle('active', b.getAttribute('data-size-btn') === size)\n  );\n  localStorage.setItem('pr-size', size);\n}\n\nfunction toggleSidebar() {\n  const sidebar = document.getElementById('sidebar');\n  sidebar.classList.toggle('collapsed');\n  const isCollapsed = sidebar.classList.contains('collapsed');\n  localStorage.setItem('pr-sidebar', isCollapsed ? '0' : '1');\n  document.getElementById('sidebar-toggle-btn').setAttribute('aria-expanded', !isCollapsed);\n}\n\nfunction setLineHeight(val) {\n  document.body.className = document.body.className.replace(/leading-\\w+/g, '');\n  if (val !== 'default') document.body.classList.add('leading-' + val);\n  localStorage.setItem('pr-leading', val);\n}\n\nfunction setSpacing(val) {\n  document.body.className = document.body.className.replace(/spacing-\\w+/g, '');\n  if (val !== 'default') document.body.classList.add('spacing-' + val);\n  localStorage.setItem('pr-spacing', val);\n}\n\nfunction setWidth(val) {\n  document.body.className = document.body.className.replace(/width-\\w+/g, '');\n  if (val !== 'default') document.body.classList.add('width-' + val);\n  localStorage.setItem('pr-width', val);\n}\n\nfunction toggleSettingsDropdown() {\n  const existing = document.querySelector('.settings-dropdown-panel');\n  const btn = document.getElementById('settings-toggle-btn');\n  if (existing) { existing.remove(); btn.setAttribute('aria-expanded', 'false'); return; }\n\n  const currentTheme = document.body.getAttribute('data-theme') || 'light';\n  const currentFont = localStorage.getItem('pr-font') || 'serif';\n  const currentSize = localStorage.getItem('pr-size') || 'medium';\n  const currentLeading = localStorage.getItem('pr-leading') || 'default';\n  const currentSpacing = localStorage.getItem('pr-spacing') || 'default';\n  const currentWidth = localStorage.getItem('pr-width') || 'default';\n\n  const panel = document.createElement('div');\n  panel.className = 'settings-dropdown-panel';\n  panel.setAttribute('role', 'region');\n  panel.setAttribute('aria-label', 'Reader settings');\n  panel.onclick = function(e) { e.stopPropagation(); };\n  panel.innerHTML = `\n    <label>Theme</label>\n    <div class=\"setting-row\">\n      <button data-setting=\"theme\" data-val=\"light\" onclick=\"setTheme('light');updateDropdownState()\" ${currentTheme==='light'?'class=\"active\"':''}>Light</button>\n      <button data-setting=\"theme\" data-val=\"dark\" onclick=\"setTheme('dark');updateDropdownState()\" ${currentTheme==='dark'?'class=\"active\"':''}>Dark</button>\n      <button data-setting=\"theme\" data-val=\"sepia\" onclick=\"setTheme('sepia');updateDropdownState()\" ${currentTheme==='sepia'?'class=\"active\"':''}>Sepia</button>\n      <button data-setting=\"theme\" data-val=\"high-contrast\" onclick=\"setTheme('high-contrast');updateDropdownState()\" ${currentTheme==='high-contrast'?'class=\"active\"':''} title=\"High contrast\">Hi-Con</button>\n    </div>\n    <label>Font</label>\n    <div class=\"setting-row\">\n      <select onchange=\"setFont(this.value)\" id=\"font-select\" aria-label=\"Font family\">\n        <option value=\"serif\" ${currentFont==='serif'?'selected':''}>Serif</option>\n        <option value=\"sans\" ${currentFont==='sans'?'selected':''}>Sans-serif</option>\n        <option value=\"system\" ${currentFont==='system'?'selected':''}>Charter</option>\n        <option value=\"mono\" ${currentFont==='mono'?'selected':''}>Monospace</option>\n        <option value=\"inter\" ${currentFont==='inter'?'selected':''}>Inter</option>\n        <option value=\"lora\" ${currentFont==='lora'?'selected':''}>Lora</option>\n        <option value=\"literata\" ${currentFont==='literata'?'selected':''}>Literata</option>\n        <option value=\"source-serif\" ${currentFont==='source-serif'?'selected':''}>Source Serif</option>\n        <option value=\"opendyslexic\" ${currentFont==='opendyslexic'?'selected':''}>OpenDyslexic</option>\n      </select>\n    </div>\n    <label>Size</label>\n    <div class=\"setting-row\">\n      <button data-setting=\"size\" data-val=\"small\" onclick=\"setSize('small');updateDropdownState()\" ${currentSize==='small'?'class=\"active\"':''} aria-label=\"Small text\">A</button>\n      <button data-setting=\"size\" data-val=\"medium\" onclick=\"setSize('medium');updateDropdownState()\" ${currentSize==='medium'?'class=\"active\"':''} style=\"font-size:14px\" aria-label=\"Medium text\">A</button>\n      <button data-setting=\"size\" data-val=\"large\" onclick=\"setSize('large');updateDropdownState()\" ${currentSize==='large'?'class=\"active\"':''} style=\"font-size:17px\" aria-label=\"Large text\">A</button>\n    </div>\n    <label>Line height</label>\n    <div class=\"setting-row\">\n      <select onchange=\"setLineHeight(this.value)\" aria-label=\"Line height\">\n        <option value=\"default\" ${currentLeading==='default'?'selected':''}>Default</option>\n        <option value=\"compact\" ${currentLeading==='compact'?'selected':''}>Compact</option>\n        <option value=\"relaxed\" ${currentLeading==='relaxed'?'selected':''}>Relaxed</option>\n        <option value=\"loose\" ${currentLeading==='loose'?'selected':''}>Loose</option>\n      </select>\n    </div>\n    <label>Letter spacing</label>\n    <div class=\"setting-row\">\n      <select onchange=\"setSpacing(this.value)\" aria-label=\"Letter spacing\">\n        <option value=\"default\" ${currentSpacing==='default'?'selected':''}>Default</option>\n        <option value=\"wide\" ${currentSpacing==='wide'?'selected':''}>Wide</option>\n        <option value=\"wider\" ${currentSpacing==='wider'?'selected':''}>Wider</option>\n      </select>\n    </div>\n    <label>Content width</label>\n    <div class=\"setting-row\">\n      <select onchange=\"setWidth(this.value)\" aria-label=\"Content width\">\n        <option value=\"narrow\" ${currentWidth==='narrow'?'selected':''}>Narrow</option>\n        <option value=\"default\" ${currentWidth==='default'?'selected':''}>Default</option>\n        <option value=\"wide\" ${currentWidth==='wide'?'selected':''}>Wide</option>\n      </select>\n    </div>\n  `;\n  document.querySelector('.settings-dropdown').appendChild(panel);\n  btn.setAttribute('aria-expanded', 'true');\n}\n\nfunction updateDropdownState() {\n  const panel = document.querySelector('.settings-dropdown-panel');\n  if (!panel) return;\n  const currentTheme = document.body.getAttribute('data-theme') || 'light';\n  const currentSize = localStorage.getItem('pr-size') || 'medium';\n  // Update theme buttons\n  panel.querySelectorAll('[data-setting=\"theme\"]').forEach(b =>\n    b.classList.toggle('active', b.getAttribute('data-val') === currentTheme)\n  );\n  // Update size buttons\n  panel.querySelectorAll('[data-setting=\"size\"]').forEach(b =>\n    b.classList.toggle('active', b.getAttribute('data-val') === currentSize)\n  );\n}\n\n// Close settings dropdown when clicking outside\ndocument.addEventListener('click', function(e) {\n  const panel = document.querySelector('.settings-dropdown-panel');\n  if (panel && !panel.contains(e.target) && !e.target.closest('.settings-dropdown')) {\n    panel.remove();\n  }\n});\n\n// Frontmatter\nfunction parseFrontmatter(text) {\n  const match = text.match(/^---\\n([\\s\\S]*?)\\n---\\n([\\s\\S]*)$/);\n  if (!match) return { meta: null, body: text };\n  const meta = {};\n  match[1].split('\\n').forEach(line => {\n    const idx = line.indexOf(':');\n    if (idx > 0) {\n      const key = line.slice(0, idx).trim();\n      const val = line.slice(idx + 1).trim().replace(/^\"(.*)\"$/, '$1');\n      meta[key] = val;\n    }\n  });\n  return { meta, body: match[2] };\n}\n\nfunction escapeHtml(s) {\n  const d = document.createElement('div');\n  d.textContent = s;\n  return d.innerHTML;\n}\n\n// Clean up broken markdown patterns that marked.js can't handle\nfunction cleanMarkdown(md) {\n  // Fix image/link patterns split across lines:\n  // [\\n![alt](img)\\n]\\n(url) -> [![alt](img)](url)\n  md = md.replace(/\\[\\s*\\n\\s*(!\\[[^\\]]*\\]\\([^)]*\\))\\s*\\n\\s*\\]\\s*\\n\\s*(\\([^)]*\\))/g, '[$1]$2');\n\n  // Fix simpler case: [text\\n](url) -> [text](url)\n  md = md.replace(/\\[([^\\]]*?)\\s*\\n\\s*\\]\\s*\\n?\\s*(\\([^)]*\\))/g, '[$1]$2');\n\n  // Fix standalone brackets around images: [\\n![alt](url)\\n] without a link\n  md = md.replace(/\\[\\s*\\n(!\\[[^\\]]*\\]\\([^)]*\\))\\s*\\n\\]/g, '$1');\n\n  // Fix image syntax broken by newlines: ![\\nalt\\n]\\n(url) -> ![alt](url)\n  md = md.replace(/!\\[\\s*\\n?\\s*([^\\]]*?)\\s*\\n?\\s*\\]\\s*\\n\\s*(\\([^)]*\\))/g, '![$1]$2');\n\n  return md;\n}\n\n// Rendering\nfunction renderArticle(text, filename) {\n  const { meta, body } = parseFrontmatter(text);\n  const content = document.getElementById('content');\n  const empty = document.getElementById('empty-state');\n\n  empty.style.display = 'none';\n  content.style.display = 'block';\n\n  let html = '';\n\n  // Article header: title, author, date, domain, actions\n  html += '<div class=\"article-header\">';\n  if (meta && meta.title) {\n    html += '<h1>' + escapeHtml(meta.title) + '</h1>';\n  }\n  html += '<div class=\"article-byline\">';\n  const bylineParts = [];\n  if (meta && meta.author) bylineParts.push('<span class=\"author\">' + escapeHtml(meta.author) + '</span>');\n  if (meta && meta.domain) bylineParts.push('<a href=\"' + escapeHtml(meta.url || '') + '\" target=\"_blank\">' + escapeHtml(meta.domain) + '</a>');\n  if (meta && meta.bookmarked) bylineParts.push(escapeHtml(meta.bookmarked.slice(0, 10)));\n  html += bylineParts.join('<span class=\"sep\">&middot;</span>');\n  // Read time will be inserted after rendering\n  html += '</div>';\n\n  // Detect review/summary articles where Summarize doesn't make sense\n  const isReviewArticle = meta && (meta.feed === 'weekly-review' || meta.feed === 'daily-review' || meta.domain === 'pullread');\n\n  // Action buttons row\n  html += '<div class=\"article-actions\">';\n  const isFav = articleNotes.isFavorite;\n  html += '<button onclick=\"toggleFavoriteFromHeader(this)\" class=\"' + (isFav ? 'active-fav' : '') + '\" aria-label=\"' + (isFav ? 'Remove from favorites' : 'Add to favorites') + '\" aria-pressed=\"' + isFav + '\"><svg class=\"icon icon-sm\" aria-hidden=\"true\"><use href=\"#i-' + (isFav ? 'heart' : 'heart-o') + '\"/></svg> Favorite</button>';\n  html += '<button onclick=\"toggleNotesFromHeader()\" aria-label=\"Toggle notes panel\"><svg class=\"icon icon-sm\" aria-hidden=\"true\"><use href=\"#i-pen\"/></svg> Notes</button>';\n  if (!isReviewArticle) {\n    html += '<button onclick=\"summarizeArticle()\" id=\"summarize-btn\" aria-label=\"Summarize article\"><svg class=\"icon icon-sm\" aria-hidden=\"true\"><use href=\"#i-wand\"/></svg> Summarize</button>';\n  }\n  if (meta && meta.url) {\n    html += '<div class=\"share-dropdown\"><button onclick=\"toggleShareDropdown(event)\" aria-label=\"Share article\"><svg class=\"icon icon-sm\" aria-hidden=\"true\"><use href=\"#i-share\"/></svg> Share</button></div>';\n  }\n  html += '</div>';\n  html += '</div>';\n\n  // Show existing summary if present in frontmatter\n  if (meta && meta.summary) {\n    html += '<div class=\"article-summary\"><div class=\"summary-label\"><span>Summary</span><span class=\"summary-actions\"><button onclick=\"hideSummary()\" title=\"Hide summary\"><svg class=\"icon icon-sm\"><use href=\"#i-xmark\"/></svg></button></span></div>' + escapeHtml(meta.summary) + '</div>';\n  }\n\n  // Strip the leading H1 from markdown body if it matches the title (avoid duplication)\n  let articleBody = cleanMarkdown(body);\n  if (meta && meta.title) {\n    var h1Match = articleBody.match(/^#\\s+(.+)\\s*\\n/);\n    if (h1Match) {\n      var normalize = function(s) { return s.toLowerCase().replace(/[\\u2018\\u2019\\u201C\\u201D]/g, \"'\").replace(/[^a-z0-9]/g, ''); };\n      // Strip if title matches, or if it's a review (title always duplicated in body)\n      if (normalize(h1Match[1]) === normalize(meta.title) || isReviewArticle) {\n        articleBody = articleBody.slice(h1Match[0].length);\n      }\n    }\n  }\n\n  html += marked.parse(articleBody);\n\n  // Deduplicate images: remove consecutive/nearby img tags with the same src\n  html = (function dedupeImages(h) {\n    const div = document.createElement('div');\n    div.innerHTML = h;\n    const imgs = Array.from(div.querySelectorAll('img'));\n    const seen = new Set();\n    for (const img of imgs) {\n      const src = img.getAttribute('src');\n      if (!src) continue;\n      // Normalize: strip query params for dedup comparison\n      let key;\n      try { key = new URL(src).origin + new URL(src).pathname; } catch { key = src; }\n      if (seen.has(key)) {\n        // Remove the duplicate image (and its wrapping <p> or <a> if it's the only child)\n        const parent = img.parentElement;\n        if (parent && (parent.tagName === 'P' || parent.tagName === 'A') && parent.children.length === 1 && parent.textContent.trim() === '') {\n          parent.remove();\n        } else {\n          img.remove();\n        }\n      } else {\n        seen.add(key);\n      }\n    }\n    return div.innerHTML;\n  })(html);\n\n  // Convert YouTube thumbnail links into embedded video iframes\n  html = html.replace(\n    /<a[^>]*href=\"(https?:\\/\\/(www\\.)?youtube\\.com\\/watch\\?v=([^\"&]+)[^\"]*|https?:\\/\\/youtu\\.be\\/([^\"/?]+)[^\"]*)\"[^>]*>\\s*<img[^>]*src=\"https:\\/\\/img\\.youtube\\.com\\/vi\\/[^\"]*\"[^>]*>\\s*<\\/a>/gi,\n    function(match, url, _yt, id1, id2) {\n      var videoId = id1 || id2;\n      if (!videoId) return match;\n      return '<div class=\"yt-embed\"><iframe src=\"https://www.youtube.com/embed/' + videoId + '\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen title=\"Embedded video\"></iframe></div>';\n    }\n  );\n\n  content.innerHTML = html;\n  document.title = (meta && meta.title) || filename || 'PullRead';\n\n  // Post-process for accessibility\n  content.querySelectorAll('img:not([alt])').forEach(function(img) { img.setAttribute('alt', ''); });\n  content.querySelectorAll('img[alt=\"\"]').forEach(function(img) { img.setAttribute('role', 'presentation'); });\n  content.querySelectorAll('table').forEach(function(table) {\n    if (!table.querySelector('thead')) {\n      var firstRow = table.querySelector('tr');\n      if (firstRow && firstRow.querySelectorAll('th').length > 0) {\n        firstRow.querySelectorAll('th').forEach(function(th) { th.setAttribute('scope', 'col'); });\n      }\n    }\n    table.setAttribute('role', 'table');\n  });\n  // Open article content links in new window\n  content.querySelectorAll('a[href]').forEach(function(a) {\n    var href = a.getAttribute('href');\n    if (href && !href.startsWith('#')) {\n      a.setAttribute('target', '_blank');\n      a.setAttribute('rel', 'noopener noreferrer');\n    }\n  });\n\n  // Add read time & word count to byline\n  const articleBodyText = content.textContent || '';\n  const { words, minutes } = calculateReadStats(articleBodyText);\n  const bylineEl = content.querySelector('.article-byline');\n  if (bylineEl && words > 50) {\n    const statsSpan = document.createElement('span');\n    statsSpan.className = 'read-stats';\n    if (bylineEl.children.length > 0) {\n      const sep = document.createElement('span');\n      sep.className = 'sep';\n      sep.innerHTML = '&middot;';\n      bylineEl.appendChild(sep);\n    }\n    statsSpan.innerHTML = minutes + ' min read<span class=\"stat-divider\">&middot;</span>' + (words >= 1000 ? (words / 1000).toFixed(1) + 'k' : words) + ' words';\n    bylineEl.appendChild(statsSpan);\n  }\n\n  // Apply syntax highlighting to code blocks\n  applySyntaxHighlighting();\n\n  // Generate table of contents\n  generateToc();\n\n  // Scroll to top\n  document.getElementById('content-pane').scrollTop = 0;\n\n  // Reset reading progress\n  updateReadingProgress();\n\n  // Clear margin notes\n  document.getElementById('margin-notes').innerHTML = '';\n\n  // Restore scroll position (after a tick so DOM is settled)\n  setTimeout(() => restoreScrollPosition(filename), 100);\n\n  // Update focus mode if active\n  if (focusModeActive) {\n    setTimeout(updateFocusMode, 200);\n  }\n}\n\n// File list\nfunction renderFileList() {\n  const list = document.getElementById('file-list');\n  const countText = document.getElementById('file-count-text');\n\n  // Apply hide-read filter\n  if (hideRead) {\n    displayFiles = filteredFiles.filter(f => !readArticles.has(f.filename) || f.filename === activeFile);\n  } else {\n    displayFiles = filteredFiles;\n  }\n\n  const total = filteredFiles.length;\n  const shown = displayFiles.length;\n  countText.textContent = shown + ' article' + (shown !== 1 ? 's' : '') + (hideRead && shown < total ? ' (' + (total - shown) + ' hidden)' : '');\n\n  // Paginate: render in chunks for performance with large lists\n  displayedCount = Math.min(displayFiles.length, PAGE_SIZE);\n\n  list.innerHTML = displayFiles.slice(0, displayedCount).map((f, i) => renderFileItem(f, i)).join('');\n}\n\nfunction renderFileItem(f, i) {\n  const date = f.bookmarked ? f.bookmarked.slice(0, 10) : '';\n  const isActive = activeFile === f.filename ? ' active' : '';\n  const isRead = readArticles.has(f.filename);\n  const { hasHl, hasNote, isFavorite } = hasAnnotations(f.filename);\n  const hasSummary = f.hasSummary;\n  let indicators = '';\n  if (hasHl || hasNote || hasSummary || isFavorite) {\n    indicators = '<div class=\"file-item-indicators\">'\n      + (isFavorite ? '<span class=\"dot dot-favorite\" aria-label=\"Favorite\"><svg class=\"icon icon-sm\" aria-hidden=\"true\"><use href=\"#i-heart\"/></svg></span>' : '')\n      + (hasHl ? '<span class=\"dot dot-highlight\" aria-label=\"Has highlights\"></span>' : '')\n      + (hasNote ? '<span class=\"dot dot-note\" aria-label=\"Has notes\"></span>' : '')\n      + (hasSummary ? '<span class=\"dot dot-summary\" aria-label=\"Has summary\"></span>' : '')\n      + '</div>';\n  }\n\n  // Favicon from Google service\n  const favicon = f.domain && f.domain !== 'pullread'\n    ? '<img class=\"file-item-favicon\" src=\"https://www.google.com/s2/favicons?domain=' + encodeURIComponent(f.domain) + '&sz=32\" alt=\"\" loading=\"lazy\" onerror=\"this.style.display=\\'none\\'\" aria-hidden=\"true\">'\n    : '';\n\n  return '<div class=\"file-item' + isActive + (isRead && !isActive ? ' read' : '') + '\" data-index=\"' + i + '\" onclick=\"loadFile(' + i + ')\" role=\"option\" aria-selected=\"' + (activeFile === f.filename) + '\" tabindex=\"0\" onkeydown=\"if(event.key===\\'Enter\\')loadFile(' + i + ')\">'\n    + '<div class=\"file-item-title\">' + favicon + escapeHtml(f.title) + '</div>'\n    + '<div class=\"file-item-meta\">'\n    + (date ? '<span><svg class=\"icon icon-sm\" style=\"opacity:0.5\" aria-hidden=\"true\"><use href=\"#i-calendar\"/></svg> ' + date + '</span>' : '')\n    + (f.domain ? '<span>' + escapeHtml(f.domain) + '</span>' : '')\n    + '</div>'\n    + indicators\n    + '</div>';\n}\n\nfunction toggleHideRead() {\n  hideRead = document.getElementById('hide-read-toggle').checked;\n  localStorage.setItem('pr-hide-read', hideRead ? '1' : '0');\n  renderFileList();\n}\n\nfunction markAsRead(filename) {\n  readArticles.add(filename);\n  // Keep only last 5000 entries\n  if (readArticles.size > 5000) {\n    const arr = Array.from(readArticles);\n    readArticles = new Set(arr.slice(arr.length - 5000));\n  }\n  localStorage.setItem('pr-read-articles', JSON.stringify(Array.from(readArticles)));\n}\n\nfunction filterFiles() {\n  const q = document.getElementById('search').value.toLowerCase();\n  if (!q) {\n    filteredFiles = allFiles;\n  } else {\n    filteredFiles = allFiles.filter(f =>\n      f.title.toLowerCase().includes(q) ||\n      f.domain.toLowerCase().includes(q) ||\n      f.feed.toLowerCase().includes(q) ||\n      (allNotesIndex[f.filename]?.tags || []).some(t => t.toLowerCase().includes(q))\n    );\n  }\n  renderFileList();\n}\n\nasync function loadFile(index) {\n  const file = displayFiles[index];\n  if (!file) return;\n  activeFile = file.filename;\n  markAsRead(file.filename);\n  renderFileList();\n  removeHlToolbar();\n\n  // Auto-close sidebar on mobile after selecting an article\n  if (window.innerWidth <= 768) {\n    const sidebar = document.getElementById('sidebar');\n    if (!sidebar.classList.contains('collapsed')) sidebar.classList.add('collapsed');\n  }\n\n  if (serverMode) {\n    // Load annotations first so favorite state is available for header render\n    await preloadAnnotations(file.filename);\n    const res = await fetch('/api/file?name=' + encodeURIComponent(file.filename));\n    if (res.ok) {\n      const text = await res.text();\n      renderArticle(text, file.filename);\n      applyHighlights();\n      renderNotesPanel();\n    }\n  }\n}\n\n// Navigate to next (+1) or previous (-1) article with wrapping\nfunction navigateArticle(direction) {\n  if (!displayFiles.length) return;\n  const currentIdx = displayFiles.findIndex(f => f.filename === activeFile);\n  let next;\n  if (direction > 0) {\n    next = currentIdx < displayFiles.length - 1 ? currentIdx + 1 : 0;\n  } else {\n    next = currentIdx > 0 ? currentIdx - 1 : displayFiles.length - 1;\n  }\n  loadFile(next);\n  const el = document.querySelector('.file-item[data-index=\"' + next + '\"]');\n  if (el) el.scrollIntoView({ block: 'nearest' });\n}\n\n// ---- Highlights & Notes ----\n\nasync function preloadAnnotations(filename) {\n  if (!serverMode) return;\n  try {\n    const [hlRes, notesRes] = await Promise.all([\n      fetch('/api/highlights?name=' + encodeURIComponent(filename)),\n      fetch('/api/notes?name=' + encodeURIComponent(filename))\n    ]);\n    articleHighlights = hlRes.ok ? await hlRes.json() : [];\n    const notesData = notesRes.ok ? await notesRes.json() : {};\n    articleNotes = { articleNote: '', annotations: [], tags: [], isFavorite: false, ...notesData };\n  } catch {\n    articleHighlights = [];\n    articleNotes = { articleNote: '', annotations: [], tags: [], isFavorite: false };\n  }\n}\n\nasync function loadAnnotations(filename) {\n  await preloadAnnotations(filename);\n  applyHighlights();\n  renderNotesPanel();\n}\n\nasync function loadAnnotationsIndex() {\n  if (!serverMode) return;\n  try {\n    const [hlRes, notesRes] = await Promise.all([\n      fetch('/api/highlights'),\n      fetch('/api/notes')\n    ]);\n    allHighlightsIndex = hlRes.ok ? await hlRes.json() : {};\n    allNotesIndex = notesRes.ok ? await notesRes.json() : {};\n  } catch {\n    allHighlightsIndex = {};\n    allNotesIndex = {};\n  }\n}\n\nfunction hasAnnotations(filename) {\n  const hls = allHighlightsIndex[filename] || [];\n  const hasHl = hls.length > 0;\n  const hasHlNotes = hls.some(h => h.note);\n  const notes = allNotesIndex[filename];\n  const hasNote = notes && (notes.articleNote || (notes.annotations && notes.annotations.length > 0) || hasHlNotes);\n  const isFavorite = notes && notes.isFavorite;\n  const hasTags = notes && notes.tags && notes.tags.length > 0;\n  return { hasHl, hasNote, isFavorite, hasTags };\n}\n\nasync function saveHighlights() {\n  if (!serverMode || !activeFile) return;\n  allHighlightsIndex[activeFile] = articleHighlights;\n  await fetch('/api/highlights', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({ name: activeFile, highlights: articleHighlights })\n  });\n}\n\nasync function saveNotes() {\n  if (!serverMode || !activeFile) return;\n  allNotesIndex[activeFile] = articleNotes;\n  await fetch('/api/notes', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({ name: activeFile, ...articleNotes })\n  });\n}\n\nfunction generateId() {\n  return 'h' + Math.random().toString(36).slice(2, 8);\n}\n\nfunction getTextContext(text, before, after) {\n  // Get surrounding context for anchoring\n  const content = document.getElementById('content');\n  const fullText = content.textContent || '';\n  const idx = fullText.indexOf(text);\n  if (idx < 0) return { contextBefore: '', contextAfter: '' };\n  return {\n    contextBefore: fullText.slice(Math.max(0, idx - 30), idx),\n    contextAfter: fullText.slice(idx + text.length, idx + text.length + 30)\n  };\n}\n\nfunction createHighlight(color) {\n  const sel = window.getSelection();\n  if (!sel || sel.isCollapsed || !sel.toString().trim()) return;\n\n  const text = sel.toString();\n  const { contextBefore, contextAfter } = getTextContext(text);\n\n  const now = new Date().toISOString();\n  const highlight = {\n    id: generateId(),\n    text: text,\n    contextBefore,\n    contextAfter,\n    color: color,\n    note: '',\n    createdAt: now,\n    updatedAt: now\n  };\n\n  articleHighlights.push(highlight);\n  saveHighlights();\n  applyHighlights();\n  removeHlToolbar();\n  sel.removeAllRanges();\n  renderFileList(); // update indicator dots\n}\n\nfunction deleteHighlight(id) {\n  articleHighlights = articleHighlights.filter(h => h.id !== id);\n  saveHighlights();\n  applyHighlights();\n  renderFileList();\n}\n\nfunction applyHighlights() {\n  const content = document.getElementById('content');\n  if (!content) return;\n\n  // Remove existing highlights (re-render from raw HTML)\n  content.querySelectorAll('mark.pr-highlight').forEach(mark => {\n    const parent = mark.parentNode;\n    while (mark.firstChild) parent.insertBefore(mark.firstChild, mark);\n    parent.removeChild(mark);\n    parent.normalize();\n  });\n\n  // Remove annotation markers and highlight note markers\n  content.querySelectorAll('.annotation-marker').forEach(m => m.remove());\n  content.querySelectorAll('.hl-note-marker').forEach(m => m.remove());\n\n  // Apply each highlight\n  for (const hl of articleHighlights) {\n    findAndWrap(content, hl);\n  }\n\n  // Apply inline annotations\n  for (const ann of (articleNotes.annotations || [])) {\n    findAndMarkAnnotation(content, ann);\n  }\n\n  // Render margin notes for highlights with notes and inline annotations\n  renderMarginNotes();\n}\n\nfunction renderMarginNotes() {\n  const marginContainer = document.getElementById('margin-notes');\n  if (!marginContainer) return;\n  marginContainer.innerHTML = '';\n\n  const pane = document.getElementById('content-pane');\n  if (!pane) return;\n  const paneRect = pane.getBoundingClientRect();\n\n  const notes = [];\n\n  // Collect highlight notes\n  for (const hl of articleHighlights) {\n    if (!hl.note) continue;\n    const mark = document.querySelector('mark[data-hl-id=\"' + hl.id + '\"]');\n    if (!mark) continue;\n    const rect = mark.getBoundingClientRect();\n    notes.push({\n      top: rect.top - paneRect.top + pane.scrollTop,\n      anchorText: hl.text.slice(0, 40),\n      body: hl.note,\n      id: hl.id,\n      type: 'highlight'\n    });\n  }\n\n  // Collect inline annotation notes\n  for (const ann of (articleNotes.annotations || [])) {\n    const matchedMarker = document.querySelector('.annotation-marker[data-ann-id=\"' + ann.id + '\"]');\n    if (!matchedMarker) continue;\n    const rect = matchedMarker.getBoundingClientRect();\n    notes.push({\n      top: rect.top - paneRect.top + pane.scrollTop,\n      anchorText: (ann.anchorText || '').slice(0, 40),\n      body: ann.note,\n      id: ann.id,\n      type: 'annotation'\n    });\n  }\n\n  // Sort by position and spread out overlapping notes\n  notes.sort((a, b) => a.top - b.top);\n  let lastBottom = 0;\n  for (const n of notes) {\n    if (n.top < lastBottom + 8) n.top = lastBottom + 8;\n    const div = document.createElement('div');\n    div.className = 'margin-note';\n    div.style.top = n.top + 'px';\n    div.innerHTML = '<div class=\"mn-text\">' + escapeHtml(n.anchorText) + (n.anchorText.length >= 40 ? '...' : '') + '</div>'\n      + '<div class=\"mn-body\">' + escapeHtml(n.body) + '</div>';\n    div.onclick = function() {\n      if (n.type === 'highlight') {\n        editHighlightNote(n.id, { clientX: window.innerWidth / 2, clientY: 200 });\n      } else {\n        const ann = (articleNotes.annotations || []).find(a => a.id === n.id);\n        if (ann) showAnnotationPopover({ clientX: window.innerWidth / 2, clientY: 200 }, ann);\n      }\n    };\n    marginContainer.appendChild(div);\n    lastBottom = n.top + div.offsetHeight;\n  }\n}\n\nfunction findAndWrap(container, hl) {\n  const searchText = hl.text;\n  const fullText = container.textContent || '';\n\n  // Find the best match position using context\n  let targetGlobalIdx = -1;\n  if (hl.contextBefore || hl.contextAfter) {\n    // Try context-anchored search first\n    const ctxBefore = (hl.contextBefore || '').slice(-15);\n    const ctxAfter = (hl.contextAfter || '').slice(0, 15);\n    const needle = ctxBefore + searchText + ctxAfter;\n    const pos = fullText.indexOf(needle);\n    if (pos >= 0) {\n      targetGlobalIdx = pos + ctxBefore.length;\n    }\n  }\n  if (targetGlobalIdx < 0) {\n    targetGlobalIdx = fullText.indexOf(searchText);\n  }\n  if (targetGlobalIdx < 0) return;\n\n  // Walk text nodes to find the one containing our target position\n  const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT);\n  let charCount = 0;\n  let node;\n\n  while (node = walker.nextNode()) {\n    const nodeLen = node.textContent.length;\n    if (charCount + nodeLen > targetGlobalIdx) {\n      const localIdx = targetGlobalIdx - charCount;\n      // Check that the text actually matches at this position\n      if (node.textContent.slice(localIdx, localIdx + searchText.length) !== searchText) break;\n\n      try {\n        const range = document.createRange();\n        range.setStart(node, localIdx);\n        range.setEnd(node, localIdx + searchText.length);\n\n        const mark = document.createElement('mark');\n        mark.className = 'pr-highlight hl-' + hl.color;\n        mark.setAttribute('data-hl-id', hl.id);\n        mark.onclick = function(e) {\n          e.stopPropagation();\n          showHighlightContextMenu(e, hl);\n        };\n\n        range.surroundContents(mark);\n      } catch {\n        // surroundContents can fail if selection spans nodes; skip gracefully\n        return;\n      }\n      return;\n    }\n    charCount += nodeLen;\n  }\n}\n\nfunction findAndMarkAnnotation(container, ann) {\n  if (!ann.anchorText) return;\n  const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT);\n  let node;\n  while (node = walker.nextNode()) {\n    const idx = node.textContent.indexOf(ann.anchorText);\n    if (idx < 0) continue;\n    // Insert a marker after the anchor text\n    const marker = document.createElement('span');\n    marker.className = 'annotation-marker';\n    marker.setAttribute('data-ann-id', ann.id);\n    marker.textContent = 'n';\n    marker.title = ann.note;\n    marker.onclick = function(e) {\n      e.stopPropagation();\n      showAnnotationPopover(e, ann);\n    };\n    const textAfter = node.splitText(idx + ann.anchorText.length);\n    textAfter.parentNode.insertBefore(marker, textAfter);\n    return;\n  }\n}\n\n// Floating highlight toolbar on text selection\nlet hlToolbarEl = null;\n\nfunction removeHlToolbar() {\n  if (hlToolbarEl) {\n    hlToolbarEl.remove();\n    hlToolbarEl = null;\n  }\n  // Only remove annotation popover if not actively focused (user is typing)\n  const popover = document.querySelector('.annotation-popover');\n  if (popover && !popover.contains(document.activeElement)) {\n    popover.remove();\n  }\n}\n\nfunction removeAnnotationPopover() {\n  const existing = document.querySelector('.annotation-popover');\n  if (existing) existing.remove();\n}\n\nfunction showHlToolbar(x, y) {\n  removeHlToolbar();\n  const bar = document.createElement('div');\n  bar.className = 'hl-toolbar';\n  bar.innerHTML = `\n    <button class=\"hl-yellow-btn\" aria-label=\"Highlight yellow\" onclick=\"createHighlight('yellow')\"></button>\n    <button class=\"hl-green-btn\" aria-label=\"Highlight green\" onclick=\"createHighlight('green')\"></button>\n    <button class=\"hl-blue-btn\" aria-label=\"Highlight blue\" onclick=\"createHighlight('blue')\"></button>\n    <button class=\"hl-pink-btn\" aria-label=\"Highlight pink\" onclick=\"createHighlight('pink')\"></button>\n    <button class=\"hl-note-btn\" aria-label=\"Add note\" onclick=\"addInlineNote()\">+ Note</button>\n  `;\n  bar.style.left = x + 'px';\n  bar.style.top = y + 'px';\n  document.getElementById('content-pane').appendChild(bar);\n  hlToolbarEl = bar;\n}\n\nfunction showHighlightContextMenu(e, hl) {\n  removeHlToolbar();\n  const bar = document.createElement('div');\n  bar.className = 'hl-toolbar';\n  const noteLabel = hl.note ? 'Edit Note' : 'Note';\n  bar.innerHTML = `\n    <button class=\"hl-yellow-btn\" aria-label=\"Yellow\" onclick=\"changeHighlightColor('${hl.id}','yellow')\"></button>\n    <button class=\"hl-green-btn\" aria-label=\"Green\" onclick=\"changeHighlightColor('${hl.id}','green')\"></button>\n    <button class=\"hl-blue-btn\" aria-label=\"Blue\" onclick=\"changeHighlightColor('${hl.id}','blue')\"></button>\n    <button class=\"hl-pink-btn\" aria-label=\"Pink\" onclick=\"changeHighlightColor('${hl.id}','pink')\"></button>\n    <button class=\"hl-note-btn\" aria-label=\"${noteLabel}\" onclick=\"editHighlightNote('${hl.id}', event)\">${noteLabel}</button>\n    <button class=\"hl-note-btn\" style=\"color:red;border-color:red\" aria-label=\"Delete highlight\" onclick=\"deleteHighlight('${hl.id}')\">Del</button>\n  `;\n  const pane = document.getElementById('content-pane');\n  bar.style.left = (e.clientX - pane.getBoundingClientRect().left) + 'px';\n  bar.style.top = (e.clientY - pane.getBoundingClientRect().top + pane.scrollTop - 40) + 'px';\n  pane.appendChild(bar);\n  hlToolbarEl = bar;\n}\n\nfunction changeHighlightColor(id, color) {\n  const hl = articleHighlights.find(h => h.id === id);\n  if (hl) {\n    hl.color = color;\n    hl.updatedAt = new Date().toISOString();\n    saveHighlights();\n    applyHighlights();\n  }\n  removeHlToolbar();\n}\n\nfunction editHighlightNote(id, e) {\n  removeHlToolbar();\n  const hl = articleHighlights.find(h => h.id === id);\n  if (!hl) return;\n\n  const pane = document.getElementById('content-pane');\n  const paneRect = pane.getBoundingClientRect();\n  const popover = document.createElement('div');\n  popover.className = 'annotation-popover';\n  popover.style.left = (e.clientX - paneRect.left) + 'px';\n  popover.style.top = (e.clientY - paneRect.top + pane.scrollTop + 10) + 'px';\n  popover.innerHTML = `\n    <div style=\"font-size:12px;color:var(--muted);margin-bottom:6px\">Note on highlight: \"${escapeHtml(hl.text.slice(0, 50))}${hl.text.length > 50 ? '...' : ''}\"</div>\n    <textarea placeholder=\"Add a note to this highlight...\">${escapeHtml(hl.note || '')}</textarea>\n    <div class=\"btn-row\">\n      ${hl.note ? '<button style=\"color:red;border-color:red\" onclick=\"clearHighlightNote(\\'' + id + '\\')\">Remove</button>' : ''}\n      <button onclick=\"removeAnnotationPopover()\">Cancel</button>\n      <button class=\"primary\" onclick=\"saveHighlightNote('${id}', this)\">Save</button>\n    </div>\n  `;\n  popover.onclick = function(ev) { ev.stopPropagation(); };\n  pane.appendChild(popover);\n  popover.querySelector('textarea').focus();\n}\n\nfunction saveHighlightNote(id, btn) {\n  const popover = btn.closest('.annotation-popover');\n  const note = popover.querySelector('textarea').value.trim();\n  const hl = articleHighlights.find(h => h.id === id);\n  if (hl) {\n    hl.note = note;\n    hl.updatedAt = new Date().toISOString();\n    saveHighlights();\n    applyHighlights();\n    renderNotesPanel();\n    renderFileList();\n  }\n  removeAnnotationPopover();\n}\n\nfunction clearHighlightNote(id) {\n  const hl = articleHighlights.find(h => h.id === id);\n  if (hl) {\n    hl.note = '';\n    hl.updatedAt = new Date().toISOString();\n    saveHighlights();\n    applyHighlights();\n    renderNotesPanel();\n    renderFileList();\n  }\n  removeAnnotationPopover();\n}\n\n// Listen for text selection in content pane\ndocument.addEventListener('mouseup', e => {\n  // Don't dismiss anything if clicking inside an annotation popover or margin note\n  if (e.target.closest && e.target.closest('.annotation-popover, .margin-note')) return;\n\n  const contentEl = document.getElementById('content');\n  if (!contentEl || !contentEl.contains(e.target)) {\n    // Don't remove toolbar if clicking on the toolbar itself\n    if (hlToolbarEl && hlToolbarEl.contains(e.target)) return;\n    removeHlToolbar();\n    return;\n  }\n\n  const sel = window.getSelection();\n  if (!sel || sel.isCollapsed || !sel.toString().trim()) return;\n\n  const pane = document.getElementById('content-pane');\n  const range = sel.getRangeAt(0);\n  const rect = range.getBoundingClientRect();\n  const paneRect = pane.getBoundingClientRect();\n\n  const x = rect.left - paneRect.left + rect.width / 2 - 70;\n  const y = rect.top - paneRect.top + pane.scrollTop - 40;\n  showHlToolbar(Math.max(10, x), y);\n});\n\n// Inline annotations\nfunction addInlineNote() {\n  const sel = window.getSelection();\n  if (!sel || sel.isCollapsed || !sel.toString().trim()) return;\n  const anchorText = sel.toString();\n  const pane = document.getElementById('content-pane');\n  const range = sel.getRangeAt(0);\n  const rect = range.getBoundingClientRect();\n  const paneRect = pane.getBoundingClientRect();\n\n  removeHlToolbar();\n\n  const popover = document.createElement('div');\n  popover.className = 'annotation-popover';\n  popover.style.left = (rect.left - paneRect.left) + 'px';\n  popover.style.top = (rect.bottom - paneRect.top + pane.scrollTop + 5) + 'px';\n  popover.innerHTML = `\n    <div style=\"font-size:12px;color:var(--muted);margin-bottom:6px\">Note on: \"${escapeHtml(anchorText.slice(0, 50))}${anchorText.length > 50 ? '...' : ''}\"</div>\n    <textarea placeholder=\"Add your note...\" autofocus></textarea>\n    <div class=\"btn-row\">\n      <button onclick=\"removeAnnotationPopover()\">Cancel</button>\n      <button class=\"primary\" onclick=\"saveInlineNote(this, '${escapeHtml(anchorText.replace(/'/g, \"\\\\'\"))}')\">Save</button>\n    </div>\n  `;\n  popover.onclick = function(e) { e.stopPropagation(); };\n  pane.appendChild(popover);\n  popover.querySelector('textarea').focus();\n  sel.removeAllRanges();\n}\n\nfunction saveInlineNote(btn, anchorText) {\n  const popover = btn.closest('.annotation-popover');\n  const note = popover.querySelector('textarea').value.trim();\n  if (!note) { removeAnnotationPopover(); return; }\n\n  const { contextBefore, contextAfter } = getTextContext(anchorText);\n  const now = new Date().toISOString();\n  const annotation = {\n    id: generateId(),\n    anchorText,\n    contextBefore,\n    contextAfter,\n    note,\n    createdAt: now,\n    updatedAt: now\n  };\n  if (!articleNotes.annotations) articleNotes.annotations = [];\n  articleNotes.annotations.push(annotation);\n  saveNotes();\n  applyHighlights();\n  removeAnnotationPopover();\n  renderFileList();\n}\n\nfunction showAnnotationPopover(e, ann) {\n  removeAnnotationPopover();\n  removeHlToolbar();\n\n  const pane = document.getElementById('content-pane');\n  const paneRect = pane.getBoundingClientRect();\n  const popover = document.createElement('div');\n  popover.className = 'annotation-popover';\n  popover.style.left = (e.clientX - paneRect.left) + 'px';\n  popover.style.top = (e.clientY - paneRect.top + pane.scrollTop + 10) + 'px';\n  popover.innerHTML = `\n    <textarea>${escapeHtml(ann.note)}</textarea>\n    <div class=\"btn-row\">\n      <button style=\"color:red;border-color:red\" onclick=\"deleteAnnotation('${ann.id}')\">Delete</button>\n      <button onclick=\"removeAnnotationPopover()\">Cancel</button>\n      <button class=\"primary\" onclick=\"updateAnnotation('${ann.id}', this)\">Save</button>\n    </div>\n  `;\n  popover.onclick = function(e) { e.stopPropagation(); };\n  pane.appendChild(popover);\n}\n\nfunction deleteAnnotation(id) {\n  articleNotes.annotations = (articleNotes.annotations || []).filter(a => a.id !== id);\n  saveNotes();\n  applyHighlights();\n  removeAnnotationPopover();\n  renderFileList();\n}\n\nfunction updateAnnotation(id, btn) {\n  const popover = btn.closest('.annotation-popover');\n  const note = popover.querySelector('textarea').value.trim();\n  const ann = (articleNotes.annotations || []).find(a => a.id === id);\n  if (ann) {\n    ann.note = note;\n    ann.updatedAt = new Date().toISOString();\n    saveNotes();\n  }\n  removeAnnotationPopover();\n}\n\n// Article-level notes panel\nfunction renderNotesPanel() {\n  // Remove existing panel\n  const existing = document.querySelector('.notes-panel');\n  if (existing) existing.remove();\n\n  const content = document.getElementById('content');\n  if (!content || content.style.display === 'none') return;\n\n  const panel = document.createElement('details');\n  panel.className = 'notes-panel';\n  const noteText = articleNotes.articleNote || '';\n  const annCount = (articleNotes.annotations || []).length;\n  const hlCount = articleHighlights.length;\n  const hlNoteCount = articleHighlights.filter(h => h.note).length;\n\n  let summaryText = 'Notes';\n  const badges = [];\n  if (hlCount) badges.push(hlCount + ' highlight' + (hlCount !== 1 ? 's' : '') + (hlNoteCount ? ' (' + hlNoteCount + ' with notes)' : ''));\n  if (annCount) badges.push(annCount + ' annotation' + (annCount !== 1 ? 's' : ''));\n  if (badges.length) summaryText += ' (' + badges.join(', ') + ')';\n\n  const tags = articleNotes.tags || [];\n  const isFav = articleNotes.isFavorite || false;\n  const tagsHtml = tags.map(t => '<span class=\"tag\">' + escapeHtml(t) + '<span class=\"tag-remove\" onclick=\"removeTag(\\'' + escapeHtml(t.replace(/'/g, \"\\\\'\")) + '\\')\">&times;</span></span>').join('');\n\n  // Build list of highlight notes and inline annotations for display\n  let hlNotesHtml = '';\n  const hlsWithNotes = articleHighlights.filter(h => h.note);\n  const annotations = articleNotes.annotations || [];\n\n  if (hlsWithNotes.length || annotations.length) {\n    hlNotesHtml += '<div style=\"margin-top:12px;font-size:12px\">';\n\n    for (const hl of hlsWithNotes) {\n      const preview = hl.text.length > 60 ? hl.text.slice(0, 60) + '...' : hl.text;\n      hlNotesHtml += '<div style=\"padding:8px 0;border-bottom:1px solid var(--border)\">'\n        + '<div style=\"color:var(--muted);font-size:11px;margin-bottom:3px\">'\n        + '<span class=\"pr-highlight hl-' + hl.color + '\" style=\"padding:1px 4px;border-radius:2px;cursor:pointer\" onclick=\"scrollToHighlight(\\'' + hl.id + '\\')\">' + escapeHtml(preview) + '</span>'\n        + '</div>'\n        + '<div style=\"white-space:pre-wrap;word-break:break-word\">' + escapeHtml(hl.note) + '</div>'\n        + '</div>';\n    }\n\n    for (const ann of annotations) {\n      const preview = (ann.anchorText || '').slice(0, 60);\n      hlNotesHtml += '<div style=\"padding:8px 0;border-bottom:1px solid var(--border)\">'\n        + '<div style=\"color:var(--muted);font-size:11px;margin-bottom:3px\">'\n        + '<span style=\"color:var(--link);cursor:pointer\">' + escapeHtml(preview) + (ann.anchorText && ann.anchorText.length > 60 ? '...' : '') + '</span>'\n        + '</div>'\n        + '<div style=\"white-space:pre-wrap;word-break:break-word\">' + escapeHtml(ann.note) + '</div>'\n        + '</div>';\n    }\n\n    hlNotesHtml += '</div>';\n  }\n\n  panel.innerHTML = `\n    <summary>${summaryText}</summary>\n    <div class=\"favorite-row\">\n      <button class=\"favorite-btn${isFav ? ' active' : ''}\" onclick=\"toggleFavorite(this)\" title=\"Mark as favorite\"><svg class=\"icon\"><use href=\"#i-${isFav ? 'heart' : 'heart-o'}\"/></svg></button>\n      <span style=\"color:var(--muted);font-size:12px\">${isFav ? 'Favorited' : 'Mark favorite'}</span>\n    </div>\n    <div class=\"tags-row\">\n      ${tagsHtml}\n      <input type=\"text\" placeholder=\"Add tag...\" onkeydown=\"handleTagKey(event)\" />\n    </div>\n    <textarea placeholder=\"Add notes about this article...\">${escapeHtml(noteText)}</textarea>\n    <div class=\"notes-save-hint\">Auto-saved</div>\n    ${hlNotesHtml}\n  `;\n\n  if (noteText || isFav || tags.length || hlsWithNotes.length || annotations.length) panel.setAttribute('open', '');\n\n  content.appendChild(panel);\n\n  const textarea = panel.querySelector('textarea');\n  let saveTimeout;\n  textarea.addEventListener('input', () => {\n    clearTimeout(saveTimeout);\n    saveTimeout = setTimeout(() => {\n      articleNotes.articleNote = textarea.value;\n      saveNotes();\n      renderFileList();\n    }, 800);\n  });\n  textarea.addEventListener('blur', () => {\n    articleNotes.articleNote = textarea.value;\n    saveNotes();\n    renderFileList();\n  });\n}\n\nfunction toggleFavorite(btn) {\n  articleNotes.isFavorite = !articleNotes.isFavorite;\n  saveNotes();\n  renderNotesPanel();\n  renderFileList();\n  updateHeaderActions();\n}\n\nfunction toggleFavoriteFromHeader(btn) {\n  articleNotes.isFavorite = !articleNotes.isFavorite;\n  saveNotes();\n  renderNotesPanel();\n  renderFileList();\n  updateHeaderActions();\n}\n\nfunction toggleNotesFromHeader() {\n  const panel = document.querySelector('.notes-panel');\n  if (panel) {\n    panel.toggleAttribute('open');\n    if (panel.hasAttribute('open')) {\n      panel.querySelector('textarea').focus();\n    }\n  }\n}\n\nfunction scrollToHighlight(id) {\n  const mark = document.querySelector('mark[data-hl-id=\"' + id + '\"]');\n  if (mark) {\n    mark.scrollIntoView({ behavior: 'smooth', block: 'center' });\n    mark.style.outline = '2px solid var(--link)';\n    setTimeout(() => { mark.style.outline = ''; }, 1500);\n  }\n}\n\nfunction updateHeaderActions() {\n  const actions = document.querySelector('.article-actions');\n  if (!actions) return;\n  const favBtn = actions.querySelector('button');\n  if (favBtn) {\n    favBtn.className = articleNotes.isFavorite ? 'active-fav' : '';\n    favBtn.innerHTML = '<svg class=\"icon icon-sm\"><use href=\"#i-' + (articleNotes.isFavorite ? 'heart' : 'heart-o') + '\"/></svg> Favorite';\n  }\n}\n\nfunction handleTagKey(e) {\n  if (e.key === 'Enter' || e.key === ',') {\n    e.preventDefault();\n    const tag = e.target.value.trim().replace(/,/g, '');\n    if (!tag) return;\n    if (!articleNotes.tags) articleNotes.tags = [];\n    if (!articleNotes.tags.includes(tag)) {\n      articleNotes.tags.push(tag);\n      saveNotes();\n      renderNotesPanel();\n      renderFileList();\n    }\n    e.target.value = '';\n  }\n}\n\nfunction removeTag(tag) {\n  if (!articleNotes.tags) return;\n  articleNotes.tags = articleNotes.tags.filter(t => t !== tag);\n  saveNotes();\n  renderNotesPanel();\n  renderFileList();\n}\n\n// ---- LLM Summarization ----\n\nlet llmConfigured = false;\nlet llmProvider = '';\nlet llmModel = '';\nlet lastSummaryProvider = '';\nlet lastSummaryModel = '';\n\nasync function checkLLMConfig() {\n  if (!serverMode) return;\n  try {\n    const res = await fetch('/api/settings');\n    if (res.ok) {\n      const data = await res.json();\n      llmConfigured = !!(data.llm && data.llm.hasKey);\n      llmProvider = data.llm?.provider || '';\n      llmModel = data.llm?.model || '';\n    }\n  } catch {}\n}\n\nfunction providerLabel(provider) {\n  const labels = { anthropic: 'Anthropic', openai: 'OpenAI', gemini: 'Gemini', openrouter: 'OpenRouter', apple: 'Apple Intelligence' };\n  return labels[provider] || provider;\n}\n\nasync function summarizeArticle() {\n  if (!serverMode || !activeFile) return;\n  const btn = document.getElementById('summarize-btn');\n  if (!btn) return;\n\n  btn.disabled = true;\n  btn.innerHTML = '<svg class=\"icon icon-sm\"><use href=\"#i-wand\"/></svg> Summarizing...';\n  btn.title = 'Summarizing with ' + providerLabel(llmProvider) + '...';\n\n  try {\n    const res = await fetch('/api/summarize', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ name: activeFile })\n    });\n    const data = await res.json();\n    if (data.error) {\n      btn.innerHTML = '<svg class=\"icon icon-sm\"><use href=\"#i-wand\"/></svg> Retry';\n      btn.disabled = false;\n      btn.title = data.error;\n      // Show error inline under the header\n      const content = document.getElementById('content');\n      const existingError = content.querySelector('.summary-error');\n      if (existingError) existingError.remove();\n      const errDiv = document.createElement('div');\n      errDiv.className = 'summary-error';\n      errDiv.style.cssText = 'padding:8px 12px;margin:8px 0;background:var(--border);border-radius:6px;font-size:12px;color:var(--muted)';\n      errDiv.textContent = data.error;\n      const articleHeader = content.querySelector('.article-header');\n      if (articleHeader) articleHeader.after(errDiv);\n      return;\n    }\n\n    lastSummaryProvider = data.provider || llmProvider;\n    lastSummaryModel = data.model || llmModel;\n\n    // Remove any previous error\n    const content = document.getElementById('content');\n    const existingError = content.querySelector('.summary-error');\n    if (existingError) existingError.remove();\n\n    // Insert summary into the DOM\n    const existingSummary = content.querySelector('.article-summary');\n    if (existingSummary) existingSummary.remove();\n\n    const summaryDiv = document.createElement('div');\n    summaryDiv.className = 'article-summary';\n    summaryDiv.innerHTML = '<div class=\"summary-label\"><span>Summary</span><span class=\"summary-actions\"><button onclick=\"hideSummary()\" title=\"Hide summary\"><svg class=\"icon icon-sm\"><use href=\"#i-xmark\"/></svg></button></span></div>'\n      + escapeHtml(data.summary)\n      + '<div style=\"font-size:10px;color:var(--muted);margin-top:6px\">'\n      + providerLabel(lastSummaryProvider) + ' · ' + escapeHtml(lastSummaryModel)\n      + '</div>';\n\n    const articleHeader = content.querySelector('.article-header');\n    if (articleHeader) {\n      articleHeader.after(summaryDiv);\n    } else {\n      content.prepend(summaryDiv);\n    }\n\n    btn.innerHTML = '<svg class=\"icon icon-sm\"><use href=\"#i-wand\"/></svg> Summarized';\n    btn.title = 'Summarized by ' + providerLabel(lastSummaryProvider) + ' (' + lastSummaryModel + '). Click to re-run.';\n    btn.disabled = false;\n    btn.onclick = function() { btn.onclick = null; summarizeArticle(); };\n  } catch (err) {\n    btn.innerHTML = '<svg class=\"icon icon-sm\"><use href=\"#i-wand\"/></svg> Retry';\n    btn.title = 'Summarization failed. Click to retry.';\n    btn.disabled = false;\n  }\n}\n\nfunction hideSummary() {\n  const content = document.getElementById('content');\n  const summary = content.querySelector('.article-summary');\n  if (summary) summary.remove();\n  // Reset summarize button\n  const btn = document.getElementById('summarize-btn');\n  if (btn) {\n    btn.innerHTML = '<svg class=\"icon icon-sm\"><use href=\"#i-wand\"/></svg> Summarize';\n    btn.title = 'Summarize';\n    btn.disabled = false;\n    btn.onclick = null;\n  }\n}\n\n// Modal focus management\n// ---- Sharing ----\n\nfunction getShareData() {\n  if (!activeFile) return null;\n  const file = allFiles.find(f => f.filename === activeFile);\n  if (!file || !file.url) return null;\n  return { title: file.title || '', url: file.url };\n}\n\nfunction toggleShareDropdown(e) {\n  e.stopPropagation();\n  // Close any existing share dropdown\n  const existing = document.querySelector('.share-dropdown-panel');\n  if (existing) { existing.remove(); return; }\n\n  const data = getShareData();\n  if (!data) return;\n\n  const panel = document.createElement('div');\n  panel.className = 'share-dropdown-panel';\n  panel.onclick = function(ev) { ev.stopPropagation(); };\n\n  const encodedUrl = encodeURIComponent(data.url);\n  const encodedTitle = encodeURIComponent(data.title);\n  const encodedText = encodeURIComponent(data.title + ' ' + data.url);\n\n  panel.innerHTML = `\n    <a href=\"https://bsky.app/intent/compose?text=${encodedText}\" target=\"_blank\" rel=\"noopener\"><span class=\"share-icon\">&#x1f98b;</span> Bluesky</a>\n    <a href=\"https://www.threads.net/intent/post?text=${encodedText}\" target=\"_blank\" rel=\"noopener\"><span class=\"share-icon\">@</span> Threads</a>\n    <a href=\"https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}\" target=\"_blank\" rel=\"noopener\"><span class=\"share-icon\">in</span> LinkedIn</a>\n    <hr>\n    <a href=\"mailto:?subject=${encodedTitle}&body=${encodedText}\" target=\"_blank\"><span class=\"share-icon\">&#9993;</span> Email</a>\n    <a href=\"sms:&body=${encodedText}\"><span class=\"share-icon\">&#128172;</span> Messages</a>\n    <hr>\n    <button onclick=\"copyArticleLink()\"><span class=\"share-icon\">&#128279;</span> Copy Link</button>\n    <button onclick=\"saveArticleLink()\"><span class=\"share-icon\">&#128278;</span> Save to Reading List</button>\n  `;\n\n  e.target.closest('.share-dropdown').appendChild(panel);\n}\n\nfunction copyArticleLink() {\n  const data = getShareData();\n  if (!data) return;\n  navigator.clipboard.writeText(data.url).then(() => {\n    // Brief feedback\n    const existing = document.querySelector('.share-dropdown-panel');\n    if (existing) {\n      const btn = existing.querySelector('button');\n      if (btn) { const orig = btn.innerHTML; btn.innerHTML = '<span class=\"share-icon\">&#10003;</span> Copied!'; setTimeout(() => { btn.innerHTML = orig; }, 1200); }\n    }\n  });\n}\n\nfunction saveArticleLink() {\n  const data = getShareData();\n  if (!data) return;\n  // Use the Web Share API if available (for Safari reading list), otherwise just copy\n  if (navigator.share) {\n    navigator.share({ title: data.title, url: data.url }).catch(() => {});\n  } else {\n    // Fallback: open a bookmarklet-style URL for adding to reading list\n    copyArticleLink();\n  }\n  const existing = document.querySelector('.share-dropdown-panel');\n  if (existing) existing.remove();\n}\n\n// Close share dropdown when clicking outside\ndocument.addEventListener('click', function(e) {\n  const panel = document.querySelector('.share-dropdown-panel');\n  if (panel && !panel.contains(e.target) && !e.target.closest('.share-dropdown')) {\n    panel.remove();\n  }\n});\n\n// Batch auto-tag all articles\nasync function batchAutotagAll() {\n  if (!serverMode) return;\n  const btn = document.getElementById('batch-tag-btn');\n  if (!btn) return;\n  const origText = btn.innerHTML;\n  btn.disabled = true;\n  btn.innerHTML = '<svg class=\"icon icon-sm\" aria-hidden=\"true\" style=\"opacity:0.5;vertical-align:-1px\"><use href=\"#i-wand\"/></svg> Tagging...';\n\n  try {\n    const res = await fetch('/api/autotag-batch', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ force: false })\n    });\n    const data = await res.json();\n    if (data.error) {\n      alert('Auto-tag failed: ' + data.error);\n    } else {\n      btn.innerHTML = '<svg class=\"icon icon-sm\" aria-hidden=\"true\" style=\"opacity:0.5;vertical-align:-1px\"><use href=\"#i-wand\"/></svg> Done!';\n      // Refresh annotations index to pick up new tags\n      await loadAnnotationsIndex();\n      renderFileList();\n      setTimeout(() => { btn.innerHTML = origText; }, 2000);\n    }\n  } catch (err) {\n    alert('Auto-tag request failed.');\n  }\n  btn.disabled = false;\n  if (btn.innerHTML.includes('Tagging')) btn.innerHTML = origText;\n}\n\nlet _modalReturnFocus = null;\n\nfunction trapFocus(overlay) {\n  overlay.addEventListener('keydown', function(e) {\n    if (e.key === 'Escape') { closeModal(); return; }\n    if (e.key !== 'Tab') return;\n    const focusable = overlay.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex=\"-1\"])');\n    if (!focusable.length) return;\n    const first = focusable[0], last = focusable[focusable.length - 1];\n    if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }\n    else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }\n  });\n}\n\n// Shortcuts modal\nfunction showShortcutsModal() {\n  closeModal();\n  _modalReturnFocus = document.activeElement;\n  const overlay = document.createElement('div');\n  overlay.className = 'modal-overlay';\n  overlay.setAttribute('role', 'dialog');\n  overlay.setAttribute('aria-modal', 'true');\n  overlay.setAttribute('aria-label', 'Keyboard shortcuts');\n  overlay.onclick = function(e) { if (e.target === overlay) closeModal(); };\n  overlay.innerHTML = `\n    <div class=\"modal-card\" onclick=\"event.stopPropagation()\">\n      <h2>Keyboard Shortcuts</h2>\n      <div class=\"shortcuts-grid\">\n        <kbd>j</kbd> / <kbd>&rarr;</kbd> <span>Next article</span>\n        <kbd>k</kbd> / <kbd>&larr;</kbd> <span>Previous article</span>\n        <kbd>&uarr;</kbd> <kbd>&darr;</kbd> <span>Scroll (jumps articles at edges)</span>\n        <kbd>/</kbd> <span>Search articles</span>\n        <kbd>[</kbd> <span>Toggle sidebar</span>\n        <kbd>h</kbd> <span>Highlight selected text</span>\n        <kbd>n</kbd> <span>Toggle article notes</span>\n        <kbd>f</kbd> <span>Toggle focus mode</span>\n        <kbd>p</kbd> <span>Print article</span>\n        <kbd>Esc</kbd> <span>Clear search / close popover</span>\n      </div>\n      <button class=\"modal-close\" onclick=\"closeModal()\">Done</button>\n    </div>\n  `;\n  document.body.appendChild(overlay);\n  trapFocus(overlay);\n  overlay.querySelector('.modal-close').focus();\n}\n\n// Guide — renders as an inline article in the content pane\nfunction showGuideModal() {\n  const content = document.getElementById('content');\n  const empty = document.getElementById('empty-state');\n  empty.style.display = 'none';\n  content.style.display = 'block';\n\n  // Deselect sidebar\n  activeFile = null;\n  renderFileList();\n\n  content.innerHTML = `\n    <div class=\"article-header\">\n      <h1>PullRead Guide</h1>\n      <div class=\"article-byline\"><span>Last updated Feb 2026</span></div>\n    </div>\n\n    <h2>What is PullRead?</h2>\n    <p>PullRead syncs your bookmarks and RSS feeds into clean markdown files you can read, search, highlight, and keep forever. Articles are stored locally on your Mac.</p>\n\n    <h2>How does syncing work?</h2>\n    <p>PullRead fetches new items from your configured feeds (Instapaper, Pinboard, Raindrop, RSS, etc.) and extracts the article content into markdown. You can sync manually from the menu bar, or set an automatic interval in Settings (every 30 min, 1 hour, 4 hours, or 12 hours).</p>\n\n    <h2>What are reviews?</h2>\n    <p>Reviews are AI-generated thematic summaries of your recent reading. You can schedule them daily or weekly in Settings. Daily reviews cover the past 24 hours; weekly reviews cover the past 7 days. They require a configured LLM provider (Anthropic, OpenAI, Gemini, OpenRouter, or Apple Intelligence).</p>\n\n    <h2>Highlights &amp; Notes</h2>\n    <p>Select any text and press <strong>h</strong> to highlight it, or use the floating toolbar to choose a color. Click a highlight to add a note. Press <strong>n</strong> to open the notes panel for article-level notes, tags, and favorites.</p>\n\n    <h2>Summaries</h2>\n    <p>Click the Summarize button on any article to generate an AI summary. Summaries are saved in the article frontmatter so they persist across sessions.</p>\n\n    <h2>Focus Mode</h2>\n    <p>Press <strong>f</strong> or click the half-circle icon in the toolbar to enter Focus Mode. This dims all content except the paragraph you're currently reading, helping you concentrate on one section at a time.</p>\n\n    <h2>Reading Progress</h2>\n    <p>A thin progress bar at the top tracks how far you've read. Each article also shows estimated read time and word count in the header. Your reading position is automatically saved so you can pick up where you left off.</p>\n\n    <h2>Table of Contents</h2>\n    <p>On wide screens, articles with 3 or more headings show an auto-generated table of contents on the left. Click any heading to jump to that section. The active section is highlighted as you scroll.</p>\n\n    <h2>Themes &amp; Fonts</h2>\n    <p>Click the gear icon to switch between Light, Dark, Sepia, and High Contrast themes. Choose from 9 fonts including OpenDyslexic. Adjust text size, line height, letter spacing, and content width. Preferences are saved automatically.</p>\n\n    <h2>Sharing</h2>\n    <p>Click the share icon on any article to send it to Bluesky, Threads, LinkedIn, email, Messages, or copy the link. Sharing uses the article's original URL so the recipient gets the source.</p>\n\n    <h2>Machine Tags</h2>\n    <p>PullRead can auto-generate topic, entity, and theme tags for your articles using your configured AI provider. Tags power relational mapping — discover connections between articles through the Explore panel. Use the <strong>Tag All</strong> button in the sidebar or enable auto-tagging after sync in the macOS app settings.</p>\n\n    <h2>Apple News &amp; Social Posts</h2>\n    <p>PullRead resolves Apple News links (apple.news) to their original article URLs before extraction. Social posts from X/Twitter, Bluesky, Mastodon, Reddit, and Hacker News are extracted with special handling to preserve the post structure.</p>\n\n    <h2>Code Highlighting</h2>\n    <p>Technical articles with code blocks are automatically syntax highlighted with language detection. The highlighting theme adapts to your chosen reading theme.</p>\n\n    <h2>Printing</h2>\n    <p>Press <strong>p</strong> or use your browser's print function to get a clean, optimized print layout of any article. Links are expanded with their URLs for reference.</p>\n\n    <h2>Browser Cookies</h2>\n    <p>Enable browser cookies in Settings to access paywalled content from sites like NYTimes or WSJ using your existing login sessions. PullRead supports <strong>Chrome, Arc, Brave, and Edge</strong>. Cookies stay on your Mac and are never uploaded.</p>\n\n    <h2>Why not Safari cookies?</h2>\n    <p>Safari stores cookies in a proprietary binary format and heavily sandboxes access. Unlike Chromium-based browsers which share a common SQLite format, Safari cookies require reverse-engineering Apple's private format. If you use Safari, consider also installing a Chromium browser for sites that need login sessions.</p>\n\n    <h2>Importing Bookmarks</h2>\n    <p>You can import bookmarks.html files exported from Chrome, Safari, Firefox, or Pocket directly from Settings or via the CLI with <code>pullread import &lt;file&gt;</code>.</p>\n\n    <h2>Keyboard Shortcuts</h2>\n    <table>\n      <thead><tr><th>Key</th><th>Action</th></tr></thead>\n      <tbody>\n        <tr><td><kbd>j</kbd> / <kbd>&rarr;</kbd></td><td>Next article</td></tr>\n        <tr><td><kbd>k</kbd> / <kbd>&larr;</kbd></td><td>Previous article</td></tr>\n        <tr><td><kbd>&uarr;</kbd> <kbd>&darr;</kbd></td><td>Scroll (jumps articles at edges)</td></tr>\n        <tr><td><kbd>/</kbd></td><td>Search articles</td></tr>\n        <tr><td><kbd>[</kbd></td><td>Toggle sidebar</td></tr>\n        <tr><td><kbd>h</kbd></td><td>Highlight selected text</td></tr>\n        <tr><td><kbd>n</kbd></td><td>Toggle article notes</td></tr>\n        <tr><td><kbd>f</kbd></td><td>Toggle focus mode</td></tr>\n        <tr><td><kbd>p</kbd></td><td>Print article</td></tr>\n        <tr><td><kbd>Esc</kbd></td><td>Clear search / close popover</td></tr>\n      </tbody>\n    </table>\n  `;\n  document.title = 'PullRead Guide';\n  document.getElementById('content-pane').scrollTop = 0;\n  generateToc();\n}\n\nfunction closeModal() {\n  const overlay = document.querySelector('.modal-overlay');\n  if (overlay) overlay.remove();\n  if (_modalReturnFocus) { _modalReturnFocus.focus(); _modalReturnFocus = null; }\n}\n\n// Keyboard navigation\ndocument.addEventListener('keydown', e => {\n  // \"/\" focuses search\n  if (e.key === '/' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {\n    e.preventDefault();\n    const sidebar = document.getElementById('sidebar');\n    if (sidebar.classList.contains('collapsed')) toggleSidebar();\n    document.getElementById('search').focus();\n    return;\n  }\n\n  // \"[\" toggles sidebar\n  if (e.key === '[' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {\n    e.preventDefault();\n    toggleSidebar();\n    return;\n  }\n\n  // Escape clears search or dismisses popovers\n  if (e.key === 'Escape') {\n    // Close modal overlays (shortcuts, guide)\n    const modal = document.querySelector('.modal-overlay');\n    if (modal) { modal.remove(); return; }\n    // Close settings dropdown\n    const dropdown = document.querySelector('.settings-dropdown-panel');\n    if (dropdown) { dropdown.remove(); return; }\n    // Close highlight toolbar / annotation popover\n    if (hlToolbarEl || document.querySelector('.annotation-popover')) {\n      removeHlToolbar();\n      return;\n    }\n    // Clear and blur search\n    const search = document.getElementById('search');\n    if (document.activeElement === search) {\n      search.value = '';\n      filterFiles();\n      search.blur();\n      return;\n    }\n    // Blur any focused textarea/input\n    if (document.activeElement.tagName === 'TEXTAREA' || document.activeElement.tagName === 'INPUT') {\n      document.activeElement.blur();\n      return;\n    }\n  }\n\n  // h to highlight selection (yellow)\n  if (e.key === 'h' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {\n    const sel = window.getSelection();\n    if (sel && !sel.isCollapsed && sel.toString().trim()) {\n      e.preventDefault();\n      createHighlight('yellow');\n      return;\n    }\n  }\n\n  // f to toggle focus mode\n  if (e.key === 'f' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {\n    e.preventDefault();\n    toggleFocusMode();\n    return;\n  }\n\n  // p to print article\n  if (e.key === 'p' && !e.ctrlKey && !e.metaKey && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {\n    if (activeFile) {\n      e.preventDefault();\n      window.print();\n      return;\n    }\n  }\n\n  // n to toggle notes panel\n  if (e.key === 'n' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {\n    const panel = document.querySelector('.notes-panel');\n    if (panel) {\n      e.preventDefault();\n      panel.toggleAttribute('open');\n      if (panel.hasAttribute('open')) {\n        panel.querySelector('textarea').focus();\n      }\n      return;\n    }\n  }\n\n  // j/k navigate file list (next/prev)\n  if ((e.key === 'j' || e.key === 'k') && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {\n    e.preventDefault();\n    navigateArticle(e.key === 'j' ? 1 : -1);\n    return;\n  }\n\n  // Left/Right arrow navigate prev/next article\n  if ((e.key === 'ArrowLeft' || e.key === 'ArrowRight') && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {\n    e.preventDefault();\n    navigateArticle(e.key === 'ArrowRight' ? 1 : -1);\n    return;\n  }\n\n  // Up/Down scroll the content pane; navigate articles at boundaries\n  if ((e.key === 'ArrowUp' || e.key === 'ArrowDown') && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {\n    const pane = document.getElementById('content-pane');\n    const scrollAmount = 80;\n    const atTop = pane.scrollTop <= 0;\n    const atBottom = pane.scrollTop + pane.clientHeight >= pane.scrollHeight - 2;\n\n    if (e.key === 'ArrowDown' && atBottom) {\n      e.preventDefault();\n      navigateArticle(1);\n    } else if (e.key === 'ArrowUp' && atTop) {\n      e.preventDefault();\n      navigateArticle(-1);\n    } else if (e.key === 'ArrowDown') {\n      pane.scrollTop += scrollAmount;\n    } else {\n      pane.scrollTop -= scrollAmount;\n    }\n    return;\n  }\n\n  // Enter loads current selection (when not in search)\n  if (e.key === 'Enter' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {\n    const currentIdx = displayFiles.findIndex(f => f.filename === activeFile);\n    if (currentIdx >= 0) loadFile(currentIdx);\n  }\n});\n\n// Drag and drop (for standalone use)\ndocument.addEventListener('dragover', e => {\n  e.preventDefault();\n  document.body.classList.add('drop-highlight');\n});\ndocument.addEventListener('dragleave', e => {\n  if (!e.relatedTarget || !document.contains(e.relatedTarget)) {\n    document.body.classList.remove('drop-highlight');\n  }\n});\ndocument.addEventListener('drop', e => {\n  e.preventDefault();\n  document.body.classList.remove('drop-highlight');\n  const files = Array.from(e.dataTransfer.files).filter(f =>\n    f.name.endsWith('.md') || f.name.endsWith('.markdown') || f.name.endsWith('.txt')\n  );\n  if (files.length) {\n    // Add dropped files to the sidebar list\n    const reader = new FileReader();\n    reader.onload = () => {\n      const text = reader.result;\n      const { meta } = parseFrontmatter(text);\n      const file = files[0];\n      // Create a virtual entry\n      const entry = {\n        filename: file.name,\n        title: (meta && meta.title) || file.name.replace(/\\.md$/, ''),\n        url: (meta && meta.url) || '',\n        domain: (meta && meta.domain) || '',\n        bookmarked: (meta && meta.bookmarked) || '',\n        feed: (meta && meta.feed) || '',\n        _content: text\n      };\n      allFiles.unshift(entry);\n      filterFiles();\n      activeFile = entry.filename;\n      renderFileList();\n      renderArticle(text, file.name);\n    };\n    reader.readAsText(files[0]);\n  }\n});\n\n// Infinite scroll for file list pagination\ndocument.getElementById('file-list').addEventListener('scroll', function() {\n  const list = this;\n  if (list.scrollTop + list.clientHeight >= list.scrollHeight - 100) {\n    if (displayedCount < displayFiles.length) {\n      const nextBatch = displayFiles.slice(displayedCount, displayedCount + PAGE_SIZE);\n      displayedCount += nextBatch.length;\n      list.insertAdjacentHTML('beforeend', nextBatch.map((f, i) => renderFileItem(f, displayedCount - nextBatch.length + i)).join(''));\n    }\n  }\n});\n\n// Onboarding overlay\nfunction dismissOnboarding(e) {\n  if (e && e.target && e.target.id !== 'onboarding' && e.target.className !== 'onboarding-dismiss') return;\n  document.getElementById('onboarding').style.display = 'none';\n  localStorage.setItem('pr-onboarded', '1');\n}\n\nfunction showOnboardingIfNeeded() {\n  if (!localStorage.getItem('pr-onboarded')) {\n    document.getElementById('onboarding').style.display = 'flex';\n  }\n}\n\n// ---- Tag Cloud / Explore ----\nfunction showTagCloud() {\n  closeModal();\n  _modalReturnFocus = document.activeElement;\n  const overlay = document.createElement('div');\n  overlay.className = 'modal-overlay';\n  overlay.setAttribute('role', 'dialog');\n  overlay.setAttribute('aria-modal', 'true');\n  overlay.setAttribute('aria-label', 'Explore articles');\n  overlay.onclick = function(e) { if (e.target === overlay) closeModal(); };\n\n  // Collect all tags and domain groupings\n  const tagCounts = {};\n  const domainArticles = {};\n  const feedCounts = {};\n\n  for (const f of allFiles) {\n    // Domain grouping\n    if (f.domain && f.domain !== 'pullread') {\n      if (!domainArticles[f.domain]) domainArticles[f.domain] = [];\n      domainArticles[f.domain].push(f);\n    }\n    // Feed grouping\n    if (f.feed) {\n      feedCounts[f.feed] = (feedCounts[f.feed] || 0) + 1;\n    }\n    // User tags\n    const notes = allNotesIndex[f.filename];\n    if (notes && notes.tags) {\n      for (const tag of notes.tags) {\n        tagCounts[tag] = (tagCounts[tag] || 0) + 1;\n      }\n    }\n  }\n\n  // Sort domains by count\n  const sortedDomains = Object.entries(domainArticles)\n    .sort((a, b) => b[1].length - a[1].length)\n    .slice(0, 30);\n\n  // Sort tags by count\n  const sortedTags = Object.entries(tagCounts)\n    .sort((a, b) => b[1] - a[1]);\n\n  let tagsHtml = '';\n  if (sortedTags.length > 0) {\n    tagsHtml = '<h3>Tags</h3><div class=\"tag-cloud\">';\n    const maxCount = sortedTags[0][1];\n    for (const [tag, count] of sortedTags) {\n      const size = Math.max(11, Math.min(20, 11 + (count / maxCount) * 9));\n      tagsHtml += '<span class=\"tag-cloud-item\" style=\"font-size:' + size + 'px\" onclick=\"closeModal();document.getElementById(\\'search\\').value=\\'' + escapeHtml(tag) + '\\';filterFiles()\">' + escapeHtml(tag) + ' <span style=\"opacity:0.5;font-size:10px\">' + count + '</span></span>';\n    }\n    tagsHtml += '</div>';\n  }\n\n  let domainsHtml = '<h3>Sources <span style=\"font-weight:400;color:var(--muted);font-size:12px\">(' + Object.keys(domainArticles).length + ' sites)</span></h3>';\n  for (const [domain, articles] of sortedDomains) {\n    domainsHtml += '<div class=\"domain-group\">';\n    domainsHtml += '<div class=\"domain-group-header\" onclick=\"this.nextElementSibling.style.display=this.nextElementSibling.style.display===\\'none\\'?\\'block\\':\\'none\\'\">';\n    domainsHtml += '<img class=\"file-item-favicon\" src=\"https://www.google.com/s2/favicons?domain=' + encodeURIComponent(domain) + '&sz=32\" alt=\"\" loading=\"lazy\" onerror=\"this.style.display=\\'none\\'\">';\n    domainsHtml += escapeHtml(domain) + ' <span class=\"domain-group-count\">' + articles.length + ' article' + (articles.length !== 1 ? 's' : '') + '</span></div>';\n    domainsHtml += '<div class=\"domain-group-articles\" style=\"display:none\">';\n    for (const a of articles.slice(0, 10)) {\n      domainsHtml += '<a href=\"#\" onclick=\"event.preventDefault();closeModal();jumpToArticle(\\'' + escapeHtml(a.filename.replace(/'/g, \"\\\\'\")) + '\\')\">' + escapeHtml(a.title) + '</a>';\n    }\n    if (articles.length > 10) {\n      domainsHtml += '<span style=\"font-size:11px;color:var(--muted)\">+ ' + (articles.length - 10) + ' more</span>';\n    }\n    domainsHtml += '</div></div>';\n  }\n\n  // Stats\n  const totalArticles = allFiles.length;\n  const totalHighlights = Object.values(allHighlightsIndex).reduce((s, h) => s + (h ? h.length : 0), 0);\n  const totalFavorites = Object.values(allNotesIndex).filter(n => n && n.isFavorite).length;\n\n  let statsHtml = '<div style=\"display:flex;gap:20px;margin:12px 0;font-size:13px;color:var(--muted)\">';\n  statsHtml += '<span><strong style=\"color:var(--fg)\">' + totalArticles + '</strong> articles</span>';\n  statsHtml += '<span><strong style=\"color:var(--fg)\">' + totalHighlights + '</strong> highlights</span>';\n  statsHtml += '<span><strong style=\"color:var(--fg)\">' + totalFavorites + '</strong> favorites</span>';\n  statsHtml += '<span><strong style=\"color:var(--fg)\">' + Object.keys(domainArticles).length + '</strong> sources</span>';\n  statsHtml += '</div>';\n\n  overlay.innerHTML = `\n    <div class=\"modal-card\" style=\"max-width:560px;max-height:80vh;overflow-y:auto\" onclick=\"event.stopPropagation()\">\n      <h2>Explore Your Library</h2>\n      ${statsHtml}\n      ${tagsHtml}\n      ${domainsHtml}\n      <button class=\"modal-close\" onclick=\"closeModal()\">Done</button>\n    </div>\n  `;\n  document.body.appendChild(overlay);\n  trapFocus(overlay);\n  overlay.querySelector('.modal-close').focus();\n}\n\nfunction jumpToArticle(filename) {\n  const idx = displayFiles.findIndex(f => f.filename === filename);\n  if (idx >= 0) {\n    loadFile(idx);\n  } else {\n    // File might be hidden - clear filters\n    document.getElementById('search').value = '';\n    hideRead = false;\n    document.getElementById('hide-read-toggle').checked = false;\n    filterFiles();\n    const newIdx = displayFiles.findIndex(f => f.filename === filename);\n    if (newIdx >= 0) loadFile(newIdx);\n  }\n}\n\n// ---- Reading Progress Bar ----\nfunction updateReadingProgress() {\n  const pane = document.getElementById('content-pane');\n  const bar = document.getElementById('reading-progress-bar');\n  if (!pane || !bar) return;\n  const scrollTop = pane.scrollTop;\n  const scrollHeight = pane.scrollHeight - pane.clientHeight;\n  const progress = scrollHeight > 0 ? (scrollTop / scrollHeight) * 100 : 0;\n  bar.style.width = Math.min(100, Math.max(0, progress)) + '%';\n}\n\ndocument.getElementById('content-pane').addEventListener('scroll', function() {\n  updateReadingProgress();\n  updateFocusMode();\n  updateTocActive();\n  saveScrollPosition();\n});\n\n// ---- Read Time & Word Count ----\nfunction calculateReadStats(text) {\n  const words = text.trim().split(/\\s+/).filter(w => w.length > 0).length;\n  const wpm = 238; // average adult reading speed\n  const minutes = Math.ceil(words / wpm);\n  return { words, minutes };\n}\n\nfunction formatReadStats(words, minutes) {\n  const wordStr = words >= 1000 ? (words / 1000).toFixed(1) + 'k' : words.toString();\n  return '<span class=\"read-stats\">' + minutes + ' min read<span class=\"stat-divider\">&middot;</span>' + wordStr + ' words</span>';\n}\n\n// ---- Focus Mode ----\nlet focusModeActive = false;\nlet focusObserver = null;\n\nfunction toggleFocusMode() {\n  focusModeActive = !focusModeActive;\n  document.body.classList.toggle('focus-mode', focusModeActive);\n  document.getElementById('focus-btn').classList.toggle('active', focusModeActive);\n  localStorage.setItem('pr-focus', focusModeActive ? '1' : '0');\n  if (focusModeActive) {\n    updateFocusMode();\n  } else {\n    clearFocusClasses();\n  }\n}\n\nfunction clearFocusClasses() {\n  document.querySelectorAll('.focus-active, .focus-adjacent').forEach(el => {\n    el.classList.remove('focus-active', 'focus-adjacent');\n  });\n}\n\nfunction updateFocusMode() {\n  if (!focusModeActive) return;\n  const content = document.getElementById('content');\n  if (!content || content.style.display === 'none') return;\n\n  const pane = document.getElementById('content-pane');\n  const paneRect = pane.getBoundingClientRect();\n  const centerY = paneRect.top + paneRect.height * 0.4;\n\n  const blocks = content.querySelectorAll(':scope > p, :scope > blockquote, :scope > ul, :scope > ol, :scope > pre, :scope > h2, :scope > h3, :scope > h4, :scope > table');\n\n  clearFocusClasses();\n\n  let closest = null;\n  let closestDist = Infinity;\n\n  blocks.forEach(block => {\n    const rect = block.getBoundingClientRect();\n    const blockCenter = rect.top + rect.height / 2;\n    const dist = Math.abs(blockCenter - centerY);\n    if (dist < closestDist) {\n      closestDist = dist;\n      closest = block;\n    }\n  });\n\n  if (closest) {\n    closest.classList.add('focus-active');\n    // Also highlight immediate siblings for context\n    if (closest.previousElementSibling && !closest.previousElementSibling.classList.contains('article-header')) {\n      closest.previousElementSibling.classList.add('focus-adjacent');\n    }\n    if (closest.nextElementSibling && !closest.nextElementSibling.classList.contains('notes-panel')) {\n      closest.nextElementSibling.classList.add('focus-adjacent');\n    }\n  }\n}\n\n// ---- Code Syntax Highlighting ----\nfunction applySyntaxHighlighting() {\n  if (typeof hljs === 'undefined') return;\n  const content = document.getElementById('content');\n  if (!content) return;\n\n  // Update highlight.js theme based on current app theme\n  updateHljsTheme();\n\n  content.querySelectorAll('pre code').forEach(block => {\n    // Skip if already highlighted\n    if (block.classList.contains('hljs')) return;\n    hljs.highlightElement(block);\n\n    // Add language label if detected\n    const lang = block.className.match(/language-(\\w+)/);\n    const detected = block.result && block.result.language;\n    const langName = (lang && lang[1]) || detected;\n    if (langName && langName !== 'undefined') {\n      const label = document.createElement('span');\n      label.className = 'code-lang-label';\n      label.textContent = langName;\n      block.closest('pre').appendChild(label);\n    }\n  });\n}\n\nfunction updateHljsTheme() {\n  const theme = document.body.getAttribute('data-theme');\n  const lightSheet = document.getElementById('hljs-light');\n  const darkSheet = document.getElementById('hljs-dark');\n  if (!lightSheet || !darkSheet) return;\n\n  if (theme === 'dark' || theme === 'high-contrast') {\n    lightSheet.media = 'not all';\n    darkSheet.media = 'all';\n  } else {\n    lightSheet.media = 'all';\n    darkSheet.media = 'not all';\n  }\n}\n\n// ---- Reading Position Memory ----\nlet scrollSaveTimeout = null;\n\nfunction saveScrollPosition() {\n  if (!activeFile) return;\n  clearTimeout(scrollSaveTimeout);\n  scrollSaveTimeout = setTimeout(() => {\n    const pane = document.getElementById('content-pane');\n    if (!pane) return;\n    const scrollHeight = pane.scrollHeight - pane.clientHeight;\n    if (scrollHeight <= 0) return;\n    const pct = pane.scrollTop / scrollHeight;\n    const positions = JSON.parse(localStorage.getItem('pr-scroll-positions') || '{}');\n    positions[activeFile] = { pct, ts: Date.now() };\n    // Keep only last 100 positions\n    const keys = Object.keys(positions);\n    if (keys.length > 100) {\n      const sorted = keys.sort((a, b) => positions[a].ts - positions[b].ts);\n      sorted.slice(0, keys.length - 100).forEach(k => delete positions[k]);\n    }\n    localStorage.setItem('pr-scroll-positions', JSON.stringify(positions));\n  }, 500);\n}\n\nfunction restoreScrollPosition(filename) {\n  const positions = JSON.parse(localStorage.getItem('pr-scroll-positions') || '{}');\n  const saved = positions[filename];\n  if (!saved || saved.pct < 0.02) return; // Don't restore if near the top\n\n  const pane = document.getElementById('content-pane');\n  if (!pane) return;\n\n  // Show a \"resume\" indicator\n  const indicator = document.createElement('div');\n  indicator.className = 'resume-indicator';\n  indicator.textContent = 'Resume reading \\u2193';\n  indicator.setAttribute('role', 'button');\n  indicator.setAttribute('aria-label', 'Resume reading from where you left off');\n  indicator.onclick = function() {\n    const scrollHeight = pane.scrollHeight - pane.clientHeight;\n    pane.scrollTo({ top: saved.pct * scrollHeight, behavior: 'smooth' });\n    indicator.remove();\n  };\n  document.body.appendChild(indicator);\n\n  // Auto-dismiss after 5 seconds\n  setTimeout(() => { if (indicator.parentNode) indicator.remove(); }, 5000);\n}\n\n// ---- Table of Contents ----\nfunction generateToc() {\n  const content = document.getElementById('content');\n  const tocContainer = document.getElementById('toc-container');\n  if (!content || !tocContainer) return;\n\n  const headings = content.querySelectorAll('h2, h3');\n  tocContainer.innerHTML = '';\n\n  if (headings.length < 3) return; // Only show TOC for articles with 3+ headings\n\n  const panel = document.createElement('div');\n  panel.className = 'toc-panel';\n\n  const label = document.createElement('div');\n  label.className = 'toc-label';\n  label.textContent = 'Contents';\n  panel.appendChild(label);\n\n  const list = document.createElement('ul');\n  list.className = 'toc-list';\n\n  headings.forEach((heading, i) => {\n    // Skip headings inside article-header\n    if (heading.closest('.article-header')) return;\n\n    const id = 'toc-heading-' + i;\n    heading.id = id;\n\n    const li = document.createElement('li');\n    const a = document.createElement('a');\n    a.href = '#' + id;\n    a.textContent = heading.textContent;\n    a.setAttribute('data-toc-target', id);\n    if (heading.tagName === 'H3') a.classList.add('toc-h3');\n\n    a.onclick = function(e) {\n      e.preventDefault();\n      heading.scrollIntoView({ behavior: 'smooth', block: 'start' });\n    };\n\n    li.appendChild(a);\n    list.appendChild(li);\n  });\n\n  panel.appendChild(list);\n  tocContainer.appendChild(panel);\n}\n\nfunction updateTocActive() {\n  const tocLinks = document.querySelectorAll('.toc-list a');\n  if (!tocLinks.length) return;\n\n  const pane = document.getElementById('content-pane');\n  const paneRect = pane.getBoundingClientRect();\n  const threshold = paneRect.top + 80;\n\n  let activeId = null;\n  const headings = document.querySelectorAll('#content h2[id], #content h3[id]');\n\n  headings.forEach(heading => {\n    if (heading.getBoundingClientRect().top <= threshold) {\n      activeId = heading.id;\n    }\n  });\n\n  tocLinks.forEach(link => {\n    link.classList.toggle('toc-active', link.getAttribute('data-toc-target') === activeId);\n  });\n}\n\n// ---- Sync Status ----\nasync function loadSyncStatus() {\n  if (!serverMode) return;\n  try {\n    const res = await fetch('/api/sync-status');\n    if (!res.ok) return;\n    const data = await res.json();\n    const countEl = document.getElementById('file-count-text');\n    if (countEl && data.intervalMinutes) {\n      const nextSync = data.intervalMinutes + ' min';\n      countEl.title = 'Sync every ' + nextSync;\n    }\n  } catch {}\n}\n\n// ---- One-Time Migration: frontmatter annotations to JSON ----\nasync function migrateAnnotationsIfNeeded() {\n  if (!serverMode) return;\n  if (localStorage.getItem('pr-migration-v1-done')) return;\n\n  // Check each article's frontmatter for old-style annotation field\n  let migrated = 0;\n  for (const file of allFiles) {\n    try {\n      const res = await fetch('/api/file?name=' + encodeURIComponent(file.filename));\n      if (!res.ok) continue;\n      const text = await res.text();\n      const match = text.match(/^---\\n([\\s\\S]*?)\\n---/);\n      if (!match) continue;\n\n      const frontmatter = match[1];\n      const annotationMatch = frontmatter.match(/^annotation:\\s*\"?(.*?)\"?\\s*$/m);\n      if (!annotationMatch || !annotationMatch[1]) continue;\n\n      // Found old-style annotation - migrate to JSON notes\n      const existingNotes = allNotesIndex[file.filename] || {};\n      if (existingNotes.articleNote) continue; // Already has notes, skip\n\n      await fetch('/api/notes', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          name: file.filename,\n          articleNote: annotationMatch[1],\n          annotations: existingNotes.annotations || [],\n          tags: existingNotes.tags || [],\n          isFavorite: existingNotes.isFavorite || false\n        })\n      });\n      migrated++;\n    } catch { continue; }\n  }\n\n  localStorage.setItem('pr-migration-v1-done', '1');\n  if (migrated > 0) {\n    console.log('Migrated ' + migrated + ' article annotations from frontmatter to JSON');\n    await loadAnnotationsIndex(); // Refresh\n    renderFileList();\n  }\n}\n\n// Refresh article list from server\nasync function refreshArticleList() {\n  if (!serverMode) return;\n  const btn = document.getElementById('refresh-btn');\n  btn.classList.add('spinning');\n  try {\n    const res = await fetch('/api/files');\n    if (res.ok) {\n      allFiles = await res.json();\n      filteredFiles = allFiles;\n      await loadAnnotationsIndex();\n      filterFiles();\n      // Reload current article if still in list\n      if (activeFile) {\n        const idx = displayFiles.findIndex(f => f.filename === activeFile);\n        if (idx >= 0) loadFile(idx);\n      }\n    }\n  } catch {}\n  btn.classList.remove('spinning');\n}\n\n// Init: try to load from server, fall back to standalone mode\nasync function init() {\n  // Restore preferences\n  const savedTheme = localStorage.getItem('pr-theme');\n  const savedFont = localStorage.getItem('pr-font');\n  const savedSize = localStorage.getItem('pr-size');\n  const savedSidebar = localStorage.getItem('pr-sidebar');\n  const savedLeading = localStorage.getItem('pr-leading');\n  const savedSpacing = localStorage.getItem('pr-spacing');\n  const savedWidth = localStorage.getItem('pr-width');\n\n  // Auto-detect OS dark mode on first visit\n  if (savedTheme) {\n    setTheme(savedTheme);\n  } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {\n    setTheme('dark');\n  }\n  if (savedFont) {\n    setFont(savedFont);\n  }\n  if (savedSize) setSize(savedSize);\n  if (savedLeading && savedLeading !== 'default') setLineHeight(savedLeading);\n  if (savedSpacing && savedSpacing !== 'default') setSpacing(savedSpacing);\n  if (savedWidth && savedWidth !== 'default') setWidth(savedWidth);\n  if (savedSidebar === '0' || window.innerWidth <= 768) {\n    document.getElementById('sidebar').classList.add('collapsed');\n    document.getElementById('sidebar-toggle-btn').setAttribute('aria-expanded', 'false');\n  }\n\n  // Restore focus mode\n  if (localStorage.getItem('pr-focus') === '1') {\n    focusModeActive = true;\n    document.body.classList.add('focus-mode');\n    document.getElementById('focus-btn').classList.add('active');\n  }\n\n  // Restore hide-read\n  hideRead = localStorage.getItem('pr-hide-read') === '1';\n  document.getElementById('hide-read-toggle').checked = hideRead;\n\n  try {\n    const res = await fetch('/api/files');\n    if (res.ok) {\n      allFiles = await res.json();\n      serverMode = true;\n      filteredFiles = allFiles;\n\n      // Load annotations index and LLM config\n      await Promise.all([loadAnnotationsIndex(), checkLLMConfig()]);\n\n      renderFileList();\n\n      // Run one-time migration and load sync status in background\n      migrateAnnotationsIfNeeded();\n      loadSyncStatus();\n\n      // Auto-load first article\n      if (allFiles.length > 0) {\n        loadFile(0);\n      }\n      showOnboardingIfNeeded();\n      return;\n    }\n  } catch {}\n\n  // Standalone mode - show drop hint\n  filteredFiles = [];\n  renderFileList();\n  document.getElementById('file-count').textContent = 'Drop files or use pullread view';\n}\n\ninit();\n</script>\n</body>\n</html>\n";
