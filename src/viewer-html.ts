// Auto-generated by scripts/embed-viewer.ts — do not edit
// Source: viewer.html + viewer.css + viewer/*.js
export const VIEWER_HTML = "<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n<meta charset=\"UTF-8\">\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n<title>PullRead</title>\n<link rel=\"manifest\" href=\"/manifest.json\">\n<meta name=\"mobile-web-app-capable\" content=\"yes\">\n<meta name=\"apple-mobile-web-app-status-bar-style\" content=\"default\">\n<meta name=\"apple-mobile-web-app-title\" content=\"PullRead\">\n<link rel=\"apple-touch-icon\" href=\"/icon-256.png\">\n<link rel=\"icon\" type=\"image/png\" sizes=\"256x256\" href=\"/icon-256.png\">\n<script src=\"https://cdn.jsdelivr.net/npm/marked/marked.min.js\"></script>\n<link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11/build/styles/github.min.css\" media=\"(prefers-color-scheme: light)\" id=\"hljs-light\">\n<link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11/build/styles/github-dark.min.css\" media=\"(prefers-color-scheme: dark)\" id=\"hljs-dark\">\n<script src=\"https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11/build/highlight.min.js\"></script>\n<script src=\"https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js\"></script>\n<script src=\"https://cdn.jsdelivr.net/npm/dompurify@3/dist/purify.min.js\"></script>\n<link rel=\"preconnect\" href=\"https://fonts.googleapis.com\">\n<link rel=\"preconnect\" href=\"https://fonts.gstatic.com\" crossorigin>\n<link href=\"https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Literata:ital,wght@0,400;0,700;1,400&family=Lora:ital,wght@0,400;0,700;1,400&family=Source+Serif+4:ital,wght@0,400;0,700;1,400&family=Work+Sans:ital,wght@0,400;0,500;0,600;0,700;1,400&display=swap\" rel=\"stylesheet\">\n<link href=\"https://fonts.cdnfonts.com/css/opendyslexic\" rel=\"stylesheet\">\n<style>\n  :root {\n    --bg: #ffffff;\n    --fg: #1a1a1a;\n    --muted: #666666;\n    --border: #e0e0e0;\n    --code-bg: #f5f5f5;\n    --link: #1a6daa;\n    --toolbar-bg: #fafafa;\n    --sidebar-bg: #f7f7f7;\n    --sidebar-hover: #eeeeee;\n    --sidebar-active: #e4e4e4;\n  }\n  [data-theme=\"dark\"] {\n    --bg: #1a1a1a;\n    --fg: #e0e0e0;\n    --muted: #999999;\n    --border: #333333;\n    --code-bg: #2a2a2a;\n    --link: #6db3e8;\n    --toolbar-bg: #222222;\n    --sidebar-bg: #1e1e1e;\n    --sidebar-hover: #2a2a2a;\n    --sidebar-active: #333333;\n  }\n  [data-theme=\"sepia\"] {\n    --bg: #f4ecd8;\n    --fg: #433422;\n    --muted: #7a6a52;\n    --border: #d4c9b0;\n    --code-bg: #ebe3cf;\n    --link: #6b4226;\n    --toolbar-bg: #efe6d0;\n    --sidebar-bg: #ede4cd;\n    --sidebar-hover: #e5dbc2;\n    --sidebar-active: #ddd1b6;\n  }\n  [data-theme=\"high-contrast\"] {\n    --bg: #000000;\n    --fg: #ffffff;\n    --muted: #cccccc;\n    --border: #666666;\n    --code-bg: #1a1a1a;\n    --link: #6ec6ff;\n    --toolbar-bg: #111111;\n    --sidebar-bg: #0a0a0a;\n    --sidebar-hover: #1a1a1a;\n    --sidebar-active: #2a2a2a;\n  }\n\n  * { box-sizing: border-box; margin: 0; padding: 0; }\n\n  .skip-link {\n    position: absolute;\n    top: -100%;\n    left: 8px;\n    padding: 8px 16px;\n    background: var(--fg);\n    color: var(--bg);\n    border-radius: 0 0 6px 6px;\n    z-index: 200;\n    font-size: 14px;\n    font-weight: 600;\n    text-decoration: none;\n  }\n  .skip-link:focus {\n    top: 0;\n  }\n\n  .sr-only {\n    position: absolute;\n    width: 1px;\n    height: 1px;\n    padding: 0;\n    margin: -1px;\n    overflow: hidden;\n    clip: rect(0, 0, 0, 0);\n    white-space: nowrap;\n    border: 0;\n  }\n\n  body {\n    background: var(--bg);\n    color: var(--fg);\n    transition: background 0.2s, color 0.2s;\n    font-family: \"Work Sans\", -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n    height: 100vh;\n    overflow: hidden;\n  }\n\n  /* Layout */\n  .app {\n    display: flex;\n    height: 100vh;\n    flex-direction: column;\n  }\n\n  .brand {\n    font-family: \"Work Sans\", -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n    font-weight: 600;\n    font-size: 14px;\n    color: var(--fg);\n    cursor: pointer;\n    letter-spacing: -0.01em;\n  }\n\n  .sidebar-toggle {\n    background: none !important;\n    border: none !important;\n    font-size: 18px !important;\n    padding: 2px 6px !important;\n    color: var(--fg) !important;\n    cursor: pointer;\n  }\n  .sidebar-toggle:hover {\n    color: var(--link) !important;\n  }\n\n  /* Share dropdown */\n  .share-dropdown {\n    position: relative;\n    display: inline-block;\n  }\n  .share-dropdown-panel {\n    position: absolute;\n    top: calc(100% + 4px);\n    right: 0;\n    width: 220px;\n    background: var(--bg);\n    border: 1px solid var(--border);\n    border-radius: 10px;\n    box-shadow: 0 8px 30px rgba(0,0,0,0.12), 0 2px 8px rgba(0,0,0,0.06);\n    padding: 4px;\n    z-index: 55;\n    animation: fadeIn 0.12s ease;\n    font-size: 13px;\n  }\n  .share-dropdown-panel .share-group-label {\n    font-size: 10px;\n    font-weight: 600;\n    text-transform: uppercase;\n    letter-spacing: 0.5px;\n    color: var(--muted);\n    padding: 4px 10px 1px;\n    opacity: 0.7;\n  }\n  .share-dropdown-panel a,\n  .share-dropdown-panel button {\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    width: 100%;\n    padding: 4px 10px;\n    border: none;\n    background: none;\n    color: var(--fg);\n    font-size: 13px;\n    text-decoration: none;\n    border-radius: 6px;\n    cursor: pointer;\n    text-align: left;\n    transition: background 0.1s;\n    line-height: 1.3;\n  }\n  .share-dropdown-panel a:hover,\n  .share-dropdown-panel button:hover {\n    background: var(--sidebar-hover);\n  }\n  .share-dropdown-panel .share-icon {\n    width: 14px;\n    height: 14px;\n    flex-shrink: 0;\n    opacity: 0.6;\n    fill: currentColor;\n    display: inline-block;\n    vertical-align: middle;\n  }\n  .share-dropdown-panel hr {\n    border: none;\n    border-top: 1px solid var(--border);\n    margin: 4px 0;\n  }\n\n  .toolbar-icon-btn {\n    background: none !important;\n    border: 1px solid transparent !important;\n    font-size: 15px !important;\n    padding: 2px 6px !important;\n    color: var(--muted) !important;\n    cursor: pointer;\n  }\n  .toolbar-icon-btn:hover { color: var(--fg) !important; }\n  .toolbar-icon-btn.spinning svg { animation: spin 0.8s linear infinite; }\n  svg.spin, .spin { animation: spin 0.8s linear infinite; }\n  @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }\n\n  /* Settings dropdown panel */\n  .settings-dropdown-panel {\n    position: fixed;\n    top: 48px;\n    right: 10px;\n    width: 260px;\n    background: var(--bg);\n    border: 1px solid var(--border);\n    border-radius: 8px;\n    box-shadow: 0 8px 24px rgba(0,0,0,0.12);\n    padding: 12px;\n    z-index: 55;\n    animation: fadeIn 0.12s ease;\n    font-size: 12px;\n  }\n  .settings-dropdown-panel label {\n    display: block;\n    font-size: 10px;\n    text-transform: uppercase;\n    letter-spacing: 0.5px;\n    color: var(--muted);\n    margin-bottom: 4px;\n    margin-top: 10px;\n  }\n  .settings-dropdown-panel label:first-child { margin-top: 0; }\n  .settings-dropdown-panel .setting-row {\n    display: flex;\n    gap: 4px;\n    align-items: center;\n  }\n  .settings-dropdown-panel button {\n    background: var(--bg);\n    color: var(--fg);\n    border: 1px solid var(--border);\n    border-radius: 4px;\n    padding: 3px 8px;\n    font-size: 12px;\n    cursor: pointer;\n  }\n  .settings-dropdown-panel button:hover { border-color: var(--muted); }\n  .settings-dropdown-panel button.active {\n    background: var(--fg);\n    color: var(--bg);\n    border-color: var(--fg);\n  }\n  .settings-dropdown-panel select {\n    flex: 1;\n    padding: 4px 6px;\n    border: 1px solid var(--border);\n    border-radius: 4px;\n    background: var(--bg);\n    color: var(--fg);\n    font-size: 12px;\n  }\n  .settings-dropdown-panel hr {\n    border: none;\n    border-top: 1px solid var(--border);\n    margin: 10px 0;\n  }\n\n  /* Main area */\n  .main {\n    flex: 1;\n    display: flex;\n    overflow: hidden;\n    position: relative;\n  }\n\n  /* Sidebar */\n  .sidebar {\n    width: 300px;\n    min-width: 300px;\n    background: var(--sidebar-bg);\n    border-right: 1px solid color-mix(in srgb, var(--border) 60%, transparent);\n    display: flex;\n    flex-direction: column;\n    transition: margin-left 0.2s ease, opacity 0.2s ease;\n    overflow: visible;\n  }\n  .sidebar.collapsed {\n    margin-left: -300px;\n    opacity: 0;\n    pointer-events: none;\n    overflow: hidden;\n  }\n\n  /* Sidebar header (replaces full-width toolbar) */\n  .sidebar-header {\n    display: flex;\n    align-items: center;\n    padding: 10px 12px;\n    gap: 8px;\n    flex-shrink: 0;\n    border-bottom: 1px solid color-mix(in srgb, var(--border) 50%, transparent);\n  }\n  .sidebar-header .brand {\n    flex: 1;\n  }\n  .sidebar-header-actions {\n    display: flex;\n    align-items: center;\n    gap: 2px;\n  }\n  .sidebar-header-actions .sidebar-toggle {\n    margin-left: 2px;\n  }\n\n  /* Floating sidebar toggle (visible when sidebar is collapsed) */\n  .sidebar-toggle-float {\n    position: absolute;\n    top: 10px;\n    left: 10px;\n    z-index: 15;\n    background: var(--sidebar-bg);\n    border: 1px solid var(--border);\n    border-radius: 8px;\n    padding: 5px 8px;\n    cursor: pointer;\n    font-size: 18px;\n    color: var(--fg);\n    display: none;\n    align-items: center;\n    box-shadow: 0 2px 8px rgba(0,0,0,0.06);\n    transition: opacity 0.15s;\n  }\n  .sidebar-toggle-float:hover {\n    border-color: var(--muted);\n  }\n  .sidebar.collapsed ~ .sidebar-toggle-float {\n    display: flex;\n  }\n\n  .sidebar-search {\n    padding: 12px 12px 8px;\n    position: relative;\n  }\n  .search-clear {\n    position: absolute;\n    right: 18px;\n    top: 50%;\n    transform: translateY(-50%);\n    background: color-mix(in srgb, var(--fg) 8%, transparent);\n    border: none;\n    color: var(--muted);\n    font-size: 13px;\n    cursor: pointer;\n    padding: 0;\n    width: 20px;\n    height: 20px;\n    line-height: 20px;\n    text-align: center;\n    display: none;\n    border-radius: 50%;\n  }\n  .search-clear:hover { background: color-mix(in srgb, var(--fg) 16%, transparent); color: var(--fg); }\n  .sidebar-search input {\n    width: 100%;\n    padding: 7px 28px 7px 12px;\n    border: none;\n    border-radius: 6px;\n    background: var(--bg);\n    color: var(--fg);\n    font-size: 13px;\n    outline: none;\n    box-shadow: 0 0 0 1px color-mix(in srgb, var(--fg) 8%, transparent);\n    transition: box-shadow 0.15s;\n  }\n  .sidebar-search input:focus {\n    box-shadow: 0 0 0 2px var(--link);\n  }\n  .sidebar-search input::placeholder {\n    color: var(--muted);\n  }\n\n  .quick-add-row {\n    display: flex;\n    gap: 6px;\n    padding: 6px 12px 8px;\n    align-items: center;\n  }\n  .quick-add-row input {\n    flex: 1;\n    min-width: 0;\n    padding: 6px 10px;\n    border: 1px solid var(--border);\n    border-radius: 6px;\n    background: var(--bg);\n    color: var(--fg);\n    font-size: 12px;\n    font-family: inherit;\n  }\n  .quick-add-row input:focus {\n    outline: none;\n    border-color: var(--link);\n    box-shadow: 0 0 0 2px color-mix(in srgb, var(--link) 20%, transparent);\n  }\n  .quick-add-row input::placeholder {\n    color: var(--muted);\n  }\n\n  .file-list {\n    flex: 1;\n    overflow-y: auto;\n    overflow-x: hidden;\n    padding: 4px 8px;\n  }\n\n  .file-item {\n    padding: 10px 12px;\n    border-radius: 7px;\n    cursor: pointer;\n    transition: background 0.12s;\n    margin-bottom: 2px;\n  }\n  .file-item:hover {\n    background: color-mix(in srgb, var(--fg) 5%, transparent);\n  }\n  .file-item.active {\n    background: color-mix(in srgb, var(--fg) 10%, transparent);\n  }\n  .file-item.read .file-item-title {\n    opacity: 0.55;\n  }\n  .file-item-new {\n    animation: fileNewFade 3s ease;\n  }\n  @keyframes fileNewFade {\n    0% { background: color-mix(in srgb, var(--link) 25%, transparent); }\n    100% { background: transparent; }\n  }\n  .file-item-title {\n    font-size: 13px;\n    font-weight: 500;\n    line-height: 1.4;\n    margin-bottom: 4px;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    display: -webkit-box;\n    -webkit-line-clamp: 2;\n    -webkit-box-orient: vertical;\n  }\n  .file-item-meta {\n    font-size: 11px;\n    color: var(--muted);\n    display: flex;\n    gap: 6px;\n    align-items: center;\n    min-width: 0;\n  }\n  .file-item-meta > span {\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    min-width: 0;\n  }\n  .file-item-meta > span:first-child {\n    flex-shrink: 0;\n  }\n  .file-item-meta .meta-sep {\n    width: 2px;\n    height: 2px;\n    border-radius: 50%;\n    background: var(--muted);\n    opacity: 0.5;\n    flex-shrink: 0;\n  }\n\n  .file-count {\n    padding: 4px 12px 4px 20px;\n    font-size: 11px;\n    color: var(--muted);\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n  }\n  .new-notebook-btn {\n    display: block;\n    width: 100%;\n    border: 1px dashed var(--border);\n    background: none;\n    color: var(--muted);\n    font-size: 12px;\n    font-weight: 500;\n    cursor: pointer;\n    padding: 8px 12px;\n    border-radius: 6px;\n    font-family: inherit;\n    text-align: left;\n    margin: 4px 0 8px;\n    transition: color 0.15s, border-color 0.15s, background 0.15s;\n  }\n  .new-notebook-btn:hover {\n    color: var(--link);\n    border-color: var(--link);\n    background: var(--sidebar-active);\n  }\n  .file-item.notebook-item .file-item-title {\n    color: var(--fg);\n  }\n  .file-item.notebook-item .nb-icon {\n    width: 12px; height: 12px; opacity: 0.45;\n    vertical-align: -1px; margin-right: 4px; flex-shrink: 0;\n    fill: currentColor;\n  }\n  .hide-read-toggle {\n    cursor: pointer;\n    font-size: 10px;\n    color: var(--muted);\n    user-select: none;\n    -webkit-user-select: none;\n    padding: 2px 8px;\n    border-radius: 10px;\n    border: 1px solid var(--border);\n    background: transparent;\n    transition: background 0.15s, color 0.15s, border-color 0.15s;\n  }\n  .hide-read-toggle:hover {\n    color: var(--fg);\n    border-color: var(--fg);\n  }\n  .hide-read-toggle.active {\n    color: var(--bg);\n    background: var(--link);\n    border-color: var(--link);\n  }\n\n  /* Favicon in sidebar — shown on meta line, pushed to far right */\n  .file-item-favicon {\n    width: 14px;\n    height: 14px;\n    border-radius: 3px;\n    margin-left: auto;\n    flex-shrink: 0;\n    opacity: 0.7;\n    filter: grayscale(100%);\n    transition: filter 0.2s;\n    background: #808080;\n  }\n  .file-item:hover .file-item-favicon,\n  .file-item.active .file-item-favicon,\n  .dash-card:hover .dash-card-meta img,\n  .domain-group-header:hover .file-item-favicon { filter: grayscale(0%); }\n\n  /* Content pane */\n  .content-pane {\n    flex: 1;\n    overflow-y: auto;\n    overflow-x: hidden;\n    background: var(--bg);\n    position: relative;\n  }\n\n  .content-wrap {\n    max-width: 720px;\n    margin: 0 auto;\n    padding: 32px 28px 96px;\n  }\n\n  .empty-state {\n    height: 100%;\n    overflow-y: auto;\n    padding: 0;\n  }\n\n  /* Dashboard */\n  .dashboard {\n    max-width: 900px;\n    margin: 0 auto;\n    padding: 32px 24px;\n    font-family: \"Work Sans\", -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n  }\n  .dash-greeting {\n    margin-bottom: 28px;\n  }\n  .dash-greeting h1 {\n    font-size: 24px;\n    font-weight: 600;\n    color: var(--fg);\n    margin: 0 0 4px;\n    letter-spacing: -0.02em;\n  }\n  .dash-greeting p {\n    font-size: 14px;\n    color: var(--muted);\n    margin: 0;\n  }\n  .dash-section {\n    margin-bottom: 28px;\n  }\n  .dash-section-header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    margin-bottom: 12px;\n  }\n  .dash-section-title {\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    font-size: 15px;\n    font-weight: 600;\n    color: var(--fg);\n  }\n  .dash-section-title svg {\n    width: 16px;\n    height: 16px;\n    fill: currentColor;\n    opacity: 0.5;\n  }\n  .dash-section-count {\n    font-weight: 400;\n    color: var(--muted);\n    font-size: 13px;\n  }\n  .dash-view-all {\n    font-size: 12px;\n    color: var(--link);\n    cursor: pointer;\n    background: none;\n    border: none;\n    font-family: inherit;\n  }\n  .dash-view-all:hover { text-decoration: underline; }\n  .dash-cards-wrap {\n    position: relative;\n  }\n  .dash-cards {\n    display: flex;\n    gap: 16px;\n    overflow-x: auto;\n    scroll-snap-type: x mandatory;\n    -webkit-overflow-scrolling: touch;\n    padding-bottom: 4px;\n    scrollbar-width: none;\n    -ms-overflow-style: none;\n  }\n  .dash-cards::-webkit-scrollbar { display: none; }\n  .dash-chevron {\n    position: absolute;\n    top: 50%;\n    transform: translateY(-50%);\n    width: 32px;\n    height: 32px;\n    border-radius: 50%;\n    border: 1px solid var(--border);\n    background: var(--bg);\n    color: var(--muted);\n    cursor: pointer;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    z-index: 2;\n    box-shadow: 0 2px 8px rgba(0,0,0,0.08);\n    transition: opacity 0.15s, color 0.15s;\n    opacity: 0;\n    pointer-events: none;\n    font-size: 14px;\n  }\n  .dash-cards-wrap:hover .dash-chevron.visible { opacity: 1; pointer-events: auto; }\n  .dash-chevron:hover { color: var(--fg); }\n  .dash-chevron.left { left: -12px; }\n  .dash-chevron.right { right: -12px; }\n  .dash-card {\n    flex: 0 0 280px;\n    scroll-snap-align: start;\n    border: 1px solid var(--border);\n    border-radius: 10px;\n    overflow: hidden;\n    cursor: pointer;\n    background: var(--bg);\n    transition: box-shadow 0.15s, transform 0.15s;\n  }\n  .dash-card:hover {\n    box-shadow: 0 4px 16px rgba(0,0,0,0.08);\n    transform: translateY(-2px);\n  }\n  .dash-card-img {\n    width: 100%;\n    height: 140px;\n    object-fit: cover;\n    background: var(--code-bg);\n    display: block;\n  }\n  .dash-card-img-placeholder {\n    width: 100%;\n    height: 140px;\n    background: var(--code-bg);\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    font-size: 32px;\n    color: var(--border);\n  }\n  .dash-card-body {\n    padding: 12px 14px;\n  }\n  .dash-card-meta {\n    display: flex;\n    align-items: center;\n    gap: 6px;\n    font-size: 11px;\n    color: var(--muted);\n    margin-bottom: 6px;\n  }\n  .dash-card-meta img {\n    width: 14px;\n    height: 14px;\n    border-radius: 2px;\n    filter: grayscale(100%);\n    transition: filter 0.2s;\n    background: #808080;\n  }\n  .dash-card-badge {\n    font-size: 10px;\n    border: 1px solid var(--border);\n    border-radius: 3px;\n    padding: 1px 5px;\n    color: var(--muted);\n  }\n  .dash-card-title {\n    font-size: 14px;\n    font-weight: 600;\n    color: var(--fg);\n    line-height: 1.35;\n    display: -webkit-box;\n    -webkit-line-clamp: 2;\n    -webkit-box-orient: vertical;\n    overflow: hidden;\n  }\n  .dash-card-excerpt {\n    font-size: 12px;\n    color: var(--muted);\n    margin-top: 4px;\n    display: -webkit-box;\n    -webkit-line-clamp: 2;\n    -webkit-box-orient: vertical;\n    overflow: hidden;\n    line-height: 1.4;\n  }\n  .dash-card-progress {\n    height: 3px;\n    background: var(--border);\n    border-radius: 2px;\n    margin-top: 8px;\n    overflow: hidden;\n  }\n  .dash-card-progress-fill {\n    height: 100%;\n    background: var(--link);\n    border-radius: 2px;\n  }\n  .dash-review-card {\n    flex: 0 0 320px;\n    border: 1px solid var(--border);\n    border-radius: 10px;\n    padding: 16px 18px;\n    cursor: pointer;\n    background: var(--bg);\n    transition: box-shadow 0.15s, transform 0.15s;\n  }\n  .dash-review-card:hover {\n    box-shadow: 0 4px 16px rgba(0,0,0,0.08);\n    transform: translateY(-2px);\n  }\n  .dash-review-title {\n    font-size: 15px;\n    font-weight: 600;\n    color: var(--fg);\n    margin-bottom: 6px;\n  }\n  .dash-review-meta {\n    font-size: 12px;\n    color: var(--muted);\n    margin-bottom: 8px;\n  }\n  .dash-review-excerpt {\n    font-size: 12px;\n    color: var(--muted);\n    line-height: 1.5;\n    display: -webkit-box;\n    -webkit-line-clamp: 3;\n    -webkit-box-orient: vertical;\n    overflow: hidden;\n  }\n  .dash-empty-hint {\n    text-align: center;\n    color: var(--muted);\n    font-size: 14px;\n    padding: 48px 0;\n  }\n  .dash-empty-hint .subhint {\n    font-size: 13px;\n  }\n  .dash-footer {\n    display: flex;\n    gap: 12px;\n    justify-content: center;\n    padding: 24px 0 8px;\n  }\n  .dash-footer button {\n    display: inline-flex;\n    align-items: center;\n    gap: 5px;\n    padding: 6px 14px;\n    font-size: 12px;\n    color: var(--muted);\n    background: transparent;\n    border: 1px solid var(--border);\n    border-radius: 6px;\n    cursor: pointer;\n    font-family: inherit;\n    transition: color 0.12s, border-color 0.12s;\n  }\n  .dash-footer button:hover {\n    color: var(--fg);\n    border-color: color-mix(in srgb, var(--fg) 20%, transparent);\n  }\n\n  /* Typography classes */\n  .font-sans .content-wrap { font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Helvetica, sans-serif; }\n  .font-serif .content-wrap { font-family: \"Georgia\", \"Times New Roman\", \"Iowan Old Style\", serif; }\n  .font-mono .content-wrap { font-family: \"SF Mono\", \"Fira Code\", \"Menlo\", monospace; }\n  .font-system .content-wrap { font-family: \"Charter\", \"Bitstream Charter\", \"Sitka Text\", Cambria, serif; }\n  .font-inter .content-wrap { font-family: \"Inter\", -apple-system, BlinkMacSystemFont, sans-serif; }\n  .font-lora .content-wrap { font-family: \"Lora\", \"Georgia\", serif; }\n  .font-literata .content-wrap { font-family: \"Literata\", \"Georgia\", serif; }\n  .font-source-serif .content-wrap { font-family: \"Source Serif 4\", \"Georgia\", serif; }\n  .font-work-sans .content-wrap { font-family: \"Work Sans\", -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif; }\n\n  .content-wrap {\n    line-height: 1.7;\n    font-size: 17px;\n  }\n  .size-small .content-wrap { font-size: 15px; }\n  .size-medium .content-wrap { font-size: 17px; }\n  .size-large .content-wrap { font-size: 20px; }\n\n  /* Article content */\n  .content-wrap h1 { font-size: 1.8em; margin: 0.5em 0 0.3em; line-height: 1.2; }\n  .content-wrap h2 { font-size: 1.4em; margin: 1.2em 0 0.3em; line-height: 1.3; }\n  .content-wrap h3 { font-size: 1.15em; margin: 1em 0 0.3em; }\n  .content-wrap p { margin: 0.8em 0; }\n  .content-wrap a { color: var(--link); text-decoration: none; }\n  .content-wrap a:hover { text-decoration: underline; }\n  .content-wrap img { max-width: 100%; height: auto; border-radius: 4px; margin: 1em 0; display: block; }\n  .content-wrap blockquote {\n    border-left: 3px solid var(--border);\n    padding-left: 16px;\n    margin: 1em 0;\n    color: var(--muted);\n  }\n  .content-wrap pre {\n    background: var(--code-bg);\n    padding: 14px;\n    border-radius: 6px;\n    overflow-x: auto;\n    margin: 1em 0;\n    font-size: 14px;\n    line-height: 1.5;\n  }\n  .content-wrap code {\n    background: var(--code-bg);\n    padding: 2px 5px;\n    border-radius: 3px;\n    font-size: 0.9em;\n  }\n  .content-wrap pre code { background: none; padding: 0; }\n  .content-wrap ul, .content-wrap ol { padding-left: 1.5em; margin: 0.8em 0; }\n  .content-wrap li { margin: 0.3em 0; }\n  .content-wrap hr { border: none; border-top: 1px solid var(--border); margin: 2em 0; }\n  .content-wrap table { border-collapse: collapse; width: 100%; margin: 1em 0; }\n  .content-wrap th, .content-wrap td { border: 1px solid var(--border); padding: 8px 12px; text-align: left; }\n  .content-wrap th { background: var(--code-bg); }\n\n  .article-header {\n    margin-bottom: 24px;\n    padding-bottom: 16px;\n    border-bottom: 1px solid var(--border);\n  }\n  .article-header h1 {\n    font-size: 1.6em;\n    line-height: 1.25;\n    margin: 0 0 8px;\n    color: var(--fg);\n    font-weight: 700;\n  }\n  .article-header h1 .title-link {\n    color: var(--fg);\n    text-decoration: none;\n    transition: color 0.15s;\n  }\n  .article-header h1 .title-link:hover {\n    color: var(--link);\n  }\n  .article-header h1 .title-link .icon-external {\n    width: 0.45em;\n    height: 0.45em;\n    fill: var(--muted);\n    margin-left: 6px;\n    vertical-align: middle;\n    opacity: 0;\n    transition: opacity 0.15s, fill 0.15s;\n  }\n  .article-header h1 .title-link:hover .icon-external {\n    opacity: 1;\n    fill: var(--link);\n  }\n  .article-byline {\n    font-size: 14px;\n    color: var(--muted);\n    line-height: 1.5;\n  }\n  .article-byline a { color: var(--link); text-decoration: none; }\n  .article-byline a:hover { text-decoration: underline; }\n  .article-byline .author { color: var(--fg); font-weight: 500; }\n  .article-byline .sep { margin: 0 6px; opacity: 0.4; }\n  .article-actions {\n    display: flex;\n    gap: 4px;\n    margin-top: 10px;\n    align-items: center;\n    flex-wrap: wrap;\n  }\n  .article-actions button {\n    display: inline-flex;\n    align-items: center;\n    gap: 4px;\n    padding: 4px 10px;\n    font-size: 12px;\n    font-weight: 500;\n    border: none;\n    border-radius: 6px;\n    background: var(--code-bg);\n    color: var(--muted);\n    cursor: pointer;\n    font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n    transition: background 0.15s, color 0.15s;\n    line-height: 1.4;\n  }\n  .article-actions button:hover { background: var(--sidebar-active); color: var(--fg); }\n  .article-actions button.active-fav { background: color-mix(in srgb, #e91e63 12%, var(--bg)); color: #e91e63; }\n  .article-actions button:disabled { opacity: 0.5; cursor: not-allowed; }\n  .play-next-menu { display: inline-flex; align-items: center; gap: 0; position: relative; }\n  .play-next-trigger {\n    padding: 4px 6px !important;\n    border-radius: 0 6px 6px 0 !important;\n    border-left: 1px solid color-mix(in srgb, var(--fg) 12%, transparent) !important;\n    margin-left: -1px;\n    opacity: 0.7;\n    line-height: 1.4;\n  }\n  .play-next-trigger svg { width: 10px; height: 10px; }\n  .play-next-trigger:hover { opacity: 1; }\n  .play-next-menu #listen-btn { border-radius: 6px; }\n  .play-next-menu:has(.play-next-trigger:not([style*=\"display: none\"])) #listen-btn {\n    border-radius: 6px 0 0 6px;\n  }\n  .article-actions button.listen-loading {\n    position: relative;\n    overflow: hidden;\n    color: var(--link);\n    pointer-events: none;\n  }\n  .article-actions button.listen-loading::before {\n    content: '';\n    position: absolute;\n    top: 0;\n    left: 0;\n    bottom: 0;\n    background: color-mix(in srgb, var(--link) 15%, transparent);\n    border-radius: inherit;\n    animation: listen-fill 2.5s ease-in-out infinite;\n  }\n  @keyframes listen-fill {\n    0% { left: 0; right: 100%; }\n    50% { left: 0; right: 0; }\n    100% { left: 100%; right: 0; }\n  }\n  .article-actions button.listen-playing {\n    color: var(--link);\n    animation: listen-pulse 3s ease-in-out infinite;\n  }\n  @keyframes listen-pulse {\n    0%, 100% { background: color-mix(in srgb, var(--link) 6%, transparent); }\n    50% { background: color-mix(in srgb, var(--link) 16%, transparent); }\n  }\n\n  /* TTS settings modal loading spinner */\n  .tts-settings-spinner {\n    width: 28px; height: 28px;\n    border: 3px solid var(--border);\n    border-top-color: var(--link);\n    border-radius: 50%;\n    animation: tts-spin 0.7s linear infinite;\n  }\n  @keyframes tts-spin { to { transform: rotate(360deg); } }\n\n  /* Margin notes (Google Docs-style) */\n  .margin-notes {\n    position: absolute;\n    top: 0;\n    right: 0;\n    width: 240px;\n    pointer-events: none;\n    z-index: 5;\n  }\n  .margin-note {\n    position: absolute;\n    right: 12px;\n    width: 216px;\n    padding: 8px 10px;\n    background: var(--code-bg);\n    border-left: 2px solid var(--link);\n    border-radius: 0 4px 4px 0;\n    font-size: 12px;\n    line-height: 1.5;\n    color: var(--fg);\n    font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n    pointer-events: all;\n    cursor: pointer;\n    transition: box-shadow 0.15s;\n  }\n  .margin-note:hover {\n    box-shadow: 0 2px 8px rgba(0,0,0,0.1);\n  }\n  .margin-note .mn-text {\n    color: var(--muted);\n    font-size: 11px;\n    margin-bottom: 3px;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n  }\n  .margin-note .mn-body {\n    white-space: pre-wrap;\n    word-break: break-word;\n  }\n  @media (max-width: 1100px) {\n    .margin-notes { display: none; }\n  }\n\n  /* Tablet */\n  @media (max-width: 768px) {\n    .sidebar {\n      position: absolute;\n      z-index: 20;\n      height: 100vh;\n      box-shadow: 4px 0 16px rgba(0,0,0,0.1);\n    }\n    .sidebar.collapsed {\n      margin-left: -300px;\n    }\n    .content-wrap {\n      padding: 24px 20px 80px;\n    }\n    .sidebar.collapsed ~ .content-pane .content-wrap,\n    .sidebar.collapsed ~ .content-pane .dashboard {\n      padding-top: 52px;\n    }\n    .article-header h1 {\n      font-size: 1.35em;\n    }\n    .settings-dropdown-panel {\n      position: fixed;\n      top: 42px;\n      right: 8px;\n      left: 8px;\n      width: auto;\n    }\n    .annotation-popover {\n      width: 240px;\n    }\n    .modal-card {\n      padding: 20px 20px;\n      width: 94%;\n    }\n  }\n\n  /* Mobile */\n  @media (max-width: 480px) {\n    .sidebar-header {\n      padding: 8px 10px 4px;\n    }\n    .brand {\n      font-size: 13px;\n    }\n    .sidebar {\n      width: 260px;\n      min-width: 260px;\n    }\n    .sidebar.collapsed {\n      margin-left: -260px;\n    }\n    .content-wrap {\n      padding: 16px 14px 72px;\n    }\n    .sidebar.collapsed ~ .content-pane .content-wrap,\n    .sidebar.collapsed ~ .content-pane .dashboard {\n      padding-top: 56px;\n    }\n    .article-header h1 {\n      font-size: 1.2em;\n    }\n    .article-byline {\n      font-size: 12px;\n    }\n    .article-actions {\n      flex-wrap: wrap;\n    }\n    .content-wrap table {\n      font-size: 13px;\n    }\n    .content-wrap th, .content-wrap td {\n      padding: 6px 8px;\n    }\n    .annotation-popover {\n      position: fixed;\n      left: 8px;\n      right: 8px;\n      bottom: 8px;\n      top: auto;\n      width: auto;\n    }\n    .hl-toolbar {\n      padding: 4px 6px;\n    }\n    .hl-toolbar button {\n      width: 28px;\n      height: 28px;\n    }\n    .notes-panel textarea {\n      min-height: 60px;\n      font-size: 16px;\n    }\n    .bottom-bar-inner { padding: 4px 8px; gap: 4px; flex-wrap: wrap; }\n    .bottom-bar-now { flex: 1 1 100%; order: 1; }\n    .bottom-bar-controls { order: 2; }\n    .bottom-bar-progress-row { order: 3; flex: 1; }\n    .bottom-bar-right { order: 4; }\n  }\n\n  /* Focus indicators (a11y) */\n  :focus-visible {\n    outline: 2px solid var(--link);\n    outline-offset: 2px;\n  }\n  .sidebar-header-actions button:focus-visible,\n  .sidebar-settings-btn:focus-visible {\n    outline: 2px solid var(--link);\n    outline-offset: 1px;\n    border-radius: 4px;\n  }\n\n  /* Reduced motion (a11y) */\n  @media (prefers-reduced-motion: reduce) {\n    *, *::before, *::after {\n      animation-duration: 0.01ms !important;\n      animation-iteration-count: 1 !important;\n      transition-duration: 0.01ms !important;\n      scroll-behavior: auto !important;\n    }\n  }\n\n  /* Line height options */\n  .leading-compact .content-wrap { line-height: 1.5; }\n  .leading-relaxed .content-wrap { line-height: 2.0; }\n  .leading-loose .content-wrap { line-height: 2.4; }\n\n  /* Letter spacing options */\n  .spacing-wide .content-wrap { letter-spacing: 0.03em; }\n  .spacing-wider .content-wrap { letter-spacing: 0.06em; }\n\n  /* Content width options */\n  .width-narrow .content-wrap { max-width: 560px; }\n  .width-wide .content-wrap { max-width: 900px; }\n\n  /* Dyslexia-friendly font */\n  .font-opendyslexic .content-wrap {\n    font-family: 'OpenDyslexic', 'Comic Sans MS', cursive, sans-serif;\n    letter-spacing: 0.04em;\n    word-spacing: 0.1em;\n  }\n\n  /* Sidebar footer */\n  .sidebar-footer {\n    padding: 6px 8px;\n  }\n  .sidebar-settings-btn {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 6px;\n    width: 100%;\n    padding: 7px 0;\n    font-size: 12px;\n    color: var(--muted);\n    background: transparent;\n    border: 1px solid var(--border);\n    border-radius: 6px;\n    cursor: pointer;\n    font-family: inherit;\n    transition: color 0.12s, background 0.12s, border-color 0.12s;\n  }\n  .sidebar-settings-btn:hover {\n    color: var(--fg);\n    background: color-mix(in srgb, var(--fg) 6%, transparent);\n    border-color: color-mix(in srgb, var(--fg) 15%, transparent);\n  }\n\n  /* Audio player panel */\n  /* TTS reading cursor — subtle left border on the paragraph being read */\n  .tts-reading-hl {\n    border-left: 2px solid var(--link);\n    padding-left: 12px;\n    margin-left: -14px;\n  }\n\n  /* ---- Bottom bar audio player ---- */\n  .bottom-bar {\n    position: fixed;\n    bottom: 0;\n    left: 0;\n    right: 0;\n    z-index: 50;\n    background: var(--sidebar-bg);\n    border-top: 1px solid var(--border);\n    font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n    font-size: 12px;\n    box-shadow: 0 -2px 12px rgba(0,0,0,0.06);\n    transition: transform 0.25s ease;\n  }\n  .bottom-bar.hidden { transform: translateY(100%); pointer-events: none; }\n  .bottom-bar-inner {\n    display: flex;\n    align-items: center;\n    gap: 14px;\n    padding: 14px 20px;\n    max-width: 100%;\n  }\n  .bottom-bar-now {\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    min-width: 0;\n    flex: 0 1 220px;\n    cursor: pointer;\n  }\n  .bottom-bar-now:hover .bottom-bar-title { text-decoration: underline; }\n  .bottom-bar-icon { width: 18px; height: 18px; fill: var(--muted); flex-shrink: 0; }\n  .bottom-bar-info {\n    display: flex;\n    flex-direction: column;\n    min-width: 0;\n  }\n  .bottom-bar-title {\n    font-weight: 600;\n    font-size: 13px;\n    color: var(--fg);\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n  }\n  .bottom-bar-status {\n    font-size: 11px;\n    color: var(--muted);\n    white-space: nowrap;\n  }\n  .bottom-bar-controls {\n    display: flex;\n    align-items: center;\n    gap: 4px;\n    flex-shrink: 0;\n  }\n  .bottom-bar-controls button {\n    border: none;\n    background: none;\n    color: var(--fg);\n    cursor: pointer;\n    padding: 8px;\n    border-radius: 50%;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n  }\n  .bottom-bar-controls button:hover { background: var(--sidebar-hover); }\n  .bottom-bar-controls svg { width: 18px; height: 18px; fill: currentColor; }\n  .bottom-bar-play svg { width: 26px; height: 26px; }\n  .bottom-bar-progress-row {\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    flex: 1;\n    min-width: 80px;\n  }\n  .audio-progress-wrap {\n    flex: 1;\n    height: 20px;\n    display: flex;\n    align-items: center;\n    cursor: pointer;\n    padding: 0 4px;\n    user-select: none;\n    -webkit-user-select: none;\n  }\n  .audio-progress {\n    width: 100%;\n    height: 5px;\n    background: var(--border);\n    border-radius: 3px;\n    overflow: hidden;\n  }\n  .audio-progress-fill {\n    height: 100%;\n    background: var(--link);\n    border-radius: 3px;\n    width: 0%;\n    transition: width 0.2s linear;\n  }\n  .audio-time {\n    font-size: 11px;\n    color: var(--muted);\n    min-width: 36px;\n    text-align: center;\n    flex-shrink: 0;\n  }\n  .bottom-bar-right {\n    display: flex;\n    align-items: center;\n    gap: 4px;\n    flex-shrink: 0;\n  }\n  .bottom-bar-right button {\n    border: none;\n    background: none;\n    color: var(--muted);\n    cursor: pointer;\n    padding: 8px;\n    border-radius: 50%;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n  }\n  .bottom-bar-right button:hover { background: var(--sidebar-hover); color: var(--fg); }\n  .bottom-bar-right svg { width: 18px; height: 18px; fill: currentColor; }\n  .audio-speed-btn {\n    font-size: 12px !important;\n    font-weight: 600;\n    padding: 4px 8px !important;\n    border: 1px solid var(--border) !important;\n    border-radius: 6px;\n    min-width: 40px;\n    text-align: center;\n    position: relative;\n  }\n  .bottom-bar-queue-btn.active { color: var(--link); }\n  .bottom-bar-queue {\n    border-top: 1px solid var(--border);\n    padding: 8px 20px 10px;\n    max-height: 200px;\n    overflow-y: auto;\n  }\n  /* Add bottom padding to content pane when bottom bar is visible */\n  .app.has-bottom-bar .content-pane { padding-bottom: 80px; }\n  .app.has-bottom-bar .sidebar { padding-bottom: 80px; }\n  .tts-speed-popup {\n    position: fixed;\n    background: var(--bg);\n    border: 1px solid var(--border);\n    border-radius: 8px;\n    padding: 10px 6px;\n    box-shadow: 0 4px 16px rgba(0,0,0,0.18);\n    z-index: 1000;\n    display: flex;\n    align-items: center;\n    gap: 4px;\n    user-select: none;\n    -webkit-user-select: none;\n  }\n  .tts-speed-popup-value {\n    font-size: 11px;\n    font-weight: 700;\n    color: var(--fg);\n    min-width: 30px;\n    text-align: center;\n  }\n  .tts-speed-track-wrap {\n    position: relative;\n    width: 16px;\n    height: 180px;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    cursor: pointer;\n  }\n  .tts-speed-track {\n    width: 3px;\n    height: 100%;\n    background: var(--border);\n    border-radius: 2px;\n    position: relative;\n  }\n  .tts-speed-thumb {\n    width: 14px;\n    height: 14px;\n    background: var(--link);\n    border-radius: 50%;\n    position: absolute;\n    left: 50%;\n    transform: translate(-50%, -50%);\n    cursor: grab;\n    box-shadow: 0 1px 3px rgba(0,0,0,0.2);\n  }\n  .tts-speed-thumb:active { cursor: grabbing; }\n  .tts-speed-ticks {\n    display: flex;\n    flex-direction: column;\n    justify-content: space-between;\n    height: 180px;\n  }\n  .tts-speed-tick {\n    font-size: 9px;\n    color: var(--muted);\n    line-height: 1;\n    text-align: left;\n    min-width: 22px;\n  }\n  .tts-speed-tick-dot {\n    font-size: 9px;\n    color: var(--border);\n    line-height: 1;\n    text-align: center;\n    min-width: 22px;\n  }\n  .audio-queue-section {\n    margin-top: 6px;\n    border-top: 1px solid var(--border);\n    padding-top: 6px;\n  }\n  .audio-queue-header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    margin-bottom: 4px;\n    font-size: 10px;\n    color: var(--muted);\n    text-transform: uppercase;\n    letter-spacing: 0.5px;\n  }\n  .audio-queue-clear {\n    cursor: pointer;\n    font-size: 10px;\n    color: var(--muted);\n    background: none;\n    border: none;\n    text-transform: none;\n    letter-spacing: 0;\n  }\n  .audio-queue-clear:hover { color: var(--fg); }\n  .audio-queue-item {\n    display: flex;\n    align-items: center;\n    padding: 3px 4px;\n    border-radius: 3px;\n    gap: 6px;\n    font-size: 11px;\n    color: var(--fg);\n    cursor: pointer;\n  }\n  .audio-queue-item:hover { background: var(--sidebar-hover); }\n  .audio-queue-item.playing {\n    font-weight: 600;\n    color: var(--link);\n  }\n  .audio-queue-item .queue-title {\n    flex: 1;\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n  }\n  .audio-queue-item .queue-remove {\n    opacity: 0;\n    cursor: pointer;\n    color: var(--muted);\n    font-size: 13px;\n    flex-shrink: 0;\n    background: none;\n    border: none;\n    padding: 0 2px;\n    line-height: 1;\n  }\n  .audio-queue-item:hover .queue-remove { opacity: 0.7; }\n  .audio-queue-item .queue-remove:hover { opacity: 1; color: var(--fg); }\n  .audio-generating {\n    display: flex;\n    align-items: center;\n    gap: 6px;\n    padding: 6px 0;\n    color: var(--muted);\n    font-size: 11px;\n  }\n  .audio-generating .spinner {\n    width: 14px;\n    height: 14px;\n    border: 2px solid var(--border);\n    border-top-color: var(--link);\n    border-radius: 50%;\n    animation: spin 0.8s linear infinite;\n  }\n  @keyframes spin { to { transform: rotate(360deg); } }\n  /* Play Next button in article actions */\n  .play-next-menu {\n    position: relative;\n    display: inline-block;\n  }\n  .play-next-dropdown {\n    position: absolute;\n    top: 100%;\n    left: 0;\n    background: var(--bg);\n    border: 1px solid var(--border);\n    border-radius: 6px;\n    box-shadow: 0 4px 12px rgba(0,0,0,0.12);\n    z-index: 20;\n    padding: 4px 0;\n    min-width: 140px;\n    font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n  }\n  .play-next-dropdown button {\n    display: block;\n    width: 100%;\n    text-align: left;\n    padding: 6px 12px;\n    border: none;\n    background: none;\n    color: var(--fg);\n    font-size: 12px;\n    cursor: pointer;\n    font-family: inherit;\n  }\n  .play-next-dropdown button:hover { background: var(--sidebar-hover); }\n\n  /* Aa reader settings button — always visible in content area */\n  .aa-settings-btn {\n    position: absolute;\n    top: 10px;\n    right: 10px;\n    z-index: 15;\n    background: var(--sidebar-bg);\n    border: 1px solid var(--border);\n    border-radius: 8px;\n    padding: 4px 10px;\n    cursor: pointer;\n    font-size: 14px;\n    font-weight: 600;\n    color: var(--fg);\n    font-family: \"Literata\", Georgia, serif;\n    box-shadow: 0 2px 8px rgba(0,0,0,0.06);\n    transition: opacity 0.15s;\n    line-height: 1.4;\n  }\n  .aa-settings-btn:hover {\n    border-color: var(--muted);\n  }\n\n  /* Sidebar audio indicator on file items */\n  .file-item-audio {\n    display: inline-flex;\n    align-items: center;\n    gap: 3px;\n    margin-left: 4px;\n    flex-shrink: 0;\n  }\n  .file-item-audio svg { width: 10px; height: 10px; fill: var(--link); }\n  .file-item-audio .eq-bars {\n    display: inline-flex;\n    align-items: flex-end;\n    gap: 1px;\n    height: 10px;\n  }\n  .file-item-audio .eq-bars span {\n    display: block;\n    width: 2px;\n    background: var(--link);\n    border-radius: 1px;\n    animation: eq-bounce 0.8s ease-in-out infinite alternate;\n  }\n  .file-item-audio .eq-bars span:nth-child(1) { height: 4px; animation-delay: 0s; }\n  .file-item-audio .eq-bars span:nth-child(2) { height: 7px; animation-delay: 0.2s; }\n  .file-item-audio .eq-bars span:nth-child(3) { height: 5px; animation-delay: 0.4s; }\n  @keyframes eq-bounce {\n    0% { height: 3px; }\n    100% { height: 10px; }\n  }\n  .file-item-audio .queue-pos {\n    font-size: 9px;\n    color: var(--link);\n    font-weight: 600;\n    background: color-mix(in srgb, var(--link) 12%, transparent);\n    border-radius: 3px;\n    padding: 0 3px;\n    line-height: 14px;\n  }\n\n  /* Generic modal overlay */\n  .modal-overlay {\n    position: fixed;\n    top: 0; left: 0; right: 0; bottom: 0;\n    background: rgba(0, 0, 0, 0.55);\n    z-index: 100;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    animation: fadeIn 0.15s ease;\n  }\n  .modal-card {\n    background: var(--bg);\n    border: 1px solid var(--border);\n    border-radius: 12px;\n    padding: 28px 32px;\n    max-width: 480px;\n    width: 90%;\n    max-height: 85vh;\n    overflow-y: auto;\n    box-shadow: 0 16px 48px rgba(0,0,0,0.2);\n    font-family: \"Work Sans\", -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n  }\n  .modal-card h2 {\n    font-size: 18px;\n    margin: 0 0 14px;\n    color: var(--fg);\n  }\n  .modal-card h3 {\n    font-size: 14px;\n    margin: 18px 0 6px;\n    color: var(--fg);\n    font-weight: 600;\n  }\n  .modal-card h3:first-of-type { margin-top: 8px; }\n  .modal-card p {\n    font-size: 13px;\n    line-height: 1.6;\n    color: var(--muted);\n    margin: 0 0 8px;\n  }\n  .modal-close {\n    display: block;\n    margin: 18px auto 0;\n    padding: 7px 24px;\n    background: var(--fg);\n    color: var(--bg);\n    border: none;\n    border-radius: 6px;\n    font-size: 13px;\n    cursor: pointer;\n  }\n  .modal-close:hover { opacity: 0.85; }\n  .modal-actions {\n    display: flex;\n    gap: 8px;\n    justify-content: center;\n    margin-top: 18px;\n  }\n  .modal-actions button {\n    padding: 7px 24px;\n    border: none;\n    border-radius: 6px;\n    font-size: 13px;\n    cursor: pointer;\n  }\n  .modal-actions .btn-primary {\n    background: var(--fg);\n    color: var(--bg);\n  }\n  .modal-actions .btn-primary:hover { opacity: 0.85; }\n  .modal-actions .btn-secondary {\n    background: var(--sidebar-hover);\n    color: var(--fg);\n  }\n  .modal-actions .btn-secondary:hover { background: var(--sidebar-active); }\n  .export-option {\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    padding: 8px 0;\n    font-size: 13px;\n    color: var(--fg);\n  }\n  .export-option input[type=\"checkbox\"] {\n    width: 16px;\n    height: 16px;\n    accent-color: var(--link);\n  }\n  .export-option label {\n    cursor: pointer;\n  }\n  .export-option .export-hint {\n    font-size: 11px;\n    color: var(--muted);\n    margin-left: auto;\n  }\n  .modal-updated {\n    font-size: 11px;\n    color: var(--muted);\n    margin-bottom: 12px;\n  }\n  .shortcuts-grid {\n    display: grid;\n    grid-template-columns: auto 1fr;\n    gap: 6px 14px;\n    margin: 12px 0;\n    font-size: 13px;\n  }\n  .shortcuts-grid kbd {\n    background: var(--code-bg);\n    border: 1px solid var(--border);\n    border-radius: 3px;\n    padding: 2px 7px;\n    font-size: 12px;\n    font-family: inherit;\n    text-align: center;\n  }\n  .shortcuts-grid span { color: var(--fg); }\n\n  /* Drop file highlight */\n  .drop-highlight .content-pane {\n    outline: 3px dashed var(--link);\n    outline-offset: -3px;\n  }\n\n  /* Onboarding overlay */\n  .onboarding-overlay {\n    position: fixed;\n    top: 0; left: 0; right: 0; bottom: 0;\n    background: rgba(0, 0, 0, 0.55);\n    z-index: 100;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    animation: fadeIn 0.3s ease;\n  }\n  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }\n  .onboarding-card {\n    background: var(--bg);\n    border: 1px solid var(--border);\n    border-radius: 12px;\n    padding: 32px 36px;\n    max-width: 520px;\n    width: 92%;\n    box-shadow: 0 16px 48px rgba(0,0,0,0.2);\n    max-height: 85vh;\n    overflow-y: auto;\n  }\n  .onboarding-card h2 {\n    font-size: 22px;\n    margin-bottom: 6px;\n    color: var(--fg);\n  }\n  .onboarding-card .ob-subtitle {\n    font-size: 14px;\n    line-height: 1.6;\n    color: var(--muted);\n    margin-bottom: 20px;\n  }\n  .ob-progress {\n    display: flex;\n    gap: 4px;\n    margin-bottom: 24px;\n  }\n  .ob-progress-bar {\n    flex: 1;\n    height: 4px;\n    border-radius: 2px;\n    background: var(--border);\n    transition: background 0.2s;\n  }\n  .ob-progress-bar.active { background: var(--link); }\n  .ob-features {\n    display: flex;\n    gap: 8px;\n    flex-wrap: wrap;\n    margin: 16px 0;\n  }\n  .ob-feature-pill {\n    display: inline-flex;\n    align-items: center;\n    gap: 5px;\n    padding: 5px 12px;\n    background: color-mix(in srgb, var(--fg) 6%, transparent);\n    border-radius: 14px;\n    font-size: 12px;\n    color: var(--fg);\n  }\n  .ob-glass-card {\n    background: color-mix(in srgb, var(--fg) 4%, transparent);\n    border: 1px solid var(--border);\n    border-radius: 10px;\n    padding: 16px;\n    margin-bottom: 16px;\n  }\n  .ob-glass-card label {\n    display: block;\n    font-size: 12px;\n    font-weight: 500;\n    color: var(--muted);\n    margin-bottom: 6px;\n  }\n  .ob-glass-card input[type=\"text\"] {\n    width: 100%;\n    padding: 8px 10px;\n    border: 1px solid var(--border);\n    border-radius: 6px;\n    background: var(--bg);\n    color: var(--fg);\n    font-size: 13px;\n    font-family: inherit;\n    box-sizing: border-box;\n  }\n  .ob-glass-card input[type=\"text\"]:focus { outline: 2px solid var(--link); border-color: transparent; }\n  .ob-feed-list {\n    list-style: none;\n    padding: 0;\n    margin: 0 0 12px;\n  }\n  .ob-feed-list li {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: 8px 0;\n    border-bottom: 1px solid var(--border);\n    font-size: 13px;\n  }\n  .ob-feed-list li:last-child { border-bottom: none; }\n  .ob-feed-list .ob-feed-name { font-weight: 500; color: var(--fg); }\n  .ob-feed-list .ob-feed-url { font-size: 11px; color: var(--muted); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 260px; }\n  .ob-feed-list button {\n    background: none;\n    border: none;\n    color: var(--muted);\n    cursor: pointer;\n    font-size: 16px;\n    padding: 2px 6px;\n  }\n  .ob-feed-list button:hover { color: var(--fg); }\n  .ob-feed-add {\n    display: flex;\n    gap: 8px;\n    align-items: center;\n  }\n  .ob-feed-add input { flex: 1; }\n  .ob-feed-add button {\n    padding: 7px 14px;\n    background: var(--link);\n    color: #fff;\n    border: none;\n    border-radius: 6px;\n    font-size: 13px;\n    cursor: pointer;\n    white-space: nowrap;\n  }\n  .ob-feed-add button:disabled { opacity: 0.5; cursor: default; }\n  .ob-hint-list {\n    font-size: 12px;\n    color: var(--muted);\n    margin-top: 12px;\n    line-height: 1.8;\n  }\n  .ob-hint-list strong { color: var(--fg); display: inline-block; width: 90px; }\n  .ob-method {\n    display: flex;\n    gap: 12px;\n    align-items: flex-start;\n    padding: 10px 0;\n    border-bottom: 1px solid var(--border);\n    font-size: 13px;\n  }\n  .ob-method:last-child { border-bottom: none; }\n  .ob-method-icon {\n    font-size: 20px;\n    width: 28px;\n    text-align: center;\n    flex-shrink: 0;\n    padding-top: 2px;\n  }\n  .ob-method-title { font-weight: 500; color: var(--fg); }\n  .ob-method-desc { font-size: 12px; color: var(--muted); margin-top: 2px; }\n  .ob-toggle-row {\n    display: flex;\n    align-items: center;\n    gap: 12px;\n    padding: 10px 0;\n  }\n  .ob-toggle-row label { margin-bottom: 0; flex: 1; }\n  .ob-toggle-row .ob-toggle-desc { font-size: 12px; color: var(--muted); margin-top: 2px; font-weight: normal; }\n  .ob-shortcuts {\n    display: grid;\n    grid-template-columns: auto 1fr;\n    gap: 6px 14px;\n    margin: 16px 0;\n    font-size: 13px;\n  }\n  .ob-shortcuts kbd {\n    background: var(--code-bg);\n    border: 1px solid var(--border);\n    border-radius: 3px;\n    padding: 2px 7px;\n    font-size: 12px;\n    font-family: inherit;\n    text-align: center;\n  }\n  .ob-shortcuts span { color: var(--fg); }\n  .ob-nav {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    margin-top: 24px;\n    gap: 12px;\n  }\n  .ob-nav button {\n    padding: 8px 24px;\n    border-radius: 6px;\n    font-size: 14px;\n    cursor: pointer;\n    font-family: inherit;\n    border: 1px solid var(--border);\n    background: var(--bg);\n    color: var(--fg);\n  }\n  .ob-nav button:hover { background: var(--sidebar-active); }\n  .ob-nav .ob-primary {\n    background: var(--fg);\n    color: var(--bg);\n    border-color: var(--fg);\n  }\n  .ob-nav .ob-primary:hover { opacity: 0.85; background: var(--fg); }\n\n  /* Highlights */\n  mark.pr-highlight {\n    border-radius: 2px;\n    padding: 1px 0;\n    cursor: pointer;\n    transition: opacity 0.15s;\n  }\n  mark.pr-highlight:hover { opacity: 0.75; }\n  .pr-highlight.hl-yellow { background: rgba(255, 235, 59, 0.45); }\n  .pr-highlight.hl-green { background: rgba(76, 175, 80, 0.35); }\n  .pr-highlight.hl-blue { background: rgba(66, 165, 245, 0.3); }\n  .pr-highlight.hl-pink { background: rgba(236, 64, 122, 0.3); }\n  [data-theme=\"dark\"] .pr-highlight.hl-yellow { background: rgba(255, 235, 59, 0.3); }\n  [data-theme=\"dark\"] .pr-highlight.hl-green { background: rgba(76, 175, 80, 0.25); }\n  [data-theme=\"dark\"] .pr-highlight.hl-blue { background: rgba(66, 165, 245, 0.25); }\n  [data-theme=\"dark\"] .pr-highlight.hl-pink { background: rgba(236, 64, 122, 0.25); }\n  /* Sepia: shift yellow to amber so it doesn't wash into the warm tan background */\n  [data-theme=\"sepia\"] .pr-highlight.hl-yellow { background: rgba(240, 185, 11, 0.4); }\n  [data-theme=\"sepia\"] .pr-highlight.hl-green { background: rgba(56, 142, 60, 0.35); }\n  [data-theme=\"sepia\"] .pr-highlight.hl-blue { background: rgba(30, 136, 229, 0.3); }\n  [data-theme=\"sepia\"] .pr-highlight.hl-pink { background: rgba(216, 27, 96, 0.3); }\n  /* High-contrast: boost alpha so highlights are clearly visible on pure black */\n  [data-theme=\"high-contrast\"] .pr-highlight.hl-yellow { background: rgba(255, 235, 59, 0.55); }\n  [data-theme=\"high-contrast\"] .pr-highlight.hl-green { background: rgba(76, 175, 80, 0.5); }\n  [data-theme=\"high-contrast\"] .pr-highlight.hl-blue { background: rgba(66, 165, 245, 0.45); }\n  [data-theme=\"high-contrast\"] .pr-highlight.hl-pink { background: rgba(236, 64, 122, 0.45); }\n\n  /* Highlight toolbar (floating) */\n  .hl-toolbar {\n    position: absolute;\n    z-index: 50;\n    display: flex;\n    gap: 4px;\n    padding: 5px 8px;\n    background: var(--toolbar-bg);\n    border: 1px solid var(--border);\n    border-radius: 8px;\n    box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n    animation: fadeIn 0.15s ease;\n  }\n  .hl-toolbar button {\n    width: 22px;\n    height: 22px;\n    border-radius: 50%;\n    border: 2px solid var(--border);\n    cursor: pointer;\n    padding: 0;\n    transition: transform 0.1s;\n  }\n  .hl-toolbar button:hover { transform: scale(1.2); }\n  .hl-toolbar .hl-yellow-btn { background: #ffeb3b; }\n  .hl-toolbar .hl-green-btn { background: #4caf50; }\n  .hl-toolbar .hl-blue-btn { background: #42a5f5; }\n  .hl-toolbar .hl-pink-btn { background: #ec407a; }\n  .hl-toolbar .hl-note-btn {\n    background: var(--bg);\n    width: auto;\n    border-radius: 4px;\n    padding: 0 8px;\n    font-size: 11px;\n    color: var(--fg);\n  }\n\n  /* Annotations panel */\n  .notes-panel {\n    margin-top: 32px;\n    padding: 16px 20px;\n    background: var(--code-bg);\n    border-radius: 8px;\n  }\n  .annotations-heading {\n    font-size: 14px;\n    font-weight: 600;\n    color: var(--muted);\n    margin-bottom: 12px;\n  }\n  .notes-panel textarea {\n    width: 100%;\n    min-height: 80px;\n    padding: 10px;\n    border: 1px solid var(--border);\n    border-radius: 6px;\n    background: var(--bg);\n    color: var(--fg);\n    font-family: inherit;\n    font-size: 14px;\n    line-height: 1.6;\n    resize: vertical;\n    outline: none;\n  }\n  .notes-panel textarea:focus { border-color: var(--link); }\n  .notes-textarea-wrap {\n    position: relative;\n    margin-top: 10px;\n  }\n  .notes-textarea-wrap textarea {\n    margin-top: 0;\n    padding-right: 40px;\n  }\n  .voice-note-btn {\n    position: absolute;\n    top: 8px;\n    right: 8px;\n    width: 28px;\n    height: 28px;\n    border: none;\n    border-radius: 50%;\n    background: var(--sidebar-hover);\n    color: var(--muted);\n    cursor: pointer;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    transition: all 0.15s;\n  }\n  .voice-note-btn:hover { background: var(--sidebar-active); color: var(--fg); }\n  .voice-note-btn.recording {\n    background: #ef4444;\n    color: #fff;\n    animation: pulse-recording 1.5s infinite;\n  }\n  @keyframes pulse-recording {\n    0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.4); }\n    50% { box-shadow: 0 0 0 6px rgba(239,68,68,0); }\n  }\n  .voice-note-btn svg { width: 14px; height: 14px; fill: currentColor; }\n  .notes-save-hint {\n    font-size: 11px;\n    color: var(--muted);\n    margin-top: 4px;\n    text-align: right;\n    font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n  }\n\n  /* Inline annotation indicator */\n  .annotation-marker {\n    display: none;\n  }\n\n  /* Footnote markers — superscript numbers in article text */\n  .footnote-marker {\n    font-size: 0.75em;\n    vertical-align: super;\n    color: var(--link);\n    cursor: pointer;\n    text-decoration: none;\n    padding: 0 1px;\n    font-weight: 600;\n  }\n  .footnote-marker:hover { text-decoration: underline; }\n\n  /* Footnotes section at bottom of article */\n  .footnotes-section {\n    border-top: 1px solid var(--border);\n    margin-top: 32px;\n    padding-top: 16px;\n  }\n  .footnotes-heading {\n    font-size: 14px;\n    font-weight: 600;\n    color: var(--muted);\n    margin-bottom: 12px;\n  }\n  .footnotes-list {\n    list-style: none;\n    padding: 0;\n    margin: 0;\n  }\n  .footnote-entry {\n    padding: 8px 0;\n    font-size: 13px;\n    cursor: pointer;\n    border-bottom: 1px solid var(--border);\n    transition: background 0.15s;\n  }\n  .footnote-entry:last-child { border-bottom: none; }\n  .footnote-entry:hover { background: var(--code-bg); }\n  .footnote-entry.flash { background: var(--code-bg); }\n  .footnote-backref {\n    color: var(--link);\n    font-weight: 600;\n    cursor: pointer;\n    margin-right: 6px;\n  }\n  .footnote-backref:hover { text-decoration: underline; }\n  .footnote-quote {\n    font-style: italic;\n    color: var(--muted);\n  }\n  .footnote-quote::before { content: \"\\201C\"; }\n  .footnote-quote::after { content: \"\\201D\"; }\n  .footnote-note {\n    margin-top: 4px;\n    white-space: pre-wrap;\n    word-break: break-word;\n  }\n\n  /* Annotation popover */\n  .annotation-popover {\n    position: absolute;\n    z-index: 51;\n    width: 280px;\n    background: var(--bg);\n    border: 1px solid var(--border);\n    border-radius: 8px;\n    box-shadow: 0 4px 16px rgba(0,0,0,0.15);\n    padding: 12px;\n    animation: fadeIn 0.15s ease;\n  }\n  .annotation-popover textarea {\n    width: 100%;\n    min-height: 60px;\n    padding: 8px;\n    border: 1px solid var(--border);\n    border-radius: 4px;\n    background: var(--bg);\n    color: var(--fg);\n    font-family: inherit;\n    font-size: 13px;\n    resize: vertical;\n    outline: none;\n  }\n  .annotation-popover textarea:focus { border-color: var(--link); }\n  .annotation-popover .btn-row {\n    display: flex;\n    justify-content: flex-end;\n    gap: 6px;\n    margin-top: 8px;\n  }\n  .annotation-popover button {\n    padding: 4px 12px;\n    border: 1px solid var(--border);\n    border-radius: 4px;\n    background: var(--bg);\n    color: var(--fg);\n    font-size: 12px;\n    cursor: pointer;\n  }\n  .annotation-popover button.primary {\n    background: var(--fg);\n    color: var(--bg);\n    border-color: var(--fg);\n  }\n\n  /* Highlight indicator dot on sidebar items */\n  .file-item-indicators {\n    display: flex;\n    gap: 4px;\n    margin-top: 3px;\n  }\n  .file-item-indicators .dot {\n    width: 6px;\n    height: 6px;\n    border-radius: 50%;\n  }\n  .dot-highlight { background: #ffeb3b; }\n  .dot-note { background: var(--link); }\n  .dot-summary { background: var(--muted); opacity: 0.6; }\n  .dot-favorite { color: #e91e63; font-size: 8px; line-height: 6px; }\n\n  /* Highlight note marker (small icon after highlighted text) */\n  .hl-note-marker {\n    display: inline-block;\n    width: 13px;\n    height: 13px;\n    background: var(--muted);\n    color: var(--bg);\n    border-radius: 50%;\n    font-size: 8px;\n    text-align: center;\n    line-height: 13px;\n    cursor: pointer;\n    vertical-align: super;\n    margin-left: 1px;\n    font-family: -apple-system, sans-serif;\n    opacity: 0.7;\n  }\n  .hl-note-marker:hover { opacity: 1; }\n\n  /* Tags input */\n  .tags-row {\n    display: flex;\n    align-items: center;\n    gap: 6px;\n    flex-wrap: wrap;\n  }\n  .tags-row .tag {\n    display: inline-flex;\n    align-items: center;\n    gap: 3px;\n    padding: 2px 8px;\n    background: var(--bg);\n    border: 1px solid var(--border);\n    border-radius: 12px;\n    font-size: 11px;\n    color: var(--fg);\n    font-family: inherit;\n  }\n  .tags-row .tag-machine {\n    opacity: 0.6;\n  }\n  .tags-row .tag .tag-remove {\n    cursor: pointer;\n    opacity: 0.5;\n    font-size: 13px;\n    line-height: 1;\n  }\n  .tags-row .tag .tag-remove:hover { opacity: 1; }\n  .tags-row input {\n    border: none;\n    background: transparent;\n    color: var(--fg);\n    font-size: 12px;\n    outline: none;\n    width: 100px;\n    font-family: inherit;\n  }\n\n  /* Summary display */\n  .article-summary {\n    background: color-mix(in srgb, var(--fg) 4%, transparent);\n    border: 1px solid color-mix(in srgb, var(--fg) 8%, transparent);\n    padding: 14px 16px;\n    margin: 12px 0 20px;\n    font-size: 14px;\n    line-height: 1.65;\n    color: var(--fg);\n    border-radius: 8px;\n    font-family: inherit;\n  }\n  .article-summary .summary-header {\n    display: flex;\n    justify-content: space-between;\n    align-items: center;\n    margin-bottom: 8px;\n    gap: 8px;\n  }\n  .article-summary .summary-header-left {\n    display: flex;\n    align-items: center;\n    gap: 6px;\n    flex-wrap: wrap;\n  }\n  .article-summary .summary-actions {\n    display: flex;\n    gap: 6px;\n    align-items: center;\n    flex-shrink: 0;\n  }\n  .article-summary .summary-actions button {\n    background: none;\n    border: none;\n    color: var(--muted);\n    cursor: pointer;\n    font-size: 12px;\n    padding: 0 2px;\n    line-height: 1;\n  }\n  .article-summary .summary-actions button:hover { color: var(--fg); }\n\n  /* Flat badges (summary provider, tags, etc.) */\n  .badge {\n    display: inline-flex;\n    align-items: center;\n    border-radius: 5px;\n    padding: 2px 7px;\n    font-size: 11px;\n    font-weight: 500;\n    line-height: 1.4;\n    font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n  }\n  .badge-gray {\n    background: color-mix(in srgb, var(--fg) 8%, transparent);\n    color: var(--muted);\n  }\n  .badge-blue {\n    background: rgba(37, 99, 235, 0.1);\n    color: #2563eb;\n  }\n  [data-theme=\"dark\"] .badge-blue {\n    background: rgba(96, 165, 250, 0.1);\n    color: #60a5fa;\n  }\n  .badge-green {\n    background: rgba(22, 163, 74, 0.1);\n    color: #16a34a;\n  }\n  [data-theme=\"dark\"] .badge-green {\n    background: rgba(74, 222, 128, 0.1);\n    color: #4ade80;\n  }\n  .badge-indigo {\n    background: rgba(79, 70, 229, 0.1);\n    color: #4f46e5;\n  }\n  [data-theme=\"dark\"] .badge-indigo {\n    background: rgba(129, 140, 248, 0.1);\n    color: #818cf8;\n  }\n  .badge-purple {\n    background: rgba(147, 51, 234, 0.1);\n    color: #9333ea;\n  }\n  [data-theme=\"dark\"] .badge-purple {\n    background: rgba(192, 132, 252, 0.1);\n    color: #c084fc;\n  }\n  .badge-amber {\n    background: rgba(217, 119, 6, 0.1);\n    color: #d97706;\n  }\n  [data-theme=\"dark\"] .badge-amber {\n    background: rgba(251, 191, 36, 0.1);\n    color: #fbbf24;\n  }\n  [data-theme=\"sepia\"] .badge-blue { background: rgba(37, 99, 235, 0.08); }\n  [data-theme=\"sepia\"] .badge-green { background: rgba(22, 163, 74, 0.08); }\n  [data-theme=\"sepia\"] .badge-indigo { background: rgba(79, 70, 229, 0.08); }\n  [data-theme=\"sepia\"] .badge-purple { background: rgba(147, 51, 234, 0.08); }\n  [data-theme=\"sepia\"] .badge-amber { background: rgba(217, 119, 6, 0.08); }\n  .summarize-btn {\n    display: inline-block;\n    padding: 3px 10px;\n    font-size: 12px;\n    border: 1px solid var(--border);\n    border-radius: 4px;\n    background: var(--bg);\n    color: var(--fg);\n    cursor: pointer;\n    margin-left: 8px;\n    vertical-align: middle;\n    font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n  }\n  .summarize-btn:hover { border-color: #ab47bc; color: #ab47bc; }\n  .summarize-btn:disabled { opacity: 0.5; cursor: not-allowed; }\n\n  /* Inline SVG icons */\n  .icon { width: 1em; height: 1em; vertical-align: -0.125em; fill: currentColor; display: inline-block; }\n  .icon-sm { width: 0.85em; height: 0.85em; }\n  .icon-lg { width: 1.15em; height: 1.15em; }\n\n  /* YouTube video embed */\n  .yt-embed { position: relative; width: 100%; padding-bottom: 56.25%; height: 0; overflow: hidden; margin: 1em 0; border-radius: 8px; }\n  .yt-embed iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; border-radius: 8px; }\n\n  /* Podcast inline player */\n  .podcast-player { margin: 1em 0; padding: 12px; background: var(--code-bg); border-radius: 8px; display: flex; align-items: center; gap: 10px; }\n  .podcast-player audio { flex: 1; min-width: 0; height: 36px; }\n  .podcast-duration { font-size: 13px; color: var(--muted); white-space: nowrap; }\n  .podcast-description { margin: 0.5em 0 1em; font-size: 13px; color: var(--muted); }\n  .podcast-description summary { cursor: pointer; font-size: 13px; color: var(--muted); }\n  .podcast-description summary:hover { color: var(--fg); }\n  .podcast-description > div { margin-top: 8px; line-height: 1.5; color: var(--fg); }\n  .podcast-description > div p { margin: 0.5em 0; }\n\n  /* Review article link list — link-blog style */\n  .review-content ul {\n    list-style: none;\n    padding-left: 0;\n    margin: 20px 0;\n  }\n  .review-content li {\n    padding: 14px 0;\n    border-bottom: 1px solid var(--border);\n    line-height: 1.5;\n  }\n  .review-content li:last-child { border-bottom: none; }\n  .review-content li a {\n    font-size: 15px;\n    font-weight: 500;\n    color: var(--fg);\n    text-decoration: none;\n    display: block;\n    margin-bottom: 2px;\n  }\n  .review-content li a:hover { color: var(--link); }\n  .review-content li em,\n  .review-content li .review-domain {\n    font-size: 12px;\n    color: var(--muted);\n    font-style: normal;\n  }\n\n  /* Open Questions — hover to start a note */\n  .review-content li { position: relative; }\n  .oq-note-btn {\n    position: absolute;\n    right: 0;\n    top: 50%;\n    transform: translateY(-50%);\n    opacity: 0;\n    transition: opacity 0.15s;\n    background: var(--bg);\n    border: 1px solid var(--border);\n    border-radius: 6px;\n    padding: 3px 8px;\n    font-size: 11px;\n    color: var(--muted);\n    cursor: pointer;\n    white-space: nowrap;\n    font-family: inherit;\n  }\n  .oq-note-btn:hover { color: var(--link); border-color: var(--link); }\n  .review-content li:hover .oq-note-btn { opacity: 1; }\n\n  /* Review links — external link affordance */\n  .review-ext-link {\n    opacity: 0;\n    transition: opacity 0.15s;\n    margin-left: 6px;\n    color: var(--muted);\n    vertical-align: middle;\n  }\n  .review-ext-link:hover { color: var(--link); }\n  .review-content li:hover .review-ext-link { opacity: 1; }\n\n  /* Notebook */\n  .notebook-header {\n    display: flex; align-items: center; justify-content: space-between;\n    margin-bottom: 20px;\n  }\n  .notebook-header h1 { margin: 0; font-size: 22px; font-weight: 600; }\n  .notebook-cards {\n    display: flex; gap: 12px; overflow-x: auto; padding: 4px 0 16px;\n    scrollbar-width: none; -ms-overflow-style: none;\n  }\n  .notebook-cards::-webkit-scrollbar { display: none; }\n  .notebook-card {\n    flex: 0 0 200px; padding: 14px; border-radius: 10px;\n    background: var(--code-bg); cursor: pointer;\n    transition: background 0.15s, transform 0.1s;\n    border: 1px solid transparent;\n  }\n  .notebook-card:hover { background: var(--sidebar-active); transform: translateY(-1px); }\n  .notebook-card.active { border-color: var(--link); }\n  .notebook-card-title {\n    font-size: 13px; font-weight: 600; margin-bottom: 6px;\n    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;\n  }\n  .notebook-card-snippet {\n    font-size: 11px; color: var(--muted); line-height: 1.4;\n    display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical;\n    overflow: hidden;\n  }\n  .notebook-card-date { font-size: 10px; color: var(--muted); margin-top: 8px; }\n  .notebook-empty {\n    text-align: center; padding: 40px 20px; color: var(--muted);\n  }\n  .notebook-empty p { margin: 8px 0; }\n  .notebook-title-input {\n    width: 100%; font-size: 1.6em; font-weight: 700;\n    border: none; border-bottom: 2px solid var(--border);\n    background: transparent; color: var(--fg);\n    padding: 8px 0; margin-bottom: 16px;\n    font-family: inherit; outline: none;\n    line-height: 1.25;\n  }\n  .notebook-title-input:focus { border-bottom-color: var(--link); }\n  .notebook-editor-wrap {\n    position: relative;\n  }\n  .notebook-editor textarea {\n    width: 100%; min-height: 400px;\n    font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;\n    font-size: 14px; line-height: 1.7;\n    border: none;\n    padding: 16px 0; background: transparent; color: var(--fg);\n    resize: vertical; outline: none;\n    tab-size: 2;\n    overflow-wrap: break-word;\n    word-break: break-word;\n  }\n  .notebook-preview {\n    min-height: 400px; padding: 16px 0;\n    overflow-wrap: break-word;\n    word-break: break-word;\n  }\n  .notebook-toolbar {\n    display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; align-items: center;\n  }\n  .notebook-toolbar button {\n    border: none; border-radius: 6px; background: var(--code-bg);\n    color: var(--fg); font-size: 12px; font-weight: 500;\n    padding: 5px 12px; cursor: pointer; transition: background 0.15s;\n    font-family: inherit;\n  }\n  .notebook-toolbar button:hover { background: var(--sidebar-active); }\n  .notebook-toolbar button.active { background: var(--link); color: #fff; }\n  .notebook-toolbar .save-hint {\n    font-size: 11px; color: var(--muted); margin-left: auto;\n  }\n  .notebook-sources {\n    display: flex; gap: 6px; flex-wrap: wrap; margin-top: 16px; align-items: center;\n  }\n  .notebook-sources-label { font-size: 11px; font-weight: 600; color: var(--muted); text-transform: uppercase; letter-spacing: 0.5px; }\n  .notebook-source-chip {\n    font-size: 11px; padding: 2px 8px;\n    border-radius: 12px; background: var(--code-bg);\n    color: var(--fg); cursor: pointer; transition: background 0.15s;\n  }\n  .notebook-source-chip:hover { background: var(--sidebar-active); }\n  .notebook-ref {\n    display: inline-flex; align-items: center; gap: 4px;\n    font-size: 11px; color: var(--link); cursor: pointer;\n    padding: 2px 8px; border-radius: 12px; background: color-mix(in srgb, var(--link) 8%, transparent);\n    margin-left: 8px;\n  }\n  .notebook-ref:hover { background: color-mix(in srgb, var(--link) 15%, transparent); }\n\n  /* Note item in sidebar */\n  .file-item.note-item .file-item-title {\n    color: var(--fg);\n  }\n  .sidebar-section-label {\n    font-size: 10px;\n    font-weight: 600;\n    color: var(--muted);\n    text-transform: uppercase;\n    letter-spacing: 0.5px;\n    padding: 12px 12px 4px;\n  }\n  /* Full-page note editor */\n  .note-page .notebook-editor textarea {\n    min-height: 400px;\n  }\n  .note-title-input {\n    display: block;\n    width: 100%;\n    font-size: 1.6em;\n    line-height: 1.25;\n    font-weight: 700;\n    color: var(--fg);\n    background: transparent;\n    border: none;\n    outline: none;\n    padding: 0;\n    margin: 0 0 8px;\n    font-family: inherit;\n  }\n  .note-title-input::placeholder {\n    color: var(--muted);\n    opacity: 0.5;\n  }\n  .note-delete-btn {\n    color: var(--muted) !important;\n  }\n  .note-delete-btn:hover {\n    color: #e74c3c !important;\n  }\n  .new-note-btn {\n    display: inline-flex;\n    align-items: center;\n    gap: 4px;\n    padding: 5px 12px;\n    border: 1px dashed var(--border);\n    border-radius: 8px;\n    background: transparent;\n    color: var(--link);\n    font-size: 12px;\n    font-weight: 500;\n    cursor: pointer;\n    font-family: inherit;\n    transition: background 0.15s, border-color 0.15s;\n  }\n  .new-note-btn:hover {\n    background: color-mix(in srgb, var(--link) 8%, transparent);\n    border-color: var(--link);\n  }\n  .sidebar-new-note {\n    padding: 6px 12px;\n  }\n  /* AI tag suggestions */\n  .nb-tag-suggestions {\n    display: flex; align-items: center; gap: 6px; flex-wrap: wrap;\n    margin-top: 8px; padding: 8px 10px;\n    background: color-mix(in srgb, var(--link) 5%, transparent);\n    border-radius: 8px; font-size: 12px;\n  }\n  .nb-suggest-label { color: var(--muted); font-size: 11px; }\n  .nb-suggest-pill {\n    display: inline-flex; align-items: center; gap: 4px;\n    padding: 3px 10px; border: 1px dashed var(--link); border-radius: 12px;\n    background: transparent; color: var(--link); font-size: 11px;\n    cursor: pointer; font-family: inherit; transition: background 0.15s;\n  }\n  .nb-suggest-pill:hover { background: color-mix(in srgb, var(--link) 10%, transparent); }\n  .nb-suggest-accept { font-weight: 700; font-size: 13px; }\n  .nb-suggest-dismiss {\n    background: none; border: none; color: var(--muted); cursor: pointer;\n    font-size: 14px; padding: 0 4px; margin-left: auto;\n  }\n  .nb-suggest-dismiss:hover { color: var(--fg); }\n\n  /* Grammar check results (LanguageTool) */\n  /* Grammar mirror overlay — positioned behind transparent textarea */\n  .grammar-mirror {\n    position: absolute;\n    top: 0; left: 0; right: 0; bottom: 0;\n    pointer-events: none;\n    overflow: hidden;\n    white-space: pre-wrap;\n    word-wrap: break-word;\n    overflow-wrap: break-word;\n    word-break: break-word;\n    color: transparent;\n    z-index: 0;\n  }\n  .notebook-editor textarea { position: relative; z-index: 1; }\n  .grammar-underline {\n    text-decoration: wavy underline #e74c3c;\n    text-decoration-skip-ink: none;\n    text-underline-offset: 2px;\n    pointer-events: auto;\n    cursor: pointer;\n    color: transparent;\n  }\n  .grammar-tooltip {\n    z-index: 1000;\n    background: var(--bg);\n    border: 1px solid var(--border);\n    border-radius: 8px;\n    padding: 8px 12px;\n    box-shadow: 0 4px 16px rgba(0,0,0,0.12);\n    max-width: 300px;\n    font-size: 13px;\n  }\n  .grammar-tooltip-msg { margin-bottom: 6px; color: var(--fg); }\n  .grammar-tooltip-fixes { display: flex; gap: 6px; flex-wrap: wrap; }\n\n  .grammar-results {\n    margin-top: 12px; padding: 12px;\n    background: color-mix(in srgb, var(--fg) 3%, transparent);\n    border-radius: 8px; font-size: 13px;\n  }\n  .grammar-header {\n    display: flex; justify-content: space-between; align-items: center;\n    font-weight: 600; margin-bottom: 8px; font-size: 12px; color: var(--muted);\n  }\n  .grammar-item {\n    padding: 8px 0;\n  }\n  .grammar-item + .grammar-item { border-top: 1px solid var(--border); }\n  .grammar-context { font-size: 12px; color: var(--muted); margin-bottom: 4px; }\n  .grammar-error {\n    color: var(--fg); background: color-mix(in srgb, #e74c3c 15%, transparent);\n    border-bottom: 2px wavy #e74c3c; padding: 1px 2px;\n  }\n  .grammar-message { font-size: 12px; margin-bottom: 6px; }\n  .grammar-fixes { display: flex; gap: 6px; flex-wrap: wrap; }\n  .grammar-fix-btn {\n    padding: 2px 10px; border: 1px solid var(--link); border-radius: 12px;\n    background: transparent; color: var(--link); font-size: 11px;\n    cursor: pointer; font-family: inherit;\n  }\n  .grammar-fix-btn:hover { background: color-mix(in srgb, var(--link) 10%, transparent); }\n  .hl-picker-date-group { margin-bottom: 8px; }\n  .hl-picker-date-header {\n    font-size: 11px; font-weight: 600; color: var(--muted);\n    text-transform: uppercase; letter-spacing: 0.5px;\n    padding: 6px 4px; cursor: pointer; user-select: none;\n  }\n  .hl-picker-date-header:hover { color: var(--fg); }\n  .hl-caret { display: inline-block; transition: transform 0.15s; font-size: 10px; }\n  .hl-caret.collapsed { transform: rotate(-90deg); }\n  .hl-color-dot {\n    width: 8px; height: 8px; border-radius: 50%;\n    flex-shrink: 0; margin-top: 4px;\n  }\n  .hl-picker-group { margin-bottom: 16px; }\n  .hl-picker-group-title {\n    font-size: 12px; font-weight: 600; color: var(--fg);\n    margin-bottom: 6px; padding-bottom: 4px;\n    border-bottom: 1px solid var(--border);\n  }\n  .hl-picker-item {\n    display: flex; align-items: flex-start; gap: 8px;\n    padding: 8px 10px; border-radius: 6px; cursor: pointer;\n    transition: background 0.15s, box-shadow 0.15s;\n    user-select: none;\n  }\n  .hl-picker-item:hover { background: var(--code-bg); }\n  .hl-picker-item.selected {\n    background: color-mix(in srgb, var(--link) 12%, transparent);\n    box-shadow: inset 0 0 0 1.5px var(--link);\n  }\n  .hl-picker-item-text { font-size: 12px; color: var(--fg); line-height: 1.4; }\n\n  /* Writing focus mode — iA Writer-style: current line at full brightness,\n     surrounding text dimmed. No pill/highlight background. */\n  .writing-focus .notebook-editor textarea {\n    caret-color: var(--fg);\n  }\n  .notebook-focus-line {\n    position: absolute;\n    left: 0; right: 0;\n    height: 1.7em;\n    background: transparent;\n    pointer-events: none;\n    transition: top 0.08s ease;\n    z-index: 3;\n    /* Massive inset shadow dims everything outside this element's bounds,\n       leaving the current line text at full brightness (iA Writer style) */\n    box-shadow: 0 -3px 0 0 var(--bg), 0 3px 0 0 var(--bg), 0 0 0 9999px color-mix(in srgb, var(--bg) 70%, transparent);\n  }\n  .writing-focus .notebook-editor textarea::selection {\n    background: color-mix(in srgb, var(--link) 25%, transparent);\n  }\n  /* Full distraction-free overlay */\n  .writing-focus-overlay {\n    position: fixed;\n    inset: 0;\n    z-index: 9000;\n    background: var(--bg);\n    display: flex;\n    flex-direction: column;\n    align-items: center;\n  }\n  .writing-focus-overlay .wf-toolbar {\n    width: 100%;\n    max-width: 720px;\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    padding: 12px 24px;\n    opacity: 0;\n    transition: opacity 0.3s;\n  }\n  .writing-focus-overlay:hover .wf-toolbar,\n  .writing-focus-overlay .wf-toolbar:focus-within { opacity: 1; }\n  .writing-focus-overlay .wf-toolbar button {\n    border: none; background: transparent; color: var(--muted);\n    font-size: 13px; cursor: pointer; font-family: inherit; padding: 4px 10px;\n    border-radius: 4px;\n  }\n  .writing-focus-overlay .wf-toolbar button:hover { color: var(--fg); background: color-mix(in srgb, var(--fg) 6%, transparent); }\n  .writing-focus-overlay .wf-title {\n    font-size: 13px; color: var(--muted); font-weight: 500;\n  }\n  .writing-focus-overlay .wf-body {\n    flex: 1;\n    width: 100%;\n    max-width: 720px;\n    padding: 0 24px 48px;\n    overflow: hidden;\n    position: relative;\n  }\n  .writing-focus-overlay .wf-body textarea {\n    width: 100%; height: 100%;\n    font-family: 'SF Mono', 'Fira Code', 'Cascadia Code', monospace;\n    font-size: 16px; line-height: 1.8;\n    border: none; outline: none; resize: none;\n    background: transparent;\n    color: var(--fg);\n    caret-color: var(--fg);\n    padding-top: 45vh;\n    padding-bottom: 45vh;\n    scrollbar-width: none;\n  }\n  .writing-focus-overlay .wf-body textarea::-webkit-scrollbar {\n    display: none;\n  }\n  .writing-focus-overlay .wf-focus-line {\n    position: absolute;\n    left: 0; right: 0;\n    height: 1.8em;\n    background: transparent;\n    pointer-events: none;\n    transition: top 0.12s ease, height 0.12s ease;\n    z-index: 3;\n    box-shadow: 0 -3px 0 0 var(--bg), 0 3px 0 0 var(--bg), 0 0 0 9999px color-mix(in srgb, var(--bg) 70%, transparent);\n  }\n  .writing-focus-overlay .wf-word-count {\n    font-size: 11px; color: var(--muted);\n  }\n\n  /* Sidebar nav tabs */\n  .sidebar-nav {\n    display: flex;\n    padding: 8px 8px 0;\n    gap: 2px;\n  }\n  .sidebar-nav-tab {\n    flex: 1;\n    padding: 7px 0;\n    font-size: 12px;\n    font-weight: 500;\n    color: var(--muted);\n    background: transparent;\n    border: none;\n    border-bottom: 2px solid transparent;\n    cursor: pointer;\n    transition: color 0.15s, border-color 0.15s;\n    font-family: inherit;\n  }\n  .sidebar-nav-tab:hover { color: var(--fg); }\n  .sidebar-nav-tab.active {\n    color: var(--fg);\n    border-bottom-color: var(--link);\n  }\n\n  /* Reading progress bar */\n  .reading-progress {\n    position: sticky;\n    top: 0;\n    left: 0;\n    right: 0;\n    height: 3px;\n    background: transparent;\n    z-index: 8;\n    pointer-events: none;\n  }\n  .reading-progress-bar {\n    height: 100%;\n    width: 0%;\n    background: var(--link);\n    transition: width 0.1s linear;\n    border-radius: 0 2px 2px 0;\n    opacity: 0.8;\n  }\n\n  /* Read time & word count badge */\n  .read-stats {\n    display: inline-flex;\n    align-items: center;\n    gap: 4px;\n    font-size: 12px;\n    color: var(--muted);\n    font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n  }\n  .read-stats .stat-divider {\n    opacity: 0.4;\n  }\n\n  /* Mini mode — full-screen audio player overlay */\n  .mini-mode-container {\n    position: fixed;\n    top: 50%;\n    left: 50%;\n    transform: translate(-50%, -50%);\n    z-index: 200;\n    width: 360px;\n    max-width: calc(100vw - 32px);\n    background: var(--bg);\n    border: 1px solid var(--border);\n    border-radius: 16px;\n    padding: 24px;\n    box-shadow: 0 8px 40px rgba(0,0,0,0.18);\n    font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n  }\n  .mini-mode-header {\n    display: flex;\n    align-items: center;\n    justify-content: space-between;\n    margin-bottom: 20px;\n  }\n  .mini-mode-brand {\n    font-size: 15px;\n    font-weight: 700;\n    color: var(--fg);\n    letter-spacing: -0.3px;\n  }\n  .mini-mode-expand {\n    border: none;\n    background: none;\n    color: var(--muted);\n    cursor: pointer;\n    padding: 4px;\n    border-radius: 6px;\n    display: flex;\n    align-items: center;\n  }\n  .mini-mode-expand:hover { background: var(--sidebar-hover); color: var(--fg); }\n  .mini-mode-now {\n    text-align: center;\n    margin-bottom: 16px;\n  }\n  .mini-mode-title {\n    font-size: 14px;\n    font-weight: 600;\n    color: var(--fg);\n    white-space: nowrap;\n    overflow: hidden;\n    text-overflow: ellipsis;\n  }\n  .mini-mode-status {\n    font-size: 11px;\n    color: var(--muted);\n    margin-top: 2px;\n  }\n  .mini-mode-controls {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n    gap: 8px;\n    margin-bottom: 12px;\n  }\n  .mini-mode-controls button {\n    border: none;\n    background: none;\n    color: var(--fg);\n    cursor: pointer;\n    padding: 8px;\n    border-radius: 50%;\n    display: flex;\n    align-items: center;\n    justify-content: center;\n  }\n  .mini-mode-controls button:hover { background: var(--sidebar-hover); }\n  .mini-mode-controls svg { width: 18px; height: 18px; fill: currentColor; }\n  .mini-mode-play-btn svg { width: 24px; height: 24px; }\n  .mini-mode-progress {\n    display: flex;\n    align-items: center;\n    gap: 6px;\n    margin-bottom: 12px;\n  }\n  .mini-mode-time {\n    font-size: 10px;\n    color: var(--muted);\n    min-width: 32px;\n    text-align: center;\n    flex-shrink: 0;\n  }\n  .mini-mode-progress-wrap {\n    flex: 1;\n    height: 20px;\n    display: flex;\n    align-items: center;\n    cursor: pointer;\n    user-select: none;\n    -webkit-user-select: none;\n  }\n  .mini-mode-progress-bar {\n    width: 100%;\n    height: 4px;\n    background: var(--border);\n    border-radius: 2px;\n    overflow: hidden;\n  }\n  .mini-mode-progress-fill {\n    height: 100%;\n    background: var(--link);\n    border-radius: 2px;\n    width: 0%;\n    transition: width 0.2s linear;\n  }\n  .mini-mode-speed-btn {\n    font-size: 10px;\n    font-weight: 600;\n    padding: 2px 6px;\n    border: 1px solid var(--border);\n    border-radius: 4px;\n    background: none;\n    color: var(--fg);\n    cursor: pointer;\n    flex-shrink: 0;\n    font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n  }\n  .mini-mode-speed-btn:hover { border-color: var(--muted); }\n  .mini-mode-queue {\n    max-height: 200px;\n    overflow-y: auto;\n  }\n  .mini-mode-queue:empty { display: none; }\n  .mini-mode-queue-item {\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    padding: 5px 6px;\n    border-radius: 6px;\n    font-size: 12px;\n    color: var(--fg);\n    cursor: pointer;\n  }\n  .mini-mode-queue-item:hover { background: var(--sidebar-hover); }\n  .mini-mode-queue-item.playing { color: var(--link); font-weight: 600; }\n\n  /* Hide main UI when mini mode is active */\n  body.mini-mode .sidebar,\n  body.mini-mode .content-pane,\n  body.mini-mode .sidebar-toggle-float,\n  body.mini-mode .aa-settings-btn,\n  body.mini-mode .bottom-bar { display: none !important; }\n  body.mini-mode { background: var(--bg); }\n\n  /* Focus mode: dim all paragraphs except the one closest to center */\n  .focus-mode .content-wrap > p,\n  .focus-mode .content-wrap > blockquote,\n  .focus-mode .content-wrap > ul,\n  .focus-mode .content-wrap > ol,\n  .focus-mode .content-wrap > pre,\n  .focus-mode .content-wrap > h2,\n  .focus-mode .content-wrap > h3,\n  .focus-mode .content-wrap > h4,\n  .focus-mode .content-wrap > table {\n    opacity: 0.25;\n    transition: opacity 0.6s ease;\n  }\n  .focus-mode .content-wrap > .focus-active,\n  .focus-mode .content-wrap > .focus-active + p,\n  .focus-mode .content-wrap > .focus-adjacent {\n    opacity: 1;\n    transition: opacity 0.4s ease;\n  }\n  .focus-mode .content-wrap > .article-header,\n  .focus-mode .content-wrap > .article-summary,\n  .focus-mode .content-wrap > .notes-panel {\n    opacity: 1;\n  }\n\n  /* Table of Contents */\n  .toc-panel {\n    position: sticky;\n    top: 16px;\n    max-height: calc(100vh - 80px);\n    overflow-y: auto;\n    padding: 12px 0;\n    font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n  }\n  .toc-container {\n    position: absolute;\n    left: 12px;\n    top: 0;\n    width: 200px;\n    pointer-events: none;\n    z-index: 4;\n  }\n  .toc-container .toc-panel {\n    pointer-events: all;\n  }\n  .toc-label {\n    font-size: 10px;\n    text-transform: uppercase;\n    letter-spacing: 0.5px;\n    color: var(--muted);\n    margin-bottom: 8px;\n    font-weight: 600;\n  }\n  .toc-list {\n    list-style: none;\n    padding: 0;\n    margin: 0;\n  }\n  .toc-list li {\n    margin: 0;\n  }\n  .toc-list a {\n    display: block;\n    padding: 3px 0;\n    font-size: 12px;\n    line-height: 1.4;\n    color: var(--muted);\n    text-decoration: none;\n    border-left: 2px solid transparent;\n    padding-left: 8px;\n    transition: color 0.15s, border-color 0.15s;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n  }\n  .toc-list a:hover {\n    color: var(--fg);\n  }\n  .toc-list a.toc-active {\n    color: var(--link);\n    border-left-color: var(--link);\n    font-weight: 500;\n  }\n  .toc-list .toc-h3 {\n    padding-left: 20px;\n    font-size: 11px;\n  }\n  @media (max-width: 1400px) {\n    .toc-container { display: none; }\n  }\n\n  /* Resume position indicator */\n  .resume-indicator {\n    position: fixed;\n    bottom: 20px;\n    right: 20px;\n    background: var(--fg);\n    color: var(--bg);\n    padding: 8px 16px;\n    border-radius: 8px;\n    font-size: 13px;\n    font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n    box-shadow: 0 4px 12px rgba(0,0,0,0.2);\n    cursor: pointer;\n    z-index: 50;\n    animation: fadeIn 0.3s ease;\n    opacity: 0.95;\n  }\n  .resume-indicator:hover {\n    opacity: 1;\n  }\n\n  /* Syntax highlighting theme sync */\n  .content-wrap pre code.hljs {\n    background: var(--code-bg);\n    padding: 14px;\n    border-radius: 6px;\n    font-size: 14px;\n    line-height: 1.5;\n  }\n  [data-theme=\"dark\"] .content-wrap pre code.hljs,\n  [data-theme=\"high-contrast\"] .content-wrap pre code.hljs {\n    background: var(--code-bg);\n  }\n  [data-theme=\"sepia\"] .content-wrap pre code.hljs {\n    background: var(--code-bg);\n  }\n\n  /* Diagram rendering (mermaid, d2) */\n  .diagram-container {\n    margin: 16px 0;\n    padding: 16px;\n    border-radius: 8px;\n    background: var(--bg);\n    border: 1px solid var(--border);\n    overflow-x: auto;\n    text-align: center;\n  }\n  .diagram-container svg {\n    max-width: 100%;\n    height: auto;\n  }\n  .diagram-loading {\n    color: var(--muted);\n    font-size: 13px;\n    font-style: italic;\n  }\n  .diagram-error-msg {\n    color: #d32f2f;\n    font-size: 12px;\n    margin-top: 8px;\n  }\n  /* D2 diagrams rendered by kroki always use light theme — invert for dark mode */\n  [data-theme=\"dark\"] .diagram-d2 svg,\n  [data-theme=\"high-contrast\"] .diagram-d2 svg {\n    filter: invert(0.88) hue-rotate(180deg);\n  }\n\n  /* Code block language label */\n  .content-wrap pre {\n    position: relative;\n  }\n  .code-lang-label {\n    position: absolute;\n    top: 0;\n    right: 0;\n    padding: 2px 8px;\n    font-size: 10px;\n    text-transform: uppercase;\n    letter-spacing: 0.5px;\n    color: var(--muted);\n    background: var(--code-bg);\n    border-radius: 0 6px 0 4px;\n    border-bottom: 1px solid var(--border);\n    border-left: 1px solid var(--border);\n    font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n    opacity: 0.7;\n  }\n\n  /* Explore tabs */\n  .explore-tabs {\n    display: flex;\n    gap: 0;\n    border-bottom: 1px solid var(--border);\n    margin: 0 0 20px;\n  }\n  .explore-tab {\n    padding: 10px 18px;\n    font-size: 13px;\n    font-weight: 500;\n    color: var(--muted);\n    background: none;\n    border: none;\n    border-bottom: 2px solid transparent;\n    cursor: pointer;\n    transition: color 0.15s, border-color 0.15s;\n    font-family: inherit;\n    white-space: nowrap;\n  }\n  .explore-tab:hover { color: var(--fg); }\n  .explore-tab.active {\n    color: var(--fg);\n    border-bottom-color: var(--link);\n    font-weight: 600;\n  }\n  .explore-tab-panel { display: none; }\n  .explore-tab-panel.active { display: block; }\n\n  /* Flat tag pills — Tailwind-inspired */\n  .tag-cloud {\n    display: flex;\n    flex-wrap: wrap;\n    gap: 8px;\n    margin: 16px 0;\n  }\n  .tag-pill {\n    display: inline-flex;\n    align-items: center;\n    gap: 5px;\n    padding: 5px 12px;\n    font-size: 12px;\n    font-weight: 500;\n    font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", sans-serif;\n    color: var(--fg);\n    background: var(--code-bg);\n    border: none;\n    border-radius: 6px;\n    cursor: pointer;\n    transition: background 0.15s, color 0.15s, box-shadow 0.15s;\n    white-space: nowrap;\n    line-height: 1.4;\n  }\n  .tag-pill:hover {\n    background: var(--sidebar-active);\n    box-shadow: 0 1px 3px rgba(0,0,0,0.06);\n  }\n  .tag-pill .tag-count {\n    font-size: 10px;\n    font-weight: 400;\n    color: var(--muted);\n    background: color-mix(in srgb, var(--fg) 6%, transparent);\n    padding: 1px 6px;\n    border-radius: 10px;\n    line-height: 1.4;\n  }\n\n  /* Quick filter pills — colored variants */\n  .tag-pill-blue { background: color-mix(in srgb, var(--link) 12%, var(--bg)); color: var(--link); }\n  .tag-pill-blue:hover { background: color-mix(in srgb, var(--link) 22%, var(--bg)); }\n  .tag-pill-green { background: color-mix(in srgb, #22c55e 12%, var(--bg)); color: #16a34a; }\n  .tag-pill-green:hover { background: color-mix(in srgb, #22c55e 22%, var(--bg)); }\n  [data-theme=\"dark\"] .tag-pill-green { color: #4ade80; }\n  .tag-pill-amber { background: color-mix(in srgb, #f59e0b 12%, var(--bg)); color: #d97706; }\n  .tag-pill-amber:hover { background: color-mix(in srgb, #f59e0b 22%, var(--bg)); }\n  [data-theme=\"dark\"] .tag-pill-amber { color: #fbbf24; }\n  .tag-pill-pink { background: color-mix(in srgb, #ec4899 10%, var(--bg)); color: #db2777; }\n  .tag-pill-pink:hover { background: color-mix(in srgb, #ec4899 20%, var(--bg)); }\n  [data-theme=\"dark\"] .tag-pill-pink { color: #f472b6; }\n\n  /* Explore stats bar */\n  /* Settings page */\n  .settings-section {\n    margin-bottom: 32px;\n  }\n  .settings-section h2 {\n    font-size: 16px; font-weight: 600; margin: 0 0 16px;\n    padding-bottom: 8px; border-bottom: 1px solid var(--border);\n  }\n  .settings-row {\n    display: flex; align-items: center; justify-content: space-between;\n    padding: 8px 0; gap: 12px;\n  }\n  .settings-row label {\n    font-size: 13px; font-weight: 500; color: var(--fg);\n    flex-shrink: 0;\n  }\n  .settings-row .settings-desc {\n    font-size: 11px; color: var(--muted); margin-top: 2px;\n  }\n  .settings-row select, .settings-row input[type=\"text\"], .settings-row input[type=\"password\"] {\n    padding: 5px 8px; border: 1px solid var(--border); border-radius: 6px;\n    background: var(--bg); color: var(--fg); font-size: 13px;\n    font-family: inherit; min-width: 160px;\n  }\n  .settings-btn-group {\n    display: flex; gap: 4px;\n  }\n  .settings-btn-group button {\n    border: 1px solid var(--border); border-radius: 6px;\n    background: var(--bg); color: var(--fg);\n    font-size: 12px; padding: 4px 10px; cursor: pointer;\n    font-family: inherit; transition: background 0.15s;\n  }\n  .settings-btn-group button:hover { background: var(--sidebar-active); }\n  .settings-btn-group button.active { background: var(--link); color: #fff; border-color: var(--link); }\n  .settings-status {\n    font-size: 11px; padding: 2px 8px; border-radius: 4px;\n  }\n  .settings-status.ok { color: #22c55e; background: color-mix(in srgb, #22c55e 10%, transparent); }\n  .settings-status.warn { color: #f59e0b; background: color-mix(in srgb, #f59e0b 10%, transparent); }\n\n  .explore-stats {\n    display: flex;\n    gap: 24px;\n    padding: 14px 0;\n    font-size: 13px;\n    color: var(--muted);\n    flex-wrap: wrap;\n    border-bottom: 1px solid var(--border);\n    margin-bottom: 20px;\n  }\n  .explore-stats strong { color: var(--fg); }\n\n  /* Source / domain list */\n  .domain-group {\n    margin: 0 0 2px;\n    padding: 0;\n  }\n  .domain-group-header {\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    font-size: 13px;\n    font-weight: 500;\n    color: var(--fg);\n    padding: 8px 10px;\n    border-radius: 6px;\n    cursor: pointer;\n    transition: background 0.15s;\n  }\n  .domain-group-header:hover { background: var(--code-bg); }\n  .domain-group-count {\n    font-weight: 400;\n    color: var(--muted);\n    font-size: 11px;\n    margin-left: auto;\n  }\n  .domain-group-articles {\n    padding: 0 10px 8px 34px;\n    font-size: 12px;\n  }\n  .domain-group-articles a {\n    display: block;\n    padding: 3px 0;\n    color: var(--muted);\n    text-decoration: none;\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n  }\n  .domain-group-articles a:hover { color: var(--link); }\n\n  /* Ontological connections */\n  .connection-group {\n    margin: 0 0 16px;\n    padding: 14px 16px;\n    background: var(--code-bg);\n    border-radius: 8px;\n  }\n  .connection-group-title {\n    font-size: 13px;\n    font-weight: 600;\n    color: var(--fg);\n    margin-bottom: 8px;\n    display: flex;\n    align-items: center;\n    gap: 6px;\n  }\n  .connection-group-title .conn-tag {\n    font-size: 11px;\n    font-weight: 500;\n    padding: 2px 8px;\n    border-radius: 4px;\n    background: color-mix(in srgb, var(--link) 14%, var(--bg));\n    color: var(--link);\n  }\n  .connection-group-articles {\n    display: flex;\n    flex-direction: column;\n    gap: 4px;\n  }\n  .connection-article {\n    display: flex;\n    align-items: center;\n    gap: 8px;\n    padding: 6px 8px;\n    border-radius: 6px;\n    cursor: pointer;\n    font-size: 12px;\n    color: var(--fg);\n    transition: background 0.15s;\n  }\n  .connection-article:hover { background: var(--sidebar-hover); }\n  .connection-article img {\n    width: 14px;\n    height: 14px;\n    border-radius: 2px;\n    filter: grayscale(100%);\n    flex-shrink: 0;\n  }\n  .connection-article:hover img { filter: grayscale(0%); }\n  .connection-article .conn-domain {\n    font-size: 11px;\n    color: var(--muted);\n    margin-left: auto;\n    white-space: nowrap;\n  }\n\n  /* Most viewed list */\n  .most-viewed-item {\n    display: flex;\n    align-items: center;\n    gap: 10px;\n    padding: 10px 12px;\n    border-radius: 8px;\n    cursor: pointer;\n    transition: background 0.15s;\n  }\n  .most-viewed-item:hover { background: var(--code-bg); }\n  .most-viewed-rank {\n    font-size: 18px;\n    font-weight: 700;\n    color: var(--border);\n    width: 28px;\n    text-align: center;\n    flex-shrink: 0;\n  }\n  .most-viewed-info { flex: 1; min-width: 0; }\n  .most-viewed-title {\n    font-size: 13px;\n    font-weight: 500;\n    color: var(--fg);\n    overflow: hidden;\n    text-overflow: ellipsis;\n    white-space: nowrap;\n  }\n  .most-viewed-meta {\n    font-size: 11px;\n    color: var(--muted);\n    display: flex;\n    align-items: center;\n    gap: 6px;\n    margin-top: 2px;\n  }\n  .most-viewed-meta img {\n    width: 12px;\n    height: 12px;\n    border-radius: 2px;\n    filter: grayscale(100%);\n  }\n  .most-viewed-item:hover .most-viewed-meta img { filter: grayscale(0%); }\n  .most-viewed-pct {\n    font-size: 11px;\n    font-weight: 600;\n    color: var(--link);\n    white-space: nowrap;\n  }\n\n  /* Focus mode toggle button in toolbar */\n  .focus-btn {\n    background: none !important;\n    border: 1px solid transparent !important;\n    font-size: 14px !important;\n    padding: 2px 6px !important;\n    color: var(--muted) !important;\n    cursor: pointer;\n    transition: color 0.15s;\n    display: inline-flex;\n    align-items: center;\n  }\n  .focus-btn .icon { width: 16px; height: 16px; fill: currentColor; }\n  .focus-btn:hover { color: var(--fg) !important; }\n  .focus-btn.active { color: var(--link) !important; }\n\n  /* Print styles */\n  @media print {\n    .toolbar, .sidebar, .sidebar-toggle-float, .skip-link, .margin-notes, .toc-container,\n    .reading-progress, .hl-toolbar, .annotation-popover, .resume-indicator,\n    .article-actions, .notes-panel .tags-row, .notes-panel textarea, .notes-save-hint,\n    .onboarding-overlay, .modal-overlay, .settings-dropdown-panel,\n    .bottom-bar, .mini-mode-container { display: none !important; }\n\n    body, .app, .main, .content-pane {\n      height: auto !important;\n      overflow: visible !important;\n      background: white !important;\n      color: black !important;\n    }\n    .content-pane {\n      position: static !important;\n    }\n    .content-wrap {\n      max-width: 100% !important;\n      padding: 0 !important;\n      font-size: 12pt !important;\n      line-height: 1.6 !important;\n      color: black !important;\n    }\n    .content-wrap a { color: #333 !important; text-decoration: underline !important; }\n    .content-wrap a::after { content: \" (\" attr(href) \")\"; font-size: 9pt; color: #666; }\n    .content-wrap a[href^=\"#\"]::after, .content-wrap a[href^=\"javascript\"]::after { content: none; }\n    .content-wrap img { max-width: 100% !important; break-inside: avoid; }\n    .content-wrap pre { break-inside: avoid; border: 1px solid #ddd !important; background: #f9f9f9 !important; }\n    .content-wrap blockquote { border-left-color: #999 !important; color: #333 !important; }\n    .article-header { border-bottom: 1px solid #ccc !important; }\n    .article-summary { border-left-color: #999 !important; background: #f5f5f5 !important; break-inside: avoid; }\n    mark.pr-highlight { background: #ff0 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }\n\n    /* Print footnotes and notes section at end */\n    .footnotes-section {\n      display: block !important;\n      border-top: 1px solid #ccc !important;\n      page-break-before: auto;\n    }\n    .footnote-marker { color: #333 !important; }\n    .notes-panel {\n      display: block !important;\n      border-top: 1px solid #ccc !important;\n      background: #f5f5f5 !important;\n      page-break-before: auto;\n    }\n\n    @page {\n      margin: 2cm;\n      @bottom-center { content: counter(page); }\n    }\n  }\n\n\n</style>\n</head>\n<body data-theme=\"light\" class=\"font-serif size-medium\">\n<a href=\"#content-pane\" class=\"skip-link\">Skip to content</a>\n<!-- SVG icon sprite (FontAwesome Free solid/regular, inlined for fully offline use) -->\n<svg xmlns=\"http://www.w3.org/2000/svg\" style=\"display:none\" aria-hidden=\"true\">\n  <symbol id=\"i-bars\" viewBox=\"0 0 448 512\"><path d=\"M0 96C0 78.3 14.3 64 32 64h384c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zm0 160c0-17.7 14.3-32 32-32h384c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zm448 160c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32h384c17.7 0 32 14.3 32 32z\"/></symbol>\n  <symbol id=\"i-gear\" viewBox=\"0 0 512 512\"><path d=\"M495.9 166.6c3.2 8.7.5 18.4-6.4 24.6l-43.3 39.4c1.1 8.3 1.7 16.8 1.7 25.4s-.6 17.1-1.7 25.4l43.3 39.4c6.9 6.2 9.6 15.9 6.4 24.6-4.4 11.9-9.7 23.3-15.8 34.3l-4.7 8.1c-6.6 11-14 21.4-22.1 31.2-5.9 7.2-15.7 9.6-24.5 6.8l-55.7-17.7c-13.4 10.1-28.2 18.3-44 24.4l-12.5 57.1c-2 9.1-9.3 15.5-18.4 17.4-12.2 2.5-24.8 3.8-37.6 3.8s-25.5-1.3-37.6-3.8c-9.2-1.9-16.5-8.3-18.4-17.4l-12.5-57.1c-15.8-6.1-30.6-14.3-44-24.4l-55.7 17.7c-8.8 2.8-18.6.3-24.5-6.8-8.1-9.8-15.5-20.2-22.1-31.2l-4.7-8.1c-6.1-11-11.4-22.4-15.8-34.3-3.2-8.7-.5-18.4 6.4-24.6l43.3-39.4C64.6 273.1 64 264.6 64 256s.6-17.1 1.7-25.4L22.4 191.2c-6.9-6.2-9.6-15.9-6.4-24.6 4.4-11.9 9.7-23.3 15.8-34.3l4.7-8.1c6.6-11 14-21.4 22.1-31.2 5.9-7.2 15.7-9.6 24.5-6.8l55.7 17.7c13.4-10.1 28.2-18.3 44-24.4l12.5-57.1c2-9.1 9.3-15.5 18.4-17.4C226.5 1.3 239.2 0 252 0s25.5 1.3 37.6 3.8c9.2 1.9 16.5 8.3 18.4 17.4l12.5 57.1c15.8 6.1 30.6 14.3 44 24.4l55.7-17.7c8.8-2.8 18.6-.3 24.5 6.8 8.1 9.8 15.5 20.2 22.1 31.2l4.7 8.1c6.1 11 11.4 22.4 15.8 34.3zM256 336a80 80 0 1 0 0-160 80 80 0 1 0 0 160z\"/></symbol>\n  <symbol id=\"i-heart\" viewBox=\"0 0 512 512\"><path d=\"M47.6 300.4L228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6 0 115.2 0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z\"/></symbol>\n  <symbol id=\"i-heart-o\" viewBox=\"0 0 512 512\"><path d=\"M225.8 468.2l-2.5-2.3L48.1 303.2C17.4 274.7 0 234.7 0 192.8v-3.3c0-70.4 50-130.8 119.2-144C158.6 37.9 198.9 47 231 69.6c9 6.3 17.3 13.6 25 21.5 7.7-7.9 16-15.2 25-21.5 32.1-22.6 72.4-31.7 111.8-24.2C461.2 58.7 512 119.1 512 189.5v3.3c0 41.9-17.4 81.9-48.1 110.4L288.7 465.9l-2.5 2.3c-8.2 7.6-19 11.9-30.2 11.9s-22-4.2-30.2-11.9zM239.1 145c-25.9-26.4-60.9-41.2-97.5-34.8-47.6 8.4-83.7 51.3-83.7 100.1v3.3c0 29.4 12.2 57.7 33.6 77.8l166.3 152.2.5.5c2.5 2.3 5.7 3.5 9 3.5s6.5-1.2 9-3.5l.5-.5 166.3-152.2c21.5-20.1 33.6-48.4 33.6-77.8v-3.3c0-48.8-36.1-91.8-83.7-100.1-36.6-6.5-71.6 8.3-97.5 34.8l-17.8 18.2-17.8-18.2z\"/></symbol>\n  <symbol id=\"i-pen\" viewBox=\"0 0 512 512\"><path d=\"M362.7 19.3L314.3 67.7 444.3 197.7l48.4-48.4c25-25 25-65.5 0-90.5L453.3 19.3c-25-25-65.5-25-90.5 0zm-71 71L58.6 323.5c-10.4 10.4-18 23.3-22.2 37.4L1 481.2C-1.5 489.7.8 498.8 7 505s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L421.7 220.3 291.7 90.3z\"/></symbol>\n  <symbol id=\"i-wand\" viewBox=\"0 0 576 512\"><path d=\"M234.7 42.7L197 56.8c-3 1.1-5 4-5 7.2s2 6.1 5 7.2l37.7 14.1L248.8 123c1.1 3 4 5 7.2 5s6.1-2 7.2-5l14.1-37.7L315 71.2c3-1.1 5-4 5-7.2s-2-6.1-5-7.2L277.3 42.7 263.2 5c-1.1-3-4-5-7.2-5s-6.1 2-7.2 5L234.7 42.7zM46.1 395.4c-18.7 18.7-18.7 49.1 0 67.9l34.6 34.6c18.7 18.7 49.1 18.7 67.9 0L529.9 116.5c18.7-18.7 18.7-49.1 0-67.9L495.3 14c-18.7-18.7-49.1-18.7-67.9 0L46.1 395.4zM484.6 82.6l-105 105-23.3-23.3 105-105 23.3 23.3zM7.5 117.2C3 118.9 0 123.2 0 128s3 9.1 7.5 10.8L64 160l21.2 56.5c1.7 4.5 6 7.5 10.8 7.5s9.1-3 10.8-7.5L128 160l56.5-21.2c4.5-1.7 7.5-6 7.5-10.8s-3-9.1-7.5-10.8L128 96 106.8 39.5C105.1 35 100.8 32 96 32s-9.1 3-10.8 7.5L64 96 7.5 117.2zm352 256c-4.5 1.7-7.5 6-7.5 10.8s3 9.1 7.5 10.8L416 416l21.2 56.5c1.7 4.5 6 7.5 10.8 7.5s9.1-3 10.8-7.5L480 416l56.5-21.2c4.5-1.7 7.5-6 7.5-10.8s-3-9.1-7.5-10.8L480 352l-21.2-56.5c-1.7-4.5-6-7.5-10.8-7.5s-9.1 3-10.8 7.5L416 352l-56.5 21.2z\"/></symbol>\n  <symbol id=\"i-globe\" viewBox=\"0 0 512 512\"><path d=\"M352 256c0 22.2-1.2 43.6-3.3 64H163.3c-2.2-20.4-3.3-41.8-3.3-64s1.2-43.6 3.3-64h185.4c2.2 20.4 3.3 41.8 3.3 64zm28.8-64h123.1c5.3 20.5 8.1 41.9 8.1 64s-2.8 43.5-8.1 64H380.8c2.1-20.6 3.2-42 3.2-64s-1.1-43.4-3.2-64zm112.6-32H376.7c-10-63.9-29.8-117.4-55.3-151.6C399.6 29 467.7 90.2 493.4 160zM256 16c30.6 0 66.7 56.5 82.3 144H173.7C189.3 72.5 225.4 16 256 16zM135.3 160H18.6c25.7-69.8 93.8-131 172-151.6-25.5 34.2-45.3 87.7-55.3 151.6zM8.1 192H131.2c-2.1 20.6-3.2 42-3.2 64s1.1 43.4 3.2 64H8.1C2.8 299.5 0 278.1 0 256s2.8-43.5 8.1-64zm10.5 160h116.7c10 63.9 29.8 117.4 55.3 151.6C112.4 483 44.3 421.8 18.6 352zM256 496c-30.6 0-66.7-56.5-82.3-144h164.7C322.7 439.5 286.6 496 256 496zm120.7 7.6c25.5-34.2 45.3-87.7 55.3-151.6h116.7c-25.7 69.8-93.8 131-172 151.6z\"/></symbol>\n  <symbol id=\"i-xmark\" viewBox=\"0 0 384 512\"><path d=\"M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3l105.4 105.3c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256l105.3-105.4z\"/></symbol>\n  <symbol id=\"i-keyboard\" viewBox=\"0 0 576 512\"><path d=\"M64 64C28.7 64 0 92.7 0 128v256c0 35.3 28.7 64 64 64h448c35.3 0 64-28.7 64-64V128c0-35.3-28.7-64-64-64H64zm16 64h32c8.8 0 16 7.2 16 16v32c0 8.8-7.2 16-16 16H80c-8.8 0-16-7.2-16-16v-32c0-8.8 7.2-16 16-16zm112 0h32c8.8 0 16 7.2 16 16v32c0 8.8-7.2 16-16 16h-32c-8.8 0-16-7.2-16-16v-32c0-8.8 7.2-16 16-16zm112 0h32c8.8 0 16 7.2 16 16v32c0 8.8-7.2 16-16 16h-32c-8.8 0-16-7.2-16-16v-32c0-8.8 7.2-16 16-16zm112 0h32c8.8 0 16 7.2 16 16v32c0 8.8-7.2 16-16 16h-32c-8.8 0-16-7.2-16-16v-32c0-8.8 7.2-16 16-16zM80 192h32c8.8 0 16 7.2 16 16v32c0 8.8-7.2 16-16 16H80c-8.8 0-16-7.2-16-16v-32c0-8.8 7.2-16 16-16zm384 0h32c8.8 0 16 7.2 16 16v32c0 8.8-7.2 16-16 16h-32c-8.8 0-16-7.2-16-16v-32c0-8.8 7.2-16 16-16zM80 320h32c8.8 0 16 7.2 16 16v32c0 8.8-7.2 16-16 16H80c-8.8 0-16-7.2-16-16v-32c0-8.8 7.2-16 16-16zm384 0h32c8.8 0 16 7.2 16 16v32c0 8.8-7.2 16-16 16h-32c-8.8 0-16-7.2-16-16v-32c0-8.8 7.2-16 16-16zm-288 0h224c8.8 0 16 7.2 16 16v32c0 8.8-7.2 16-16 16H176c-8.8 0-16-7.2-16-16v-32c0-8.8 7.2-16 16-16z\"/></symbol>\n  <symbol id=\"i-tags\" viewBox=\"0 0 512 512\"><path d=\"M345 39.1L472.8 168.4c52.4 53 52.4 138.2 0 191.2L360.8 472.9c-9.3 9.4-24.5 9.5-33.9.2s-9.5-24.5-.2-33.9L438.6 325.9c33.9-34.3 33.9-89.4 0-123.7L310.9 72.9c-9.3-9.4-9.2-24.6.2-33.9s24.6-9.2 33.9.2zM0 229.5V80C0 53.5 21.5 32 48 32H197.5c17 0 33.3 6.7 45.3 18.7l168 168c25 25 25 65.5 0 90.5L277.3 442.7c-25 25-65.5 25-90.5 0l-168-168C6.7 262.7 0 246.5 0 229.5zM144 144a32 32 0 1 0-64 0 32 32 0 1 0 64 0z\"/></symbol>\n  <symbol id=\"i-book\" viewBox=\"0 0 448 512\"><path d=\"M96 0C43 0 0 43 0 96v320c0 53 43 96 96 96h320c17.7 0 32-14.3 32-32s-14.3-32-32-32v-64c17.7 0 32-14.3 32-32V32c0-17.7-14.3-32-32-32H96zm0 384h256v64H96c-17.7 0-32-14.3-32-32s14.3-32 32-32zm32-240c0-8.8 7.2-16 16-16h192c8.8 0 16 7.2 16 16s-7.2 16-16 16H144c-8.8 0-16-7.2-16-16zm16 48h192c8.8 0 16 7.2 16 16s-7.2 16-16 16H144c-8.8 0-16-7.2-16-16s7.2-16 16-16z\"/></symbol>\n  <symbol id=\"i-calendar\" viewBox=\"0 0 448 512\"><path d=\"M152 24c0-13.3-10.7-24-24-24s-24 10.7-24 24v40H64C28.7 64 0 92.7 0 128v16 48V448c0 35.3 28.7 64 64 64h320c35.3 0 64-28.7 64-64V192 144 128c0-35.3-28.7-64-64-64h-40V24c0-13.3-10.7-24-24-24s-24 10.7-24 24v40H152V24zM48 192h352V448c0 8.8-7.2 16-16 16H64c-8.8 0-16-7.2-16-16V192z\"/></symbol>\n  <symbol id=\"i-refresh\" viewBox=\"0 0 512 512\"><path d=\"M105.1 202.6c7.7-21.8 20.2-42.3 37.8-59.8c62.5-62.5 163.8-62.5 226.3 0L386.3 160 352 160c-17.7 0-32 14.3-32 32s14.3 32 32 32l111.5 0c0 0 0 0 0 0l.4 0c17.7 0 32-14.3 32-32l0-112c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 35.2L414.4 97.6c-87.5-87.5-229.3-87.5-316.8 0C73.2 122 55.6 150.7 44.8 181.4c-5.9 16.7 2.9 34.9 19.5 40.8s34.9-2.9 40.8-19.5zM39 289.3c-5 1.5-9.8 4.2-13.7 8.2c-4 4-6.7 8.8-8.1 14c-.3 1.2-.6 2.5-.8 3.8c-.3 1.7-.4 3.4-.4 5.1L16 432c0 17.7 14.3 32 32 32s32-14.3 32-32l0-35.1 17.6 17.5c87.5 87.4 229.3 87.4 316.7 0c24.4-24.4 42.1-53.1 52.9-83.8c5.9-16.7-2.9-34.9-19.5-40.8s-34.9 2.9-40.8 19.5c-7.7 21.8-20.2 42.3-37.8 59.8c-62.5 62.5-163.8 62.5-226.3 0l-.1-.1L125.6 352l34.4 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L48.4 288c-1.6 0-3.2 .1-4.8 .3s-3.1 .5-4.6 1z\"/></symbol>\n  <symbol id=\"i-share\" viewBox=\"0 0 448 512\"><path d=\"M246.6 9.4c-12.5-12.5-32.8-12.5-45.3 0l-128 128c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 109.3 192 320c0 17.7 14.3 32 32 32s32-14.3 32-32l0-210.7 73.4 73.4c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3l-128-128zM64 352c0-17.7-14.3-32-32-32S0 334.3 0 352l0 64c0 53 43 96 96 96l256 0c53 0 96-43 96-96l0-64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 64c0 17.7-14.3 32-32 32L96 448c-17.7 0-32-14.3-32-32l0-64z\"/></symbol>\n  <symbol id=\"i-external\" viewBox=\"0 0 512 512\"><path d=\"M320 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l82.7 0-201.4 201.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L448 109.3 448 192c0 17.7 14.3 32 32 32s32-14.3 32-32l0-160c0-17.7-14.3-32-32-32L320 0zM80 96C35.8 96 0 131.8 0 176L0 432c0 44.2 35.8 80 80 80l256 0c44.2 0 80-35.8 80-80l0-80c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 80c0 8.8-7.2 16-16 16L80 448c-8.8 0-16-7.2-16-16l0-256c0-8.8 7.2-16 16-16l80 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L80 96z\"/></symbol>\n  <symbol id=\"i-focus\" viewBox=\"0 0 24 24\"><path d=\"M3 7h18v2H3V7zm0 8h18v2H3v-2z\" opacity=\".3\"/><path d=\"M3 13h18v2H3z\"/></symbol>\n  <!-- Brand icons (FontAwesome Free 6.x Brands, CC BY 4.0) -->\n  <symbol id=\"i-bluesky\" viewBox=\"0 0 512 512\"><path d=\"M111.8 62.2C170.2 105.9 233 194.7 256 242.4c23-47.6 85.8-136.4 144.2-180.2c42.1-31.6 110.3-56 110.3 21.8c0 15.5-8.9 130.5-14.1 149.2C478.2 298 412 314.6 353.1 304.5c102.9 17.5 129.1 75.5 72.5 133.5c-107.4 110.2-154.3-27.6-166.3-62.9l0 0c-1.7-4.9-2.6-7.8-3.3-7.8s-1.6 3-3.3 7.8l0 0c-12 35.3-59 173.1-166.3 62.9c-56.5-58-30.4-116 72.5-133.5C100 314.6 33.8 298 15.7 233.1C10.4 214.4 1.5 99.4 1.5 83.9c0-77.8 68.2-53.4 110.3-21.8z\"/></symbol>\n  <symbol id=\"i-threads\" viewBox=\"0 0 448 512\"><path d=\"M331.5 235.7c2.2 .9 4.2 1.9 6.3 2.8c29.2 14.1 50.6 35.2 61.8 61.4c15.7 36.5 17.2 95.8-30.3 143.2c-36.2 36.2-80.3 52.5-142.6 53h-.3c-70.2-.5-124.1-24.1-160.4-70.2c-32.3-41-48.9-98.1-49.5-169.6V256v-.2C17 184.3 33.6 127.2 65.9 86.2C102.2 40.1 156.2 16.5 226.4 16h.3c70.3 .5 124.9 24 162.3 69.9c18.4 22.7 32 50 40.6 81.7l-40.4 10.8c-7.1-25.8-17.8-47.8-32.2-65.4c-29.2-35.8-73-54.2-130.5-54.6c-57 .5-100.1 18.8-128.2 54.4C72.1 146.1 58.5 194.3 58 256c.5 61.7 14.1 109.9 40.3 143.3c28 35.6 71.2 53.9 128.2 54.4c51.4-.4 85.4-12.6 113.7-40.9c32.3-32.2 31.7-71.8 21.4-95.9c-6.1-14.2-17.1-26-31.9-34.9c-3.7 26.9-11.8 48.3-24.7 64.8c-17.1 21.8-41.4 33.6-72.7 35.3c-23.6 1.3-46.3-4.4-63.9-16c-20.8-13.8-33-34.8-34.3-59.3c-2.5-48.3 35.7-83 95.2-86.4c21.1-1.2 40.9-.3 59.2 2.8c-2.4-14.8-7.3-26.6-14.6-35.2c-10-11.7-25.6-17.7-46.2-17.8H227c-16.6 0-39 4.6-53.3 26.3l-34.4-23.6c19.2-29.1 50.3-45.1 87.8-45.1h.8c62.6 .4 99.9 39.5 103.7 107.7l-.2 .2zm-156 68.8c1.3 25.1 28.4 36.8 54.6 35.3c25.6-1.4 54.6-11.4 59.5-73.2c-13.2-2.9-27.8-4.4-43.4-4.4c-4.8 0-9.6 .1-14.4 .4c-42.9 2.4-57.2 23.2-56.2 41.8l-.1 .1z\"/></symbol>\n  <symbol id=\"i-linkedin\" viewBox=\"0 0 448 512\"><path d=\"M100.28 448H7.4V148.9h92.88zM53.79 108.1C24.09 108.1 0 83.5 0 53.8a53.79 53.79 0 0 1 107.58 0c0 29.7-24.1 54.3-53.79 54.3zM447.9 448h-92.68V302.4c0-34.7-.7-79.2-48.29-79.2-48.29 0-55.69 37.7-55.69 76.7V448h-92.78V148.9h89.08v40.8h1.3c12.4-23.5 42.69-48.3 87.88-48.3 94 0 111.28 61.9 111.28 142.3V448z\"/></symbol>\n  <symbol id=\"i-mastodon\" viewBox=\"0 0 448 512\"><path d=\"M433 179.11c0-97.2-63.71-125.7-63.71-125.7-62.52-28.7-228.56-28.4-290.48 0 0 0-63.72 28.5-63.72 125.7 0 115.7-6.6 259.4 105.63 289.1 40.51 10.7 75.32 13 103.33 11.4 50.81-2.8 79.32-18.1 79.32-18.1l-1.7-36.9s-36.31 11.4-77.12 10.1c-40.41-1.4-83-4.4-89.63-54a102.54 102.54 0 0 1-.9-13.9c85.63 20.9 158.65 9.1 178.75 6.7 56.12-6.7 105-41.3 111.23-72.9 9.8-49.8 9-121.5 9-121.5zm-75.12 125.2h-46.63v-114.2c0-49.7-64-51.6-64 6.9v62.5h-46.33V197c0-58.5-64-56.6-64-6.9v114.2H90.19c0-122.1-5.2-147.9 18.41-175 25.9-28.9 79.82-30.8 103.83 6.1l11.6 19.5 11.6-19.5c24.11-37.1 78.12-34.8 103.83-6.1 23.71 27.3 18.4 53 18.4 175z\"/></symbol>\n  <symbol id=\"i-facebook\" viewBox=\"0 0 320 512\"><path d=\"M80 299.3V512H196V299.3h86.5l18-97.8H196V166.9c0-51.7 20.3-71.5 72.7-71.5c16.3 0 29.4 .4 37 1.2V7.9C291.4 4 256.4 0 236.2 0C129.3 0 80 50.5 80 159.4v42.1H14v97.8H80z\"/></symbol>\n  <symbol id=\"i-envelope\" viewBox=\"0 0 512 512\"><path d=\"M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4L236.8 313.6c11.4 8.5 27 8.5 38.4 0L492.8 150.4c12.1-9.1 19.2-23.3 19.2-38.4c0-26.5-21.5-48-48-48L48 64zM0 176L0 384c0 35.3 28.7 64 64 64l384 0c35.3 0 64-28.7 64-64l0-208L294.4 339.2c-22.8 17.1-54 17.1-76.8 0L0 176z\"/></symbol>\n  <symbol id=\"i-comment\" viewBox=\"0 0 512 512\"><path d=\"M512 240c0 114.9-114.6 208-256 208c-37.1 0-72.3-6.4-104.1-17.9c-11.9 8.7-31.3 20.6-54.3 30.6C73.6 471.1 44.7 480 16 480c-6.5 0-12.3-3.9-14.8-9.9c-2.5-6-1.1-12.8 3.4-17.4l.3-.3c.3-.3 .7-.7 1.3-1.4c1.1-1.2 2.8-3.1 4.9-5.7c4.1-5 9.6-12.4 15.2-21.6c10-16.6 19.5-38.4 21.4-62.9C17.7 326.8 0 285.1 0 240C0 125.1 114.6 32 256 32s256 93.1 256 208z\"/></symbol>\n  <symbol id=\"i-link\" viewBox=\"0 0 640 512\"><path d=\"M579.8 267.7c56.5-56.5 56.5-148 0-204.5c-50-50-128.8-56.5-186.3-15.4l-1.6 1.1c-14.4 10.3-17.7 30.3-7.4 44.6s30.3 17.7 44.6 7.4l1.6-1.1c32.1-22.9 76-19.3 103.8 8.6c31.5 31.5 31.5 82.5 0 114L422.3 334.8c-31.5 31.5-82.5 31.5-114 0c-27.9-27.9-31.5-71.8-8.6-103.8l1.1-1.6c10.3-14.4 6.9-34.4-7.4-44.6s-34.4-6.9-44.6 7.4l-1.1 1.6C206.5 251.2 213 330 263 380c56.5 56.5 148 56.5 204.5 0L579.8 267.7zM60.2 244.3c-56.5 56.5-56.5 148 0 204.5c50 50 128.8 56.5 186.3 15.4l1.6-1.1c14.4-10.3 17.7-30.3 7.4-44.6s-30.3-17.7-44.6-7.4l-1.6 1.1c-32.1 22.9-76 19.3-103.8-8.6C74 372 74 321 105.5 289.5L217.7 177.2c31.5-31.5 82.5-31.5 114 0c27.9 27.9 31.5 71.8 8.6 103.9l-1.1 1.6c-10.3 14.4-6.9 34.4 7.4 44.6s34.4 6.9 44.6-7.4l1.1-1.6C433.5 260.8 427 182 377 132c-56.5-56.5-148-56.5-204.5 0L60.2 244.3z\"/></symbol>\n  <symbol id=\"i-cloud-download\" viewBox=\"0 0 640 512\"><path d=\"M144 480C64.5 480 0 415.5 0 336c0-62.8 40.2-116.2 96.2-135.9c-.1-2.7-.2-5.4-.2-8.1c0-88.4 71.6-160 160-160c59.3 0 111 32.2 138.7 80.2C409.9 102 428.3 96 448 96c53 0 96 43 96 96c0 12.2-2.3 23.8-6.4 34.6C596 238.4 640 290.1 640 352c0 70.7-57.3 128-128 128l-368 0zm79-167l80 80c9.4 9.4 24.6 9.4 33.9 0l80-80c9.4-9.4 9.4-24.6 0-33.9s-24.6-9.4-33.9 0l-39 39L344 184c0-13.3-10.7-24-24-24s-24 10.7-24 24l0 134.1-39-39c-9.4-9.4-24.6-9.4-33.9 0s-9.4 24.6 0 33.9z\"/></symbol>\n  <symbol id=\"i-mic\" viewBox=\"0 0 384 512\"><path d=\"M192 0C139 0 96 43 96 96v160c0 53 43 96 96 96s96-43 96-96V96c0-53-43-96-96-96zM64 216c0-13.3-10.7-24-24-24s-24 10.7-24 24v40c0 89.1 66.2 162.7 152 174.4V464H120c-13.3 0-24 10.7-24 24s10.7 24 24 24h144c13.3 0 24-10.7 24-24s-10.7-24-24-24H216V430.4c85.8-11.7 152-85.3 152-174.4V216c0-13.3-10.7-24-24-24s-24 10.7-24 24v40c0 70.7-57.3 128-128 128s-128-57.3-128-128V216z\"/></symbol>\n  <symbol id=\"i-stop\" viewBox=\"0 0 384 512\"><path d=\"M0 128C0 92.7 28.7 64 64 64h256c35.3 0 64 28.7 64 64v256c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V128z\"/></symbol>\n  <symbol id=\"i-volume\" viewBox=\"0 0 640 512\"><path d=\"M533.6 32.5C598.5 85.2 640 165.8 640 256s-41.5 170.7-106.4 223.5c-10.3 8.4-25.4 6.8-33.8-3.5s-6.8-25.4 3.5-33.8C557.5 398.2 592 331.2 592 256s-34.5-142.2-88.7-186.3c-10.3-8.4-11.8-23.5-3.5-33.8s23.5-11.8 33.8-3.5zM473.1 107c43.2 35.2 70.9 88.9 70.9 149s-27.7 113.8-70.9 149c-10.3 8.4-25.4 6.8-33.8-3.5s-6.8-25.4 3.5-33.8C475.3 341.3 496 301.1 496 256s-20.7-85.3-53.2-111.8c-10.3-8.4-11.8-23.5-3.5-33.8s23.5-11.8 33.8-3.5zm-60.5 74.5C434.1 199.1 448 225.9 448 256s-13.9 56.9-35.4 74.5c-10.3 8.4-25.4 6.8-33.8-3.5s-6.8-25.4 3.5-33.8C393.1 284.4 400 271 400 256s-6.9-28.4-17.7-37.3c-10.3-8.4-11.8-23.5-3.5-33.8s23.5-11.8 33.8-3.5zM301.1 34.8C312.6 40 320 51.4 320 64l0 384c0 12.6-7.4 24-18.9 29.2s-25 3.1-34.4-5.3L131.8 352 64 352c-35.3 0-64-28.7-64-64l0-64c0-35.3 28.7-64 64-64l67.8 0L266.7 40.1c9.4-8.4 22.9-10.4 34.4-5.3z\"/></symbol>\n  <symbol id=\"i-eye-slash\" viewBox=\"0 0 640 512\"><path d=\"M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7l-105.2-82.4c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6C557.3 127.4 469.3 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223 149.5c31.5-23.6 70.3-37.5 97-37.5c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L339.4 237.1c2.4-8.3 4.6-17 4.6-25.1c0-44.2-35.8-80-80-80c-8.1 0-16.8 2.2-25.1 4.6L223 149.5zm-60.4 64.9l-60.5-47.4C63.3 200.1 32 228 32 256c0 24.9 17.8 66.9 79.9 118.4C159 416 235.4 448 320 448c45.1 0 86.9-9.6 123.5-25.8l-58.1-45.5c-20.3 9.3-42.8 15.3-65.4 15.3c-79.5 0-144-64.5-144-144c0-22.7 6-44.9 15.3-65.4l-28.7-22.5zm129.8 58.1L188 216.1c-3.4 12.2-5.6 24.9-5.6 39.9c0 61.9 50.1 112 112 112c15 0 27.7-2.2 39.9-5.6L278 317.5c-11.8 5.4-24.3 10.5-38 10.5c-35.3 0-64-28.7-64-64c0-13.7 5.1-26.2 10.5-38z\"/></symbol>\n  <symbol id=\"i-play\" viewBox=\"0 0 384 512\"><path d=\"M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.8 23-24.2 23-41s-8.7-32.2-23-41L73 39z\"/></symbol>\n  <symbol id=\"i-pause\" viewBox=\"0 0 320 512\"><path d=\"M48 64C21.5 64 0 85.5 0 112V400c0 26.5 21.5 48 48 48h32c26.5 0 48-21.5 48-48V112c0-26.5-21.5-48-48-48H48zm192 0c-26.5 0-48 21.5-48 48V400c0 26.5 21.5 48 48 48h32c26.5 0 48-21.5 48-48V112c0-26.5-21.5-48-48-48H240z\"/></symbol>\n  <symbol id=\"i-forward\" viewBox=\"0 0 512 512\"><path d=\"M52.5 440.6c-9.5 7.9-22.8 9.7-34.1 4.4S0 428.4 0 416V96C0 83.6 7.2 72.3 18.4 67s24.5-3.6 34.1 4.4L224 214.3V96c0-12.4 7.2-23.7 18.4-29s24.5-3.6 34.1 4.4l192 160c7.3 6.1 11.5 15.1 11.5 24.6s-4.2 18.5-11.5 24.6l-192 160c-9.5 7.9-22.8 9.7-34.1 4.4S224 428.4 224 416V297.7L52.5 440.6z\"/></symbol>\n  <symbol id=\"i-backward\" viewBox=\"0 0 512 512\"><path d=\"M459.5 440.6c9.5 7.9 22.8 9.7 34.1 4.4S512 428.4 512 416V96c0-12.4-7.2-23.7-18.4-29s-24.5-3.6-34.1 4.4L288 214.3V96c0-12.4-7.2-23.7-18.4-29s-24.5-3.6-34.1 4.4l-192 160C36.2 237.5 32 246.5 32 256s4.2 18.5 11.5 24.6l192 160c9.5 7.9 22.8 9.7 34.1 4.4S288 428.4 288 416V297.7L459.5 440.6z\"/></symbol>\n  <symbol id=\"i-queue\" viewBox=\"0 0 512 512\"><path d=\"M40 48C26.7 48 16 58.7 16 72v48c0 13.3 10.7 24 24 24H472c13.3 0 24-10.7 24-24V72c0-13.3-10.7-24-24-24H40zM40 176c-13.3 0-24 10.7-24 24v48c0 13.3 10.7 24 24 24H472c13.3 0 24-10.7 24-24V200c0-13.3-10.7-24-24-24H40zM16 328c0-13.3 10.7-24 24-24H280c13.3 0 24 10.7 24 24v48c0 13.3-10.7 24-24 24H40c-13.3 0-24-10.7-24-24V328zm320 24v-48c0-13.3 10.7-24 24-24h48V232c0-13.3 10.7-24 24-24s24 10.7 24 24v48h48c13.3 0 24 10.7 24 24v48c0 13.3-10.7 24-24 24H456v48c0 13.3-10.7 24-24 24s-24-10.7-24-24V400H360c-13.3 0-24-10.7-24-24z\"/></symbol>\n  <symbol id=\"i-chevron-down\" viewBox=\"0 0 512 512\"><path d=\"M233.4 406.6c12.5 12.5 32.8 12.5 45.3 0l192-192c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L256 338.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l192 192z\"/></symbol>\n  <symbol id=\"i-sliders\" viewBox=\"0 0 512 512\"><path d=\"M0 416c0 17.7 14.3 32 32 32l54.7 0c12.3 28.3 40.5 48 73.3 48s61-19.7 73.3-48L480 448c17.7 0 32-14.3 32-32s-14.3-32-32-32l-246.7 0c-12.3-28.3-40.5-48-73.3-48s-61 19.7-73.3 48L32 384c-17.7 0-32 14.3-32 32zm128 0a32 32 0 1 1 64 0 32 32 0 1 1 -64 0zM320 256a32 32 0 1 1 64 0 32 32 0 1 1 -64 0zm32-80c-32.8 0-61 19.7-73.3 48L32 224c-17.7 0-32 14.3-32 32s14.3 32 32 32l246.7 0c12.3 28.3 40.5 48 73.3 48s61-19.7 73.3-48l54.7 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-54.7 0c-12.3-28.3-40.5-48-73.3-48zM192 128a32 32 0 1 1 0-64 32 32 0 1 1 0 64zm73.3-64C253 35.7 224.8 16 192 16s-61 19.7-73.3 48L32 64C14.3 64 0 78.3 0 96s14.3 32 32 32l86.7 0c12.3 28.3 40.5 48 73.3 48s61-19.7 73.3-48L480 128c17.7 0 32-14.3 32-32s-14.3-32-32-32L265.3 64z\"/></symbol>\n  <symbol id=\"i-plus\" viewBox=\"0 0 448 512\"><path d=\"M256 80c0-17.7-14.3-32-32-32s-32 14.3-32 32V224H48c-17.7 0-32 14.3-32 32s14.3 32 32 32H192V432c0 17.7 14.3 32 32 32s32-14.3 32-32V288H400c17.7 0 32-14.3 32-32s-14.3-32-32-32H256V80z\"/></symbol>\n</svg>\n<div class=\"app\" role=\"application\" aria-label=\"PullRead article reader\">\n\n  <div class=\"main\">\n    <aside class=\"sidebar\" id=\"sidebar\" aria-label=\"Article list\">\n      <div class=\"sidebar-header\">\n        <span class=\"brand\" onclick=\"goHome()\" role=\"heading\" aria-level=\"1\">PullRead</span>\n        <div class=\"sidebar-header-actions\">\n          <button class=\"focus-btn\" onclick=\"toggleFocusMode()\" aria-label=\"Toggle focus mode\" title=\"Focus mode (f)\" id=\"focus-btn\"><svg class=\"icon\" aria-hidden=\"true\"><use href=\"#i-focus\"/></svg></button>\n          <button class=\"toolbar-icon-btn\" onclick=\"toggleQuickAdd()\" aria-label=\"Add article by URL\" title=\"Add URL\" id=\"quick-add-btn\"><svg class=\"icon\" aria-hidden=\"true\"><use href=\"#i-plus\"/></svg></button>\n          <button class=\"toolbar-icon-btn\" onclick=\"refreshArticleList()\" aria-label=\"Refresh articles\" title=\"Refresh\" id=\"refresh-btn\"><svg class=\"icon\" aria-hidden=\"true\"><use href=\"#i-refresh\"/></svg></button>\n          <button class=\"sidebar-toggle\" onclick=\"toggleSidebar()\" aria-label=\"Collapse sidebar\" aria-expanded=\"true\" id=\"sidebar-toggle-btn\"><svg class=\"icon\" aria-hidden=\"true\"><use href=\"#i-bars\"/></svg></button>\n        </div>\n      </div>\n      <div class=\"sidebar-nav\" id=\"sidebar-nav\">\n        <button class=\"sidebar-nav-tab active\" data-view=\"home\" onclick=\"switchSidebarView('home')\">Home</button>\n        <button class=\"sidebar-nav-tab\" data-view=\"notebooks\" onclick=\"switchSidebarView('notebooks')\">Notebook</button>\n      </div>\n      <div class=\"sidebar-search\" role=\"search\">\n        <label for=\"search\" class=\"sr-only\">Search articles</label>\n        <input type=\"text\" id=\"search\" placeholder=\"Search... try is:favorite or tag:tech\" oninput=\"filterFiles()\" />\n        <button class=\"search-clear\" id=\"search-clear\" onclick=\"clearSearch()\" aria-label=\"Clear search\">&times;</button>\n      </div>\n      <div class=\"quick-add-row\" id=\"quick-add-row\" style=\"display:none\">\n        <input type=\"url\" id=\"quick-add-input\" placeholder=\"Paste article URL and press Enter\" onkeydown=\"if(event.key==='Enter')quickAddUrl()\" />\n        <button class=\"btn-primary\" onclick=\"quickAddUrl()\" id=\"quick-add-save\" style=\"font-size:12px;padding:4px 10px;white-space:nowrap\">Save</button>\n      </div>\n      <div class=\"file-count\" id=\"file-count\" aria-live=\"polite\" aria-atomic=\"true\">\n        <span id=\"file-count-text\"></span>\n        <span class=\"hide-read-toggle\" id=\"hide-read-toggle\" onclick=\"toggleHideRead()\" title=\"Hide viewed articles\">Hide read</span>\n      </div>\n      <div class=\"file-list\" id=\"file-list\" role=\"listbox\" aria-label=\"Articles\"></div>\n      <div class=\"sidebar-footer\">\n        <button class=\"sidebar-settings-btn\" onclick=\"showSettingsPage()\" aria-label=\"Settings\"><svg class=\"icon icon-sm\" aria-hidden=\"true\" style=\"vertical-align:-1px\"><use href=\"#i-gear\"/></svg> Settings</button>\n      </div>\n    </aside>\n\n    <button class=\"sidebar-toggle-float\" onclick=\"toggleSidebar()\" aria-label=\"Show sidebar\" id=\"sidebar-toggle-float\"><svg class=\"icon\" aria-hidden=\"true\"><use href=\"#i-bars\"/></svg></button>\n\n    <button class=\"aa-settings-btn\" id=\"aa-settings-btn\" onclick=\"toggleSettingsDropdown()\" aria-label=\"Reader settings\" aria-expanded=\"false\">Aa</button>\n\n    <div class=\"bottom-bar hidden\" id=\"audio-player\">\n      <div class=\"bottom-bar-inner\">\n        <div class=\"bottom-bar-now\" id=\"bottom-bar-now\" onclick=\"bottomBarGoToArticle()\">\n          <svg class=\"bottom-bar-icon\" aria-hidden=\"true\"><use href=\"#i-volume\"/></svg>\n          <div class=\"bottom-bar-info\">\n            <span class=\"bottom-bar-title\" id=\"audio-now-label\">No article queued</span>\n            <span class=\"bottom-bar-status\" id=\"audio-now-status\"></span>\n          </div>\n        </div>\n        <div class=\"bottom-bar-controls\">\n          <button onclick=\"ttsSkipPrev()\" title=\"Rewind 15s\" id=\"tts-prev-btn\"><svg><use href=\"#i-backward\"/></svg></button>\n          <button class=\"bottom-bar-play\" onclick=\"ttsTogglePlay()\" title=\"Play/Pause\" id=\"tts-play-btn\"><svg><use href=\"#i-play\"/></svg></button>\n          <button onclick=\"ttsSkipNext()\" title=\"Forward 15s\" id=\"tts-next-btn\"><svg><use href=\"#i-forward\"/></svg></button>\n        </div>\n        <div class=\"bottom-bar-progress-row\">\n          <span class=\"audio-time\" id=\"tts-time-current\">0:00</span>\n          <div class=\"audio-progress-wrap\" id=\"audio-progress-wrap\">\n            <div class=\"audio-progress\"><div class=\"audio-progress-fill\" id=\"tts-progress\"></div></div>\n          </div>\n          <span class=\"audio-time\" id=\"tts-time-total\">0:00</span>\n        </div>\n        <div class=\"bottom-bar-right\">\n          <button class=\"audio-speed-btn\" onclick=\"ttsToggleSpeedSlider()\" title=\"Playback speed\" id=\"tts-speed-btn\">1x</button>\n          <button class=\"bottom-bar-queue-btn\" onclick=\"toggleBottomBarQueue()\" title=\"Queue\" id=\"bottom-bar-queue-toggle\"><svg><use href=\"#i-queue\"/></svg></button>\n          <button class=\"bottom-bar-settings-btn\" onclick=\"showSettingsPage('settings-voice')\" title=\"Voice settings\"><svg><use href=\"#i-sliders\"/></svg></button>\n        </div>\n      </div>\n      <div class=\"bottom-bar-queue\" id=\"audio-queue-section\" style=\"display:none\">\n        <div class=\"audio-queue-header\">\n          <span>Queue</span>\n          <button class=\"audio-queue-clear\" onclick=\"ttsClearQueue()\">Clear</button>\n        </div>\n        <div id=\"audio-queue-list\"></div>\n      </div>\n    </div>\n\n    <div class=\"mini-mode-container\" id=\"mini-mode-container\" style=\"display:none\">\n      <div class=\"mini-mode-header\">\n        <span class=\"mini-mode-brand\">PullRead</span>\n        <button class=\"mini-mode-expand\" onclick=\"toggleMiniMode()\" title=\"Exit mini mode\">\n          <svg class=\"icon icon-sm\" aria-hidden=\"true\"><use href=\"#i-bars\"/></svg>\n        </button>\n      </div>\n      <div class=\"mini-mode-now\">\n        <div class=\"mini-mode-title\" id=\"mini-mode-title\">No article playing</div>\n        <div class=\"mini-mode-status\" id=\"mini-mode-status\"></div>\n      </div>\n      <div class=\"mini-mode-controls\">\n        <button onclick=\"ttsSkipPrev()\" title=\"Rewind 15s\"><svg><use href=\"#i-backward\"/></svg></button>\n        <button class=\"mini-mode-play-btn\" onclick=\"ttsTogglePlay()\" title=\"Play/Pause\" id=\"mini-mode-play-btn\"><svg><use href=\"#i-play\"/></svg></button>\n        <button onclick=\"ttsSkipNext()\" title=\"Forward 15s\"><svg><use href=\"#i-forward\"/></svg></button>\n      </div>\n      <div class=\"mini-mode-progress\">\n        <span class=\"mini-mode-time\" id=\"mini-mode-time-current\">0:00</span>\n        <div class=\"mini-mode-progress-wrap\" id=\"mini-mode-progress-wrap\">\n          <div class=\"mini-mode-progress-bar\"><div class=\"mini-mode-progress-fill\" id=\"mini-mode-progress-fill\"></div></div>\n        </div>\n        <span class=\"mini-mode-time\" id=\"mini-mode-time-total\">0:00</span>\n        <button class=\"mini-mode-speed-btn\" onclick=\"ttsCycleSpeed()\" title=\"Cycle speed\" id=\"mini-mode-speed-btn\">1x</button>\n      </div>\n      <div class=\"mini-mode-queue\" id=\"mini-mode-queue\"></div>\n    </div>\n\n    <main class=\"content-pane\" id=\"content-pane\" aria-label=\"Article content\">\n      <div class=\"reading-progress\" aria-hidden=\"true\"><div class=\"reading-progress-bar\" id=\"reading-progress-bar\"></div></div>\n      <div class=\"empty-state\" id=\"empty-state\">\n        <div class=\"dashboard\" id=\"dashboard\"></div>\n      </div>\n      <article class=\"content-wrap\" id=\"content\" style=\"display:none;\" aria-live=\"polite\"></article>\n      <div class=\"margin-notes\" id=\"margin-notes\" aria-hidden=\"true\"></div>\n      <div class=\"toc-container\" id=\"toc-container\" aria-label=\"Table of contents\"></div>\n    </main>\n  </div>\n\n</div>\n\n<div class=\"onboarding-overlay\" id=\"onboarding\" style=\"display:none\" role=\"dialog\" aria-modal=\"true\" aria-label=\"Welcome to PullRead\">\n  <div class=\"onboarding-card\" id=\"onboarding-card\"></div>\n</div>\n\n<script>\n// ABOUTME: Tauri compatibility shim — loaded before all other viewer modules\n// ABOUTME: Detects Tauri environment and provides cross-platform helpers\n\n// Detect if running inside a Tauri WebView\nwindow.PR_TAURI = !!(window.__TAURI__ || window.__TAURI_INTERNALS__);\n\n/**\n * Cross-platform folder picker.\n * Uses Tauri dialog plugin when available, falls back to /api/pick-folder.\n */\nwindow.prPickFolder = async function () {\n  if (window.PR_TAURI) {\n    try {\n      const { open } = window.__TAURI__.dialog || await import('@tauri-apps/plugin-dialog');\n      const path = await open({ directory: true, title: 'Choose Output Folder' });\n      if (path) return { path: path };\n      return { cancelled: true };\n    } catch (e) {\n      console.warn('Tauri dialog failed, falling back to API:', e);\n    }\n  }\n  // Fallback: use the Bun server's osascript-based picker\n  try {\n    var res = await fetch('/api/pick-folder', { method: 'POST' });\n    return await res.json();\n  } catch (e) {\n    return { cancelled: true, error: e.message };\n  }\n};\n\n/**\n * Listen for file-change events from the Tauri backend.\n * Falls back to polling /api/files-changed if not in Tauri.\n */\nwindow.prListenFilesChanged = async function (callback) {\n  if (window.PR_TAURI) {\n    try {\n      const { listen } = window.__TAURI__.event || await import('@tauri-apps/api/event');\n      await listen('files:changed', function () { callback(); });\n      return true; // Event-based, no polling needed\n    } catch (e) {\n      console.warn('Tauri event listen failed:', e);\n    }\n  }\n  return false; // Caller should fall back to polling\n};\n\n/**\n * Send a notification via Tauri or ignore silently.\n */\nwindow.prNotify = async function (title, body) {\n  if (window.PR_TAURI) {\n    try {\n      const { sendNotification, isPermissionGranted } = window.__TAURI__.notification || await import('@tauri-apps/plugin-notification');\n      if (await isPermissionGranted()) {\n        sendNotification({ title: title, body: body });\n      }\n    } catch (e) {\n      console.warn('Tauri notification failed:', e);\n    }\n  }\n};\n\n// Log Tauri detection result\nif (window.PR_TAURI) {\n  console.log('[PullRead] Running inside Tauri WebView');\n} else {\n  console.log('[PullRead] Running in standalone browser mode');\n}\n\n// State\nlet allFiles = [];\nlet filteredFiles = [];\nlet displayFiles = []; // after hide-read filter\nlet activeFile = null;\nlet serverMode = false;\nlet hideRead = false;\nlet readArticles = new Set(JSON.parse(localStorage.getItem('pr-read-articles') || '[]'));\nconst PAGE_SIZE = 200; // pagination chunk\nlet displayedCount = 0;\n\n// Mini mode — collapses app to just the audio player\nlet miniMode = false;\n\n// Highlights & Notes state\nlet articleHighlights = []; // highlights for current article\nlet articleNotes = { articleNote: '', annotations: [], tags: [], isFavorite: false }; // notes for current article\nlet allHighlightsIndex = {}; // { filename: [...] } for sidebar indicators\nlet allNotesIndex = {}; // { filename: { articleNote, annotations } } for sidebar indicators\n\n\n// Frontmatter\nfunction parseFrontmatter(text) {\n  const match = text.match(/^---\\n([\\s\\S]*?)\\n---\\n([\\s\\S]*)$/);\n  if (!match) return { meta: null, body: text };\n  const meta = {};\n  match[1].split('\\n').forEach(line => {\n    const idx = line.indexOf(':');\n    if (idx > 0) {\n      const key = line.slice(0, idx).trim();\n      const val = line.slice(idx + 1).trim().replace(/^\"(.*)\"$/, '$1').replace(/\\\\\"/g, '\"');\n      meta[key] = val;\n    }\n  });\n  return { meta, body: match[2] };\n}\n\nfunction escapeHtml(s) {\n  const d = document.createElement('div');\n  d.textContent = s;\n  return d.innerHTML;\n}\n\n// Sanitize rendered HTML to prevent XSS from malicious article content\nfunction sanitizeHtml(html) {\n  if (typeof DOMPurify !== 'undefined') return DOMPurify.sanitize(html);\n  return html;\n}\n\n// Escape a string for safe interpolation inside single-quoted JS strings in onclick attributes\nfunction escapeJsStr(s) {\n  return String(s).replace(/\\\\/g, '\\\\\\\\').replace(/'/g, \"\\\\'\").replace(/\\n/g, '\\\\n');\n}\n\n// Clean up broken markdown patterns that marked.js can't handle\nfunction cleanMarkdown(md) {\n  // Fix image/link patterns split across lines:\n  // [\\n![alt](img)\\n]\\n(url) -> [![alt](img)](url)\n  md = md.replace(/\\[\\s*\\n\\s*(!\\[[^\\]]*\\]\\([^)]*\\))\\s*\\n\\s*\\]\\s*\\n\\s*(\\([^)]*\\))/g, '[$1]$2');\n\n  // Fix simpler case: [text\\n](url) -> [text](url)\n  md = md.replace(/\\[([^\\]]*?)\\s*\\n\\s*\\]\\s*\\n?\\s*(\\([^)]*\\))/g, '[$1]$2');\n\n  // Fix standalone brackets around images: [\\n![alt](url)\\n] without a link\n  md = md.replace(/\\[\\s*\\n(!\\[[^\\]]*\\]\\([^)]*\\))\\s*\\n\\]/g, '$1');\n\n  // Fix image syntax broken by newlines: ![\\nalt\\n]\\n(url) -> ![alt](url)\n  md = md.replace(/!\\[\\s*\\n?\\s*([^\\]]*?)\\s*\\n?\\s*\\]\\s*\\n\\s*(\\([^)]*\\))/g, '![$1]$2');\n\n  // Fix standalone brackets wrapping images on same line: [![alt](img)] -> ![alt](img)\n  md = md.replace(/\\[\\s*(!\\[[^\\]]*\\]\\([^)]*\\))\\s*\\]/g, '$1');\n\n  // Fix broken link-wrapped images where link part is on next line: [![alt](img)]\\n(url)\n  md = md.replace(/(!\\[[^\\]]*\\]\\([^)]*\\))\\s*\\]\\s*\\n\\s*(\\([^)]*\\))/g, '$1');\n\n  // Remove orphaned ](...) on its own line after an image (broken link fragment)\n  md = md.replace(/(!\\[[^\\]]*\\]\\([^)]*\\))\\s*\\n+\\s*\\]\\([^)]*\\)/g, '$1');\n\n  // Collapse linked images where link URL = image URL: [![alt](url)](url) → ![alt](url)\n  md = md.replace(/\\[!\\[([^\\]]*)\\]\\(([^)]+)\\)\\]\\(\\2\\)/g, '![$1]($2)');\n\n  // Simplify Substack CDN proxy URLs in images — these are extremely long and contain\n  // commas/colons that break marked.js. Extract the real image URL from inside.\n  // e.g. ![alt](https://substackcdn.com/image/fetch/w_1456,c_limit,.../https%3A%2F%2Fsubstack-post-media...)\n  // becomes ![alt](https://substack-post-media.s3.amazonaws.com/public/images/abc.png)\n  md = md.replace(/!\\[([^\\]]*)\\]\\((https:\\/\\/substackcdn\\.com\\/image\\/fetch\\/[^)]+)\\)/g, function(m, alt, url) {\n    var inner = url.match(/\\/image\\/fetch\\/[^/]*\\/(https?[:%].*)/);\n    if (inner) {\n      try { return '![' + alt + '](' + decodeURIComponent(inner[1]) + ')'; } catch(e) {}\n      return '![' + alt + '](' + inner[1] + ')';\n    }\n    return m;\n  });\n\n  // Also catch Substack CDN URLs that leaked out of image syntax as raw text on their own line.\n  // These appear when the markdown image syntax broke (e.g. commas terminated the URL).\n  // Pattern: line starting with the raw URL (possibly with a leading \"(\" or broken \"![\" prefix)\n  md = md.replace(/^!?\\[?[^\\]\\n]*\\]?\\(?(https:\\/\\/substackcdn\\.com\\/image\\/fetch\\/[^\\s)]+)\\)?$/gm, function(m, url) {\n    var inner = url.match(/\\/image\\/fetch\\/[^/]*\\/(https?[:%].*)/);\n    if (inner) {\n      try { return '![]('+decodeURIComponent(inner[1])+')'; } catch(e) {}\n      return '![]('+inner[1]+')';\n    }\n    return m;\n  });\n\n  // Remove standalone parenthesized URLs on their own line (leftover link targets)\n  // e.g. a line that is just \"(https://substackcdn.com/image/fetch/...)\"\n  md = md.replace(/^\\(https?:\\/\\/[^)]+\\)\\s*$/gm, '');\n\n  // Remove parenthesized URLs that span multiple lines (long substackcdn URLs wrap)\n  md = md.replace(/^\\(https?:\\/\\/[^\\n)]*\\n[^)]*\\)\\s*$/gm, '');\n\n  // Remove Wayback Machine parenthesized URLs: (/web/20250908.../https://...)\n  md = md.replace(/\\(\\/web\\/\\d+\\/https?:\\/\\/[^)]+\\)/g, '');\n\n  // Remove lone [ or ] on their own line (broken markdown fragments)\n  md = md.replace(/^\\s*[\\[\\]]\\s*$/gm, '');\n\n  // Remove common image accessibility boilerplate from Wayback/archive extractions\n  md = md.replace(/^\\s*Press enter or click to view image in full size\\s*$/gm, '');\n\n  // Clean up PDF LaTeX/math artifacts from arxiv and academic papers\n  md = md.replace(/start_POSTSUBSCRIPT\\b/g, '');\n  md = md.replace(/end_POSTSUBSCRIPT\\b/g, '');\n  md = md.replace(/start_POSTSUPERSCRIPT\\b/g, '');\n  md = md.replace(/end_POSTSUPERSCRIPT\\b/g, '');\n  md = md.replace(/\\\\boldsymbol\\{[^}]*\\}/g, '');\n  md = md.replace(/\\\\mathbb\\{[^}]*\\}/g, '');\n  md = md.replace(/\\\\left[\\\\\\[\\({|]/g, '');\n  md = md.replace(/\\\\right[\\\\\\]\\)}|]/g, '');\n  md = md.replace(/\\\\(?:text|mathrm|mathbf|mathcal|mathit)\\{([^}]*)\\}/g, '$1');\n  md = md.replace(/\\\\(?:frac|sqrt|sum|prod|int|partial|nabla|infty|approx|neq|leq|geq|in|notin|subset|supset|cup|cap|forall|exists)\\b/g, '');\n  md = md.replace(/\\^\\{\\\\prime\\}/g, \"'\");\n  md = md.replace(/\\{([^{}]*)\\}/g, '$1');\n\n  // Remove leftover empty lines from cleanup\n  md = md.replace(/\\n{3,}/g, '\\n\\n');\n\n  return md;\n}\n\n// Shared tag input handler: parses comma/Enter, adds tag, calls callbacks\nfunction handleTagInput(e, getTagsArray, onAdd) {\n  if (e.key === 'Enter' || e.key === ',') {\n    e.preventDefault();\n    var tag = e.target.value.trim().replace(/,/g, '');\n    if (!tag) return;\n    var tags = getTagsArray();\n    if (tags && !tags.includes(tag)) {\n      tags.push(tag);\n      onAdd(tag);\n    }\n    e.target.value = '';\n  }\n}\n\n// Preferences\nfunction setTheme(theme) {\n  document.body.setAttribute('data-theme', theme);\n  document.querySelectorAll('[data-theme-btn]').forEach(b =>\n    b.classList.toggle('active', b.getAttribute('data-theme-btn') === theme)\n  );\n  localStorage.setItem('pr-theme', theme);\n  updateHljsTheme();\n}\n\nfunction setFont(font) {\n  document.body.className = document.body.className.replace(/font-[\\w-]+/, 'font-' + font);\n  localStorage.setItem('pr-font', font);\n}\n\nfunction setSize(size) {\n  document.body.className = document.body.className.replace(/size-\\w+/, 'size-' + size);\n  document.querySelectorAll('[data-size-btn]').forEach(b =>\n    b.classList.toggle('active', b.getAttribute('data-size-btn') === size)\n  );\n  localStorage.setItem('pr-size', size);\n}\n\nfunction toggleSidebar() {\n  const sidebar = document.getElementById('sidebar');\n  sidebar.classList.toggle('collapsed');\n  const isCollapsed = sidebar.classList.contains('collapsed');\n  localStorage.setItem('pr-sidebar', isCollapsed ? '0' : '1');\n  document.getElementById('sidebar-toggle-btn').setAttribute('aria-expanded', !isCollapsed);\n}\n\nfunction setLineHeight(val) {\n  document.body.className = document.body.className.replace(/leading-\\w+/g, '');\n  if (val !== 'default') document.body.classList.add('leading-' + val);\n  localStorage.setItem('pr-leading', val);\n}\n\nfunction setSpacing(val) {\n  document.body.className = document.body.className.replace(/spacing-\\w+/g, '');\n  if (val !== 'default') document.body.classList.add('spacing-' + val);\n  localStorage.setItem('pr-spacing', val);\n}\n\nfunction setWidth(val) {\n  document.body.className = document.body.className.replace(/width-\\w+/g, '');\n  if (val !== 'default') document.body.classList.add('width-' + val);\n  localStorage.setItem('pr-width', val);\n}\n\n\nfunction toggleSettingsDropdown() {\n  const existing = document.querySelector('.settings-dropdown-panel');\n  const btn = document.getElementById('aa-settings-btn');\n  if (existing) { existing.remove(); btn.setAttribute('aria-expanded', 'false'); return; }\n\n  const currentTheme = document.body.getAttribute('data-theme') || 'light';\n  const currentFont = localStorage.getItem('pr-font') || 'serif';\n  const currentSize = localStorage.getItem('pr-size') || 'medium';\n  const currentLeading = localStorage.getItem('pr-leading') || 'default';\n  const currentSpacing = localStorage.getItem('pr-spacing') || 'default';\n  const currentWidth = localStorage.getItem('pr-width') || 'default';\n\n  const panel = document.createElement('div');\n  panel.className = 'settings-dropdown-panel';\n  panel.setAttribute('role', 'region');\n  panel.setAttribute('aria-label', 'Reader settings');\n  panel.onclick = function(e) { e.stopPropagation(); };\n  panel.innerHTML = `\n    <label>Theme</label>\n    <div class=\"setting-row\">\n      <button data-setting=\"theme\" data-val=\"light\" onclick=\"setTheme('light');updateDropdownState()\" ${currentTheme==='light'?'class=\"active\"':''}>Light</button>\n      <button data-setting=\"theme\" data-val=\"dark\" onclick=\"setTheme('dark');updateDropdownState()\" ${currentTheme==='dark'?'class=\"active\"':''}>Dark</button>\n      <button data-setting=\"theme\" data-val=\"sepia\" onclick=\"setTheme('sepia');updateDropdownState()\" ${currentTheme==='sepia'?'class=\"active\"':''}>Sepia</button>\n      <button data-setting=\"theme\" data-val=\"high-contrast\" onclick=\"setTheme('high-contrast');updateDropdownState()\" ${currentTheme==='high-contrast'?'class=\"active\"':''} title=\"High contrast\">Hi-Con</button>\n    </div>\n    <label>Font</label>\n    <div class=\"setting-row\">\n      <select onchange=\"setFont(this.value)\" id=\"font-select\" aria-label=\"Font family\">\n        <option value=\"serif\" ${currentFont==='serif'?'selected':''}>Serif</option>\n        <option value=\"sans\" ${currentFont==='sans'?'selected':''}>Sans-serif</option>\n        <option value=\"system\" ${currentFont==='system'?'selected':''}>Charter</option>\n        <option value=\"mono\" ${currentFont==='mono'?'selected':''}>Monospace</option>\n        <option value=\"inter\" ${currentFont==='inter'?'selected':''}>Inter</option>\n        <option value=\"lora\" ${currentFont==='lora'?'selected':''}>Lora</option>\n        <option value=\"literata\" ${currentFont==='literata'?'selected':''}>Literata</option>\n        <option value=\"source-serif\" ${currentFont==='source-serif'?'selected':''}>Source Serif</option>\n        <option value=\"work-sans\" ${currentFont==='work-sans'?'selected':''}>Work Sans</option>\n        <option value=\"opendyslexic\" ${currentFont==='opendyslexic'?'selected':''}>OpenDyslexic</option>\n      </select>\n    </div>\n    <label>Size</label>\n    <div class=\"setting-row\">\n      <button data-setting=\"size\" data-val=\"small\" onclick=\"setSize('small');updateDropdownState()\" ${currentSize==='small'?'class=\"active\"':''} aria-label=\"Small text\">A</button>\n      <button data-setting=\"size\" data-val=\"medium\" onclick=\"setSize('medium');updateDropdownState()\" ${currentSize==='medium'?'class=\"active\"':''} style=\"font-size:14px\" aria-label=\"Medium text\">A</button>\n      <button data-setting=\"size\" data-val=\"large\" onclick=\"setSize('large');updateDropdownState()\" ${currentSize==='large'?'class=\"active\"':''} style=\"font-size:17px\" aria-label=\"Large text\">A</button>\n    </div>\n    <label>Line height</label>\n    <div class=\"setting-row\">\n      <select onchange=\"setLineHeight(this.value)\" aria-label=\"Line height\">\n        <option value=\"default\" ${currentLeading==='default'?'selected':''}>Default</option>\n        <option value=\"compact\" ${currentLeading==='compact'?'selected':''}>Compact</option>\n        <option value=\"relaxed\" ${currentLeading==='relaxed'?'selected':''}>Relaxed</option>\n        <option value=\"loose\" ${currentLeading==='loose'?'selected':''}>Loose</option>\n      </select>\n    </div>\n    <label>Letter spacing</label>\n    <div class=\"setting-row\">\n      <select onchange=\"setSpacing(this.value)\" aria-label=\"Letter spacing\">\n        <option value=\"default\" ${currentSpacing==='default'?'selected':''}>Default</option>\n        <option value=\"wide\" ${currentSpacing==='wide'?'selected':''}>Wide</option>\n        <option value=\"wider\" ${currentSpacing==='wider'?'selected':''}>Wider</option>\n      </select>\n    </div>\n    <label>Content width</label>\n    <div class=\"setting-row\">\n      <select onchange=\"setWidth(this.value)\" aria-label=\"Content width\">\n        <option value=\"narrow\" ${currentWidth==='narrow'?'selected':''}>Narrow</option>\n        <option value=\"default\" ${currentWidth==='default'?'selected':''}>Default</option>\n        <option value=\"wide\" ${currentWidth==='wide'?'selected':''}>Wide</option>\n      </select>\n    </div>\n    <hr style=\"border:none;border-top:1px solid var(--border);margin:12px 0 8px\">\n    <label>Article</label>\n    <div class=\"setting-row\">\n      <button onclick=\"reprocessCurrentArticle(this)\" id=\"reprocess-btn\" style=\"flex:1;text-align:center\" title=\"Re-fetch this article from the original URL\"><svg class=\"icon icon-sm\" aria-hidden=\"true\" style=\"vertical-align:-1px;margin-right:3px\"><use href=\"#i-cloud-download\"/></svg> Re-fetch from source</button>\n    </div>\n    <hr style=\"border:none;border-top:1px solid var(--border);margin:12px 0 8px\">\n    <div class=\"setting-row\">\n      <button onclick=\"var p=document.querySelector('.settings-dropdown-panel');if(p)p.remove();var b=document.getElementById('aa-settings-btn');if(b)b.setAttribute('aria-expanded','false');showShortcutsModal()\" style=\"flex:1;text-align:center\"><svg class=\"icon icon-sm\" aria-hidden=\"true\" style=\"vertical-align:-1px;margin-right:3px\"><use href=\"#i-keyboard\"/></svg> Keyboard Shortcuts</button>\n    </div>\n  `;\n  document.body.appendChild(panel);\n  btn.setAttribute('aria-expanded', 'true');\n}\n\nfunction updateDropdownState() {\n  const panel = document.querySelector('.settings-dropdown-panel');\n  if (!panel) return;\n  const currentTheme = document.body.getAttribute('data-theme') || 'light';\n  const currentSize = localStorage.getItem('pr-size') || 'medium';\n  // Update theme buttons\n  panel.querySelectorAll('[data-setting=\"theme\"]').forEach(b =>\n    b.classList.toggle('active', b.getAttribute('data-val') === currentTheme)\n  );\n  // Update size buttons\n  panel.querySelectorAll('[data-setting=\"size\"]').forEach(b =>\n    b.classList.toggle('active', b.getAttribute('data-val') === currentSize)\n  );\n}\n\n// Close settings dropdown when clicking outside\ndocument.addEventListener('click', function(e) {\n  const panel = document.querySelector('.settings-dropdown-panel');\n  if (panel && !panel.contains(e.target) && !e.target.closest('#aa-settings-btn')) {\n    panel.remove();\n    var btn = document.getElementById('aa-settings-btn');\n    if (btn) btn.setAttribute('aria-expanded', 'false');\n  }\n});\n\n// ---- Full Settings Page ----\nfunction showSettingsPage(scrollToSection) {\n  activeFile = null;\n  _activeNotebook = null;\n  const content = document.getElementById('content');\n  const empty = document.getElementById('empty-state');\n  empty.style.display = 'none';\n  content.style.display = 'block';\n  document.title = 'Settings — PullRead';\n  document.getElementById('margin-notes').innerHTML = '';\n  renderFileList();\n\n  var currentTheme = document.body.getAttribute('data-theme') || 'light';\n  function themeBtn(val, label) {\n    return '<button class=\"' + (currentTheme === val ? 'active' : '') + '\" onclick=\"setTheme(\\'' + val + '\\');showSettingsPage()\">' + label + '</button>';\n  }\n\n  var html = '<div class=\"article-header\"><h1>Settings</h1></div>';\n\n  // ---- Display section ----\n  html += '<div class=\"settings-section\">';\n  html += '<h2>Display</h2>';\n  html += '<div class=\"settings-row\"><label>Theme</label><div class=\"settings-btn-group\">'\n    + themeBtn('light', 'Light') + themeBtn('dark', 'Dark') + themeBtn('sepia', 'Sepia') + themeBtn('high-contrast', 'Hi-Con')\n    + '</div></div>';\n  html += '<div class=\"settings-row\"><div><label>Article font &amp; layout</label><div class=\"settings-desc\">Font, text size, line height, spacing, and content width</div></div>';\n  html += '<button onclick=\"settingsOpenAa()\" style=\"font-size:13px;padding:6px 14px;background:var(--bg);color:var(--fg);border:1px solid var(--border);border-radius:6px;cursor:pointer;font-family:inherit;white-space:nowrap\">Open Aa reader settings</button>';\n  html += '</div>';\n  html += '</div>';\n\n  // ---- Open In section (Tauri only) ----\n  html += '<div class=\"settings-section\" id=\"settings-viewer-mode\" style=\"display:none\">';\n  html += '<h2>Open In</h2>';\n  html += '<div class=\"settings-row\"><div><label>Viewer window</label><div class=\"settings-desc\">Where PullRead opens when you click View Articles</div></div>';\n  html += '<select id=\"sp-viewer-mode\" onchange=\"settingsPageSaveViewerMode()\">';\n  html += '<option value=\"app\">PullRead window</option>';\n  html += '<option value=\"browser\">Default browser</option>';\n  html += '</select></div>';\n  html += '</div>';\n\n  // ---- Feeds & Sync section (placeholder, loaded async) ----\n  html += '<div class=\"settings-section\" id=\"settings-feeds\">';\n  html += '<h2>Bookmarks &amp; Sync</h2>';\n  html += '<p style=\"color:var(--muted);font-size:13px\">Loading feed configuration...</p>';\n  html += '</div>';\n\n  // ---- Voice Playback section (placeholder, loaded async) ----\n  html += '<div class=\"settings-section\" id=\"settings-voice\">';\n  html += '<h2>Voice Playback</h2>';\n  html += '<p style=\"color:var(--muted);font-size:13px\">Loading voice settings...</p>';\n  html += '</div>';\n\n  // ---- AI Summaries section (placeholder, loaded async) ----\n  html += '<div class=\"settings-section\" id=\"settings-ai\">';\n  html += '<h2>AI Summaries &amp; Tagging</h2>';\n  html += '<p style=\"color:var(--muted);font-size:13px\">Loading AI settings...</p>';\n  html += '</div>';\n\n  // ---- Notifications section ----\n  html += '<div class=\"settings-section\">';\n  html += '<h2>Notifications</h2>';\n  html += '<p style=\"font-size:13px;color:var(--muted);margin-bottom:12px\">PullRead sends notifications when syncs complete, articles are saved, and reviews are ready. Notification sounds are off by default.</p>';\n  html += '<div style=\"display:flex;gap:8px;align-items:flex-start;padding:10px 12px;background:color-mix(in srgb, var(--fg) 4%, transparent);border-radius:8px;font-size:12px;color:var(--muted)\">'\n    + '<span style=\"flex-shrink:0;font-size:14px\">&#9881;</span>'\n    + '<span>To change notification preferences, go to <strong style=\"color:var(--fg)\">System Settings &rarr; Notifications &rarr; PullRead</strong>. You can enable or disable alerts, banners, and sounds there.</span>'\n    + '</div>';\n  html += '</div>';\n\n  // ---- Backup & Restore section ----\n  html += '<div class=\"settings-section\">';\n  html += '<h2>Backup &amp; Restore</h2>';\n  html += '<p style=\"font-size:13px;color:var(--muted);margin-bottom:16px\">Export your settings, highlights, notes, notebooks, and feed configuration to a single file. Use Restore to import a previous backup.</p>';\n  html += '<div class=\"settings-row\" style=\"gap:12px\">';\n  html += '<button class=\"btn-primary\" onclick=\"settingsBackup()\" style=\"font-size:13px;padding:6px 16px\">Download Backup</button>';\n  html += '<button style=\"font-size:13px;padding:6px 16px;background:var(--bg);color:var(--fg);border:1px solid var(--border);border-radius:6px;cursor:pointer\" onclick=\"settingsRestore()\">Restore from File\\u2026</button>';\n  html += '</div>';\n  html += '<div id=\"backup-status\" style=\"font-size:12px;color:var(--muted);padding-top:8px\"></div>';\n  html += '<hr style=\"border:none;border-top:1px solid var(--border);margin:16px 0 12px\">';\n  html += '<div class=\"settings-row\" style=\"gap:12px\">';\n  html += '<button id=\"reimport-all-btn\" style=\"font-size:13px;padding:6px 16px;background:var(--bg);color:var(--fg);border:1px solid var(--border);border-radius:6px;cursor:pointer\" onclick=\"reimportAllArticles()\"><svg class=\"icon icon-sm\" aria-hidden=\"true\" style=\"vertical-align:-1px;margin-right:3px\"><use href=\"#i-cloud-download\"/></svg>Reimport All Articles</button>';\n  html += '</div>';\n  html += '<div id=\"reimport-status\" style=\"font-size:12px;color:var(--muted);padding-top:8px\"></div>';\n  html += '</div>';\n\n  // ---- About section ----\n  html += '<div class=\"settings-section\" id=\"settings-about\">';\n  html += '<h2>About</h2>';\n  html += '<div class=\"settings-row\"><label>Version</label><span id=\"sp-version\" style=\"color:var(--muted);font-size:13px\">Checking\\u2026</span></div>';\n  html += '<div class=\"settings-row\" style=\"gap:12px\">';\n  html += '<button id=\"sp-check-updates-btn\" style=\"font-size:13px;padding:6px 16px;background:var(--bg);color:var(--fg);border:1px solid var(--border);border-radius:6px;cursor:pointer\" onclick=\"settingsCheckForUpdates()\">Check for Updates</button>';\n  html += '<span id=\"sp-update-status\" style=\"font-size:12px;color:var(--muted);align-self:center\"></span>';\n  html += '</div>';\n  html += '</div>';\n\n  content.innerHTML = html;\n  document.getElementById('content-pane').scrollTop = 0;\n\n  if (scrollToSection) {\n    var target = document.getElementById(scrollToSection);\n    if (target) setTimeout(function() { target.scrollIntoView({ behavior: 'smooth' }); }, 50);\n  }\n\n  // Load viewer mode setting (show section when running inside Tauri or always for server mode)\n  if (serverMode) {\n    fetch('/api/settings').then(function(r) { return r.json(); }).then(function(data) {\n      var sec = document.getElementById('settings-viewer-mode');\n      var sel = document.getElementById('sp-viewer-mode');\n      if (sec && sel) {\n        sel.value = data.viewerMode || 'app';\n        sec.style.display = '';\n      }\n    }).catch(function() {});\n  }\n\n  // Load current version\n  if (serverMode) {\n    fetch('/api/check-updates').then(function(r) { return r.json(); }).then(function(data) {\n      var el = document.getElementById('sp-version');\n      if (el) el.textContent = data.currentVersion || 'unknown';\n    }).catch(function() {\n      var el = document.getElementById('sp-version');\n      if (el) el.textContent = 'unknown';\n    });\n  }\n\n  // Load Feeds & Sync config async\n  if (serverMode) {\n    fetch('/api/config').then(function(r) { return r.json(); }).then(function(cfg) {\n      var sec = document.getElementById('settings-feeds');\n      if (!sec) return;\n      var feeds = cfg.feeds || {};\n      var feedNames = Object.keys(feeds);\n\n      var h = '<h2>Bookmarks &amp; Sync</h2>';\n      h += '<p style=\"font-size:13px;color:var(--muted);margin-bottom:16px\">Manage your bookmark feeds, newsletter subscriptions, output folder, and sync options.</p>';\n\n      // Output path\n      h += '<div class=\"settings-row\"><div><label>Output Folder</label><div class=\"settings-desc\">Where articles are saved as markdown</div></div>';\n      h += '<div style=\"display:flex;gap:8px;align-items:center\">';\n      h += '<input type=\"text\" id=\"sp-output-path\" value=\"' + escapeHtml(cfg.outputPath || '') + '\" placeholder=\"~/Documents/PullRead\" style=\"min-width:200px\">';\n      h += '<button onclick=\"pickOutputFolder(\\'sp-output-path\\')\" style=\"white-space:nowrap;padding:5px 12px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--fg);font-size:13px;cursor:pointer;font-family:inherit\">Choose\\u2026</button>';\n      h += '</div></div>';\n\n      // Sync interval\n      h += '<div class=\"settings-row\"><div><label>Auto-sync</label><div class=\"settings-desc\">How often to check for new articles</div></div>';\n      h += '<select id=\"sp-sync-interval\">';\n      var intervals = [['30m','Every 30 min'],['1h','Every hour'],['4h','Every 4 hours'],['12h','Every 12 hours'],['manual','Manual only']];\n      for (var ii = 0; ii < intervals.length; ii++) {\n        h += '<option value=\"' + intervals[ii][0] + '\"' + (cfg.syncInterval === intervals[ii][0] ? ' selected' : '') + '>' + intervals[ii][1] + '</option>';\n      }\n      h += '</select></div>';\n\n      // Browser cookies\n      h += '<div class=\"settings-row\"><div><label>Chrome Cookies</label><div class=\"settings-desc\">Use Chrome login cookies for paywalled sites (local only)</div></div>';\n      h += '<input type=\"checkbox\" id=\"sp-cookies\"' + (cfg.useBrowserCookies ? ' checked' : '') + '>';\n      h += '</div>';\n\n      // Feed list\n      h += '<div style=\"margin-top:16px\"><label style=\"font-size:13px;font-weight:500;margin-bottom:8px;display:block\">Feeds (' + feedNames.length + ')</label>';\n      if (feedNames.length > 0) {\n        h += '<div style=\"border:1px solid var(--border);border-radius:8px;overflow:hidden\">';\n        for (var fi = 0; fi < feedNames.length; fi++) {\n          var fn = feedNames[fi];\n          h += '<div style=\"display:flex;align-items:center;justify-content:space-between;padding:8px 12px;border-bottom:' + (fi < feedNames.length - 1 ? '1px solid var(--border)' : 'none') + ';font-size:13px\">'\n            + '<div><div style=\"font-weight:500\">' + escapeHtml(fn) + '</div><div style=\"font-size:11px;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:300px\">' + escapeHtml(feeds[fn]) + '</div></div>'\n            + '<button onclick=\"settingsRemoveFeed(\\'' + escapeHtml(fn.replace(/'/g, \"\\\\'\")) + '\\')\" style=\"background:none;border:none;cursor:pointer;color:var(--muted);font-size:16px;padding:2px 6px\" title=\"Remove\">&times;</button>'\n            + '</div>';\n        }\n        h += '</div>';\n      }\n      h += '<div style=\"display:flex;gap:8px;margin-top:10px\">'\n        + '<input type=\"text\" id=\"sp-new-feed\" placeholder=\"Paste bookmark feed URL or web address\\u2026\" style=\"flex:1;padding:7px 10px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--fg);font-size:13px;font-family:inherit\" onkeydown=\"if(event.key===\\'Enter\\')settingsAddFeed()\">'\n        + '<button class=\"btn-primary\" onclick=\"settingsAddFeed()\" id=\"sp-add-feed-btn\" style=\"font-size:13px;padding:6px 14px\">Add</button>'\n        + '</div>';\n      h += '<div style=\"font-size:11px;color:var(--muted);margin-top:8px;line-height:1.6\">'\n        + 'Paste a bookmark feed URL from Instapaper, Pinboard, Raindrop, or Pocket. '\n        + 'You can also subscribe to newsletters (Substack, Ghost, Buttondown) and blogs \\u2014 just paste the web address.'\n        + '</div>';\n      h += '<div style=\"display:flex;gap:8px;align-items:flex-start;margin-top:10px;padding:8px 10px;background:color-mix(in srgb, var(--fg) 4%, transparent);border-radius:6px;font-size:11px;color:var(--muted)\">'\n        + '<span style=\"flex-shrink:0\">&#128196;</span>'\n        + '<span>Bookmark services only sync articles you save. Newsletter feeds save every post as a separate file.</span>'\n        + '</div>';\n      h += '</div>';\n\n      h += '<div class=\"settings-row\" style=\"justify-content:flex-end;padding-top:12px\">';\n      h += '<button class=\"btn-primary\" onclick=\"settingsPageSaveConfig()\" style=\"font-size:13px;padding:6px 16px\">Save Bookmark Settings</button>';\n      h += '</div>';\n\n      sec.innerHTML = h;\n      sec._configData = cfg;\n    }).catch(function() {\n      var sec = document.getElementById('settings-feeds');\n      if (sec) sec.innerHTML = '<h2>Bookmarks &amp; Sync</h2><p style=\"color:var(--muted);font-size:13px\">Could not load feed configuration.</p>';\n    });\n  }\n\n  // Load TTS settings async\n  if (serverMode) {\n    fetch('/api/tts-settings').then(function(r) { return r.json(); }).then(function(data) {\n      var sec = document.getElementById('settings-voice');\n      if (!sec) return;\n      var providers = [\n        { id: 'kokoro', label: 'Kokoro — free, on-device' },\n        { id: 'browser', label: 'Built-in Voice (Apple) — free' },\n        { id: 'openai', label: 'OpenAI — premium' },\n        { id: 'elevenlabs', label: 'ElevenLabs — premium' },\n      ];\n      var h = '<h2>Voice Playback</h2>';\n      h += '<div class=\"settings-row\"><div><label>Provider</label><div class=\"settings-desc\">Choose how articles are read aloud</div></div>';\n      h += '<select id=\"sp-tts-provider\" onchange=\"settingsPageTTSChanged()\">';\n      for (var i = 0; i < providers.length; i++) {\n        h += '<option value=\"' + providers[i].id + '\"' + (data.provider === providers[i].id ? ' selected' : '') + '>' + providers[i].label + '</option>';\n      }\n      h += '</select></div>';\n\n      // Voice select\n      if (data.voices) {\n        h += '<div class=\"settings-row\" id=\"sp-tts-voice-row\"><label>Voice</label>';\n        h += '<select id=\"sp-tts-voice\">';\n        var prov = data.provider || 'browser';\n        var voices = data.voices[prov] || [];\n        h += settingsRenderVoiceOptions(prov, voices, data.voice);\n        h += '</select></div>';\n      }\n\n      // Model / quality select\n      if (data.models) {\n        if (data.provider === 'kokoro') {\n          h += '<div class=\"settings-row\" id=\"sp-tts-model-row\"><label>Quality</label>';\n          if (data.model === 'kokoro-v1-q4') {\n            h += '<span style=\"font-size:12px;color:#22c55e\">&#10003; High quality</span>';\n          } else {\n            h += '<span style=\"font-size:12px\">Standard <button onclick=\"spUpgradeKokoroQuality()\" style=\"margin-left:8px;padding:2px 8px;border:1px solid var(--border);border-radius:4px;background:var(--bg);color:var(--link);font-size:11px;cursor:pointer;font-family:inherit\">Upgrade</button> <span style=\"color:var(--muted);font-size:11px\">Free &middot; 305MB</span></span>';\n          }\n          h += '<input type=\"hidden\" id=\"sp-tts-model\" value=\"' + escapeHtml(data.model || 'kokoro-v1-q8') + '\">';\n          h += '</div>';\n        } else {\n          h += '<div class=\"settings-row\" id=\"sp-tts-model-row\"><label>Model</label>';\n          h += '<select id=\"sp-tts-model\">';\n          var models = data.models[data.provider] || [];\n          for (var mi = 0; mi < models.length; mi++) {\n            h += '<option value=\"' + models[mi].id + '\"' + (data.model === models[mi].id ? ' selected' : '') + '>' + escapeHtml(models[mi].label) + '</option>';\n          }\n          h += '</select></div>';\n        }\n      }\n\n      // API key for cloud providers\n      var isCloud = data.provider === 'openai' || data.provider === 'elevenlabs';\n      h += '<div class=\"settings-row\" id=\"sp-tts-key-row\" style=\"display:' + (isCloud ? 'flex' : 'none') + '\"><div><label>API Key</label>';\n      h += '<div class=\"settings-desc\">' + (data.hasKey && isCloud ? '<span class=\"settings-status ok\">Key saved</span>' : 'Required for cloud TTS') + '</div></div>';\n      h += '<input type=\"password\" id=\"sp-tts-key\" placeholder=\"' + (data.hasKey && isCloud ? '••••••••' : 'Paste API key') + '\" style=\"min-width:200px\">';\n      h += '</div>';\n\n      // Kokoro status\n      h += '<div id=\"sp-kokoro-status\" style=\"display:' + (data.provider === 'kokoro' ? 'block' : 'none') + ';padding:8px 0\">';\n      if (data.kokoro && data.kokoro.bundled) {\n        h += '<div style=\"font-size:12px;color:var(--muted)\"><span class=\"settings-status ok\">Kokoro bundled</span> Runs on-device, no API key or download needed</div>';\n      } else if (data.kokoro && data.kokoro.installed) {\n        h += '<div style=\"font-size:12px;color:var(--muted)\"><span class=\"settings-status ok\">Kokoro ready</span> Runs on-device, no API key needed</div>';\n      } else {\n        h += '<div style=\"font-size:12px;color:var(--muted)\">Will download on first listen (~86MB). Runs on-device after that.</div>';\n      }\n      h += '</div>';\n\n      h += '<div class=\"settings-row\" style=\"justify-content:flex-end;padding-top:8px\">';\n      h += '<button class=\"btn-primary\" onclick=\"settingsPageSaveTTS()\" style=\"font-size:13px;padding:6px 16px\">Save Voice Settings</button>';\n      h += '</div>';\n\n      sec.innerHTML = h;\n      sec._ttsData = data;\n    }).catch(function() {\n      var sec = document.getElementById('settings-voice');\n      if (sec) sec.innerHTML = '<h2>Voice Playback</h2><p style=\"color:var(--muted);font-size:13px\">Could not load voice settings.</p>';\n    });\n\n    // Load LLM settings async (multi-provider)\n    fetch('/api/settings').then(function(r) { return r.json(); }).then(function(data) {\n      var sec = document.getElementById('settings-ai');\n      if (!sec) return;\n      var llm = data.llm || {};\n      var defaultProv = llm.defaultProvider || 'apple';\n      var provs = llm.providers || {};\n      var appleAvailable = llm.appleAvailable || false;\n\n      var providerList = [\n        { id: 'apple', label: 'Apple Intelligence (on-device)' },\n        { id: 'anthropic', label: 'Anthropic (Claude)' },\n        { id: 'openai', label: 'OpenAI' },\n        { id: 'gemini', label: 'Google Gemini' },\n        { id: 'openrouter', label: 'OpenRouter' },\n      ];\n      var cloudProviders = [\n        { id: 'anthropic', label: 'Anthropic (Claude)', placeholder: 'sk-ant-...' },\n        { id: 'openai', label: 'OpenAI', placeholder: 'sk-...' },\n        { id: 'gemini', label: 'Google Gemini', placeholder: 'AIza...' },\n        { id: 'openrouter', label: 'OpenRouter', placeholder: 'sk-or-...' },\n      ];\n\n      var h = '<h2>AI Summaries &amp; Tagging</h2>';\n      h += '<p style=\"font-size:13px;color:var(--muted);margin-bottom:16px\">Choose a provider for article summaries and auto-tagging.</p>';\n\n      // Default provider selector\n      h += '<div class=\"settings-row\"><div><label>Provider</label>';\n      h += '<div class=\"settings-desc\">Used for summaries and auto-tagging</div></div>';\n      h += '<select id=\"sp-llm-default\" onchange=\"settingsPageLLMProviderChanged()\">';\n      for (var i = 0; i < providerList.length; i++) {\n        var p = providerList[i];\n        h += '<option value=\"' + p.id + '\"' + (defaultProv === p.id ? ' selected' : '') + '>' + p.label + '</option>';\n      }\n      h += '</select></div>';\n\n      // Apple Intelligence section\n      h += '<div id=\"sp-llm-apple-info\" style=\"display:' + (defaultProv === 'apple' ? 'block' : 'none') + ';padding:10px 12px;margin-top:8px;background:color-mix(in srgb, var(--fg) 4%, transparent);border-radius:8px;font-size:12px;color:var(--muted);line-height:1.6\">';\n      if (appleAvailable) {\n        h += '<span class=\"settings-status ok\">Apple Intelligence available</span> Runs on-device, no API key needed.';\n      } else {\n        h += 'Apple Intelligence requires macOS 26+ with Apple Silicon.';\n      }\n      h += '</div>';\n\n      // One section per cloud provider — only the selected one is visible\n      for (var ci = 0; ci < cloudProviders.length; ci++) {\n        var cp = cloudProviders[ci];\n        var pConfig = provs[cp.id] || {};\n        var hasKey = pConfig.hasKey || false;\n        var visible = defaultProv === cp.id;\n\n        h += '<div id=\"sp-llm-section-' + cp.id + '\" style=\"display:' + (visible ? 'block' : 'none') + ';margin-top:8px\">';\n\n        if (hasKey) {\n          h += '<div style=\"font-size:12px;margin-bottom:8px\"><span class=\"settings-status ok\">Key saved</span></div>';\n        }\n\n        h += '<div style=\"display:flex;gap:8px;align-items:center;margin-bottom:6px\">';\n        h += '<label style=\"font-size:12px;min-width:55px;color:var(--muted)\">API Key</label>';\n        h += '<input type=\"password\" id=\"sp-llm-key-' + cp.id + '\" placeholder=\"' + (hasKey ? '••••••••' : cp.placeholder) + '\" style=\"flex:1;min-width:0\">';\n        h += '</div>';\n\n        h += '<div style=\"display:flex;gap:8px;align-items:center\">';\n        h += '<label style=\"font-size:12px;min-width:55px;color:var(--muted)\">Model</label>';\n        h += '<input type=\"text\" id=\"sp-llm-model-' + cp.id + '\" value=\"' + escapeHtml(pConfig.model || '') + '\" placeholder=\"default\" style=\"flex:1;min-width:0;font-size:12px\">';\n        h += '</div>';\n\n        h += '</div>';\n      }\n\n      h += '<div class=\"settings-row\" style=\"justify-content:flex-end;padding-top:12px\">';\n      h += '<button class=\"btn-primary\" onclick=\"settingsPageSaveLLM()\" style=\"font-size:13px;padding:6px 16px\">Save</button>';\n      h += '</div>';\n\n      sec.innerHTML = h;\n    }).catch(function() {\n      var sec = document.getElementById('settings-ai');\n      if (sec) sec.innerHTML = '<h2>AI Summaries &amp; Tagging</h2><p style=\"color:var(--muted);font-size:13px\">Could not load AI settings. Configure in the menu bar app.</p>';\n    });\n  }\n}\n\nfunction settingsPageSaveViewerMode() {\n  var mode = document.getElementById('sp-viewer-mode').value;\n  fetch('/api/settings', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({ viewerMode: mode }),\n  });\n}\n\nfunction settingsCheckForUpdates() {\n  var btn = document.getElementById('sp-check-updates-btn');\n  var status = document.getElementById('sp-update-status');\n  if (btn) btn.disabled = true;\n  if (status) status.textContent = 'Checking\\u2026';\n  fetch('/api/check-updates').then(function(r) { return r.json(); }).then(function(data) {\n    if (btn) btn.disabled = false;\n    if (!status) return;\n    if (data.error) {\n      status.textContent = data.error;\n    } else if (data.updateAvailable) {\n      status.innerHTML = 'v' + escapeHtml(data.latestVersion) + ' available \\u2014 <a href=\"' + escapeHtml(data.releaseUrl) + '\" target=\"_blank\" style=\"color:var(--link)\">View release</a>';\n    } else {\n      status.textContent = 'You\\u2019re up to date.';\n    }\n  }).catch(function() {\n    if (btn) btn.disabled = false;\n    if (status) status.textContent = 'Could not check for updates.';\n  });\n}\n\nfunction settingsOpenAa() {\n  // Navigate to dashboard/last article so the Aa button is in context, then open the dropdown\n  renderDashboard();\n  setTimeout(function() { toggleSettingsDropdown(); }, 100);\n}\n\nfunction settingsPageLLMProviderChanged() {\n  var selected = document.getElementById('sp-llm-default').value;\n  var cloudProviders = ['anthropic', 'openai', 'gemini', 'openrouter'];\n  var appleInfo = document.getElementById('sp-llm-apple-info');\n  if (appleInfo) appleInfo.style.display = selected === 'apple' ? 'block' : 'none';\n  for (var i = 0; i < cloudProviders.length; i++) {\n    var sec = document.getElementById('sp-llm-section-' + cloudProviders[i]);\n    if (sec) sec.style.display = cloudProviders[i] === selected ? 'block' : 'none';\n  }\n}\n\nvar KOKORO_VOICE_GROUPS = { af: 'American Female', am: 'American Male', bf: 'British Female', bm: 'British Male' };\nfunction settingsRenderVoiceOptions(provider, voices, selectedVoice) {\n  if (provider !== 'kokoro') {\n    return voices.map(function(v) {\n      return '<option value=\"' + v.id + '\"' + (selectedVoice === v.id ? ' selected' : '') + '>' + escapeHtml(v.label) + '</option>';\n    }).join('');\n  }\n  var groups = {};\n  var order = [];\n  for (var i = 0; i < voices.length; i++) {\n    var prefix = voices[i].id.substring(0, 2);\n    if (!groups[prefix]) { groups[prefix] = []; order.push(prefix); }\n    groups[prefix].push(voices[i]);\n  }\n  var html = '';\n  for (var g = 0; g < order.length; g++) {\n    var key = order[g];\n    html += '<optgroup label=\"' + (KOKORO_VOICE_GROUPS[key] || key) + '\">';\n    for (var j = 0; j < groups[key].length; j++) {\n      var v = groups[key][j];\n      html += '<option value=\"' + v.id + '\"' + (selectedVoice === v.id ? ' selected' : '') + '>' + escapeHtml(v.label) + '</option>';\n    }\n    html += '</optgroup>';\n  }\n  return html;\n}\n\nfunction settingsPageTTSChanged() {\n  var provider = document.getElementById('sp-tts-provider').value;\n  var sec = document.getElementById('settings-voice');\n  var data = sec ? sec._ttsData : null;\n  var keyRow = document.getElementById('sp-tts-key-row');\n  var kokoroStatus = document.getElementById('sp-kokoro-status');\n  var isCloud = provider === 'openai' || provider === 'elevenlabs';\n  if (keyRow) keyRow.style.display = isCloud ? 'flex' : 'none';\n  if (kokoroStatus) kokoroStatus.style.display = provider === 'kokoro' ? 'block' : 'none';\n\n  // Update voice/model dropdowns\n  if (data) {\n    var voiceSelect = document.getElementById('sp-tts-voice');\n    var modelSelect = document.getElementById('sp-tts-model');\n    if (voiceSelect && data.voices && data.voices[provider]) {\n      voiceSelect.innerHTML = settingsRenderVoiceOptions(provider, data.voices[provider], '');\n    } else if (voiceSelect) { voiceSelect.innerHTML = ''; }\n    var modelRow = document.getElementById('sp-tts-model-row');\n    if (modelRow && provider === 'kokoro') {\n      var label = modelRow.querySelector('label');\n      modelRow.innerHTML = '';\n      if (label) modelRow.appendChild(label);\n      modelRow.insertAdjacentHTML('beforeend',\n        '<span style=\"font-size:12px\">Standard <button onclick=\"spUpgradeKokoroQuality()\" style=\"margin-left:8px;padding:2px 8px;border:1px solid var(--border);border-radius:4px;background:var(--bg);color:var(--link);font-size:11px;cursor:pointer;font-family:inherit\">Upgrade</button> <span style=\"color:var(--muted);font-size:11px\">Free &middot; 305MB</span></span>'\n        + '<input type=\"hidden\" id=\"sp-tts-model\" value=\"kokoro-v1-q8\">');\n    } else if (modelSelect && data.models && data.models[provider]) {\n      modelSelect.innerHTML = data.models[provider].map(function(m) {\n        return '<option value=\"' + m.id + '\">' + escapeHtml(m.label) + '</option>';\n      }).join('');\n    } else if (modelSelect) { modelSelect.innerHTML = ''; }\n  }\n}\n\nfunction spUpgradeKokoroQuality() {\n  var hidden = document.getElementById('sp-tts-model');\n  if (hidden) hidden.value = 'kokoro-v1-q4';\n  var row = document.getElementById('sp-tts-model-row');\n  if (row) {\n    var label = row.querySelector('label');\n    row.innerHTML = '';\n    if (label) row.appendChild(label);\n    row.insertAdjacentHTML('beforeend',\n      '<span style=\"font-size:12px;color:#22c55e\">&#10003; High quality — save to apply</span>'\n      + '<input type=\"hidden\" id=\"sp-tts-model\" value=\"kokoro-v1-q4\">');\n  }\n}\n\nfunction settingsPageSaveTTS() {\n  var provider = document.getElementById('sp-tts-provider').value;\n  var config = { provider: provider };\n\n  if (provider === 'kokoro') {\n    var kVoice = document.getElementById('sp-tts-voice');\n    var kModel = document.getElementById('sp-tts-model');\n    if (kVoice) config.voice = kVoice.value;\n    if (kModel) config.model = kModel.value;\n  } else if (provider !== 'browser') {\n    var apiKey = document.getElementById('sp-tts-key').value;\n    if (apiKey) { config.apiKey = apiKey; } else { config.preserveKey = true; }\n    var voice = document.getElementById('sp-tts-voice');\n    var model = document.getElementById('sp-tts-model');\n    if (voice) config.voice = voice.value;\n    if (model) config.model = model.value;\n  }\n\n  fetch('/api/tts-settings', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify(config),\n  }).then(function(r) {\n    if (r.ok) {\n      ttsProvider = provider;\n      ttsQueue = [];\n      ttsCurrentIndex = -1;\n      if (ttsAudio) { ttsAudio.pause(); ttsAudio.src = ''; ttsAudio = null; }\n      renderAudioPlayer();\n      showSettingsPage(); // Refresh to show updated state\n    } else {\n      alert('Failed to save voice settings.');\n    }\n  });\n}\n\nfunction settingsPageSaveLLM() {\n  var defaultProvider = document.getElementById('sp-llm-default').value;\n  var cloudProviders = ['anthropic', 'openai', 'gemini', 'openrouter'];\n  var providers = {};\n\n  for (var i = 0; i < cloudProviders.length; i++) {\n    var p = cloudProviders[i];\n    var keyInput = document.getElementById('sp-llm-key-' + p);\n    var modelInput = document.getElementById('sp-llm-model-' + p);\n    var entry = {};\n    if (keyInput && keyInput.value) entry.apiKey = keyInput.value;\n    if (modelInput && modelInput.value) entry.model = modelInput.value;\n    if (Object.keys(entry).length > 0) providers[p] = entry;\n  }\n\n  fetch('/api/settings', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({ defaultProvider: defaultProvider, providers: providers }),\n  }).then(function(r) {\n    if (r.ok) {\n      llmProvider = defaultProvider;\n      llmConfigured = true;\n      showSettingsPage(); // Refresh to show updated state\n    } else {\n      alert('Failed to save AI settings.');\n    }\n  });\n}\n\n// ---- Feeds & Sync settings ----\nfunction pickOutputFolder(inputId) {\n  fetch('/api/pick-folder', { method: 'POST' })\n    .then(function(r) { return r.json(); })\n    .then(function(data) {\n      if (data.path) {\n        document.getElementById(inputId).value = data.path;\n      }\n    })\n    .catch(function() { /* osascript not available — user can type manually */ });\n}\n\nfunction settingsPageSaveConfig() {\n  var outputPath = document.getElementById('sp-output-path').value.trim();\n  var syncInterval = document.getElementById('sp-sync-interval').value;\n  var cookies = document.getElementById('sp-cookies').checked;\n  var sec = document.getElementById('settings-feeds');\n  var cfg = sec ? sec._configData : {};\n  var feeds = cfg.feeds || {};\n\n  fetch('/api/config', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({ outputPath: outputPath, feeds: feeds, syncInterval: syncInterval, useBrowserCookies: cookies })\n  }).then(function(r) {\n    if (r.ok) showSettingsPage();\n    else alert('Failed to save feed settings.');\n  });\n}\n\nasync function settingsAddFeed() {\n  var input = document.getElementById('sp-new-feed');\n  var url = (input.value || '').trim();\n  if (!url) return;\n  if (!url.startsWith('http://') && !url.startsWith('https://')) url = 'https://' + url;\n  var btn = document.getElementById('sp-add-feed-btn');\n  if (btn) { btn.disabled = true; btn.textContent = 'Finding feed\\u2026'; }\n  try {\n    var r = await fetch('/api/feed-discover?url=' + encodeURIComponent(url));\n    var result = await r.json();\n    var feedUrl = result.feedUrl || url;\n    var title = result.title || feedUrl.replace(/^https?:\\/\\/(www\\.)?/, '').split('/')[0];\n    var sec = document.getElementById('settings-feeds');\n    if (sec && sec._configData) {\n      if (!sec._configData.feeds) sec._configData.feeds = {};\n      sec._configData.feeds[title] = feedUrl;\n    }\n  } catch (e) {\n    var sec2 = document.getElementById('settings-feeds');\n    if (sec2 && sec2._configData) {\n      if (!sec2._configData.feeds) sec2._configData.feeds = {};\n      sec2._configData.feeds[url] = url;\n    }\n  }\n  settingsPageSaveConfig();\n}\n\nfunction settingsRemoveFeed(name) {\n  var sec = document.getElementById('settings-feeds');\n  if (sec && sec._configData && sec._configData.feeds) {\n    delete sec._configData.feeds[name];\n  }\n  settingsPageSaveConfig();\n}\n\nfunction settingsBackup() {\n  var status = document.getElementById('backup-status');\n  if (status) status.textContent = 'Preparing backup...';\n  fetch('/api/backup').then(function(r) {\n    if (!r.ok) throw new Error('Backup failed');\n    var disp = r.headers.get('Content-Disposition') || '';\n    var match = disp.match(/filename=\"([^\"]+)\"/);\n    var filename = match ? match[1] : 'pullread-backup.json';\n    return r.blob().then(function(blob) {\n      var url = URL.createObjectURL(blob);\n      var a = document.createElement('a');\n      a.href = url;\n      a.download = filename;\n      a.click();\n      URL.revokeObjectURL(url);\n      if (status) status.textContent = 'Backup downloaded: ' + filename;\n    });\n  }).catch(function(e) {\n    if (status) status.textContent = 'Backup failed: ' + e.message;\n  });\n}\n\nfunction settingsRestore() {\n  var input = document.createElement('input');\n  input.type = 'file';\n  input.accept = '.json';\n  input.onchange = function() {\n    if (!input.files || !input.files[0]) return;\n    var status = document.getElementById('backup-status');\n    if (status) status.textContent = 'Restoring...';\n    var reader = new FileReader();\n    reader.onload = function() {\n      try {\n        var data = JSON.parse(reader.result);\n        if (!data._pullread_backup) {\n          if (status) status.textContent = 'Not a valid PullRead backup file.';\n          return;\n        }\n      } catch(e) {\n        if (status) status.textContent = 'Could not read file: ' + e.message;\n        return;\n      }\n      fetch('/api/restore', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: reader.result,\n      }).then(function(r) { return r.json(); }).then(function(result) {\n        if (result.ok) {\n          if (status) status.textContent = 'Restored ' + result.restored + ' data files. Reload to see changes.';\n        } else {\n          if (status) status.textContent = 'Restore failed: ' + (result.error || 'unknown error');\n        }\n      }).catch(function(e) {\n        if (status) status.textContent = 'Restore failed: ' + e.message;\n      });\n    };\n    reader.readAsText(input.files[0]);\n  };\n  input.click();\n}\n\nfunction reimportAllArticles() {\n  var btn = document.getElementById('reimport-all-btn');\n  var status = document.getElementById('reimport-status');\n\n  // Fetch article count for confirmation\n  fetch('/api/files').then(function(r) { return r.json(); }).then(function(files) {\n    var count = files.length;\n    if (!confirm('This will re-fetch all ' + count + ' articles from their original URLs. Continue?')) return;\n\n    if (btn) { btn.disabled = true; btn.style.opacity = '0.5'; }\n    if (status) status.textContent = 'Reimporting... 0/' + count;\n\n    fetch('/api/reimport-all', { method: 'POST' }).then(function(response) {\n      var reader = response.body.getReader();\n      var decoder = new TextDecoder();\n      var buffer = '';\n\n      function read() {\n        reader.read().then(function(result) {\n          if (result.done) return;\n          buffer += decoder.decode(result.value, { stream: true });\n\n          var lines = buffer.split('\\n');\n          buffer = lines.pop() || '';\n\n          for (var i = 0; i < lines.length; i++) {\n            var line = lines[i];\n            if (!line.startsWith('data: ')) continue;\n            try {\n              var evt = JSON.parse(line.slice(6));\n              if (evt.complete) {\n                if (status) status.textContent = 'Done! ' + evt.succeeded + ' succeeded, ' + evt.failed + ' failed.';\n                if (btn) { btn.disabled = false; btn.style.opacity = '1'; }\n                return;\n              }\n              if (status) status.textContent = 'Reimporting... ' + evt.done + '/' + evt.total + (evt.ok ? '' : ' (failed: ' + evt.current + ')');\n            } catch(e) {}\n          }\n          read();\n        });\n      }\n      read();\n    }).catch(function(e) {\n      if (status) status.textContent = 'Reimport failed: ' + e.message;\n      if (btn) { btn.disabled = false; btn.style.opacity = '1'; }\n    });\n  });\n}\n\n\n// Rendering\nfunction renderDashboard() {\n  const dash = document.getElementById('dashboard');\n  if (!dash) return;\n\n  const empty = document.getElementById('empty-state');\n  const content = document.getElementById('content');\n  empty.style.display = '';\n  if (content) content.style.display = 'none';\n\n  if (allFiles.length === 0) {\n    dash.innerHTML = '<div class=\"dash-empty-hint\"><p class=\"hint\">No articles yet</p><p class=\"subhint\">Add RSS feeds in the tray app, or drop a .md file here</p></div>';\n    return;\n  }\n\n  let html = '';\n\n  // Greeting\n  const hour = new Date().getHours();\n  const greeting = hour < 12 ? 'Good morning' : hour < 17 ? 'Good afternoon' : 'Good evening';\n  const totalArticles = allFiles.length;\n  const unreadCount = allFiles.filter(f => !readArticles.has(f.filename)).length;\n  html += '<div class=\"dash-greeting\">';\n  html += '<h1>' + greeting + '</h1>';\n  html += '<p>' + totalArticles + ' articles' + (unreadCount > 0 ? ' &middot; ' + unreadCount + ' unread' : '') + '</p>';\n  html += '</div>';\n\n  // Continue Reading — articles with saved scroll position (partially read)\n  const positions = JSON.parse(localStorage.getItem('pr-scroll-positions') || '{}');\n  const continueReading = allFiles.filter(f => {\n    const pos = positions[f.filename];\n    return pos && pos.pct > 0.05 && pos.pct < 0.9; // partially read\n  }).sort((a, b) => (positions[b.filename].ts || 0) - (positions[a.filename].ts || 0)).slice(0, 10);\n\n  if (continueReading.length > 0) {\n    html += '<div class=\"dash-section\">';\n    html += '<div class=\"dash-section-header\">';\n    html += '<span class=\"dash-section-title\"><svg viewBox=\"0 0 384 512\"><use href=\"#i-book\"/></svg> Continue Reading <span class=\"dash-section-count\">(' + continueReading.length + ')</span></span>';\n    html += '</div>';\n    html += '<div class=\"dash-cards-wrap\"><button class=\"dash-chevron left\" onclick=\"dashScrollLeft(this)\" aria-label=\"Scroll left\">&#8249;</button><div class=\"dash-cards\">';\n    for (const f of continueReading) {\n      html += dashCardHtml(f, positions[f.filename]?.pct);\n    }\n    html += '</div><button class=\"dash-chevron right\" onclick=\"dashScrollRight(this)\" aria-label=\"Scroll right\">&#8250;</button></div></div>';\n  }\n\n  // Latest Reviews\n  const reviews = allFiles.filter(f => f.feed === 'weekly-review' || f.feed === 'daily-review' || f.domain === 'pullread').slice(0, 5);\n  if (reviews.length > 0) {\n    html += '<div class=\"dash-section\">';\n    html += '<div class=\"dash-section-header\">';\n    html += '<span class=\"dash-section-title\"><svg viewBox=\"0 0 512 512\"><use href=\"#i-wand\"/></svg> Reviews</span>';\n    html += '</div>';\n    html += '<div class=\"dash-cards-wrap\"><button class=\"dash-chevron left\" onclick=\"dashScrollLeft(this)\" aria-label=\"Scroll left\">&#8249;</button><div class=\"dash-cards\">';\n    for (const f of reviews) {\n      const isWeekly = f.feed === 'weekly-review';\n      const typeLabel = isWeekly ? 'Weekly' : 'Daily';\n      const date = f.bookmarked ? f.bookmarked.slice(0, 10) : '';\n      html += '<div class=\"dash-review-card\" onclick=\"dashLoadArticle(\\'' + escapeHtml(f.filename) + '\\')\">';\n      html += '<div class=\"dash-review-title\">' + escapeHtml(f.title) + '</div>';\n      html += '<div class=\"dash-review-meta\">' + typeLabel + ' Review' + (date ? ' &middot; ' + date : '') + '</div>';\n      if (f.excerpt) html += '<div class=\"dash-review-excerpt\">' + escapeHtml(f.excerpt) + '</div>';\n      html += '</div>';\n    }\n    html += '</div><button class=\"dash-chevron right\" onclick=\"dashScrollRight(this)\" aria-label=\"Scroll right\">&#8250;</button></div></div>';\n  }\n\n  // Favorites\n  const favorites = allFiles.filter(f => allNotesIndex[f.filename]?.isFavorite);\n  if (favorites.length > 0) {\n    html += '<div class=\"dash-section\">';\n    html += '<div class=\"dash-section-header\">';\n    html += '<span class=\"dash-section-title\"><svg viewBox=\"0 0 512 512\"><use href=\"#i-heart\"/></svg> Favorites <span class=\"dash-section-count\">(' + favorites.length + ')</span></span>';\n    html += '</div>';\n    html += '<div class=\"dash-cards-wrap\"><button class=\"dash-chevron left\" onclick=\"dashScrollLeft(this)\" aria-label=\"Scroll left\">&#8249;</button><div class=\"dash-cards\">';\n    for (const f of favorites.slice(0, 10)) {\n      html += dashCardHtml(f);\n    }\n    html += '</div><button class=\"dash-chevron right\" onclick=\"dashScrollRight(this)\" aria-label=\"Scroll right\">&#8250;</button></div></div>';\n  }\n\n  // Recent — latest unread articles\n  const recent = allFiles.filter(f => !readArticles.has(f.filename) && f.feed !== 'weekly-review' && f.feed !== 'daily-review' && f.domain !== 'pullread').slice(0, 20);\n  if (recent.length > 0) {\n    html += '<div class=\"dash-section\">';\n    html += '<div class=\"dash-section-header\">';\n    html += '<span class=\"dash-section-title\"><svg viewBox=\"0 0 448 512\"><use href=\"#i-calendar\"/></svg> Recent <span class=\"dash-section-count\">(' + recent.length + ')</span></span>';\n    if (unreadCount > recent.length) {\n      html += '<button class=\"dash-view-all\" onclick=\"document.getElementById(\\'search\\').focus()\">View all ' + unreadCount + ' &rsaquo;</button>';\n    }\n    html += '</div>';\n    html += '<div class=\"dash-cards-wrap\"><button class=\"dash-chevron left\" onclick=\"dashScrollLeft(this)\" aria-label=\"Scroll left\">&#8249;</button><div class=\"dash-cards\">';\n    for (const f of recent) {\n      html += dashCardHtml(f);\n    }\n    html += '</div><button class=\"dash-chevron right\" onclick=\"dashScrollRight(this)\" aria-label=\"Scroll right\">&#8250;</button></div></div>';\n  }\n\n  // Footer links\n  html += '<div class=\"dash-footer\">';\n  html += '<button onclick=\"showTagCloud()\"><svg class=\"icon icon-sm\" aria-hidden=\"true\" style=\"vertical-align:-1px\"><use href=\"#i-search\"/></svg> Explore</button>';\n  html += '<button onclick=\"showGuideModal()\"><svg class=\"icon icon-sm\" aria-hidden=\"true\" style=\"vertical-align:-1px\"><use href=\"#i-book\"/></svg> Guide</button>';\n  html += '</div>';\n\n  dash.innerHTML = html;\n  // Initialize chevron visibility after DOM is populated\n  requestAnimationFrame(initDashChevrons);\n}\n\nfunction dashCardHtml(f, progressPct) {\n  const onclick = 'dashLoadArticle(\\'' + escapeHtml(f.filename) + '\\')';\n  const domain = f.domain || '';\n  const favicon = domain ? '/favicons/' + encodeURIComponent(domain) + '.png' : '';\n  const date = f.bookmarked ? f.bookmarked.slice(0, 10) : '';\n\n  let html = '<div class=\"dash-card\" onclick=\"' + onclick + '\">';\n\n  // Image or placeholder\n  if (f.image) {\n    html += '<img class=\"dash-card-img\" src=\"' + escapeHtml(f.image) + '\" alt=\"\" loading=\"lazy\" onerror=\"this.outerHTML=\\'<div class=dash-card-img-placeholder><svg style=width:32px;height:32px;fill:currentColor viewBox=&quot;0 0 448 512&quot;><use href=&quot;#i-book&quot;/></svg></div>\\'\">';\n  } else {\n    html += '<div class=\"dash-card-img-placeholder\"><svg style=\"width:32px;height:32px;fill:currentColor\" viewBox=\"0 0 448 512\"><use href=\"#i-book\"/></svg></div>';\n  }\n\n  html += '<div class=\"dash-card-body\">';\n\n  // Meta row: favicon, domain, feed badge\n  html += '<div class=\"dash-card-meta\">';\n  if (favicon) html += '<img src=\"' + escapeHtml(favicon) + '\" alt=\"\" loading=\"lazy\">';\n  if (domain) html += '<span>' + escapeHtml(domain) + '</span>';\n  if (f.feed && f.feed !== domain) html += '<span class=\"dash-card-badge\">' + escapeHtml(f.feed) + '</span>';\n  html += '</div>';\n\n  // Title\n  html += '<div class=\"dash-card-title\">' + escapeHtml(f.title) + '</div>';\n\n  // Excerpt\n  if (f.excerpt) {\n    html += '<div class=\"dash-card-excerpt\">' + escapeHtml(f.excerpt) + '</div>';\n  }\n\n  // Progress bar for continue reading\n  if (progressPct !== undefined && progressPct > 0) {\n    html += '<div class=\"dash-card-progress\"><div class=\"dash-card-progress-fill\" style=\"width:' + Math.round(progressPct * 100) + '%\"></div></div>';\n  }\n\n  html += '</div></div>';\n  return html;\n}\n\nfunction goHome() {\n  _sidebarView = 'home'; syncSidebarTabs();\n  activeFile = null;\n  document.title = 'PullRead';\n  renderDashboard();\n}\n\nfunction dashScrollLeft(btn) {\n  const cards = btn.closest('.dash-cards-wrap').querySelector('.dash-cards');\n  cards.scrollBy({ left: -300, behavior: 'smooth' });\n}\n\nfunction dashScrollRight(btn) {\n  const cards = btn.closest('.dash-cards-wrap').querySelector('.dash-cards');\n  cards.scrollBy({ left: 300, behavior: 'smooth' });\n}\n\nfunction initDashChevrons() {\n  document.querySelectorAll('.dash-cards').forEach(cards => {\n    const wrap = cards.closest('.dash-cards-wrap');\n    if (!wrap) return;\n    const leftBtn = wrap.querySelector('.dash-chevron.left');\n    const rightBtn = wrap.querySelector('.dash-chevron.right');\n\n    function updateChevrons() {\n      const hasOverflow = cards.scrollWidth > cards.clientWidth + 8;\n      if (leftBtn) leftBtn.classList.toggle('visible', hasOverflow && cards.scrollLeft > 8);\n      if (rightBtn) rightBtn.classList.toggle('visible', hasOverflow && cards.scrollLeft < cards.scrollWidth - cards.clientWidth - 8);\n    }\n    cards.addEventListener('scroll', updateChevrons);\n    updateChevrons();\n    // Recheck after images load\n    setTimeout(updateChevrons, 500);\n  });\n}\n\nfunction dashLoadArticle(filename) {\n  var idx = displayFiles.findIndex(f => f.filename === filename);\n  if (idx >= 0) {\n    loadFile(idx);\n    return;\n  }\n  // Article not in current view — set activeFile so filterFiles includes it\n  // even when hide-read is on (filterFiles preserves activeFile)\n  activeFile = filename;\n  document.getElementById('search').value = '';\n  filterFiles();\n  idx = displayFiles.findIndex(f => f.filename === filename);\n  if (idx >= 0) loadFile(idx);\n}\n\nfunction renderArticle(text, filename) {\n  const { meta, body: rawBodyText } = parseFrontmatter(text);\n  let body = rawBodyText;\n  const content = document.getElementById('content');\n  const empty = document.getElementById('empty-state');\n\n  empty.style.display = 'none';\n  content.style.display = 'block';\n\n  let html = '';\n\n  // Article header: title, author, date, domain, actions\n  html += '<div class=\"article-header\">';\n  if (meta && meta.title) {\n    if (meta.url) {\n      html += '<h1><a href=\"' + escapeHtml(meta.url) + '\" target=\"_blank\" rel=\"noopener\" class=\"title-link\">' + escapeHtml(meta.title) + '<svg class=\"icon icon-external\" aria-hidden=\"true\"><use href=\"#i-external\"/></svg></a></h1>';\n    } else {\n      html += '<h1>' + escapeHtml(meta.title) + '</h1>';\n    }\n  }\n  html += '<div class=\"article-byline\">';\n  const bylineParts = [];\n  if (meta && meta.author) {\n    // Truncate overly long bylines (e.g. full author bios from PDFs/arxiv)\n    var authorText = meta.author;\n    if (authorText.length > 80) {\n      // Try to cut at first sentence boundary or period\n      var cutoff = authorText.indexOf('. ');\n      if (cutoff > 10 && cutoff < 80) authorText = authorText.slice(0, cutoff);\n      else authorText = authorText.slice(0, 80).replace(/\\s+\\S*$/, '') + '\\u2026';\n    }\n    bylineParts.push('<span class=\"author\">' + escapeHtml(authorText) + '</span>');\n  }\n  if (meta && meta.domain) bylineParts.push('<a href=\"' + escapeHtml(meta.url || '') + '\" target=\"_blank\">' + escapeHtml(meta.domain) + '</a>');\n  if (meta && meta.bookmarked) bylineParts.push(escapeHtml(meta.bookmarked.slice(0, 10)));\n  html += bylineParts.join('<span class=\"sep\">&middot;</span>');\n  // Read time will be inserted after rendering\n  html += '</div>';\n\n  // Detect review/summary articles where Summarize doesn't make sense\n  const isReviewArticle = meta && (meta.feed === 'weekly-review' || meta.feed === 'daily-review' || meta.domain === 'pullread');\n\n  // Action buttons row\n  html += '<div class=\"article-actions\">';\n  const isFav = articleNotes.isFavorite;\n  html += '<button onclick=\"toggleFavoriteFromHeader(this)\" class=\"' + (isFav ? 'active-fav' : '') + '\" aria-label=\"' + (isFav ? 'Remove from favorites' : 'Add to favorites') + '\" aria-pressed=\"' + isFav + '\"><svg class=\"icon icon-sm\" aria-hidden=\"true\"><use href=\"#i-' + (isFav ? 'heart' : 'heart-o') + '\"/></svg> Favorite</button>';\n  html += '<button onclick=\"toggleNotesFromHeader()\" aria-label=\"Toggle annotations panel\"><svg class=\"icon icon-sm\" aria-hidden=\"true\"><use href=\"#i-pen\"/></svg> Annotations</button>';\n  if (!isReviewArticle) {\n    html += '<button onclick=\"summarizeArticle()\" id=\"summarize-btn\" aria-label=\"Summarize article\"><svg class=\"icon icon-sm\" aria-hidden=\"true\"><use href=\"#i-wand\"/></svg> Summarize</button>';\n  }\n  var isPodcast = meta && meta.enclosure_url && meta.enclosure_type && meta.enclosure_type.startsWith('audio/');\n  var listenLabel = isPodcast ? 'Play' : 'Listen';\n  html += '<div class=\"play-next-menu\" id=\"play-next-menu\">';\n  html += '<button id=\"listen-btn\" onclick=\"addCurrentToTTSQueue()\" aria-label=\"' + listenLabel + ' article\"><svg class=\"icon icon-sm\" aria-hidden=\"true\"><use href=\"#i-volume\"/></svg> ' + listenLabel + '</button>';\n  html += '<button class=\"play-next-trigger\" id=\"play-next-trigger\" onclick=\"togglePlayNextMenu(event)\" aria-label=\"Queue options\" style=\"display:none\"><svg class=\"icon icon-sm\" aria-hidden=\"true\"><use href=\"#i-chevron-down\"/></svg></button>';\n  html += '</div>';\n  if (meta && meta.url) {\n    html += '<div class=\"share-dropdown\"><button onclick=\"toggleShareDropdown(event)\" aria-label=\"Share article\"><svg class=\"icon icon-sm\" aria-hidden=\"true\"><use href=\"#i-share\"/></svg> Share</button></div>';\n  }\n  html += '<button onclick=\"markCurrentAsUnread()\" aria-label=\"Mark as unread\"><svg class=\"icon icon-sm\" aria-hidden=\"true\"><use href=\"#i-eye-slash\"/></svg> Unread</button>';\n  html += '</div>';\n  // Show notebook back-references\n  var nbRefs = Object.values(_notebooks || {}).filter(function(nb) { return nb.sources && nb.sources.indexOf(filename) >= 0; });\n  if (nbRefs.length) {\n    html += '<div style=\"margin-top:6px\">';\n    for (var nbi = 0; nbi < nbRefs.length; nbi++) {\n      html += '<span class=\"notebook-ref\" onclick=\"openNotebookEditor(\\'' + nbRefs[nbi].id + '\\')\"><svg class=\"icon icon-sm\" style=\"vertical-align:-1px\"><use href=\"#i-pen\"/></svg> ' + escapeHtml(nbRefs[nbi].title || 'Untitled notebook') + '</span>';\n    }\n    html += '</div>';\n  }\n  html += '</div>';\n\n  // Show existing summary if present in frontmatter\n  if (meta && meta.summary) {\n    const sp = meta.summaryProvider || '';\n    const sm = meta.summaryModel || '';\n    html += '<div class=\"article-summary\"><div class=\"summary-header\"><div class=\"summary-header-left\">'\n      + summaryBadgesHtml(sp, sm)\n      + '</div><span class=\"summary-actions\"><button onclick=\"hideSummary()\" title=\"Hide summary\"><svg class=\"icon icon-sm\"><use href=\"#i-xmark\"/></svg></button></span></div>'\n      + escapeHtml(meta.summary) + '</div>';\n  }\n\n  // YouTube embed: detect from frontmatter and inject responsive iframe\n  const isYouTube = meta && meta.domain && /youtube\\.com|youtu\\.be|m\\.youtube\\.com/.test(meta.domain);\n  if (isYouTube && meta.url) {\n    var ytId = null;\n    try {\n      var ytUrl = new URL(meta.url);\n      if (ytUrl.hostname === 'youtu.be') ytId = ytUrl.pathname.slice(1).split('/')[0];\n      else if (ytUrl.searchParams.get('v')) ytId = ytUrl.searchParams.get('v');\n      else { var em = ytUrl.pathname.match(/\\/(embed|v)\\/([^/?]+)/); if (em) ytId = em[2]; }\n    } catch {}\n    if (ytId) {\n      html += '<div class=\"yt-embed\"><iframe src=\"https://www.youtube.com/embed/' + encodeURIComponent(ytId)\n        + '\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen loading=\"lazy\" title=\"Embedded video\"></iframe></div>';\n    }\n  }\n\n  // Podcast: show podcast info banner (audio plays through unified bottom bar)\n  if (isPodcast) {\n    html += '<div class=\"podcast-player\">';\n    html += '<svg style=\"width:16px;height:16px;fill:var(--muted);flex-shrink:0\"><use href=\"#i-mic\"/></svg>';\n    html += '<span style=\"font-size:13px;color:var(--fg)\">Podcast episode</span>';\n    if (meta.enclosure_duration) {\n      html += '<span class=\"podcast-duration\">' + escapeHtml(meta.enclosure_duration) + '</span>';\n    }\n    html += '<button onclick=\"addCurrentToTTSQueue()\" style=\"margin-left:auto;padding:4px 12px;border:1px solid var(--border);border-radius:6px;background:none;color:var(--link);font-size:12px;cursor:pointer;font-family:inherit;white-space:nowrap\">Play in player</button>';\n    html += '</div>';\n    // Show podcast description in a collapsible section instead of as article body\n    if (body && body.trim()) {\n      html += '<details class=\"podcast-description\"><summary>Episode description</summary>';\n      html += '<div>' + sanitizeHtml(marked.parse(cleanMarkdown(body))) + '</div>';\n      html += '</details>';\n    }\n  }\n\n  // Podcast body is already rendered in the collapsible description above\n  if (isPodcast) body = '';\n\n  // Strip YouTube thumbnail link BEFORE cleanMarkdown (which mangles the link-wrapped image)\n  var rawBody = body;\n  if (isYouTube) {\n    rawBody = rawBody.replace(/\\[?!\\[.*?\\]\\(https:\\/\\/img\\.youtube\\.com\\/vi\\/[^)]*\\)\\]?\\(?[^)\\n]*\\)?\\s*/g, '');\n    // Strip standalone YouTube image that lost its link wrapper\n    rawBody = rawBody.replace(/!\\[.*?\\]\\(https:\\/\\/img\\.youtube\\.com\\/vi\\/[^)]*\\)\\s*/g, '');\n    // Strip channel name line (already in byline)\n    if (meta && meta.author) rawBody = rawBody.replace(new RegExp('^\\\\s*\\\\*' + meta.author.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&') + '\\\\*\\\\s*$', 'm'), '');\n    // Strip description that duplicates the excerpt\n    if (meta && meta.excerpt) {\n      var excerptNorm = meta.excerpt.replace(/\\.\\.\\.$/, '').trim();\n      rawBody = rawBody.replace(new RegExp('^\\\\s*' + excerptNorm.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&') + '[^\\\\n]*\\\\s*$', 'm'), '');\n    }\n  }\n\n  // Strip the leading H1 from markdown body if it matches the title (avoid duplication)\n  let articleBody = cleanMarkdown(rawBody);\n  if (meta && meta.title) {\n    var h1Match = articleBody.match(/^\\s*#\\s+(.+)\\s*\\n/);\n    if (h1Match) {\n      var normalize = function(s) { return s.toLowerCase().replace(/[\\u2018\\u2019\\u201C\\u201D]/g, \"'\").replace(/[^a-z0-9]/g, ''); };\n      // Strip if title matches, or if it's a review (title always duplicated in body)\n      if (normalize(h1Match[1]) === normalize(meta.title) || isReviewArticle) {\n        articleBody = articleBody.slice(h1Match[0].length);\n      }\n    }\n  }\n\n  html += sanitizeHtml(marked.parse(articleBody));\n\n  // Deduplicate images: remove consecutive/nearby img tags with the same src\n  html = (function dedupeImages(h) {\n    const div = document.createElement('div');\n    div.innerHTML = h;\n    const imgs = Array.from(div.querySelectorAll('img'));\n    const seen = new Set();\n    for (const img of imgs) {\n      const src = img.getAttribute('src');\n      if (!src) continue;\n      // Normalize: strip query params for dedup comparison\n      let key;\n      try { key = new URL(src).origin + new URL(src).pathname; } catch { key = src; }\n      if (seen.has(key)) {\n        // Remove the duplicate image (and its wrapping <p> or <a> if it's the only child)\n        const parent = img.parentElement;\n        if (parent && (parent.tagName === 'P' || parent.tagName === 'A') && parent.children.length === 1 && parent.textContent.trim() === '') {\n          parent.remove();\n        } else {\n          img.remove();\n        }\n      } else {\n        seen.add(key);\n      }\n    }\n    return div.innerHTML;\n  })(html);\n\n  // Convert YouTube thumbnail links into embedded video iframes (fallback for inline links)\n  html = html.replace(\n    /<a[^>]*href=\"(https?:\\/\\/(?:www\\.|m\\.)?youtube\\.com\\/watch\\?v=([^\"&]+)[^\"]*|https?:\\/\\/youtu\\.be\\/([^\"/?]+)[^\"]*)\"[^>]*>\\s*<img[^>]*src=\"https:\\/\\/img\\.youtube\\.com\\/vi\\/[^\"]*\"[^>]*\\/?>\\s*<\\/a>/gi,\n    function(match, url, id1, id2) {\n      var videoId = id1 || id2;\n      if (!videoId) return match;\n      return '<div class=\"yt-embed\"><iframe src=\"https://www.youtube.com/embed/' + encodeURIComponent(videoId) + '\" frameborder=\"0\" allow=\"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture\" allowfullscreen loading=\"lazy\" title=\"Embedded video\"></iframe></div>';\n    }\n  );\n\n  content.innerHTML = html;\n  document.title = (meta && meta.title) || filename || 'PullRead';\n\n  // Apply review-content class for link-blog styling on review articles\n  if (isReviewArticle) {\n    content.classList.add('review-content');\n    enhanceOpenQuestions(content, filename);\n    localizeReviewLinks(content);\n  } else {\n    content.classList.remove('review-content');\n  }\n\n  // Post-process for accessibility\n  content.querySelectorAll('img:not([alt])').forEach(function(img) { img.setAttribute('alt', ''); });\n  content.querySelectorAll('img[alt=\"\"]').forEach(function(img) { img.setAttribute('role', 'presentation'); });\n  content.querySelectorAll('table').forEach(function(table) {\n    if (!table.querySelector('thead')) {\n      var firstRow = table.querySelector('tr');\n      if (firstRow && firstRow.querySelectorAll('th').length > 0) {\n        firstRow.querySelectorAll('th').forEach(function(th) { th.setAttribute('scope', 'col'); });\n      }\n    }\n    table.setAttribute('role', 'table');\n  });\n  // Open article content links in new window\n  content.querySelectorAll('a[href]').forEach(function(a) {\n    var href = a.getAttribute('href');\n    if (href && !href.startsWith('#')) {\n      a.setAttribute('target', '_blank');\n      a.setAttribute('rel', 'noopener noreferrer');\n    }\n  });\n  // Wrap standalone images in links to their full-size source\n  content.querySelectorAll('img[src]').forEach(function(img) {\n    var parent = img.parentElement;\n    // Skip images already wrapped in a link\n    if (parent && parent.tagName === 'A') return;\n    var src = img.getAttribute('src');\n    if (!src || src.startsWith('data:')) return;\n    var a = document.createElement('a');\n    a.href = src;\n    a.setAttribute('target', '_blank');\n    a.setAttribute('rel', 'noopener noreferrer');\n    img.parentNode.insertBefore(a, img);\n    a.appendChild(img);\n  });\n  // Clean up leftover broken markdown artifacts (stray brackets, parenthesized URLs)\n  (function cleanBrokenFragments(root) {\n    var walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null);\n    var removals = [];\n    while (walker.nextNode()) {\n      var node = walker.currentNode;\n      var text = node.textContent;\n      // Remove text nodes that are just lone brackets\n      if (/^\\s*[\\[\\]]\\s*$/.test(text)) { removals.push(node); continue; }\n      // Remove text nodes that are just a parenthesized URL\n      if (/^\\s*\\(https?:\\/\\/[^)]+\\)\\s*$/.test(text)) { removals.push(node); continue; }\n      // Remove leading/trailing lone brackets in mixed text\n      var cleaned = text.replace(/^\\s*\\[\\s*/, '').replace(/\\s*\\]\\s*$/, '');\n      if (cleaned !== text) node.textContent = cleaned;\n    }\n    removals.forEach(function(n) {\n      var p = n.parentElement;\n      n.remove();\n      // Remove empty <p> tags left behind\n      if (p && p.tagName === 'P' && !p.textContent.trim() && !p.querySelector('img,a,iframe')) p.remove();\n    });\n  })(content);\n\n  // Add read time & word count to byline\n  const articleBodyText = content.textContent || '';\n  const { words, minutes } = calculateReadStats(articleBodyText);\n  const bylineEl = content.querySelector('.article-byline');\n  if (bylineEl && words > 50) {\n    const statsSpan = document.createElement('span');\n    statsSpan.className = 'read-stats';\n    if (bylineEl.children.length > 0) {\n      const sep = document.createElement('span');\n      sep.className = 'sep';\n      sep.innerHTML = '&middot;';\n      bylineEl.appendChild(sep);\n    }\n    statsSpan.innerHTML = minutes + ' min read<span class=\"stat-divider\">&middot;</span>' + (words >= 1000 ? (words / 1000).toFixed(1) + 'k' : words) + ' words';\n    bylineEl.appendChild(statsSpan);\n  }\n\n  // Render diagrams (mermaid, d2) before highlighting\n  renderDiagrams();\n\n  // Apply syntax highlighting to code blocks\n  applySyntaxHighlighting();\n\n  // Generate table of contents\n  generateToc();\n\n  // Scroll to top\n  document.getElementById('content-pane').scrollTop = 0;\n\n  // Reset reading progress\n  updateReadingProgress();\n\n  // Clear margin notes\n  document.getElementById('margin-notes').innerHTML = '';\n\n  // Restore scroll position (after a tick so DOM is settled)\n  setTimeout(() => restoreScrollPosition(filename), 100);\n\n  // Update focus mode if active\n  if (focusModeActive) {\n    setTimeout(updateFocusMode, 200);\n  }\n\n  // Show \"Playing\" state on Listen button if this article is currently playing\n  updateListenButtonState();\n}\n\n\n// Add \"start a note\" buttons to Open Questions in review articles\nfunction enhanceOpenQuestions(container, filename) {\n  var headings = container.querySelectorAll('h2');\n  var oqHeading = null;\n  for (var i = 0; i < headings.length; i++) {\n    if (/open questions/i.test(headings[i].textContent)) {\n      oqHeading = headings[i];\n      break;\n    }\n  }\n  if (!oqHeading) return;\n\n  var list = oqHeading.nextElementSibling;\n  if (!list || (list.tagName !== 'UL' && list.tagName !== 'OL')) return;\n\n  var items = list.querySelectorAll('li');\n  for (var j = 0; j < items.length; j++) {\n    var li = items[j];\n    var questionText = li.textContent.trim();\n    var btn = document.createElement('button');\n    btn.className = 'oq-note-btn';\n    btn.textContent = 'Note';\n    btn.setAttribute('aria-label', 'Start a note from this question');\n    (function(q) {\n      btn.onclick = function(e) {\n        e.stopPropagation();\n        var content = '# ' + q + '\\n\\n';\n        createNote(filename, content);\n        _sidebarView = 'notebooks';\n        syncSidebarTabs();\n        renderFileList();\n      };\n    })(questionText);\n    li.appendChild(btn);\n  }\n}\n\n// Rewrite review article links to open in PullRead when the article exists locally\nfunction localizeReviewLinks(container) {\n  var urlMap = {};\n  for (var i = 0; i < allFiles.length; i++) {\n    if (allFiles[i].url) urlMap[allFiles[i].url] = allFiles[i].filename;\n  }\n\n  container.querySelectorAll('li > a[href]').forEach(function(a) {\n    var href = a.getAttribute('href');\n    var localFile = urlMap[href];\n    if (!localFile) return;\n\n    a.removeAttribute('target');\n    a.removeAttribute('rel');\n    a.onclick = function(e) {\n      e.preventDefault();\n      dashLoadArticle(localFile);\n    };\n\n    // Add small external link affordance on hover\n    var ext = document.createElement('a');\n    ext.href = href;\n    ext.target = '_blank';\n    ext.rel = 'noopener noreferrer';\n    ext.className = 'review-ext-link';\n    ext.title = 'Open original';\n    ext.setAttribute('aria-label', 'Open original article');\n    ext.innerHTML = '<svg class=\"icon icon-sm\" aria-hidden=\"true\"><use href=\"#i-external\"/></svg>';\n    ext.onclick = function(e) { e.stopPropagation(); };\n    a.parentElement.appendChild(ext);\n  });\n}\n\n// ---- Reading Progress Bar ----\nfunction updateReadingProgress() {\n  const pane = document.getElementById('content-pane');\n  const bar = document.getElementById('reading-progress-bar');\n  if (!pane || !bar) return;\n  const scrollTop = pane.scrollTop;\n  const scrollHeight = pane.scrollHeight - pane.clientHeight;\n  const progress = scrollHeight > 0 ? (scrollTop / scrollHeight) * 100 : 0;\n  bar.style.width = Math.min(100, Math.max(0, progress)) + '%';\n}\n\ndocument.getElementById('content-pane').addEventListener('scroll', function() {\n  updateReadingProgress();\n  updateFocusMode();\n  updateTocActive();\n  saveScrollPosition();\n});\n\n// ---- Read Time & Word Count ----\nfunction calculateReadStats(text) {\n  const words = text.trim().split(/\\s+/).filter(w => w.length > 0).length;\n  const wpm = 238; // average adult reading speed\n  const minutes = Math.ceil(words / wpm);\n  return { words, minutes };\n}\n\nfunction formatReadStats(words, minutes) {\n  const wordStr = words >= 1000 ? (words / 1000).toFixed(1) + 'k' : words.toString();\n  return '<span class=\"read-stats\">' + minutes + ' min read<span class=\"stat-divider\">&middot;</span>' + wordStr + ' words</span>';\n}\n\n// ---- Focus Mode ----\nlet focusModeActive = false;\nlet focusObserver = null;\n\nfunction toggleFocusMode() {\n  focusModeActive = !focusModeActive;\n  document.body.classList.toggle('focus-mode', focusModeActive);\n  document.getElementById('focus-btn').classList.toggle('active', focusModeActive);\n  localStorage.setItem('pr-focus', focusModeActive ? '1' : '0');\n  if (focusModeActive) {\n    updateFocusMode();\n  } else {\n    clearFocusClasses();\n  }\n}\n\nfunction clearFocusClasses() {\n  document.querySelectorAll('.focus-active, .focus-adjacent').forEach(el => {\n    el.classList.remove('focus-active', 'focus-adjacent');\n  });\n}\n\nfunction updateFocusMode() {\n  if (!focusModeActive) return;\n  const content = document.getElementById('content');\n  if (!content || content.style.display === 'none') return;\n\n  const pane = document.getElementById('content-pane');\n  const paneRect = pane.getBoundingClientRect();\n  // Shift the focus point near the top/bottom of the scroll so edge\n  // paragraphs still get highlighted instead of being permanently dimmed.\n  const scrollTop = pane.scrollTop;\n  const scrollBottom = pane.scrollHeight - pane.clientHeight - scrollTop;\n  let focusRatio = 0.4;\n  if (scrollTop < 200) focusRatio = 0.15;\n  else if (scrollBottom < 200) focusRatio = 0.7;\n  const centerY = paneRect.top + paneRect.height * focusRatio;\n\n  const blocks = content.querySelectorAll(':scope > p, :scope > blockquote, :scope > ul, :scope > ol, :scope > pre, :scope > h2, :scope > h3, :scope > h4, :scope > table');\n\n  clearFocusClasses();\n\n  let closest = null;\n  let closestDist = Infinity;\n\n  blocks.forEach(block => {\n    const rect = block.getBoundingClientRect();\n    const blockCenter = rect.top + rect.height / 2;\n    const dist = Math.abs(blockCenter - centerY);\n    if (dist < closestDist) {\n      closestDist = dist;\n      closest = block;\n    }\n  });\n\n  if (closest) {\n    closest.classList.add('focus-active');\n    // Also highlight immediate siblings for context\n    if (closest.previousElementSibling && !closest.previousElementSibling.classList.contains('article-header')) {\n      closest.previousElementSibling.classList.add('focus-adjacent');\n    }\n    if (closest.nextElementSibling && !closest.nextElementSibling.classList.contains('notes-panel')) {\n      closest.nextElementSibling.classList.add('focus-adjacent');\n    }\n  }\n}\n\n// ---- Code Syntax Highlighting ----\nconst DIAGRAM_LANGUAGES = new Set(['mermaid', 'd2']);\n\nfunction applySyntaxHighlighting() {\n  if (typeof hljs === 'undefined') return;\n  const content = document.getElementById('content');\n  if (!content) return;\n\n  // Update highlight.js theme based on current app theme\n  updateHljsTheme();\n\n  content.querySelectorAll('pre code').forEach(block => {\n    // Skip if already highlighted\n    if (block.classList.contains('hljs')) return;\n    // Skip diagram languages — they get rendered by renderDiagrams()\n    const langMatch = block.className.match(/language-(\\w+)/);\n    if (langMatch && DIAGRAM_LANGUAGES.has(langMatch[1])) return;\n\n    hljs.highlightElement(block);\n\n    // Add language label if detected\n    const detected = block.result && block.result.language;\n    const langName = (langMatch && langMatch[1]) || detected;\n    if (langName && langName !== 'undefined') {\n      const label = document.createElement('span');\n      label.className = 'code-lang-label';\n      label.textContent = langName;\n      block.closest('pre').appendChild(label);\n    }\n  });\n}\n\n// ---- Diagram Rendering (Mermaid + D2) ----\nfunction renderDiagrams() {\n  const content = document.getElementById('content');\n  if (!content) return;\n\n  // Mermaid: client-side rendering\n  const mermaidBlocks = content.querySelectorAll('pre code.language-mermaid');\n  if (mermaidBlocks.length > 0 && typeof mermaid !== 'undefined') {\n    mermaidBlocks.forEach((block, i) => {\n      const source = block.textContent;\n      const pre = block.closest('pre');\n      const container = document.createElement('div');\n      container.className = 'diagram-container mermaid';\n      container.id = 'mermaid-diagram-' + Date.now() + '-' + i;\n      container.textContent = source;\n      pre.replaceWith(container);\n    });\n    const theme = document.body.getAttribute('data-theme');\n    const isDark = theme === 'dark' || theme === 'high-contrast';\n    mermaid.initialize({ startOnLoad: false, theme: isDark ? 'dark' : 'default' });\n    mermaid.run();\n  }\n\n  // D2: server-side via kroki.io (no client-side renderer exists)\n  content.querySelectorAll('pre code.language-d2').forEach(block => {\n    const source = block.textContent;\n    const pre = block.closest('pre');\n    const container = document.createElement('div');\n    container.className = 'diagram-container diagram-d2';\n    container.innerHTML = '<span class=\"diagram-loading\">Rendering d2 diagram\\u2026</span>';\n    pre.replaceWith(container);\n\n    fetch('https://kroki.io/d2/svg', {\n      method: 'POST',\n      headers: { 'Content-Type': 'text/plain' },\n      body: source\n    })\n    .then(function(r) { return r.ok ? r.text() : Promise.reject(r.status + ' ' + r.statusText); })\n    .then(function(svg) { container.innerHTML = sanitizeHtml(svg); })\n    .catch(function(err) {\n      container.innerHTML = '<pre style=\"text-align:left\"><code>' + escapeHtml(source) + '</code></pre>'\n        + '<p class=\"diagram-error-msg\">D2 rendering unavailable: ' + escapeHtml(String(err)) + '</p>';\n    });\n  });\n}\n\nfunction updateHljsTheme() {\n  const theme = document.body.getAttribute('data-theme');\n  const lightSheet = document.getElementById('hljs-light');\n  const darkSheet = document.getElementById('hljs-dark');\n  if (!lightSheet || !darkSheet) return;\n\n  if (theme === 'dark' || theme === 'high-contrast') {\n    lightSheet.media = 'not all';\n    darkSheet.media = 'all';\n  } else {\n    lightSheet.media = 'all';\n    darkSheet.media = 'not all';\n  }\n}\n\n// ---- Reading Position Memory ----\nlet scrollSaveTimeout = null;\n\nfunction saveScrollPosition() {\n  if (!activeFile) return;\n  clearTimeout(scrollSaveTimeout);\n  scrollSaveTimeout = setTimeout(() => {\n    const pane = document.getElementById('content-pane');\n    if (!pane) return;\n    const scrollHeight = pane.scrollHeight - pane.clientHeight;\n    if (scrollHeight <= 0) return;\n    const pct = pane.scrollTop / scrollHeight;\n    const positions = JSON.parse(localStorage.getItem('pr-scroll-positions') || '{}');\n    positions[activeFile] = { pct, ts: Date.now() };\n    // Keep only last 100 positions\n    const keys = Object.keys(positions);\n    if (keys.length > 100) {\n      const sorted = keys.sort((a, b) => positions[a].ts - positions[b].ts);\n      sorted.slice(0, keys.length - 100).forEach(k => delete positions[k]);\n    }\n    localStorage.setItem('pr-scroll-positions', JSON.stringify(positions));\n  }, 500);\n}\n\nfunction restoreScrollPosition(filename) {\n  const positions = JSON.parse(localStorage.getItem('pr-scroll-positions') || '{}');\n  const saved = positions[filename];\n  if (!saved || saved.pct < 0.02) return; // Don't restore if near the top\n\n  const pane = document.getElementById('content-pane');\n  if (!pane) return;\n\n  // Show a \"resume\" indicator\n  const indicator = document.createElement('div');\n  indicator.className = 'resume-indicator';\n  indicator.textContent = 'Resume reading \\u2193';\n  indicator.setAttribute('role', 'button');\n  indicator.setAttribute('aria-label', 'Resume reading from where you left off');\n  indicator.onclick = function() {\n    const scrollHeight = pane.scrollHeight - pane.clientHeight;\n    pane.scrollTo({ top: saved.pct * scrollHeight, behavior: 'smooth' });\n    indicator.remove();\n  };\n  document.body.appendChild(indicator);\n\n  // Auto-dismiss after 5 seconds\n  setTimeout(() => { if (indicator.parentNode) indicator.remove(); }, 5000);\n}\n\n// ---- Table of Contents ----\nfunction generateToc() {\n  const content = document.getElementById('content');\n  const tocContainer = document.getElementById('toc-container');\n  if (!content || !tocContainer) return;\n\n  const headings = content.querySelectorAll('h2, h3');\n  tocContainer.innerHTML = '';\n\n  if (headings.length < 3) return; // Only show TOC for articles with 3+ headings\n\n  const panel = document.createElement('div');\n  panel.className = 'toc-panel';\n\n  const label = document.createElement('div');\n  label.className = 'toc-label';\n  label.textContent = 'Contents';\n  panel.appendChild(label);\n\n  const list = document.createElement('ul');\n  list.className = 'toc-list';\n\n  headings.forEach((heading, i) => {\n    // Skip headings inside article-header\n    if (heading.closest('.article-header')) return;\n\n    const id = 'toc-heading-' + i;\n    heading.id = id;\n\n    const li = document.createElement('li');\n    const a = document.createElement('a');\n    a.href = '#' + id;\n    a.textContent = heading.textContent;\n    a.setAttribute('data-toc-target', id);\n    if (heading.tagName === 'H3') a.classList.add('toc-h3');\n\n    a.onclick = function(e) {\n      e.preventDefault();\n      heading.scrollIntoView({ behavior: 'smooth', block: 'start' });\n    };\n\n    li.appendChild(a);\n    list.appendChild(li);\n  });\n\n  panel.appendChild(list);\n  tocContainer.appendChild(panel);\n}\n\nfunction updateTocActive() {\n  const tocLinks = document.querySelectorAll('.toc-list a');\n  if (!tocLinks.length) return;\n\n  const pane = document.getElementById('content-pane');\n  const paneRect = pane.getBoundingClientRect();\n  const threshold = paneRect.top + 80;\n\n  let activeId = null;\n  const headings = document.querySelectorAll('#content h2[id], #content h3[id]');\n\n  headings.forEach(heading => {\n    if (heading.getBoundingClientRect().top <= threshold) {\n      activeId = heading.id;\n    }\n  });\n\n  tocLinks.forEach(link => {\n    link.classList.toggle('toc-active', link.getAttribute('data-toc-target') === activeId);\n  });\n}\n\n\n// File list\nfunction renderFileList() {\n  const list = document.getElementById('file-list');\n  const countText = document.getElementById('file-count-text');\n\n  // Apply hide-read filter\n  if (hideRead) {\n    displayFiles = filteredFiles.filter(f => !readArticles.has(f.filename) || f.filename === activeFile);\n  } else {\n    displayFiles = filteredFiles;\n  }\n\n  const searchTerm = (document.getElementById('search').value || '').trim().toLowerCase();\n\n  const total = filteredFiles.length;\n  const shown = displayFiles.length;\n  const isNotebooksTab = _sidebarView === 'notebooks';\n\n  let countStr;\n  if (isNotebooksTab) {\n    countStr = 'Notebook';\n  } else {\n    countStr = shown + ' article' + (shown !== 1 ? 's' : '');\n    if (hideRead && shown < total) countStr += ' (' + (total - shown) + ' hidden)';\n  }\n  countText.textContent = countStr;\n\n  let html = '';\n  if (isNotebooksTab) {\n    // Notebook tab: + New Note button, individual notes, annotated articles\n    html += '<div class=\"sidebar-new-note\"><button class=\"new-note-btn\" onclick=\"createNote()\"><svg class=\"icon icon-sm\" aria-hidden=\"true\"><use href=\"#i-plus\"/></svg> New Note</button></div>';\n    var nbObj = _notebooks[SINGLE_NOTEBOOK_ID];\n    var notes = nbObj ? (nbObj.notes || []) : [];\n    // Filter notes by search term\n    if (searchTerm) {\n      notes = notes.filter(function(n) {\n        var text = (n.content || '').toLowerCase();\n        return text.includes(searchTerm);\n      });\n    }\n    for (var ni = 0; ni < notes.length; ni++) {\n      html += renderNoteItem(notes[ni], ni);\n    }\n    // Annotated articles below notes\n    const annotatedFiles = displayFiles.filter(f => {\n      const { hasHl, hasNote } = hasAnnotations(f.filename);\n      return hasHl || hasNote;\n    });\n    if (annotatedFiles.length) {\n      html += '<div class=\"sidebar-section-label\">Annotated Articles</div>';\n      displayedCount = Math.min(annotatedFiles.length, PAGE_SIZE);\n      html += annotatedFiles.slice(0, displayedCount).map((f, i) => renderFileItem(f, i)).join('');\n    }\n    var totalNotes = nbObj ? (nbObj.notes || []).length : 0;\n    countStr = totalNotes + ' note' + (totalNotes !== 1 ? 's' : '');\n    countText.textContent = countStr;\n  } else {\n    // Library / Explore: show articles only\n    displayedCount = Math.min(displayFiles.length, PAGE_SIZE);\n    html += displayFiles.slice(0, displayedCount).map((f, i) => renderFileItem(f, i)).join('');\n  }\n\n  list.innerHTML = html;\n}\n\nfunction renderFileItem(f, i) {\n  const date = f.bookmarked ? f.bookmarked.slice(0, 10) : '';\n  const isActive = activeFile === f.filename ? ' active' : '';\n  const isRead = readArticles.has(f.filename);\n  const { hasHl, hasNote, isFavorite } = hasAnnotations(f.filename);\n  const hasSummary = f.hasSummary;\n  let indicators = '';\n  if (hasHl || hasNote || hasSummary || isFavorite) {\n    indicators = '<div class=\"file-item-indicators\">'\n      + (isFavorite ? '<span class=\"dot dot-favorite\" aria-label=\"Favorite\"><svg class=\"icon icon-sm\" aria-hidden=\"true\"><use href=\"#i-heart\"/></svg></span>' : '')\n      + (hasHl ? '<span class=\"dot dot-highlight\" aria-label=\"Has highlights\"></span>' : '')\n      + (hasNote ? '<span class=\"dot dot-note\" aria-label=\"Has annotations\"></span>' : '')\n      + (hasSummary ? '<span class=\"dot dot-summary\" aria-label=\"Has summary\"></span>' : '')\n      + '</div>';\n  }\n\n  const favicon = f.domain && f.domain !== 'pullread'\n    ? '<img class=\"file-item-favicon\" src=\"/favicons/' + encodeURIComponent(f.domain) + '.png\" alt=\"\" loading=\"lazy\" onerror=\"this.style.display=\\'none\\'\" aria-hidden=\"true\">'\n    : '';\n\n  const metaParts = [];\n  if (date) metaParts.push('<span>' + date + '</span>');\n  if (f.domain) metaParts.push('<span>' + escapeHtml(f.domain) + '</span>');\n  const metaHtml = metaParts.join('<span class=\"meta-sep\"></span>');\n\n  return '<div class=\"file-item' + isActive + (isRead && !isActive ? ' read' : '') + '\" data-index=\"' + i + '\" data-filename=\"' + escapeHtml(f.filename) + '\" onclick=\"loadFile(' + i + ')\" role=\"option\" aria-selected=\"' + (activeFile === f.filename) + '\" tabindex=\"0\" onkeydown=\"if(event.key===\\'Enter\\')loadFile(' + i + ')\">'\n    + '<div class=\"file-item-title\">' + escapeHtml(f.title) + '</div>'\n    + '<div class=\"file-item-meta\">' + metaHtml + favicon + '</div>'\n    + indicators\n    + '</div>';\n}\n\nfunction renderNoteItem(note, index) {\n  var isActive = _activeNoteId === note.id ? ' active' : '';\n  var firstLine = (note.content || '').split('\\n')[0].replace(/^#+\\s*/, '').trim() || 'Empty note';\n  var dateStr = note.updatedAt ? new Date(note.updatedAt).toLocaleDateString() : '';\n  var metaParts = [];\n  if (dateStr) metaParts.push('<span>' + dateStr + '</span>');\n  if (note.sourceArticle) {\n    var srcFile = allFiles.find(function(f) { return f.filename === note.sourceArticle; });\n    var domain = srcFile ? srcFile.domain : '';\n    if (domain) metaParts.push('<span>' + escapeHtml(domain) + '</span>');\n  }\n  var metaHtml = metaParts.join('<span class=\"meta-sep\"></span>');\n  return '<div class=\"file-item note-item' + isActive + '\" data-note-id=\"' + escapeHtml(note.id) + '\" onclick=\"openNoteInPane(\\'' + escapeHtml(note.id) + '\\')\" role=\"option\" tabindex=\"0\" onkeydown=\"if(event.key===\\'Enter\\')openNoteInPane(\\'' + escapeHtml(note.id) + '\\')\">'\n    + '<div class=\"file-item-title\">' + escapeHtml(firstLine.slice(0, 120)) + '</div>'\n    + '<div class=\"file-item-meta\">' + metaHtml + '</div>'\n    + '</div>';\n}\n\nfunction toggleHideRead() {\n  hideRead = !hideRead;\n  localStorage.setItem('pr-hide-read', hideRead ? '1' : '0');\n  document.getElementById('hide-read-toggle').classList.toggle('active', hideRead);\n  renderFileList();\n}\n\nfunction markAsRead(filename) {\n  readArticles.add(filename);\n  // Keep only last 5000 entries\n  if (readArticles.size > 5000) {\n    const arr = Array.from(readArticles);\n    readArticles = new Set(arr.slice(arr.length - 5000));\n  }\n  localStorage.setItem('pr-read-articles', JSON.stringify(Array.from(readArticles)));\n}\n\nfunction markCurrentAsUnread() {\n  if (!activeFile) return;\n  readArticles.delete(activeFile);\n  localStorage.setItem('pr-read-articles', JSON.stringify(Array.from(readArticles)));\n  renderFileList();\n}\n\nfunction clearSearch() {\n  var input = document.getElementById('search');\n  if (input) { input.value = ''; input.focus(); }\n  filterFiles();\n}\n\nfunction filterFiles() {\n  const raw = document.getElementById('search').value.trim();\n  var clearBtn = document.getElementById('search-clear');\n  if (clearBtn) clearBtn.style.display = raw ? '' : 'none';\n  if (!raw) {\n    filteredFiles = allFiles;\n    renderFileList();\n    return;\n  }\n\n  // Parse search query into groups separated by OR\n  // Each group is an array of terms that must ALL match (AND)\n  // Groups are combined with OR\n  const orGroups = raw.split(/\\bOR\\b/i).map(g => g.trim()).filter(Boolean);\n\n  filteredFiles = allFiles.filter(f => {\n    const notes = allNotesIndex[f.filename];\n    const { hasHl, hasNote, isFavorite, hasTags } = hasAnnotations(f.filename);\n\n    return orGroups.some(group => {\n      // Split group into individual terms (AND logic)\n      const terms = group.match(/\"[^\"]*\"|\\S+/g) || [];\n      return terms.every(term => {\n        // Remove surrounding quotes if present\n        const t = term.replace(/^\"(.*)\"$/, '$1');\n        const tl = t.toLowerCase();\n\n        // Operator: is:favorite / is:fav\n        if (tl === 'is:favorite' || tl === 'is:fav') return isFavorite;\n        // Operator: is:read\n        if (tl === 'is:read') return readArticles.has(f.filename);\n        // Operator: is:unread\n        if (tl === 'is:unread') return !readArticles.has(f.filename);\n        // Operator: has:summary\n        if (tl === 'has:summary') return f.hasSummary;\n        // Operator: has:highlights\n        if (tl === 'has:highlights' || tl === 'has:highlight') return hasHl;\n        // Operator: has:notes\n        if (tl === 'has:notes' || tl === 'has:note') return hasNote;\n        // Operator: has:tags\n        if (tl === 'has:tags' || tl === 'has:tag') return hasTags;\n        // Operator: tag:value\n        if (tl.startsWith('tag:')) {\n          const tagQ = tl.slice(4);\n          if (!tagQ) return hasTags;\n          const allTags = [...(notes?.tags || []), ...(notes?.machineTags || [])];\n          return allTags.some(t => t.toLowerCase().includes(tagQ));\n        }\n        // Operator: feed:value\n        if (tl.startsWith('feed:')) {\n          const feedQ = tl.slice(5);\n          return f.feed.toLowerCase().includes(feedQ);\n        }\n        // Operator: domain:value\n        if (tl.startsWith('domain:')) {\n          const domQ = tl.slice(7);\n          return f.domain.toLowerCase().includes(domQ);\n        }\n        // Operator: author:value\n        if (tl.startsWith('author:')) {\n          const authQ = tl.slice(7);\n          return (f.author || '').toLowerCase().includes(authQ);\n        }\n\n        // Plain text search — match against title, domain, feed, tags\n        return f.title.toLowerCase().includes(tl) ||\n          f.domain.toLowerCase().includes(tl) ||\n          f.feed.toLowerCase().includes(tl) ||\n          (notes?.tags || []).some(t => t.toLowerCase().includes(tl)) ||\n          (notes?.machineTags || []).some(t => t.toLowerCase().includes(tl));\n      });\n    });\n  });\n\n  renderFileList();\n}\n\nvar _loadFileAbort = null;\n\nasync function loadFile(index) {\n  const file = displayFiles[index];\n  if (!file) return;\n  _sidebarView = 'home'; syncSidebarTabs();\n  activeFile = file.filename;\n  markAsRead(file.filename);\n  renderFileList();\n  removeHlToolbar();\n\n  // Auto-close sidebar on mobile after selecting an article\n  if (window.innerWidth <= 768) {\n    const sidebar = document.getElementById('sidebar');\n    if (!sidebar.classList.contains('collapsed')) sidebar.classList.add('collapsed');\n  }\n\n  if (serverMode) {\n    // Abort any in-flight article fetch so stale responses don't overwrite\n    if (_loadFileAbort) _loadFileAbort.abort();\n    var controller = new AbortController();\n    _loadFileAbort = controller;\n    var targetFile = file.filename;\n\n    // Load annotations first so favorite state is available for header render\n    await preloadAnnotations(file.filename);\n    if (activeFile !== targetFile) return;\n\n    try {\n      const res = await fetch('/api/file?name=' + encodeURIComponent(file.filename), { signal: controller.signal });\n      if (activeFile !== targetFile) return;\n      if (res.ok) {\n        const text = await res.text();\n        if (activeFile !== targetFile) return;\n        renderArticle(text, file.filename);\n        applyHighlights();\n        renderNotesPanel();\n      }\n    } catch (e) {\n      if (e.name === 'AbortError') return;\n      throw e;\n    }\n  }\n}\n\n// Navigate to next (+1) or previous (-1) article with wrapping\nfunction navigateArticle(direction) {\n  if (!displayFiles.length) return;\n  const currentIdx = displayFiles.findIndex(f => f.filename === activeFile);\n  let next;\n  if (direction > 0) {\n    next = currentIdx < displayFiles.length - 1 ? currentIdx + 1 : 0;\n  } else {\n    next = currentIdx > 0 ? currentIdx - 1 : displayFiles.length - 1;\n  }\n  loadFile(next);\n  const el = document.querySelector('.file-item[data-index=\"' + next + '\"]');\n  if (el) el.scrollIntoView({ block: 'nearest' });\n}\n\n\n// Drag and drop (for standalone use)\ndocument.addEventListener('dragover', e => {\n  e.preventDefault();\n  document.body.classList.add('drop-highlight');\n});\ndocument.addEventListener('dragleave', e => {\n  if (!e.relatedTarget || !document.contains(e.relatedTarget)) {\n    document.body.classList.remove('drop-highlight');\n  }\n});\ndocument.addEventListener('drop', e => {\n  e.preventDefault();\n  document.body.classList.remove('drop-highlight');\n  const files = Array.from(e.dataTransfer.files).filter(f =>\n    f.name.endsWith('.md') || f.name.endsWith('.markdown') || f.name.endsWith('.txt')\n  );\n  if (files.length) {\n    // Add dropped files to the sidebar list\n    const reader = new FileReader();\n    reader.onload = () => {\n      const text = reader.result;\n      const { meta } = parseFrontmatter(text);\n      const file = files[0];\n      // Create a virtual entry\n      const entry = {\n        filename: file.name,\n        title: (meta && meta.title) || file.name.replace(/\\.md$/, ''),\n        url: (meta && meta.url) || '',\n        domain: (meta && meta.domain) || '',\n        bookmarked: (meta && meta.bookmarked) || '',\n        feed: (meta && meta.feed) || '',\n        _content: text\n      };\n      allFiles.unshift(entry);\n      filterFiles();\n      activeFile = entry.filename;\n      renderFileList();\n      renderArticle(text, file.name);\n    };\n    reader.readAsText(files[0]);\n  }\n});\n\n// Infinite scroll for file list pagination\ndocument.getElementById('file-list').addEventListener('scroll', function() {\n  const list = this;\n  if (list.scrollTop + list.clientHeight >= list.scrollHeight - 100) {\n    if (displayedCount < displayFiles.length) {\n      const nextBatch = displayFiles.slice(displayedCount, displayedCount + PAGE_SIZE);\n      displayedCount += nextBatch.length;\n      list.insertAdjacentHTML('beforeend', nextBatch.map((f, i) => renderFileItem(f, displayedCount - nextBatch.length + i)).join(''));\n    }\n  }\n});\n\n\n// ---- Quick-add URL ----\nfunction toggleQuickAdd() {\n  var row = document.getElementById('quick-add-row');\n  if (!row) return;\n  var visible = row.style.display !== 'none';\n  row.style.display = visible ? 'none' : 'flex';\n  if (!visible) {\n    var input = document.getElementById('quick-add-input');\n    if (input) { input.value = ''; input.focus(); }\n  }\n}\n\nfunction quickAddUrl() {\n  var input = document.getElementById('quick-add-input');\n  var url = (input.value || '').trim();\n  if (!url) return;\n  if (!url.startsWith('http://') && !url.startsWith('https://')) url = 'https://' + url;\n  var btn = document.getElementById('quick-add-save');\n  if (btn) { btn.disabled = true; btn.textContent = 'Saving\\u2026'; }\n  fetch('/api/save', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({ url: url })\n  }).then(function(r) {\n    if (r.ok) {\n      input.value = '';\n      document.getElementById('quick-add-row').style.display = 'none';\n      refreshArticleList();\n    } else {\n      alert('Failed to save URL.');\n    }\n  }).catch(function() {\n    alert('Could not connect to server.');\n  }).finally(function() {\n    if (btn) { btn.disabled = false; btn.textContent = 'Save'; }\n  });\n}\n\n// ---- Sidebar nav view switching ----\nlet _sidebarView = 'home';\n\nfunction switchSidebarView(view) {\n  _sidebarView = view;\n  syncSidebarTabs();\n\n  if (view === 'notebooks') { openSingleNotebook(); }\n  else if (view === 'home') goHome();\n}\n\nfunction openSingleNotebook() {\n  getOrCreateSingleNotebook().then(function(nb) {\n    openNotebookInPane(nb.id);\n  });\n}\n\nfunction syncSidebarTabs() {\n  document.querySelectorAll('.sidebar-nav-tab').forEach(function(t) {\n    t.classList.toggle('active', t.dataset.view === _sidebarView);\n  });\n  // Always show file list and count — articles + notebooks visible on all tabs\n  var fileCount = document.getElementById('file-count');\n  var fileList = document.getElementById('file-list');\n  if (fileCount) fileCount.style.display = '';\n  if (fileList) fileList.style.display = '';\n\n  // Update search placeholder contextually\n  var search = document.getElementById('search');\n  if (search) {\n    if (_sidebarView === 'notebooks') search.placeholder = 'Search notebooks...';\n    else search.placeholder = 'Search... try is:favorite or tag:tech';\n  }\n}\n\nlet _writingFocusActive = false;\n\nfunction toggleWritingFocus() {\n  if (_writingFocusActive) {\n    exitWritingFocus();\n    return;\n  }\n  if (!_activeNotebook) return;\n  _writingFocusActive = true;\n\n  // Create full-screen distraction-free overlay\n  var overlay = document.createElement('div');\n  overlay.className = 'writing-focus-overlay';\n  overlay.id = 'writing-focus-overlay';\n\n  if (!_activeNoteId) return;\n  var note = (_activeNotebook.notes || []).find(function(n) { return n.id === _activeNoteId; });\n  if (!note) return;\n  var title = (note.content || '').split('\\n')[0].replace(/^#+\\s*/, '').trim() || 'Untitled Note';\n  var content = note.content || '';\n  var wordCount = content.trim() ? content.trim().split(/\\s+/).length : 0;\n\n  overlay.innerHTML = '<div class=\"wf-toolbar\">'\n    + '<button onclick=\"exitWritingFocus()\" title=\"Exit focus mode (Esc)\">Exit Focus</button>'\n    + '<span class=\"wf-title\">' + escapeHtml(title) + '</span>'\n    + '<span class=\"wf-word-count\" id=\"wf-word-count\">' + wordCount + ' words</span>'\n    + '</div>'\n    + '<div class=\"wf-body\">'\n    + '<div class=\"wf-focus-line\" id=\"wf-focus-line\"></div>'\n    + '<textarea id=\"wf-textarea\">' + escapeHtml(content) + '</textarea>'\n    + '</div>';\n\n  document.body.appendChild(overlay);\n\n  var ta = document.getElementById('wf-textarea');\n  ta.focus();\n  // Move cursor to end and scroll so cursor line is vertically centered\n  ta.selectionStart = ta.selectionEnd = ta.value.length;\n  wfScrollCursorToCenter(ta);\n\n  var _wfRafPending = false;\n  function wfScheduleUpdate() {\n    if (_wfRafPending) return;\n    _wfRafPending = true;\n    requestAnimationFrame(function() {\n      _wfRafPending = false;\n      wfScrollCursorToCenter(ta);\n      updateWritingFocusLine();\n    });\n  }\n  ta.addEventListener('input', function() {\n    notebookDebounceSave();\n    wfScheduleUpdate();\n    var wc = ta.value.trim() ? ta.value.trim().split(/\\s+/).length : 0;\n    var wcEl = document.getElementById('wf-word-count');\n    if (wcEl) wcEl.textContent = wc + ' words';\n  });\n  ta.addEventListener('click', wfScheduleUpdate);\n  ta.addEventListener('keyup', function(e) {\n    // Only update on arrow keys / home / end (cursor movement without input)\n    if (e.key.startsWith('Arrow') || e.key === 'Home' || e.key === 'End') wfScheduleUpdate();\n  });\n  ta.addEventListener('scroll', updateWritingFocusLine);\n\n  // Escape key to exit\n  overlay.addEventListener('keydown', function(e) {\n    if (e.key === 'Escape') { exitWritingFocus(); }\n  });\n\n  updateWritingFocusLine();\n\n  // Update the inline Focus button state\n  var btn = document.querySelector('.notebook-toolbar button[onclick=\"toggleWritingFocus()\"]');\n  if (btn) btn.classList.add('active');\n}\n\nfunction exitWritingFocus() {\n  _writingFocusActive = false;\n\n  // Sync content back from overlay textarea to the expanded note\n  var ta = document.getElementById('wf-textarea');\n  if (ta && _activeNotebook && _activeNoteId) {\n    var note = (_activeNotebook.notes || []).find(function(n) { return n.id === _activeNoteId; });\n    if (note) {\n      note.content = ta.value;\n      note.updatedAt = new Date().toISOString();\n    }\n    notebookDebounceSave();\n  }\n\n  var overlay = document.getElementById('writing-focus-overlay');\n  if (overlay) overlay.remove();\n  var mirror = document.getElementById('wf-mirror');\n  if (mirror) mirror.remove();\n\n  // Refresh the note editor to show updated content\n  if (_activeNotebook && _activeNoteId) {\n    openNoteInPane(_activeNoteId);\n  }\n}\n\n// Keep the cursor line vertically centered in the textarea (iA Writer style)\nfunction wfScrollCursorToCenter(ta) {\n  var lh = parseFloat(getComputedStyle(ta).lineHeight) || 28.8;\n  var cursorY = measureCharY(ta, ta.selectionStart);\n  var visibleHeight = ta.parentElement ? ta.parentElement.clientHeight : ta.clientHeight;\n  var targetScroll = cursorY - visibleHeight / 2 + lh / 2;\n  ta.scrollTop = targetScroll;\n}\n\n// Find the start of the sentence containing the character at pos\nfunction findSentenceStart(text, pos) {\n  var i = pos - 1;\n  while (i >= 0) {\n    // Sentence-ending punctuation followed by whitespace\n    if (/[.!?]/.test(text[i]) && i + 1 < text.length && /\\s/.test(text[i + 1])) {\n      // Skip whitespace after punctuation to find sentence start\n      var j = i + 1;\n      while (j < pos && /\\s/.test(text[j])) j++;\n      return j;\n    }\n    // Paragraph break (double newline)\n    if (text[i] === '\\n' && i > 0 && text[i - 1] === '\\n') {\n      var j = i + 1;\n      while (j < pos && /[ \\t]/.test(text[j])) j++;\n      return j;\n    }\n    i--;\n  }\n  // Skip leading whitespace from start of text\n  var j = 0;\n  while (j < pos && /\\s/.test(text[j])) j++;\n  return j;\n}\n\n// Find the end of the sentence containing the character at pos\nfunction findSentenceEnd(text, pos) {\n  var i = pos;\n  while (i < text.length) {\n    // Sentence-ending punctuation followed by whitespace or end\n    if (/[.!?]/.test(text[i])) {\n      // Include trailing quotes/parens that are part of the sentence\n      var end = i + 1;\n      while (end < text.length && /[\"'\\u201D\\u2019)]/.test(text[end])) end++;\n      if (end >= text.length || /\\s/.test(text[end])) return end;\n    }\n    // Paragraph break\n    if (text[i] === '\\n' && i + 1 < text.length && text[i + 1] === '\\n') return i;\n    i++;\n  }\n  return text.length;\n}\n\n// Measure the visual Y position of a character in a textarea, accounting for word wrap\nfunction measureCharY(ta, charIndex) {\n  var mirror = document.getElementById('wf-mirror');\n  if (!mirror) {\n    mirror = document.createElement('div');\n    mirror.id = 'wf-mirror';\n    mirror.style.position = 'absolute';\n    mirror.style.visibility = 'hidden';\n    mirror.style.whiteSpace = 'pre-wrap';\n    mirror.style.wordWrap = 'break-word';\n    mirror.style.overflowWrap = 'break-word';\n    mirror.style.wordBreak = 'break-word';\n    document.body.appendChild(mirror);\n  }\n  var cs = getComputedStyle(ta);\n  mirror.style.font = cs.font;\n  mirror.style.lineHeight = cs.lineHeight;\n  mirror.style.letterSpacing = cs.letterSpacing;\n  mirror.style.tabSize = cs.tabSize;\n  mirror.style.padding = cs.padding;\n  mirror.style.border = cs.border;\n  mirror.style.boxSizing = cs.boxSizing;\n  mirror.style.width = ta.offsetWidth + 'px';\n\n  var textBefore = ta.value.substring(0, charIndex);\n  mirror.textContent = '';\n  var beforeNode = document.createTextNode(textBefore);\n  var marker = document.createElement('span');\n  marker.textContent = '\\u200b'; // zero-width space\n  mirror.appendChild(beforeNode);\n  mirror.appendChild(marker);\n  return marker.offsetTop;\n}\n\nfunction updateWritingFocusLine() {\n  if (!_writingFocusActive) return;\n  var ta = document.getElementById('wf-textarea');\n  var line = document.getElementById('wf-focus-line');\n  if (!ta || !line) {\n    ta = document.querySelector('.note-page .notebook-editor textarea');\n    line = document.querySelector('.notebook-focus-line');\n  }\n  if (!ta || !line) return;\n  var text = ta.value;\n  var pos = ta.selectionStart;\n  var lineHeight = parseFloat(getComputedStyle(ta).lineHeight) || 28.8;\n\n  // Find sentence boundaries around cursor\n  var sentStart = findSentenceStart(text, pos);\n  var sentEnd = findSentenceEnd(text, pos);\n\n  // Measure visual positions using mirror div (accounts for word wrap)\n  var startY = measureCharY(ta, sentStart);\n  var endY = measureCharY(ta, sentEnd > 0 ? sentEnd - 1 : 0);\n\n  var top = startY - ta.scrollTop;\n  var height = endY - startY + lineHeight;\n  line.style.top = top + 'px';\n  line.style.height = height + 'px';\n}\n\n\n// ABOUTME: Highlights, inline annotations, and footnote rendering for article content.\n// ABOUTME: Manages highlight creation/deletion, footnote numbering, and the notes panel.\n\nasync function preloadAnnotations(filename) {\n  if (!serverMode) return;\n  try {\n    const [hlRes, notesRes] = await Promise.all([\n      fetch('/api/highlights?name=' + encodeURIComponent(filename)),\n      fetch('/api/notes?name=' + encodeURIComponent(filename))\n    ]);\n    articleHighlights = hlRes.ok ? await hlRes.json() : [];\n    const notesData = notesRes.ok ? await notesRes.json() : {};\n    articleNotes = { articleNote: '', annotations: [], tags: [], isFavorite: false, ...notesData };\n  } catch {\n    articleHighlights = [];\n    articleNotes = { articleNote: '', annotations: [], tags: [], isFavorite: false };\n  }\n}\n\nasync function loadAnnotations(filename) {\n  await preloadAnnotations(filename);\n  applyHighlights();\n  renderNotesPanel();\n}\n\nasync function loadAnnotationsIndex() {\n  if (!serverMode) return;\n  try {\n    const [hlRes, notesRes] = await Promise.all([\n      fetch('/api/highlights'),\n      fetch('/api/notes')\n    ]);\n    allHighlightsIndex = hlRes.ok ? await hlRes.json() : {};\n    allNotesIndex = notesRes.ok ? await notesRes.json() : {};\n  } catch {\n    allHighlightsIndex = {};\n    allNotesIndex = {};\n  }\n}\n\nfunction hasAnnotations(filename) {\n  const hls = allHighlightsIndex[filename] || [];\n  const hasHl = hls.length > 0;\n  const hasHlNotes = hls.some(h => h.note);\n  const notes = allNotesIndex[filename];\n  const hasNote = notes && (notes.articleNote || (notes.annotations && notes.annotations.length > 0) || hasHlNotes);\n  const isFavorite = notes && notes.isFavorite;\n  const hasTags = notes && ((notes.tags && notes.tags.length > 0) || (notes.machineTags && notes.machineTags.length > 0));\n  return { hasHl, hasNote, isFavorite, hasTags };\n}\n\nasync function saveHighlights() {\n  if (!serverMode || !activeFile) return;\n  allHighlightsIndex[activeFile] = articleHighlights;\n  await fetch('/api/highlights', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({ name: activeFile, highlights: articleHighlights })\n  });\n}\n\nasync function saveNotes() {\n  if (!serverMode || !activeFile) return;\n  allNotesIndex[activeFile] = articleNotes;\n  await fetch('/api/notes', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({ name: activeFile, ...articleNotes })\n  });\n}\n\nfunction generateId() {\n  return 'h' + Math.random().toString(36).slice(2, 8);\n}\n\nfunction getTextContext(text, before, after) {\n  // Get surrounding context for anchoring\n  const content = document.getElementById('content');\n  const fullText = content.textContent || '';\n  const idx = fullText.indexOf(text);\n  if (idx < 0) return { contextBefore: '', contextAfter: '' };\n  return {\n    contextBefore: fullText.slice(Math.max(0, idx - 30), idx),\n    contextAfter: fullText.slice(idx + text.length, idx + text.length + 30)\n  };\n}\n\nfunction createHighlight(color) {\n  const sel = window.getSelection();\n  if (!sel || sel.isCollapsed || !sel.toString().trim()) return;\n\n  const text = sel.toString();\n  const { contextBefore, contextAfter } = getTextContext(text);\n\n  const now = new Date().toISOString();\n  const highlight = {\n    id: generateId(),\n    text: text,\n    contextBefore,\n    contextAfter,\n    color: color,\n    note: '',\n    createdAt: now,\n    updatedAt: now\n  };\n\n  articleHighlights.push(highlight);\n  saveHighlights();\n  applyHighlights();\n  removeHlToolbar();\n  sel.removeAllRanges();\n  renderFileList(); // update indicator dots\n}\n\nfunction deleteHighlight(id) {\n  articleHighlights = articleHighlights.filter(h => h.id !== id);\n  saveHighlights();\n  applyHighlights();\n  renderFileList();\n}\n\n// ---- Footnotes ----\nlet footnoteEntries = [];\n\nfunction assignFootnoteNumbers() {\n  const content = document.getElementById('content');\n  if (!content) return;\n  footnoteEntries = [];\n\n  // Collect all anchored elements (highlights and annotation markers)\n  const elements = [];\n  content.querySelectorAll('mark[data-hl-id]').forEach(el => {\n    const hl = articleHighlights.find(h => h.id === el.getAttribute('data-hl-id'));\n    if (hl) elements.push({ el, type: 'highlight', data: hl });\n  });\n  content.querySelectorAll('.annotation-marker[data-ann-id]').forEach(el => {\n    const ann = (articleNotes.annotations || []).find(a => a.id === el.getAttribute('data-ann-id'));\n    if (ann) elements.push({ el, type: 'annotation', data: ann });\n  });\n\n  // Sort by document position\n  elements.sort((a, b) => {\n    const pos = a.el.compareDocumentPosition(b.el);\n    if (pos & Node.DOCUMENT_POSITION_FOLLOWING) return -1;\n    if (pos & Node.DOCUMENT_POSITION_PRECEDING) return 1;\n    return 0;\n  });\n\n  // Assign numbers and insert superscript markers\n  elements.forEach((item, i) => {\n    const num = i + 1;\n    const sup = document.createElement('sup');\n    sup.className = 'footnote-marker';\n    sup.id = 'fnref-' + num;\n    sup.textContent = num;\n    sup.onclick = function(e) { e.stopPropagation(); scrollToFootnote(num); };\n    item.el.after(sup);\n\n    const entry = { num, type: item.type, id: item.data.id };\n    if (item.type === 'highlight') {\n      entry.text = item.data.text;\n      entry.note = item.data.note || '';\n      entry.color = item.data.color;\n    } else {\n      entry.text = item.data.anchorText || '';\n      entry.note = item.data.note || '';\n    }\n    footnoteEntries.push(entry);\n  });\n}\n\nfunction renderFootnotes() {\n  const content = document.getElementById('content');\n  if (!content) return;\n  const existing = content.querySelector('.footnotes-section');\n  if (existing) existing.remove();\n\n  if (footnoteEntries.length === 0) return;\n\n  const section = document.createElement('section');\n  section.className = 'footnotes-section';\n\n  let html = '<div class=\"footnotes-heading\">Footnotes</div><ol class=\"footnotes-list\">';\n  for (const entry of footnoteEntries) {\n    const excerpt = escapeHtml((entry.text || '').slice(0, 80));\n    const colorClass = entry.type === 'highlight' && entry.color ? ' hl-' + entry.color : '';\n    html += '<li class=\"footnote-entry\" id=\"fn-' + entry.num + '\" onclick=\"scrollToFootnoteRef(' + entry.num + ')\">';\n    html += '<span class=\"footnote-backref\">' + entry.num + '.</span>';\n    if (excerpt) {\n      html += '<span class=\"footnote-quote' + (colorClass ? ' pr-highlight' + colorClass : '') + '\">' + excerpt + (entry.text.length > 80 ? '...' : '') + '</span>';\n    }\n    if (entry.note) {\n      html += '<div class=\"footnote-note\">' + escapeHtml(entry.note) + '</div>';\n    }\n    html += '</li>';\n  }\n  html += '</ol>';\n  section.innerHTML = html;\n\n  // Insert before notes panel to maintain correct order\n  const notesPanel = content.querySelector('.notes-panel');\n  if (notesPanel) {\n    content.insertBefore(section, notesPanel);\n  } else {\n    content.appendChild(section);\n  }\n}\n\nfunction scrollToFootnote(num) {\n  const el = document.getElementById('fn-' + num);\n  if (!el) return;\n  el.scrollIntoView({ behavior: 'smooth', block: 'center' });\n  el.classList.add('flash');\n  setTimeout(() => el.classList.remove('flash'), 1500);\n}\n\nfunction scrollToFootnoteRef(num) {\n  const el = document.getElementById('fnref-' + num);\n  if (!el) return;\n  el.scrollIntoView({ behavior: 'smooth', block: 'center' });\n  el.style.outline = '2px solid var(--link)';\n  setTimeout(() => { el.style.outline = ''; }, 1500);\n}\n\nfunction applyHighlights() {\n  const content = document.getElementById('content');\n  if (!content) return;\n\n  // Remove existing highlights (re-render from raw HTML)\n  content.querySelectorAll('mark.pr-highlight').forEach(mark => {\n    const parent = mark.parentNode;\n    while (mark.firstChild) parent.insertBefore(mark.firstChild, mark);\n    parent.removeChild(mark);\n    parent.normalize();\n  });\n\n  // Remove annotation markers, highlight note markers, and footnote markers\n  content.querySelectorAll('.annotation-marker').forEach(m => m.remove());\n  content.querySelectorAll('.hl-note-marker').forEach(m => m.remove());\n  content.querySelectorAll('.footnote-marker').forEach(m => m.remove());\n\n  // Apply each highlight\n  for (const hl of articleHighlights) {\n    findAndWrap(content, hl);\n  }\n\n  // Apply inline annotations\n  for (const ann of (articleNotes.annotations || [])) {\n    findAndMarkAnnotation(content, ann);\n  }\n\n  // Build footnotes from highlights and annotations\n  assignFootnoteNumbers();\n  renderFootnotes();\n}\n\nfunction renderMarginNotes() {\n  // Margin notes replaced by footnotes section at bottom of article\n  const marginContainer = document.getElementById('margin-notes');\n  if (marginContainer) marginContainer.innerHTML = '';\n}\n\nfunction findAndWrap(container, hl) {\n  const searchText = hl.text;\n  const fullText = container.textContent || '';\n\n  // Find the best match position using context\n  let targetGlobalIdx = -1;\n  if (hl.contextBefore || hl.contextAfter) {\n    const ctxBefore = (hl.contextBefore || '').slice(-15);\n    const ctxAfter = (hl.contextAfter || '').slice(0, 15);\n    const needle = ctxBefore + searchText + ctxAfter;\n    const pos = fullText.indexOf(needle);\n    if (pos >= 0) {\n      targetGlobalIdx = pos + ctxBefore.length;\n    }\n  }\n  if (targetGlobalIdx < 0) {\n    targetGlobalIdx = fullText.indexOf(searchText);\n  }\n  if (targetGlobalIdx < 0) return;\n\n  const endGlobalIdx = targetGlobalIdx + searchText.length;\n\n  // Walk text nodes to find start and end positions (handles cross-element spans)\n  const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT);\n  let charCount = 0;\n  let startNode = null, startOffset = 0;\n  let endNode = null, endOffset = 0;\n  let node;\n\n  while (node = walker.nextNode()) {\n    const nodeLen = node.textContent.length;\n    if (!startNode && charCount + nodeLen > targetGlobalIdx) {\n      startNode = node;\n      startOffset = targetGlobalIdx - charCount;\n    }\n    if (startNode && charCount + nodeLen >= endGlobalIdx) {\n      endNode = node;\n      endOffset = endGlobalIdx - charCount;\n      break;\n    }\n    charCount += nodeLen;\n  }\n\n  if (!startNode || !endNode) return;\n\n  try {\n    const range = document.createRange();\n    range.setStart(startNode, startOffset);\n    range.setEnd(endNode, endOffset);\n\n    const mark = document.createElement('mark');\n    mark.className = 'pr-highlight hl-' + hl.color;\n    mark.setAttribute('data-hl-id', hl.id);\n    mark.onclick = function(e) {\n      e.stopPropagation();\n      showHighlightContextMenu(e, hl);\n    };\n\n    // extractContents handles cross-element ranges (bold/italic boundaries)\n    // where surroundContents would throw\n    const fragment = range.extractContents();\n    mark.appendChild(fragment);\n    range.insertNode(mark);\n  } catch {\n    return;\n  }\n}\n\nfunction findAndMarkAnnotation(container, ann) {\n  if (!ann.anchorText) return;\n  const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT);\n  let node;\n  while (node = walker.nextNode()) {\n    const idx = node.textContent.indexOf(ann.anchorText);\n    if (idx < 0) continue;\n    // Insert a marker after the anchor text\n    const marker = document.createElement('span');\n    marker.className = 'annotation-marker';\n    marker.setAttribute('data-ann-id', ann.id);\n    marker.textContent = '';\n    marker.title = ann.note;\n    marker.onclick = function(e) {\n      e.stopPropagation();\n      showAnnotationPopover(e, ann);\n    };\n    const textAfter = node.splitText(idx + ann.anchorText.length);\n    textAfter.parentNode.insertBefore(marker, textAfter);\n    return;\n  }\n}\n\n// Floating highlight toolbar on text selection\nlet hlToolbarEl = null;\n\nfunction removeHlToolbar() {\n  if (hlToolbarEl) {\n    hlToolbarEl.remove();\n    hlToolbarEl = null;\n  }\n  // Only remove annotation popover if not actively focused (user is typing)\n  const popover = document.querySelector('.annotation-popover');\n  if (popover && !popover.contains(document.activeElement)) {\n    popover.remove();\n  }\n}\n\nfunction removeAnnotationPopover() {\n  const existing = document.querySelector('.annotation-popover');\n  if (existing) existing.remove();\n}\n\nfunction showHlToolbar(x, y) {\n  removeHlToolbar();\n  const bar = document.createElement('div');\n  bar.className = 'hl-toolbar';\n  // Prevent mousedown from clearing the text selection — critical for\n  // highlight/note buttons to read the selection when their onclick fires\n  bar.addEventListener('mousedown', e => e.preventDefault());\n  bar.innerHTML = `\n    <button class=\"hl-yellow-btn\" aria-label=\"Highlight yellow\" onclick=\"createHighlight('yellow')\"></button>\n    <button class=\"hl-green-btn\" aria-label=\"Highlight green\" onclick=\"createHighlight('green')\"></button>\n    <button class=\"hl-blue-btn\" aria-label=\"Highlight blue\" onclick=\"createHighlight('blue')\"></button>\n    <button class=\"hl-pink-btn\" aria-label=\"Highlight pink\" onclick=\"createHighlight('pink')\"></button>\n    <button class=\"hl-note-btn\" aria-label=\"Add note\" onclick=\"addInlineNote()\">+ Note</button>\n  `;\n  bar.style.left = x + 'px';\n  bar.style.top = y + 'px';\n  document.getElementById('content-pane').appendChild(bar);\n  hlToolbarEl = bar;\n}\n\nfunction showHighlightContextMenu(e, hl) {\n  removeHlToolbar();\n  const bar = document.createElement('div');\n  bar.className = 'hl-toolbar';\n  bar.addEventListener('mousedown', e => e.preventDefault());\n  const noteLabel = hl.note ? 'Edit Note' : 'Note';\n  bar.innerHTML = `\n    <button class=\"hl-yellow-btn\" aria-label=\"Yellow\" onclick=\"changeHighlightColor('${hl.id}','yellow')\"></button>\n    <button class=\"hl-green-btn\" aria-label=\"Green\" onclick=\"changeHighlightColor('${hl.id}','green')\"></button>\n    <button class=\"hl-blue-btn\" aria-label=\"Blue\" onclick=\"changeHighlightColor('${hl.id}','blue')\"></button>\n    <button class=\"hl-pink-btn\" aria-label=\"Pink\" onclick=\"changeHighlightColor('${hl.id}','pink')\"></button>\n    <button class=\"hl-note-btn\" aria-label=\"${noteLabel}\" onclick=\"editHighlightNote('${hl.id}', event)\">${noteLabel}</button>\n    <button class=\"hl-note-btn\" style=\"color:red;border-color:red\" aria-label=\"Delete highlight\" onclick=\"deleteHighlight('${hl.id}')\">Del</button>\n  `;\n  const pane = document.getElementById('content-pane');\n  bar.style.left = (e.clientX - pane.getBoundingClientRect().left) + 'px';\n  bar.style.top = (e.clientY - pane.getBoundingClientRect().top + pane.scrollTop - 40) + 'px';\n  pane.appendChild(bar);\n  hlToolbarEl = bar;\n}\n\nfunction changeHighlightColor(id, color) {\n  const hl = articleHighlights.find(h => h.id === id);\n  if (hl) {\n    hl.color = color;\n    hl.updatedAt = new Date().toISOString();\n    saveHighlights();\n    applyHighlights();\n  }\n  removeHlToolbar();\n}\n\nfunction editHighlightNote(id, e) {\n  removeHlToolbar();\n  const hl = articleHighlights.find(h => h.id === id);\n  if (!hl) return;\n\n  const pane = document.getElementById('content-pane');\n  const paneRect = pane.getBoundingClientRect();\n  const popover = document.createElement('div');\n  popover.className = 'annotation-popover';\n  popover.style.left = (e.clientX - paneRect.left) + 'px';\n  popover.style.top = (e.clientY - paneRect.top + pane.scrollTop + 10) + 'px';\n  popover.innerHTML = `\n    <div style=\"font-size:12px;color:var(--muted);margin-bottom:6px\">Note on highlight: \"${escapeHtml(hl.text.slice(0, 50))}${hl.text.length > 50 ? '...' : ''}\"</div>\n    <textarea placeholder=\"Add a note to this highlight...\">${escapeHtml(hl.note || '')}</textarea>\n    <div class=\"btn-row\">\n      ${hl.note ? '<button style=\"color:red;border-color:red\" onclick=\"clearHighlightNote(\\'' + id + '\\')\">Remove</button>' : ''}\n      <button onclick=\"removeAnnotationPopover()\">Cancel</button>\n      <button class=\"primary\" onclick=\"saveHighlightNote('${id}', this)\">Save</button>\n    </div>\n  `;\n  popover.onclick = function(ev) { ev.stopPropagation(); };\n  pane.appendChild(popover);\n  popover.querySelector('textarea').focus();\n}\n\nfunction saveHighlightNote(id, btn) {\n  const popover = btn.closest('.annotation-popover');\n  const note = popover.querySelector('textarea').value.trim();\n  const hl = articleHighlights.find(h => h.id === id);\n  if (hl) {\n    hl.note = note;\n    hl.updatedAt = new Date().toISOString();\n    saveHighlights();\n    applyHighlights();\n    renderNotesPanel();\n    renderFileList();\n  }\n  removeAnnotationPopover();\n}\n\nfunction clearHighlightNote(id) {\n  const hl = articleHighlights.find(h => h.id === id);\n  if (hl) {\n    hl.note = '';\n    hl.updatedAt = new Date().toISOString();\n    saveHighlights();\n    applyHighlights();\n    renderNotesPanel();\n    renderFileList();\n  }\n  removeAnnotationPopover();\n}\n\n// Listen for text selection in content pane\ndocument.addEventListener('mouseup', e => {\n  // Don't dismiss anything if clicking inside an annotation popover or margin note\n  if (e.target.closest && e.target.closest('.annotation-popover, .margin-note')) return;\n\n  const contentEl = document.getElementById('content');\n  if (!contentEl || !contentEl.contains(e.target)) {\n    // Don't remove toolbar if clicking on the toolbar itself\n    if (hlToolbarEl && hlToolbarEl.contains(e.target)) return;\n    removeHlToolbar();\n    return;\n  }\n\n  const sel = window.getSelection();\n  if (!sel || sel.isCollapsed || !sel.toString().trim()) return;\n\n  // Don't show highlight toolbar on Guide or Explore pages\n  if (!activeFile) return;\n\n  const pane = document.getElementById('content-pane');\n  const range = sel.getRangeAt(0);\n  const rect = range.getBoundingClientRect();\n  const paneRect = pane.getBoundingClientRect();\n\n  const x = rect.left - paneRect.left + rect.width / 2 - 70;\n  const y = rect.top - paneRect.top + pane.scrollTop - 40;\n  showHlToolbar(Math.max(10, x), y);\n});\n\n// Inline annotations\nfunction addInlineNote() {\n  const sel = window.getSelection();\n  if (!sel || sel.isCollapsed || !sel.toString().trim()) return;\n  const anchorText = sel.toString();\n  const pane = document.getElementById('content-pane');\n  const range = sel.getRangeAt(0);\n  const rect = range.getBoundingClientRect();\n  const paneRect = pane.getBoundingClientRect();\n\n  removeHlToolbar();\n\n  const popover = document.createElement('div');\n  popover.className = 'annotation-popover';\n  popover.style.left = (rect.left - paneRect.left) + 'px';\n  popover.style.top = (rect.bottom - paneRect.top + pane.scrollTop + 5) + 'px';\n  // Store anchor text as data attribute to avoid escaping issues with\n  // newlines/quotes in onclick string literals\n  popover.setAttribute('data-anchor', anchorText);\n  popover.innerHTML = `\n    <div style=\"font-size:12px;color:var(--muted);margin-bottom:6px\">Note on: \"${escapeHtml(anchorText.slice(0, 50))}${anchorText.length > 50 ? '...' : ''}\"</div>\n    <textarea placeholder=\"Add your note...\" autofocus></textarea>\n    <div class=\"btn-row\">\n      <button onclick=\"removeAnnotationPopover()\">Cancel</button>\n      <button class=\"primary\" onclick=\"saveInlineNote(this)\">Save</button>\n    </div>\n  `;\n  popover.onclick = function(e) { e.stopPropagation(); };\n  pane.appendChild(popover);\n  popover.querySelector('textarea').focus();\n  sel.removeAllRanges();\n}\n\nfunction saveInlineNote(btn) {\n  const popover = btn.closest('.annotation-popover');\n  const anchorText = popover.getAttribute('data-anchor') || '';\n  const note = popover.querySelector('textarea').value.trim();\n  if (!note) { removeAnnotationPopover(); return; }\n\n  const { contextBefore, contextAfter } = getTextContext(anchorText);\n  const now = new Date().toISOString();\n  const annotation = {\n    id: generateId(),\n    anchorText,\n    contextBefore,\n    contextAfter,\n    note,\n    createdAt: now,\n    updatedAt: now\n  };\n  if (!articleNotes.annotations) articleNotes.annotations = [];\n  articleNotes.annotations.push(annotation);\n  saveNotes();\n  applyHighlights();\n  removeAnnotationPopover();\n  renderFileList();\n}\n\nfunction showAnnotationPopover(e, ann) {\n  removeAnnotationPopover();\n  removeHlToolbar();\n\n  const pane = document.getElementById('content-pane');\n  const paneRect = pane.getBoundingClientRect();\n  const popover = document.createElement('div');\n  popover.className = 'annotation-popover';\n  popover.style.left = (e.clientX - paneRect.left) + 'px';\n  popover.style.top = (e.clientY - paneRect.top + pane.scrollTop + 10) + 'px';\n  popover.innerHTML = `\n    <textarea>${escapeHtml(ann.note)}</textarea>\n    <div class=\"btn-row\">\n      <button style=\"color:red;border-color:red\" onclick=\"deleteAnnotation('${ann.id}')\">Delete</button>\n      <button onclick=\"removeAnnotationPopover()\">Cancel</button>\n      <button class=\"primary\" onclick=\"updateAnnotation('${ann.id}', this)\">Save</button>\n    </div>\n  `;\n  popover.onclick = function(e) { e.stopPropagation(); };\n  pane.appendChild(popover);\n}\n\nfunction deleteAnnotation(id) {\n  articleNotes.annotations = (articleNotes.annotations || []).filter(a => a.id !== id);\n  saveNotes();\n  applyHighlights();\n  removeAnnotationPopover();\n  renderFileList();\n}\n\nfunction updateAnnotation(id, btn) {\n  const popover = btn.closest('.annotation-popover');\n  const note = popover.querySelector('textarea').value.trim();\n  const ann = (articleNotes.annotations || []).find(a => a.id === id);\n  if (ann) {\n    ann.note = note;\n    ann.updatedAt = new Date().toISOString();\n    saveNotes();\n  }\n  removeAnnotationPopover();\n}\n\n// Article-level annotations panel\nfunction renderNotesPanel() {\n  const existing = document.querySelector('.notes-panel');\n  if (existing) existing.remove();\n\n  const content = document.getElementById('content');\n  if (!content || content.style.display === 'none') return;\n\n  const panel = document.createElement('div');\n  panel.className = 'notes-panel';\n  const noteText = articleNotes.articleNote || '';\n\n  const tags = articleNotes.tags || [];\n  const machineTags = articleNotes.machineTags || [];\n  const tagsHtml = tags.map(t => '<span class=\"tag\">' + escapeHtml(t) + '<span class=\"tag-remove\" onclick=\"removeTag(\\'' + escapeHtml(t.replace(/'/g, \"\\\\'\")) + '\\')\">&times;</span></span>').join('')\n    + machineTags.map(t => '<span class=\"tag tag-machine\" title=\"Auto-generated\">' + escapeHtml(t) + '</span>').join('');\n\n  panel.innerHTML = `\n    <div class=\"annotations-heading\">Annotations</div>\n    <div class=\"tags-row\">\n      ${tagsHtml}\n      <input type=\"text\" placeholder=\"Add tag...\" onkeydown=\"handleTagKey(event)\" />\n    </div>\n    <div class=\"notes-textarea-wrap\">\n      <textarea placeholder=\"Write a note...\">${escapeHtml(noteText)}</textarea>\n      <button class=\"voice-note-btn\" onclick=\"toggleVoiceNote(this)\" title=\"Voice note\"><svg aria-hidden=\"true\"><use href=\"#i-mic\"/></svg></button>\n    </div>\n    <div class=\"notes-save-hint\">Auto-saved</div>\n  `;\n\n  content.appendChild(panel);\n\n  const textarea = panel.querySelector('textarea');\n  let saveTimeout;\n  textarea.addEventListener('input', () => {\n    clearTimeout(saveTimeout);\n    saveTimeout = setTimeout(() => {\n      articleNotes.articleNote = textarea.value;\n      saveNotes();\n      renderFileList();\n    }, 800);\n  });\n  textarea.addEventListener('blur', () => {\n    articleNotes.articleNote = textarea.value;\n    saveNotes();\n    renderFileList();\n  });\n}\n\nfunction toggleFavorite(btn) {\n  articleNotes.isFavorite = !articleNotes.isFavorite;\n  saveNotes();\n  renderNotesPanel();\n  renderFileList();\n  updateHeaderActions();\n}\n\n// Alias for backward compatibility with header button onclick\nvar toggleFavoriteFromHeader = toggleFavorite;\n\nfunction toggleNotesFromHeader() {\n  const panel = document.querySelector('.notes-panel');\n  if (panel) {\n    panel.scrollIntoView({ behavior: 'smooth', block: 'center' });\n    const ta = panel.querySelector('textarea');\n    if (ta) ta.focus();\n  }\n}\n\nfunction scrollToHighlight(id) {\n  const mark = document.querySelector('mark[data-hl-id=\"' + id + '\"]');\n  if (mark) {\n    mark.scrollIntoView({ behavior: 'smooth', block: 'center' });\n    mark.style.outline = '2px solid var(--link)';\n    setTimeout(() => { mark.style.outline = ''; }, 1500);\n  }\n}\n\nfunction updateHeaderActions() {\n  const actions = document.querySelector('.article-actions');\n  if (!actions) return;\n  const favBtn = actions.querySelector('button');\n  if (favBtn) {\n    favBtn.className = articleNotes.isFavorite ? 'active-fav' : '';\n    favBtn.innerHTML = '<svg class=\"icon icon-sm\"><use href=\"#i-' + (articleNotes.isFavorite ? 'heart' : 'heart-o') + '\"/></svg> Favorite';\n  }\n}\n\nfunction handleTagKey(e) {\n  handleTagInput(e,\n    function() { if (!articleNotes.tags) articleNotes.tags = []; return articleNotes.tags; },\n    function() { saveNotes(); renderNotesPanel(); renderFileList(); }\n  );\n}\n\nfunction removeTag(tag) {\n  if (!articleNotes.tags) return;\n  articleNotes.tags = articleNotes.tags.filter(t => t !== tag);\n  saveNotes();\n  renderNotesPanel();\n  renderFileList();\n}\n\n// ---- Voice Notes (Web Speech API) ----\nlet voiceRecognition = null;\n\nfunction toggleVoiceNote(btn) {\n  if (voiceRecognition) {\n    voiceRecognition.stop();\n    return;\n  }\n\n  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;\n  if (!SpeechRecognition) {\n    alert('Speech recognition is not supported in this browser. Try Chrome or Safari.');\n    return;\n  }\n\n  const textarea = btn.closest('.notes-textarea-wrap').querySelector('textarea');\n  if (!textarea) return;\n\n  const recognition = new SpeechRecognition();\n  recognition.continuous = true;\n  recognition.interimResults = true;\n  recognition.lang = navigator.language || 'en-US';\n\n  let finalTranscript = '';\n\n  recognition.onstart = function() {\n    voiceRecognition = recognition;\n    btn.classList.add('recording');\n    btn.innerHTML = '<svg aria-hidden=\"true\"><use href=\"#i-stop\"/></svg>';\n    btn.title = 'Stop recording';\n  };\n\n  recognition.onresult = function(event) {\n    let interim = '';\n    for (let i = event.resultIndex; i < event.results.length; i++) {\n      if (event.results[i].isFinal) {\n        finalTranscript += event.results[i][0].transcript;\n      } else {\n        interim += event.results[i][0].transcript;\n      }\n    }\n    // Show live preview: existing text + final transcript + interim (dimmed)\n    const existingText = textarea.value;\n    const separator = existingText && !existingText.endsWith('\\n') && !existingText.endsWith(' ') ? '\\n' : '';\n    const preview = existingText + separator + finalTranscript + interim;\n    textarea.value = preview;\n    textarea.scrollTop = textarea.scrollHeight;\n  };\n\n  recognition.onend = function() {\n    voiceRecognition = null;\n    btn.classList.remove('recording');\n    btn.innerHTML = '<svg aria-hidden=\"true\"><use href=\"#i-mic\"/></svg>';\n    btn.title = 'Voice note (requires microphone)';\n    // Commit final transcript to notes\n    if (finalTranscript.trim()) {\n      const existingText = articleNotes.articleNote || '';\n      const separator = existingText && !existingText.endsWith('\\n') && !existingText.endsWith(' ') ? '\\n' : '';\n      articleNotes.articleNote = existingText + separator + finalTranscript.trim();\n      textarea.value = articleNotes.articleNote;\n      saveNotes();\n      renderFileList();\n    }\n  };\n\n  recognition.onerror = function(event) {\n    if (event.error === 'not-allowed') {\n      alert('Microphone access was denied. Please allow microphone access in your browser settings.');\n    }\n    voiceRecognition = null;\n    btn.classList.remove('recording');\n    btn.innerHTML = '<svg aria-hidden=\"true\"><use href=\"#i-mic\"/></svg>';\n    btn.title = 'Voice note (requires microphone)';\n  };\n\n  recognition.start();\n}\n\n\n// ---- TTS Audio Playback ----\nlet ttsQueue = [];\nlet ttsCurrentIndex = -1;\nlet ttsAudio = null;        // HTMLAudioElement for cloud TTS\nlet ttsSynthUtterance = null; // SpeechSynthesisUtterance for browser TTS\nlet ttsPlaying = false;\nlet ttsSpeed = 1.0;\nlet ttsProvider = 'browser';\nlet ttsGenerating = false;\nlet ttsProgressTimer = null;\nlet _ttsChunkSession = null; // { id, totalChunks, currentChunk, elapsedTime }\nvar _ttsNextPrefetch = null;  // { filename, sessionId, totalChunks, currentChunk, done }\n\nconst TTS_SPEEDS = [0.5, 0.6, 0.7, 0.8, 0.85, 0.9, 0.95, 1.0, 1.1, 1.15, 1.2, 1.3, 1.5, 1.75, 2.0];\n\nfunction playCueSound() {\n  try { new Audio('/audio/cue.webm').play(); } catch(e) {}\n}\n\n// ---- Listen button loading animation ----\nvar LISTEN_WORDS = [\n  'Reading', 'Processing', 'Generating', 'Preparing', 'Creating',\n  'Warming up', 'Clearing throat', 'Rehearsing', 'Caffeinating', 'Inhaling',\n  'Summoning', 'Channeling', 'Tuning', 'Vocalizing', 'Manifesting',\n  'Contemplating', 'Conjuring', 'Brewing', 'Stretching', 'Composing',\n  'Hydrating', 'Buffering', 'Focusing', 'Harmonizing', 'Simmering',\n];\nvar _listenTimer = null;\nvar _listenWordIdx = 0;\nvar _listenLoadingFile = null;\n\nfunction startListenLoading() {\n  var btn = document.getElementById('listen-btn');\n  if (!btn) return;\n  btn.classList.add('listen-loading');\n  _listenWordIdx = Math.floor(Math.random() * LISTEN_WORDS.length);\n  btn.innerHTML = '<svg class=\"icon icon-sm\" aria-hidden=\"true\"><use href=\"#i-volume\"/></svg> ' + LISTEN_WORDS[_listenWordIdx] + '\\u2026';\n  _listenTimer = setInterval(function() {\n    _listenWordIdx = (_listenWordIdx + 1) % LISTEN_WORDS.length;\n    if (activeFile !== _listenLoadingFile) return;\n    var b = document.getElementById('listen-btn');\n    if (!b) { stopListenLoading(); return; }\n    b.innerHTML = '<svg class=\"icon icon-sm\" aria-hidden=\"true\"><use href=\"#i-volume\"/></svg> ' + LISTEN_WORDS[_listenWordIdx] + '\\u2026';\n  }, 2500);\n}\n\nfunction stopListenLoading() {\n  if (_listenTimer) { clearInterval(_listenTimer); _listenTimer = null; }\n  _listenLoadingFile = null;\n  var btn = document.getElementById('listen-btn');\n  if (btn) btn.classList.remove('listen-loading');\n  updateListenButtonState();\n}\n\nfunction updateListenButtonState() {\n  var btn = document.getElementById('listen-btn');\n  if (!btn || (_listenTimer && activeFile === _listenLoadingFile)) return; // Loading animation takes precedence\n  var playingFile = ttsPlaying && ttsCurrentIndex >= 0 && ttsCurrentIndex < ttsQueue.length\n    ? ttsQueue[ttsCurrentIndex].filename : null;\n  // Use \"Play\" label for podcast articles, \"Listen\" for TTS\n  var file = activeFile && allFiles.find(function(f) { return f.filename === activeFile; });\n  var isPodcast = file && file.enclosureUrl && file.enclosureType && file.enclosureType.startsWith('audio/');\n  var idleLabel = isPodcast ? 'Play' : 'Listen';\n  if (playingFile && playingFile === activeFile) {\n    btn.classList.add('listen-playing');\n    btn.innerHTML = '<svg class=\"icon icon-sm\" aria-hidden=\"true\"><use href=\"#i-volume\"/></svg> Playing';\n  } else {\n    btn.classList.remove('listen-playing');\n    btn.innerHTML = '<svg class=\"icon icon-sm\" aria-hidden=\"true\"><use href=\"#i-volume\"/></svg> ' + idleLabel;\n  }\n  // Show/hide Play Next trigger when queue is active\n  var trigger = document.getElementById('play-next-trigger');\n  if (trigger) {\n    trigger.style.display = ttsQueue.length > 0 ? '' : 'none';\n  }\n}\n\nfunction togglePlayNextMenu(e) {\n  e.stopPropagation();\n  var existing = document.querySelector('.play-next-dropdown');\n  if (existing) { existing.remove(); return; }\n  var menu = document.getElementById('play-next-menu');\n  if (!menu) return;\n  var dropdown = document.createElement('div');\n  dropdown.className = 'play-next-dropdown';\n\n  var isQueued = ttsQueue.some(function(q) { return q.filename === activeFile; });\n  if (!isQueued) {\n    dropdown.innerHTML =\n      '<button onclick=\"playNextFromArticle();this.closest(\\'.play-next-dropdown\\').remove()\"><svg class=\"icon icon-sm\" style=\"width:12px;height:12px;vertical-align:-1px;margin-right:4px\"><use href=\"#i-forward\"/></svg> Play next</button>'\n      + '<button onclick=\"addCurrentToTTSQueue();this.closest(\\'.play-next-dropdown\\').remove()\"><svg class=\"icon icon-sm\" style=\"width:12px;height:12px;vertical-align:-1px;margin-right:4px\"><use href=\"#i-queue\"/></svg> Add to queue</button>';\n  } else {\n    dropdown.innerHTML = '<button onclick=\"this.closest(\\'.play-next-dropdown\\').remove()\" style=\"color:var(--muted)\">Already in queue</button>';\n  }\n  menu.appendChild(dropdown);\n  // Close on click outside\n  setTimeout(function() {\n    document.addEventListener('click', function closePlayNext() {\n      dropdown.remove();\n      document.removeEventListener('click', closePlayNext);\n    });\n  }, 0);\n}\n\nfunction addCurrentToTTSQueue() {\n  if (!activeFile) return;\n  _listenLoadingFile = activeFile;\n  startListenLoading();\n  addToTTSQueue(activeFile);\n}\n\nfunction playNextFromArticle(filename) {\n  if (!filename) filename = activeFile;\n  if (!filename) return;\n  // Insert after current playing item\n  var file = allFiles.find(function(f) { return f.filename === filename; });\n  if (!file) return;\n  // If already in queue, just move it\n  var existingIdx = ttsQueue.findIndex(function(q) { return q.filename === filename; });\n  if (existingIdx >= 0) {\n    var item = ttsQueue.splice(existingIdx, 1)[0];\n    if (existingIdx < ttsCurrentIndex) ttsCurrentIndex--;\n    var insertAt = ttsCurrentIndex + 1;\n    ttsQueue.splice(insertAt, 0, item);\n    renderAudioPlayer();\n    return;\n  }\n  var newItem = { filename: filename, title: file.title };\n  if (file.enclosureUrl && file.enclosureType && file.enclosureType.startsWith('audio/')) {\n    newItem.enclosureUrl = file.enclosureUrl;\n  }\n  var insertAt = ttsCurrentIndex >= 0 ? ttsCurrentIndex + 1 : 0;\n  ttsQueue.splice(insertAt, 0, newItem);\n  renderAudioPlayer();\n  if (ttsQueue.length === 1) playTTSItem(0);\n}\n\nasync function addToTTSQueue(filename) {\n  const file = allFiles.find(f => f.filename === filename);\n  if (!file) return;\n\n  // If already in queue, jump to it\n  if (ttsQueue.some(q => q.filename === filename)) {\n    stopListenLoading();\n    const idx = ttsQueue.findIndex(q => q.filename === filename);\n    if (idx >= 0) playTTSItem(idx);\n    return;\n  }\n\n  // Fetch current provider if not yet known\n  if (serverMode && ttsProvider === 'browser') {\n    try {\n      const res = await fetch('/api/tts-settings');\n      if (res.ok) {\n        const cfg = await res.json();\n        ttsProvider = cfg.provider || 'browser';\n      }\n    } catch {}\n  }\n\n  var item = { filename, title: file.title };\n  if (file.enclosureUrl && file.enclosureType && file.enclosureType.startsWith('audio/')) {\n    item.enclosureUrl = file.enclosureUrl;\n  }\n  ttsQueue.push(item);\n  renderAudioPlayer();\n  // Auto-play if this is the first item in the queue\n  if (ttsQueue.length === 1) playTTSItem(0);\n}\n\nfunction renderAudioPlayer() {\n  const panel = document.getElementById('audio-player');\n  if (!panel) return;\n\n  var app = document.querySelector('.app');\n\n  if (ttsQueue.length === 0) {\n    panel.classList.add('hidden');\n    if (app) app.classList.remove('has-bottom-bar');\n    updateSidebarAudioIndicators();\n    updateArticleNowPlaying();\n    return;\n  }\n  panel.classList.remove('hidden');\n  if (app) app.classList.add('has-bottom-bar');\n\n  const label = document.getElementById('audio-now-label');\n  const status = document.getElementById('audio-now-status');\n  const playBtn = document.getElementById('tts-play-btn');\n\n  if (ttsCurrentIndex >= 0 && ttsCurrentIndex < ttsQueue.length) {\n    label.textContent = ttsQueue[ttsCurrentIndex].title;\n  } else {\n    label.textContent = 'No article playing';\n  }\n\n  if (ttsGenerating) {\n    status.textContent = 'Generating\\u2026';\n  } else if (ttsPlaying) {\n    status.textContent = 'Playing';\n  } else if (ttsCurrentIndex >= 0) {\n    status.textContent = 'Paused';\n  } else {\n    status.textContent = '';\n  }\n\n  playBtn.innerHTML = ttsPlaying\n    ? '<svg><use href=\"#i-pause\"/></svg>'\n    : '<svg><use href=\"#i-play\"/></svg>';\n\n  // Render queue\n  const queueSection = document.getElementById('audio-queue-section');\n  const queueList = document.getElementById('audio-queue-list');\n  var queueToggle = document.getElementById('bottom-bar-queue-toggle');\n  if (ttsQueue.length > 1) {\n    if (queueToggle) queueToggle.classList.add('active');\n    queueList.innerHTML = ttsQueue.map((item, i) =>\n      '<div class=\"audio-queue-item' + (i === ttsCurrentIndex ? ' playing' : '') + '\" onclick=\"playTTSItem(' + i + ')\">'\n      + '<span style=\"font-size:10px;color:var(--muted);width:14px;text-align:center\">' + (i === ttsCurrentIndex ? '&#9654;' : (i + 1)) + '</span>'\n      + '<span class=\"queue-title\">' + escapeHtml(item.title) + '</span>'\n      + '<button class=\"queue-remove\" onclick=\"event.stopPropagation();removeTTSQueueItem(' + i + ')\" title=\"Remove\">&times;</button>'\n      + '</div>'\n    ).join('');\n  } else {\n    if (queueToggle) queueToggle.classList.remove('active');\n    queueSection.style.display = 'none';\n  }\n\n  updateListenButtonState();\n  updateSidebarAudioIndicators();\n  updateArticleNowPlaying();\n  renderMiniMode();\n  saveTTSState();\n}\n\n/** Navigate to the currently playing article */\nfunction bottomBarGoToArticle() {\n  var fn = ttsCurrentIndex >= 0 && ttsCurrentIndex < ttsQueue.length\n    ? ttsQueue[ttsCurrentIndex].filename : null;\n  if (!fn) return;\n  var idx = displayFiles.findIndex(function(f) { return f.filename === fn; });\n  if (idx >= 0) loadFile(idx);\n}\n\n/** Toggle queue visibility in bottom bar */\nfunction toggleBottomBarQueue() {\n  var qs = document.getElementById('audio-queue-section');\n  if (!qs) return;\n  if (ttsQueue.length <= 1) { qs.style.display = 'none'; return; }\n  qs.style.display = qs.style.display === 'none' ? '' : 'none';\n}\n\n/** Show playing/queued indicators on sidebar file items */\nfunction updateSidebarAudioIndicators() {\n  // Remove all existing indicators first\n  document.querySelectorAll('.file-item-audio').forEach(function(el) { el.remove(); });\n  if (ttsQueue.length === 0) return;\n\n  var playingFile = ttsCurrentIndex >= 0 && ttsCurrentIndex < ttsQueue.length\n    ? ttsQueue[ttsCurrentIndex].filename : null;\n\n  ttsQueue.forEach(function(item, i) {\n    var el = document.querySelector('.file-item[data-filename=\"' + CSS.escape(item.filename) + '\"]');\n    if (!el) return;\n    var meta = el.querySelector('.file-item-meta');\n    if (!meta) return;\n    var indicator = document.createElement('span');\n    indicator.className = 'file-item-audio';\n    if (item.filename === playingFile && ttsPlaying) {\n      indicator.innerHTML = '<span class=\"eq-bars\"><span></span><span></span><span></span></span>';\n    } else if (item.filename === playingFile) {\n      indicator.innerHTML = '<svg><use href=\"#i-pause\"/></svg>';\n    } else {\n      indicator.innerHTML = '<span class=\"queue-pos\">' + (i + 1) + '</span>';\n    }\n    meta.appendChild(indicator);\n  });\n}\n\n/** Clean up any stale inline player elements */\nfunction updateArticleNowPlaying() {\n  var existing = document.getElementById('article-now-playing');\n  if (existing) existing.remove();\n}\n\nasync function playTTSItem(index) {\n  stopTTS();\n  ttsCurrentIndex = index;\n  if (index < 0 || index >= ttsQueue.length) return;\n\n  const item = ttsQueue[index];\n  ttsPlaying = true;\n  renderAudioPlayer();\n\n  // Podcast enclosures play as native audio — no TTS synthesis needed\n  if (item.enclosureUrl) {\n    await playPodcastAudio(item);\n    return;\n  }\n\n  // Check TTS provider\n  await loadTTSSettings();\n\n  if (ttsProvider === 'browser') {\n    await playBrowserTTS(item.filename);\n  } else {\n    await playCloudTTS(item.filename);\n  }\n}\n\nasync function loadTTSSettings() {\n  if (!serverMode) { ttsProvider = 'browser'; return; }\n  try {\n    const res = await fetch('/api/tts-settings');\n    if (res.ok) {\n      const data = await res.json();\n      ttsProvider = data.provider || 'browser';\n    }\n  } catch { ttsProvider = 'browser'; }\n}\n\nasync function playBrowserTTS(filename) {\n  const synth = window.speechSynthesis;\n  if (!synth) {\n    alert('Speech synthesis not available in this browser.');\n    ttsPlaying = false;\n    renderAudioPlayer();\n    return;\n  }\n\n  // Fetch article text\n  let text = '';\n  try {\n    const res = await fetch('/api/file?name=' + encodeURIComponent(filename));\n    if (res.ok) text = await res.text();\n  } catch {}\n  if (!text) { ttsPlaying = false; renderAudioPlayer(); return; }\n\n  const { meta, body } = parseFrontmatter(text);\n  const ttsText = (meta && meta.title ? meta.title + '\\n\\n' : '') + body;\n  const plainText = stripMarkdownForTTS(ttsText);\n\n  // Cancel any existing\n  synth.cancel();\n\n  const utterance = new SpeechSynthesisUtterance(plainText);\n  utterance.rate = ttsSpeed;\n  utterance.lang = navigator.language || 'en-US';\n  ttsSynthUtterance = utterance;\n\n  // Estimate total duration (browser TTS doesn't give real progress)\n  const estimatedWords = plainText.split(/\\s+/).length;\n  const estimatedSeconds = estimatedWords / (150 * ttsSpeed); // ~150 wpm base\n  let startTime = Date.now();\n\n  utterance.onstart = function() {\n    playCueSound();\n    stopListenLoading();\n    ttsPlaying = true;\n    startTime = Date.now();\n    renderAudioPlayer();\n    document.getElementById('tts-time-total').textContent = formatTime(estimatedSeconds);\n    ttsProgressTimer = setInterval(() => {\n      const elapsed = (Date.now() - startTime) / 1000;\n      const pct = Math.min(100, (elapsed / estimatedSeconds) * 100);\n      document.getElementById('tts-progress').style.width = pct + '%';\n      document.getElementById('tts-time-current').textContent = formatTime(elapsed);\n    }, 200);\n  };\n\n  utterance.onend = function() {\n    clearInterval(ttsProgressTimer);\n    ttsPlaying = false;\n    ttsSynthUtterance = null;\n    document.getElementById('tts-progress').style.width = '100%';\n    renderAudioPlayer();\n    // Auto-play next\n    if (ttsCurrentIndex + 1 < ttsQueue.length) {\n      setTimeout(() => playTTSItem(ttsCurrentIndex + 1), 500);\n    }\n  };\n\n  utterance.onerror = function() {\n    clearInterval(ttsProgressTimer);\n    ttsPlaying = false;\n    ttsSynthUtterance = null;\n    renderAudioPlayer();\n  };\n\n  synth.speak(utterance);\n}\n\nasync function playCloudTTS(filename) {\n  ttsGenerating = true;\n  renderAudioPlayer();\n\n  try {\n    // Start a chunked TTS session\n    const startRes = await fetch('/api/tts/start', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ name: filename }),\n    });\n\n    ttsGenerating = false;\n\n    if (!startRes.ok) {\n      const err = await startRes.json().catch(function() { return { error: 'TTS failed' }; });\n      if (err.fallback === 'browser') {\n        console.warn('Kokoro unavailable, falling back to browser TTS:', err.error);\n        await playBrowserTTS(filename);\n        return;\n      }\n      stopListenLoading();\n      alert('TTS Error: ' + (err.error || 'Unknown error'));\n      ttsPlaying = false;\n      renderAudioPlayer();\n      return;\n    }\n\n    const session = await startRes.json();\n\n    if (session.cached) {\n      // Already cached on disk — use the full-file endpoint for instant playback\n      await playCloudTTSCached(filename);\n      return;\n    }\n\n    // Progressive chunk-based playback\n    _ttsChunkSession = {\n      id: session.id,\n      totalChunks: session.totalChunks,\n      currentChunk: 0,\n      elapsedTime: 0,\n      estimatedTotalDuration: 0,\n    };\n\n    ttsPlaying = true;\n    renderAudioPlayer();\n    ttsPlayNextChunk(0);\n  } catch (err) {\n    ttsGenerating = false;\n    ttsPlaying = false;\n    _ttsChunkSession = null;\n    renderAudioPlayer();\n    alert('TTS Error: ' + err.message);\n  }\n}\n\n/** Play a full cached audio file via HTMLAudioElement (preserves pitch when speed changes) */\nasync function playCloudTTSCached(filename) {\n  try {\n    var audio = new Audio('/api/tts/play?name=' + encodeURIComponent(filename));\n    audio.playbackRate = ttsSpeed;\n\n    audio.addEventListener('loadedmetadata', function() {\n      document.getElementById('tts-time-total').textContent = formatTime(audio.duration);\n    });\n\n    audio.addEventListener('playing', function() {\n      playCueSound();\n      stopListenLoading();\n      ttsPlaying = true;\n      renderAudioPlayer();\n      // Cached playback means Kokoro is idle — pre-generate next queue item\n      ttsPrefetchNextQueueItem();\n    });\n\n    audio.addEventListener('timeupdate', function() {\n      if (!audio.duration) return;\n      var pct = Math.min(100, (audio.currentTime / audio.duration) * 100);\n      document.getElementById('tts-progress').style.width = pct + '%';\n      document.getElementById('tts-time-current').textContent = formatTime(audio.currentTime);\n    });\n\n    audio.addEventListener('ended', function() {\n      document.getElementById('tts-progress').style.width = '100%';\n      ttsPlaying = false;\n      _ttsNextPrefetch = null;\n      renderAudioPlayer();\n      if (ttsCurrentIndex + 1 < ttsQueue.length) {\n        setTimeout(function() { playTTSItem(ttsCurrentIndex + 1); }, 500);\n      }\n    });\n\n    audio.addEventListener('error', function() {\n      stopListenLoading();\n      ttsPlaying = false;\n      renderAudioPlayer();\n      alert('TTS Error: Failed to load cached audio');\n    });\n\n    audio.play();\n\n    ttsAudio = audio;\n    ttsPlaying = true;\n    renderAudioPlayer();\n  } catch (err) {\n    ttsPlaying = false;\n    renderAudioPlayer();\n    alert('TTS Error: ' + err.message);\n  }\n}\n\n/** Play a podcast episode via its enclosure URL as native audio */\nasync function playPodcastAudio(item) {\n  try {\n    var audio = new Audio(item.enclosureUrl);\n    audio.playbackRate = ttsSpeed;\n    var resumeTime = item.savedTime || 0;\n\n    audio.addEventListener('loadedmetadata', function() {\n      document.getElementById('tts-time-total').textContent = formatTime(audio.duration);\n      // Resume from saved position\n      if (resumeTime > 0 && resumeTime < audio.duration - 5) {\n        audio.currentTime = resumeTime;\n        resumeTime = 0;\n      }\n    });\n\n    var _cuePlayed = false;\n    audio.addEventListener('playing', function() {\n      stopListenLoading();\n      if (!_cuePlayed) { _cuePlayed = true; playCueSound(); }\n      ttsPlaying = true;\n      renderAudioPlayer();\n    });\n\n    var _lastProgressSave = 0;\n    audio.addEventListener('timeupdate', function() {\n      if (!audio.duration) return;\n      var pct = Math.min(100, (audio.currentTime / audio.duration) * 100);\n      document.getElementById('tts-progress').style.width = pct + '%';\n      document.getElementById('tts-time-current').textContent = formatTime(audio.currentTime);\n      // Save progress every 5 seconds\n      if (Date.now() - _lastProgressSave > 5000) {\n        _lastProgressSave = Date.now();\n        saveTTSState();\n      }\n    });\n\n    audio.addEventListener('ended', function() {\n      document.getElementById('tts-progress').style.width = '100%';\n      ttsPlaying = false;\n      renderAudioPlayer();\n      if (ttsCurrentIndex + 1 < ttsQueue.length) {\n        setTimeout(function() { playTTSItem(ttsCurrentIndex + 1); }, 500);\n      }\n    });\n\n    audio.addEventListener('error', function() {\n      stopListenLoading();\n      ttsPlaying = false;\n      renderAudioPlayer();\n      alert('Podcast playback error: could not load audio');\n    });\n\n    audio.play();\n    ttsAudio = audio;\n    ttsPlaying = true;\n    renderAudioPlayer();\n  } catch (err) {\n    ttsPlaying = false;\n    renderAudioPlayer();\n    alert('Podcast playback error: ' + err.message);\n  }\n}\n\n// Tracks which chunks have been pre-fetched (server-side cache warming)\nvar _ttsChunkBuffer = new Map();\n\n/** Pre-fetch the next chunk to warm the server cache so HTMLAudioElement loads instantly */\nfunction ttsPrefetchChunk(index) {\n  var session = _ttsChunkSession;\n  if (!session || index >= session.totalChunks) return;\n  if (_ttsChunkBuffer.has(index)) return;\n\n  // Mark as in-flight so we don't double-fetch\n  _ttsChunkBuffer.set(index, 'fetching');\n\n  fetch('/api/tts/chunk/' + session.id + '/' + index)\n    .then(function(res) {\n      if (res.ok && session === _ttsChunkSession) {\n        _ttsChunkBuffer.set(index, 'ready');\n      }\n      // Consume the body to complete the fetch (warms server cache)\n      return res.arrayBuffer();\n    })\n    .catch(function() {\n      if (session === _ttsChunkSession) _ttsChunkBuffer.delete(index);\n    });\n}\n\n/** Pre-generate audio for the next queue item so transition is instant */\nfunction ttsPrefetchNextQueueItem() {\n  if (ttsProvider === 'browser') return;\n  var nextIndex = ttsCurrentIndex + 1;\n  if (nextIndex >= ttsQueue.length) return;\n  var nextItem = ttsQueue[nextIndex];\n  // Already prefetching this item\n  if (_ttsNextPrefetch && _ttsNextPrefetch.filename === nextItem.filename) return;\n\n  fetch('/api/tts/start', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify({ name: nextItem.filename }),\n  })\n  .then(function(res) { return res.json(); })\n  .then(function(session) {\n    if (session.cached) {\n      _ttsNextPrefetch = { filename: nextItem.filename, done: true };\n      return;\n    }\n    _ttsNextPrefetch = {\n      filename: nextItem.filename,\n      sessionId: session.id,\n      totalChunks: session.totalChunks,\n      currentChunk: 0,\n      done: false,\n    };\n    ttsPrefetchNextQueueChunk();\n  })\n  .catch(function() { _ttsNextPrefetch = null; });\n}\n\n/** Sequentially generate chunks for the next queue item in the background */\nfunction ttsPrefetchNextQueueChunk() {\n  if (!_ttsNextPrefetch || _ttsNextPrefetch.done) return;\n  if (_ttsNextPrefetch.currentChunk >= _ttsNextPrefetch.totalChunks) {\n    _ttsNextPrefetch.done = true;\n    return;\n  }\n  fetch('/api/tts/chunk/' + _ttsNextPrefetch.sessionId + '/' + _ttsNextPrefetch.currentChunk)\n    .then(function(res) { return res.arrayBuffer(); })\n    .then(function() {\n      if (!_ttsNextPrefetch) return;\n      _ttsNextPrefetch.currentChunk++;\n      ttsPrefetchNextQueueChunk();\n    })\n    .catch(function() { /* non-critical */ });\n}\n\n/** Play a single TTS chunk via HTMLAudioElement (preserves pitch), then chain to the next */\nasync function ttsPlayNextChunk(index, seekPct) {\n  var session = _ttsChunkSession;\n  if (!session || session !== _ttsChunkSession) return;\n\n  if (index >= session.totalChunks) {\n    // All chunks played — done\n    ttsPlaying = false;\n    _ttsChunkSession = null;\n    _ttsChunkBuffer.clear();\n    _ttsNextPrefetch = null;\n    document.getElementById('tts-progress').style.width = '100%';\n    renderAudioPlayer();\n    if (ttsCurrentIndex + 1 < ttsQueue.length) {\n      setTimeout(function() { playTTSItem(ttsCurrentIndex + 1); }, 500);\n    }\n    return;\n  }\n\n  session.currentChunk = index;\n  renderAudioPlayer();\n\n  try {\n    var chunkUrl = '/api/tts/chunk/' + session.id + '/' + index;\n    var audio = new Audio(chunkUrl);\n    audio.playbackRate = ttsSpeed;\n    // preservesPitch defaults to true — pitch stays constant when speed changes\n\n    audio.addEventListener('loadedmetadata', function() {\n      if (session !== _ttsChunkSession) return;\n      var chunkDuration = audio.duration;\n\n      if (index === 0 && !seekPct) {\n        session.estimatedTotalDuration = chunkDuration * session.totalChunks;\n        document.getElementById('tts-time-total').textContent = '~' + formatTime(session.estimatedTotalDuration);\n      }\n\n      // Seek within chunk if a seek percentage was given\n      if (seekPct && seekPct > 0 && chunkDuration) {\n        audio.currentTime = seekPct * chunkDuration;\n      }\n    });\n\n    audio.addEventListener('playing', function() {\n      if (session !== _ttsChunkSession) return;\n      if (index === 0) playCueSound();\n      stopListenLoading();\n      ttsPlaying = true;\n      renderAudioPlayer();\n\n      // Pre-fetch next chunk while this one plays\n      if (index + 1 < session.totalChunks) {\n        ttsPrefetchChunk(index + 1);\n      } else {\n        // Last chunk playing — Kokoro is idle, pre-generate next queue item\n        ttsPrefetchNextQueueItem();\n      }\n    });\n\n    audio.addEventListener('timeupdate', function() {\n      if (session !== _ttsChunkSession) return;\n      var chunkDuration = audio.duration || 1;\n      var chunkProgress = Math.min(1, audio.currentTime / chunkDuration);\n      var overallPct = ((index + chunkProgress) / session.totalChunks) * 100;\n      document.getElementById('tts-progress').style.width = overallPct + '%';\n      var currentTime = session.elapsedTime + audio.currentTime;\n      document.getElementById('tts-time-current').textContent = formatTime(currentTime);\n    });\n\n    audio.addEventListener('ended', function() {\n      if (session !== _ttsChunkSession) return;\n      session.elapsedTime += audio.duration || 0;\n      // Show loading words only if next chunk isn't pre-warmed on the server yet\n      var nextReady = _ttsChunkBuffer.get(index + 1) === 'ready';\n      if (index + 1 < session.totalChunks && !nextReady) startListenLoading();\n      ttsPlayNextChunk(index + 1);\n    });\n\n    audio.addEventListener('error', function() {\n      if (session !== _ttsChunkSession) return;\n      stopListenLoading();\n      ttsPlaying = false;\n      _ttsChunkSession = null;\n      _ttsChunkBuffer.clear();\n      renderAudioPlayer();\n      var statusEl = document.getElementById('audio-now-status');\n      if (statusEl) statusEl.textContent = 'Playback error';\n    });\n\n    audio.play();\n\n    // Store as plain HTMLAudioElement — existing toggle/speed/stop code handles this\n    ttsAudio = audio;\n    ttsPlaying = true;\n    renderAudioPlayer();\n  } catch (err) {\n    stopListenLoading();\n    ttsPlaying = false;\n    _ttsChunkSession = null;\n    _ttsChunkBuffer.clear();\n    renderAudioPlayer();\n    alert('TTS Error: ' + err.message);\n  }\n}\n\nfunction stopTTS() {\n  clearInterval(ttsProgressTimer);\n  _ttsChunkSession = null;\n  _ttsChunkBuffer.clear();\n  _ttsNextPrefetch = null;\n  if (ttsAudio) {\n    ttsAudio.pause();\n    ttsAudio.src = '';\n    ttsAudio = null;\n  }\n  if (ttsSynthUtterance) {\n    window.speechSynthesis.cancel();\n    ttsSynthUtterance = null;\n  }\n  ttsPlaying = false;\n  ttsGenerating = false;\n  var prog = document.getElementById('tts-progress');\n  if (prog) prog.style.width = '0%';\n  var cur = document.getElementById('tts-time-current');\n  if (cur) cur.textContent = '0:00';\n  var tot = document.getElementById('tts-time-total');\n  if (tot) tot.textContent = '0:00';\n}\n\nfunction ttsTogglePlay() {\n  if (ttsQueue.length === 0) return;\n\n  if (ttsProvider === 'browser') {\n    const synth = window.speechSynthesis;\n    if (ttsPlaying) {\n      synth.pause();\n      ttsPlaying = false;\n      clearInterval(ttsProgressTimer);\n    } else if (synth.paused) {\n      synth.resume();\n      ttsPlaying = true;\n      // Restart progress timer\n      ttsProgressTimer = setInterval(() => {\n        const timeEl = document.getElementById('tts-time-current');\n        const totalEl = document.getElementById('tts-time-total');\n        // parse current time and increment\n        const parts = timeEl.textContent.split(':');\n        let secs = parseInt(parts[0]) * 60 + parseInt(parts[1]) + 0.2;\n        timeEl.textContent = formatTime(secs);\n      }, 200);\n    } else if (ttsCurrentIndex >= 0) {\n      playTTSItem(ttsCurrentIndex);\n    } else {\n      playTTSItem(0);\n    }\n  } else {\n    if (ttsAudio) {\n      if (ttsPlaying) {\n        ttsAudio.pause();\n        ttsPlaying = false;\n      } else {\n        ttsAudio.play();\n        ttsPlaying = true;\n      }\n    } else if (ttsCurrentIndex >= 0) {\n      playTTSItem(ttsCurrentIndex);\n    } else {\n      playTTSItem(0);\n    }\n  }\n  renderAudioPlayer();\n}\n\nfunction ttsSkipNext() {\n  skipTime(15);\n}\n\nfunction ttsSkipPrev() {\n  skipTime(-15);\n}\n\nfunction skipTime(seconds) {\n  if (_ttsChunkSession) {\n    var session = _ttsChunkSession;\n    // Can't seek until we have a duration estimate from the first chunk\n    if (!session.estimatedTotalDuration) return;\n    var currentChunkTime = ttsAudio ? ttsAudio.currentTime : 0;\n    var targetTime = session.elapsedTime + currentChunkTime + seconds;\n    if (targetTime < 0) targetTime = 0;\n    var totalEst = session.estimatedTotalDuration;\n    if (targetTime >= totalEst) return;\n    var pct = targetTime / totalEst;\n    seekToChunkPosition(pct);\n    return;\n  }\n  if (ttsAudio && ttsAudio.duration) {\n    var newTime = ttsAudio.currentTime + seconds;\n    ttsAudio.currentTime = Math.max(0, Math.min(newTime, ttsAudio.duration));\n    return;\n  }\n  // Browser TTS doesn't support seeking\n}\n\nfunction seekToChunkPosition(pct) {\n  var session = _ttsChunkSession;\n  // Can't seek until we have a duration estimate from the first chunk\n  if (!session || !session.estimatedTotalDuration) return;\n  pct = Math.max(0, Math.min(1, pct));\n  var targetChunkFloat = pct * session.totalChunks;\n  var targetChunk = Math.floor(targetChunkFloat);\n  if (targetChunk >= session.totalChunks) targetChunk = session.totalChunks - 1;\n  var seekPct = targetChunkFloat - targetChunk;\n\n  // Estimate elapsed time up to target chunk\n  var avgChunkDuration = session.estimatedTotalDuration / session.totalChunks;\n  session.elapsedTime = targetChunk * avgChunkDuration;\n\n  // Stop current audio and play from target chunk\n  if (ttsAudio) {\n    ttsAudio.pause();\n    ttsAudio.src = '';\n    ttsAudio = null;\n  }\n  ttsPlayNextChunk(targetChunk, seekPct);\n}\n\nfunction ttsSeek(pct) {\n  if (_ttsChunkSession) {\n    seekToChunkPosition(pct);\n    return;\n  }\n  if (ttsAudio && ttsAudio.duration) {\n    ttsAudio.currentTime = pct * ttsAudio.duration;\n  }\n  // Browser TTS doesn't support seeking\n}\n\nfunction initProgressDrag() {\n  var wrap = document.getElementById('audio-progress-wrap');\n  if (!wrap) return;\n\n  function seekFromEvent(e) {\n    // Don't seek if nothing is playing or generating\n    if (!ttsPlaying && ttsCurrentIndex < 0) return;\n    var rect = wrap.getBoundingClientRect();\n    var clientX = e.touches ? e.touches[0].clientX : e.clientX;\n    var pct = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));\n    ttsSeek(pct);\n  }\n\n  function onMove(e) { seekFromEvent(e); }\n  function onEnd() {\n    document.removeEventListener('mousemove', onMove);\n    document.removeEventListener('mouseup', onEnd);\n    document.removeEventListener('touchmove', onMove);\n    document.removeEventListener('touchend', onEnd);\n  }\n\n  wrap.addEventListener('mousedown', function(e) {\n    e.preventDefault();\n    seekFromEvent(e);\n    document.addEventListener('mousemove', onMove);\n    document.addEventListener('mouseup', onEnd);\n  });\n\n  wrap.addEventListener('touchstart', function(e) {\n    e.preventDefault();\n    seekFromEvent(e);\n    document.addEventListener('touchmove', onMove, { passive: false });\n    document.addEventListener('touchend', onEnd);\n  }, { passive: false });\n}\n\n// Initialize drag on the progress bar\ninitProgressDrag();\n\nlet _ttsSpeedPopup = null;\n\nfunction ttsToggleSpeedSlider() {\n  if (_ttsSpeedPopup) { ttsCloseSpeedSlider(); return; }\n\n  var btn = document.getElementById('tts-speed-btn');\n  var rect = btn.getBoundingClientRect();\n  var count = TTS_SPEEDS.length;\n\n  var popup = document.createElement('div');\n  popup.className = 'tts-speed-popup';\n\n  // Build tick labels — show value for major speeds, dot for minor ones\n  var majorSpeeds = [0.5, 1.0, 1.5, 2.0];\n  var ticksHtml = '';\n  for (var i = count - 1; i >= 0; i--) {\n    var s = TTS_SPEEDS[i];\n    if (majorSpeeds.indexOf(s) >= 0) {\n      ticksHtml += '<div class=\"tts-speed-tick\">' + s + 'x</div>';\n    } else {\n      ticksHtml += '<div class=\"tts-speed-tick-dot\">\\u00b7</div>';\n    }\n  }\n\n  popup.innerHTML =\n    '<div class=\"tts-speed-popup-value\" id=\"tts-speed-popup-val\">' + ttsSpeed + 'x</div>' +\n    '<div class=\"tts-speed-track-wrap\" id=\"tts-speed-track-wrap\">' +\n      '<div class=\"tts-speed-track\" id=\"tts-speed-track\">' +\n        '<div class=\"tts-speed-thumb\" id=\"tts-speed-thumb\"></div>' +\n      '</div>' +\n    '</div>' +\n    '<div class=\"tts-speed-ticks\">' + ticksHtml + '</div>';\n\n  document.body.appendChild(popup);\n\n  // Position above the button, centered horizontally\n  var popW = popup.offsetWidth;\n  var popH = popup.offsetHeight;\n  var left = rect.left + rect.width / 2 - popW / 2;\n  var top = rect.top - popH - 6;\n  // Keep on screen\n  if (left < 4) left = 4;\n  if (top < 4) { top = rect.bottom + 6; }\n  popup.style.left = left + 'px';\n  popup.style.top = top + 'px';\n\n  // Set thumb position for current speed\n  ttsPositionThumb();\n  _ttsSpeedPopup = popup;\n\n  // Drag handling\n  var trackWrap = document.getElementById('tts-speed-track-wrap');\n\n  function onDrag(clientY) {\n    var trackRect = trackWrap.getBoundingClientRect();\n    var pct = (clientY - trackRect.top) / trackRect.height;\n    pct = Math.max(0, Math.min(1, pct));\n    // Top = fastest (last index), bottom = slowest (first index)\n    var idx = Math.round((1 - pct) * (count - 1));\n    idx = Math.max(0, Math.min(count - 1, idx));\n    ttsSetSpeed(TTS_SPEEDS[idx]);\n    ttsPositionThumb();\n  }\n\n  trackWrap.addEventListener('mousedown', function(e) {\n    e.preventDefault();\n    onDrag(e.clientY);\n    function onMove(ev) { onDrag(ev.clientY); }\n    function onUp() {\n      document.removeEventListener('mousemove', onMove);\n      document.removeEventListener('mouseup', onUp);\n    }\n    document.addEventListener('mousemove', onMove);\n    document.addEventListener('mouseup', onUp);\n  });\n\n  trackWrap.addEventListener('touchstart', function(e) {\n    e.preventDefault();\n    onDrag(e.touches[0].clientY);\n    function onTouchMove(ev) { ev.preventDefault(); onDrag(ev.touches[0].clientY); }\n    function onTouchEnd() {\n      document.removeEventListener('touchmove', onTouchMove);\n      document.removeEventListener('touchend', onTouchEnd);\n    }\n    document.addEventListener('touchmove', onTouchMove, { passive: false });\n    document.addEventListener('touchend', onTouchEnd);\n  }, { passive: false });\n\n  // Close on click outside (delay to avoid catching the opening click)\n  setTimeout(function() {\n    document.addEventListener('mousedown', ttsSpeedOutsideClick);\n    document.addEventListener('touchstart', ttsSpeedOutsideClick);\n  }, 0);\n}\n\nfunction ttsSpeedOutsideClick(e) {\n  if (_ttsSpeedPopup && !_ttsSpeedPopup.contains(e.target) && e.target.id !== 'tts-speed-btn') {\n    ttsCloseSpeedSlider();\n  }\n}\n\nfunction ttsCloseSpeedSlider() {\n  if (_ttsSpeedPopup) {\n    _ttsSpeedPopup.remove();\n    _ttsSpeedPopup = null;\n  }\n  document.removeEventListener('mousedown', ttsSpeedOutsideClick);\n  document.removeEventListener('touchstart', ttsSpeedOutsideClick);\n}\n\nfunction ttsPositionThumb() {\n  var thumb = document.getElementById('tts-speed-thumb');\n  if (!thumb) return;\n  var idx = TTS_SPEEDS.indexOf(ttsSpeed);\n  if (idx < 0) idx = TTS_SPEEDS.indexOf(1.0);\n  // Top = fastest (last index), bottom = slowest (first index)\n  var pct = 1 - idx / (TTS_SPEEDS.length - 1);\n  thumb.style.top = (pct * 100) + '%';\n}\n\nfunction ttsSetSpeed(speed) {\n  ttsSpeed = speed;\n  var speedBtn = document.getElementById('tts-speed-btn');\n  if (speedBtn) speedBtn.textContent = speed + 'x';\n  var popupVal = document.getElementById('tts-speed-popup-val');\n  if (popupVal) popupVal.textContent = speed + 'x';\n  var miniSpeedBtn = document.getElementById('mini-mode-speed-btn');\n  if (miniSpeedBtn) miniSpeedBtn.textContent = speed + 'x';\n  // Update article inline speed button\n  var anpSpeed = document.querySelector('.article-now-playing .anp-speed');\n  if (anpSpeed) anpSpeed.textContent = speed + 'x';\n\n  if (ttsAudio) {\n    ttsAudio.playbackRate = speed;\n  }\n  if (ttsSynthUtterance && window.speechSynthesis.speaking) {\n    ttsSynthUtterance.rate = speed;\n  }\n  saveTTSState();\n}\n\nfunction ttsCycleSpeed() {\n  var idx = TTS_SPEEDS.indexOf(ttsSpeed);\n  if (idx < 0) idx = TTS_SPEEDS.indexOf(1.0);\n  var next = (idx + 1) % TTS_SPEEDS.length;\n  ttsSetSpeed(TTS_SPEEDS[next]);\n}\n\nfunction removeTTSQueueItem(index) {\n  if (index === ttsCurrentIndex) {\n    stopListenLoading();\n    stopTTS();\n    ttsQueue.splice(index, 1);\n    if (ttsQueue.length > 0) {\n      ttsCurrentIndex = Math.min(index, ttsQueue.length - 1);\n      playTTSItem(ttsCurrentIndex);\n    } else {\n      ttsCurrentIndex = -1;\n    }\n  } else {\n    ttsQueue.splice(index, 1);\n    if (index < ttsCurrentIndex) ttsCurrentIndex--;\n  }\n  renderAudioPlayer();\n}\n\nfunction ttsClearQueue() {\n  stopListenLoading();\n  stopTTS();\n  ttsQueue = [];\n  ttsCurrentIndex = -1;\n  localStorage.removeItem('pr-tts-state');\n  renderAudioPlayer();\n}\n\nfunction formatTime(seconds) {\n  if (!seconds || isNaN(seconds)) return '0:00';\n  const m = Math.floor(seconds / 60);\n  const s = Math.floor(seconds % 60);\n  return m + ':' + (s < 10 ? '0' : '') + s;\n}\n\n/** Strip markdown formatting to get clean text for TTS */\nfunction stripMarkdownForTTS(md) {\n  let text = md;\n  // Remove images\n  text = text.replace(/!\\[([^\\]]*)\\]\\([^)]*\\)/g, '');\n  // Convert links to just text\n  text = text.replace(/\\[([^\\]]*)\\]\\([^)]*\\)/g, '$1');\n  // Remove HTML tags\n  text = text.replace(/<[^>]+>/g, '');\n  // Remove header markers\n  text = text.replace(/^#{1,6}\\s+/gm, '');\n  // Remove bold/italic\n  text = text.replace(/(\\*{1,3}|_{1,3})([^*_]+)\\1/g, '$2');\n  // Remove strikethrough\n  text = text.replace(/~~([^~]+)~~/g, '$1');\n  // Remove code blocks\n  text = text.replace(/```[\\s\\S]*?```/g, '');\n  // Remove inline code\n  text = text.replace(/`([^`]+)`/g, '$1');\n  // Remove blockquote markers\n  text = text.replace(/^>\\s*/gm, '');\n  // Remove horizontal rules\n  text = text.replace(/^[-*_]{3,}\\s*$/gm, '');\n  // Remove list markers\n  text = text.replace(/^\\s*[-*+]\\s+/gm, '');\n  text = text.replace(/^\\s*\\d+\\.\\s+/gm, '');\n  // Collapse whitespace\n  text = text.replace(/\\n{3,}/g, '\\n\\n');\n  text = text.trim();\n  // Add a sentence-ending period after the title (first line) so TTS engines\n  // pause briefly before reading the body\n  var firstBreak = text.indexOf('\\n\\n');\n  if (firstBreak > 0) {\n    var title = text.slice(0, firstBreak).trimEnd();\n    var lastChar = title[title.length - 1];\n    if (lastChar !== '.' && lastChar !== '!' && lastChar !== '?') {\n      text = title + '.\\n\\n' + text.slice(firstBreak + 2);\n    }\n  }\n  return text;\n}\n\n// ---- TTS Reading Highlight ----\n// Highlights the current paragraph in the article as TTS reads aloud.\n\nlet _ttsHighlightParaIndex = -1;\n\nfunction ttsClearHighlight() {\n  _ttsHighlightParaIndex = -1;\n  document.querySelectorAll('.tts-reading-hl').forEach(function(el) {\n    el.classList.remove('tts-reading-hl');\n  });\n}\n\nfunction ttsHighlightParagraph(paraIndex) {\n  if (paraIndex === _ttsHighlightParaIndex) return;\n  _ttsHighlightParaIndex = paraIndex;\n  var content = document.getElementById('content');\n  if (!content) return;\n\n  // Only highlight if the displayed article is the one being played\n  var playingFile = ttsCurrentIndex >= 0 && ttsCurrentIndex < ttsQueue.length\n    ? ttsQueue[ttsCurrentIndex].filename : null;\n  if (!playingFile || activeFile !== playingFile) return;\n\n  // Remove previous highlight\n  content.querySelectorAll('.tts-reading-hl').forEach(function(el) {\n    el.classList.remove('tts-reading-hl');\n  });\n  // Find the Nth paragraph-level element in the article\n  var blocks = content.querySelectorAll('p, h1, h2, h3, h4, h5, h6, li, blockquote, pre');\n  if (paraIndex >= 0 && paraIndex < blocks.length) {\n    blocks[paraIndex].classList.add('tts-reading-hl');\n  }\n}\n\nfunction ttsHighlightAtChar(charIndex, paraOffsets) {\n  for (var i = 0; i < paraOffsets.length; i++) {\n    if (charIndex >= paraOffsets[i].start && charIndex < paraOffsets[i].end) {\n      ttsHighlightParagraph(i);\n      return;\n    }\n  }\n}\n\nfunction ttsHighlightByProgress(progress, paraOffsets) {\n  if (!paraOffsets || !paraOffsets.length) return;\n  var totalChars = paraOffsets[paraOffsets.length - 1].end;\n  var charPos = Math.floor(progress * totalChars);\n  ttsHighlightAtChar(charPos, paraOffsets);\n}\n\nfunction showTTSSettings() {\n  if (!serverMode) {\n    alert('Voice playback settings are only available in server mode.');\n    return;\n  }\n\n  // Show modal immediately with loading spinner\n  var overlay = document.createElement('div');\n  overlay.className = 'modal-overlay';\n  overlay.setAttribute('role', 'dialog');\n  overlay.setAttribute('aria-modal', 'true');\n  overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };\n\n  overlay.innerHTML =\n    '<div class=\"modal-card\" onclick=\"event.stopPropagation()\" style=\"max-width:440px\">' +\n      '<h2>Voice Settings</h2>' +\n      '<div style=\"display:flex;justify-content:center;padding:48px 0\">' +\n        '<div class=\"tts-settings-spinner\"></div>' +\n      '</div>' +\n    '</div>';\n  document.body.appendChild(overlay);\n\n  fetch('/api/tts-settings').then(function(r) { return r.json(); }).then(function(data) {\n    var card = overlay.querySelector('.modal-card');\n    if (!card) return;\n\n    var providers = [\n      { id: 'kokoro', label: 'Kokoro — natural voice, free & private' },\n      { id: 'browser', label: 'Built-in Voice (Apple) — free' },\n      { id: 'openai', label: 'OpenAI — premium quality' },\n      { id: 'elevenlabs', label: 'ElevenLabs — premium quality' },\n    ];\n\n    // Store data on overlay so module-scope render helpers can access it\n    overlay._ttsData = data;\n\n    var isCloud = data.provider === 'openai' || data.provider === 'elevenlabs';\n    var kokoroInstalled = data.kokoro && data.kokoro.installed;\n\n    card.innerHTML =\n      '<h2>Voice Settings</h2>' +\n      '<div style=\"margin:12px 0\">' +\n        '<label style=\"font-size:12px;font-weight:600;display:block;margin-bottom:4px\">Provider</label>' +\n        '<select id=\"tts-provider-select\" style=\"width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--fg);font-size:13px\" onchange=\"ttsSettingsProviderChanged()\">' +\n          providers.map(function(p) { return '<option value=\"' + p.id + '\"' + (data.provider === p.id ? ' selected' : '') + '>' + p.label + '</option>'; }).join('') +\n        '</select>' +\n      '</div>' +\n      '<div id=\"tts-kokoro-settings\" style=\"display:' + (data.provider === 'kokoro' ? 'block' : 'none') + '\">' +\n        '<div style=\"background:var(--code-bg);border:1px solid var(--border);border-radius:6px;padding:10px 12px;margin:10px 0;font-size:12px;line-height:1.6\">' +\n          '<strong style=\"color:var(--fg)\">Kokoro — natural-sounding voice, completely free</strong><br>' +\n          '<span style=\"color:var(--muted)\">Runs entirely on your Mac using the Kokoro voice engine — your articles stay private and never leave your machine.</span><br>' +\n          '<span style=\"color:var(--muted)\">Sets itself up automatically the first time you listen (~86MB download).</span>' +\n          '<div id=\"kokoro-status\" style=\"margin-top:6px\">' +\n            (kokoroInstalled\n              ? '<span style=\"color:#22c55e\">&#10003; Ready to go</span>'\n              : '<span style=\"color:var(--muted)\">Will set up automatically on first listen</span>') +\n          '</div>' +\n        '</div>' +\n        '<div style=\"margin:12px 0\">' +\n          '<label style=\"font-size:12px;font-weight:600;display:block;margin-bottom:4px\">Voice</label>' +\n          '<select id=\"tts-kokoro-voice\" style=\"width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--fg);font-size:13px\">' +\n            renderVoiceOptions('kokoro') +\n          '</select>' +\n        '</div>' +\n        '<div style=\"margin:12px 0\" id=\"tts-kokoro-quality\">' +\n          '<label style=\"font-size:12px;font-weight:600;display:block;margin-bottom:4px\">Quality</label>' +\n          ((data.model === 'kokoro-v1-q4')\n            ? '<div style=\"font-size:12px;color:#22c55e\">&#10003; High quality</div>'\n            : '<div style=\"font-size:12px;color:var(--fg)\">Standard quality'\n              + '<br><button onclick=\"ttsUpgradeKokoroQuality()\" style=\"margin-top:6px;padding:4px 10px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--link);font-size:12px;cursor:pointer;font-family:inherit\">Upgrade to high quality</button>'\n              + '<span style=\"color:var(--muted);font-size:11px;margin-left:6px\">Free &middot; 305MB download</span></div>'\n          ) +\n          '<input type=\"hidden\" id=\"tts-kokoro-model\" value=\"' + escapeHtml(data.model || 'kokoro-v1-q8') + '\">' +\n        '</div>' +\n      '</div>' +\n      '<div id=\"tts-cost-info\" style=\"display:' + (isCloud ? 'block' : 'none') + '\">' +\n        '<div id=\"tts-cost-estimate\" style=\"background:var(--code-bg);border:1px solid var(--border);border-radius:6px;padding:10px 12px;margin:10px 0;font-size:12px;line-height:1.5\">' +\n          ttsGetCostHtml(data.provider, data.model) +\n        '</div>' +\n      '</div>' +\n      '<div id=\"tts-cloud-settings\" style=\"display:' + (isCloud ? 'block' : 'none') + '\">' +\n        '<div style=\"margin:12px 0\">' +\n          '<label style=\"font-size:12px;font-weight:600;display:block;margin-bottom:4px\">API Key</label>' +\n          '<input type=\"password\" id=\"tts-api-key\" placeholder=\"' + (data.hasKey && isCloud ? '••••••••••••••••' : 'Paste your key here') + '\" style=\"width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--fg);font-size:13px\" />' +\n          (data.hasKey && isCloud\n            ? '<div style=\"font-size:11px;color:#22c55e;margin-top:3px\">&#10003; API key saved. Leave blank to keep current key.</div>'\n            : '<div style=\"font-size:11px;color:var(--muted);margin-top:3px\">You can get a key from your provider\\'s website. This key is only used for reading articles aloud.</div>') +\n        '</div>' +\n        '<div style=\"margin:12px 0\" id=\"tts-voice-row\">' +\n          '<label style=\"font-size:12px;font-weight:600;display:block;margin-bottom:4px\">Voice</label>' +\n          '<select id=\"tts-voice-select\" style=\"width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--fg);font-size:13px\" onchange=\"ttsSettingsModelChanged()\">' +\n            renderVoiceOptions(data.provider) +\n          '</select>' +\n        '</div>' +\n        '<div style=\"margin:12px 0\" id=\"tts-model-row\">' +\n          '<label style=\"font-size:12px;font-weight:600;display:block;margin-bottom:4px\">Model</label>' +\n          '<select id=\"tts-model-select\" style=\"width:100%;padding:6px 8px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--fg);font-size:13px\" onchange=\"ttsSettingsModelChanged()\">' +\n            renderModelOptions(data.provider) +\n          '</select>' +\n        '</div>' +\n        '<div style=\"margin:14px 0;padding:10px 12px;background:var(--code-bg);border:1px solid var(--border);border-radius:6px\">' +\n          '<label style=\"display:flex;align-items:flex-start;gap:8px;font-size:12px;cursor:pointer;line-height:1.5\">' +\n            '<input type=\"checkbox\" id=\"tts-consent\" style=\"margin-top:3px;width:16px;height:16px;accent-color:var(--link);flex-shrink:0\" />' +\n            '<span>Articles will be sent to this provider to create audio. Your API key will be charged a small amount per article — audio is saved locally so you only pay once per article.</span>' +\n          '</label>' +\n        '</div>' +\n      '</div>' +\n      '<div class=\"modal-actions\">' +\n        '<button class=\"btn-secondary\" onclick=\"this.closest(\\'.modal-overlay\\').remove()\">Cancel</button>' +\n        '<button class=\"btn-primary\" onclick=\"saveTTSSettings()\" id=\"tts-save-btn\">Save</button>' +\n      '</div>';\n  }).catch(function() {\n    overlay.remove();\n    alert('Could not load voice playback settings.');\n  });\n}\n\nvar _KOKORO_GROUPS = { af: 'American Female', am: 'American Male', bf: 'British Female', bm: 'British Male' };\n\nfunction renderKokoroVoiceOptions(voices, sel) {\n  var groups = {};\n  var order = [];\n  for (var i = 0; i < voices.length; i++) {\n    var prefix = voices[i].id.substring(0, 2);\n    if (!groups[prefix]) { groups[prefix] = []; order.push(prefix); }\n    groups[prefix].push(voices[i]);\n  }\n  var html = '';\n  for (var g = 0; g < order.length; g++) {\n    var key = order[g];\n    html += '<optgroup label=\"' + (_KOKORO_GROUPS[key] || key) + '\">';\n    for (var j = 0; j < groups[key].length; j++) {\n      var v = groups[key][j];\n      html += '<option value=\"' + v.id + '\"' + (sel === v.id ? ' selected' : '') + '>' + escapeHtml(v.label) + '</option>';\n    }\n    html += '</optgroup>';\n  }\n  return html;\n}\n\nfunction renderVoiceOptions(provider, selectedVoice) {\n  var overlay = document.querySelector('.modal-overlay');\n  var data = overlay && overlay._ttsData;\n  if (!data || !data.voices[provider]) return '';\n  var sel = selectedVoice || data.voice;\n  var voices = data.voices[provider];\n  if (provider === 'kokoro') return renderKokoroVoiceOptions(voices, sel);\n  return voices.map(function(v) {\n    return '<option value=\"' + v.id + '\"' + (sel === v.id ? ' selected' : '') + '>' + escapeHtml(v.label) + '</option>';\n  }).join('');\n}\n\nfunction renderModelOptions(provider) {\n  var overlay = document.querySelector('.modal-overlay');\n  var data = overlay && overlay._ttsData;\n  if (!data || !data.models[provider]) return '';\n  return data.models[provider].map(function(m) {\n    return '<option value=\"' + m.id + '\"' + (data.model === m.id ? ' selected' : '') + '>' + escapeHtml(m.label) + '</option>';\n  }).join('');\n}\n\n// Cost estimates per model ($ per 1K characters, based on a ~2000-word / 10K char article)\nconst TTS_COST_PER_1K = {\n  'tts-1': 0.015,\n  'tts-1-hd': 0.030,\n  'gpt-4o-mini-tts': 0.015,\n  'eleven_multilingual_v2': 0.24,\n  'eleven_turbo_v2_5': 0.12,\n  'eleven_flash_v2_5': 0.12,\n};\nconst TTS_AVG_ARTICLE_CHARS = 10000; // ~2000 words\n\nfunction ttsGetCostHtml(provider, model) {\n  if (provider === 'browser') return '';\n  const perK = TTS_COST_PER_1K[model];\n  if (!perK) return '<span style=\"color:var(--muted)\">Cost depends on model — typically a few cents per article.</span>';\n  const perArticle = (perK * TTS_AVG_ARTICLE_CHARS / 1000);\n  let html = '<strong style=\"color:var(--fg)\">What it costs</strong><br>';\n  if (perArticle < 0.05) {\n    html += '<span style=\"color:var(--muted)\">Just a few cents per article — most people spend less than a dollar a week.</span>';\n  } else {\n    html += '<span style=\"color:var(--muted)\">About $' + perArticle.toFixed(2) + ' per article.</span>';\n  }\n  html += '<br><span style=\"font-size:11px;color:var(--muted)\">Audio is saved on your Mac so you only pay once per article, even if you listen again.</span>';\n  return html;\n}\n\nfunction ttsSettingsModelChanged() {\n  const provider = document.getElementById('tts-provider-select').value;\n  const model = document.getElementById('tts-model-select').value;\n  const costEl = document.getElementById('tts-cost-estimate');\n  if (costEl) costEl.innerHTML = ttsGetCostHtml(provider, model);\n}\n\nfunction ttsSettingsProviderChanged() {\n  const provider = document.getElementById('tts-provider-select').value;\n  const cloudSettings = document.getElementById('tts-cloud-settings');\n  const costInfo = document.getElementById('tts-cost-info');\n  const kokoroSettings = document.getElementById('tts-kokoro-settings');\n  const isCloud = provider === 'openai' || provider === 'elevenlabs';\n  cloudSettings.style.display = isCloud ? 'block' : 'none';\n  costInfo.style.display = isCloud ? 'block' : 'none';\n  if (kokoroSettings) kokoroSettings.style.display = provider === 'kokoro' ? 'block' : 'none';\n\n  // Reset consent checkbox when changing providers\n  const consent = document.getElementById('tts-consent');\n  if (consent) consent.checked = false;\n\n  const overlay = document.querySelector('.modal-overlay');\n  const data = overlay?._ttsData;\n  if (!data) return;\n\n  // Update voice options\n  const voiceSelect = document.getElementById('tts-voice-select');\n  if (data.voices[provider]) {\n    voiceSelect.innerHTML = renderVoiceOptions(provider, '');\n  } else {\n    voiceSelect.innerHTML = '';\n  }\n  // Also update Kokoro voice dropdown\n  const kokoroVoice = document.getElementById('tts-kokoro-voice');\n  if (kokoroVoice && data.voices.kokoro) {\n    kokoroVoice.innerHTML = renderVoiceOptions('kokoro', '');\n  }\n\n  // Update model options\n  const modelSelect = document.getElementById('tts-model-select');\n  if (data.models[provider]) {\n    modelSelect.innerHTML = data.models[provider].map(m =>\n      '<option value=\"' + m.id + '\">' + escapeHtml(m.label) + '</option>'\n    ).join('');\n  } else {\n    modelSelect.innerHTML = '';\n  }\n\n  // Update cost estimate\n  const model = modelSelect.value;\n  const costEl = document.getElementById('tts-cost-estimate');\n  if (costEl) costEl.innerHTML = ttsGetCostHtml(provider, model);\n}\n\nfunction ttsUpgradeKokoroQuality() {\n  var hidden = document.getElementById('tts-kokoro-model');\n  if (hidden) hidden.value = 'kokoro-v1-q4';\n  var container = document.getElementById('tts-kokoro-quality');\n  if (container) {\n    var label = container.querySelector('label');\n    container.innerHTML = '';\n    if (label) container.appendChild(label);\n    container.insertAdjacentHTML('beforeend',\n      '<div style=\"font-size:12px;color:#22c55e\">&#10003; High quality — will download on next listen</div>'\n      + '<input type=\"hidden\" id=\"tts-kokoro-model\" value=\"kokoro-v1-q4\">');\n  }\n}\n\nfunction saveTTSSettings() {\n  const provider = document.getElementById('tts-provider-select').value;\n  const config = { provider };\n\n  if (provider === 'kokoro') {\n    config.voice = document.getElementById('tts-kokoro-voice').value;\n    config.model = document.getElementById('tts-kokoro-model').value;\n  } else if (provider !== 'browser') {\n    const consent = document.getElementById('tts-consent');\n    if (!consent || !consent.checked) {\n      // Briefly highlight the consent checkbox\n      const label = consent?.closest('label');\n      if (label) {\n        label.style.outline = '2px solid #ef4444';\n        label.style.outlineOffset = '2px';\n        setTimeout(() => { label.style.outline = ''; label.style.outlineOffset = ''; }, 2000);\n      }\n      return;\n    }\n    const apiKeyInput = document.getElementById('tts-api-key').value;\n    if (apiKeyInput) {\n      config.apiKey = apiKeyInput;\n    } else {\n      // Preserve existing key on server\n      config.preserveKey = true;\n    }\n    config.voice = document.getElementById('tts-voice-select').value;\n    config.model = document.getElementById('tts-model-select').value;\n    // If no key entered and no existing key, require one\n    const overlay = document.querySelector('.modal-overlay');\n    const hasExistingKey = overlay?._ttsData?.hasKey;\n    if (!apiKeyInput && !hasExistingKey) {\n      alert('Please enter an API key for TTS.');\n      return;\n    }\n  }\n\n  // Close modal immediately for responsive feel\n  var settingsOverlay = document.querySelector('.modal-overlay');\n  if (settingsOverlay) settingsOverlay.remove();\n\n  var wasPlaying = ttsPlaying && ttsCurrentIndex >= 0 && ttsCurrentIndex < ttsQueue.length;\n  var resumeIdx = ttsCurrentIndex;\n\n  fetch('/api/tts-settings', {\n    method: 'POST',\n    headers: { 'Content-Type': 'application/json' },\n    body: JSON.stringify(config),\n  }).then(function(r) {\n    if (r.ok) {\n      ttsProvider = provider;\n      // Stop current audio but keep the queue\n      _ttsChunkSession = null;\n      if (ttsAudio) {\n        ttsAudio.pause();\n        ttsAudio.src = '';\n        ttsAudio = null;\n      }\n      if (window.speechSynthesis) window.speechSynthesis.cancel();\n      ttsPlaying = false;\n      renderAudioPlayer();\n      // Restart current article with the new voice\n      if (wasPlaying) {\n        startListenLoading();\n        playTTSItem(resumeIdx);\n      }\n    } else {\n      alert('Failed to save voice playback settings.');\n    }\n  });\n}\n\n// ---- Playback State Persistence ----\nfunction saveTTSState() {\n  try {\n    // Save position on the current queue item so it persists with the queue\n    if (ttsAudio && ttsAudio.duration && ttsCurrentIndex >= 0 && ttsCurrentIndex < ttsQueue.length) {\n      ttsQueue[ttsCurrentIndex].savedTime = ttsAudio.currentTime;\n      ttsQueue[ttsCurrentIndex].savedDuration = ttsAudio.duration;\n    }\n    var state = {\n      queue: ttsQueue,\n      currentIndex: ttsCurrentIndex,\n      speed: ttsSpeed,\n      timestamp: Date.now(),\n    };\n    if (ttsAudio && ttsAudio.duration) {\n      state.currentTime = ttsAudio.currentTime;\n      state.duration = ttsAudio.duration;\n    }\n    localStorage.setItem('pr-tts-state', JSON.stringify(state));\n  } catch(e) {}\n}\n\nfunction restoreTTSState() {\n  try {\n    var raw = localStorage.getItem('pr-tts-state');\n    if (!raw) return;\n    var state = JSON.parse(raw);\n    // Only restore if saved within last 24 hours\n    if (!state || !state.queue || !state.queue.length) return;\n    if (Date.now() - state.timestamp > 24 * 60 * 60 * 1000) {\n      localStorage.removeItem('pr-tts-state');\n      return;\n    }\n    ttsQueue = state.queue;\n    ttsCurrentIndex = state.currentIndex;\n    if (state.speed) ttsSpeed = state.speed;\n    // Don't auto-play — just show the queue and position\n    ttsPlaying = false;\n    renderAudioPlayer();\n    var speedBtn = document.getElementById('tts-speed-btn');\n    if (speedBtn) speedBtn.textContent = ttsSpeed + 'x';\n    // Show saved playback position in the progress bar\n    if (state.currentTime && state.duration && state.duration > 0) {\n      var pct = Math.min(100, (state.currentTime / state.duration) * 100);\n      var bar = document.getElementById('tts-progress');\n      var timeEl = document.getElementById('tts-time-current');\n      var totalEl = document.getElementById('tts-time-total');\n      if (bar) bar.style.width = pct + '%';\n      if (timeEl) timeEl.textContent = formatTime(state.currentTime);\n      if (totalEl) totalEl.textContent = formatTime(state.duration);\n    }\n  } catch(e) {}\n}\n\n// Save state when the page is closing so progress isn't lost\nwindow.addEventListener('beforeunload', function() {\n  if (ttsQueue.length > 0) saveTTSState();\n});\n\n// Restore on load (called externally after DOM is ready)\nif (typeof _ttsStateRestored === 'undefined') {\n  var _ttsStateRestored = true;\n  setTimeout(restoreTTSState, 500);\n}\n\n// ---- Mini Mode ----\n\nvar _miniModeSyncTimer = null;\nfunction startMiniModeSync() {\n  if (_miniModeSyncTimer) return;\n  _miniModeSyncTimer = setInterval(function() {\n    if (!miniMode) { stopMiniModeSync(); return; }\n    var fill = document.getElementById('mini-mode-progress-fill');\n    var cur = document.getElementById('mini-mode-time-current');\n    var tot = document.getElementById('mini-mode-time-total');\n    var mainFill = document.getElementById('tts-progress');\n    var mainCur = document.getElementById('tts-time-current');\n    var mainTot = document.getElementById('tts-time-total');\n    if (fill && mainFill) fill.style.width = mainFill.style.width;\n    if (cur && mainCur) cur.textContent = mainCur.textContent;\n    if (tot && mainTot) tot.textContent = mainTot.textContent;\n  }, 250);\n}\nfunction stopMiniModeSync() {\n  if (_miniModeSyncTimer) { clearInterval(_miniModeSyncTimer); _miniModeSyncTimer = null; }\n}\n\nfunction toggleMiniMode() {\n  miniMode = !miniMode;\n  document.body.classList.toggle('mini-mode', miniMode);\n  var container = document.getElementById('mini-mode-container');\n  if (container) container.style.display = miniMode ? '' : 'none';\n  if (miniMode) {\n    renderMiniMode();\n    initMiniModeProgressDrag();\n    startMiniModeSync();\n  } else {\n    stopMiniModeSync();\n  }\n  localStorage.setItem('pr-mini-mode', miniMode ? '1' : '0');\n}\n\nfunction renderMiniMode() {\n  var container = document.getElementById('mini-mode-container');\n  if (!container || !miniMode) return;\n\n  var titleEl = document.getElementById('mini-mode-title');\n  var statusEl = document.getElementById('mini-mode-status');\n  var playBtn = document.getElementById('mini-mode-play-btn');\n  var speedBtn = document.getElementById('mini-mode-speed-btn');\n  var queueEl = document.getElementById('mini-mode-queue');\n\n  if (ttsCurrentIndex >= 0 && ttsCurrentIndex < ttsQueue.length) {\n    titleEl.textContent = ttsQueue[ttsCurrentIndex].title;\n  } else {\n    titleEl.textContent = 'No article playing';\n  }\n\n  if (ttsGenerating) {\n    statusEl.textContent = 'Generating...';\n  } else if (ttsPlaying) {\n    statusEl.textContent = 'Playing';\n  } else if (ttsCurrentIndex >= 0) {\n    statusEl.textContent = 'Paused';\n  } else {\n    statusEl.textContent = '';\n  }\n\n  playBtn.innerHTML = ttsPlaying\n    ? '<svg><use href=\"#i-pause\"/></svg>'\n    : '<svg><use href=\"#i-play\"/></svg>';\n\n  speedBtn.textContent = ttsSpeed + 'x';\n\n  // Sync progress from main player\n  var mainProgress = document.getElementById('tts-progress');\n  var mainCurrent = document.getElementById('tts-time-current');\n  var mainTotal = document.getElementById('tts-time-total');\n  if (mainProgress) document.getElementById('mini-mode-progress-fill').style.width = mainProgress.style.width;\n  if (mainCurrent) document.getElementById('mini-mode-time-current').textContent = mainCurrent.textContent;\n  if (mainTotal) document.getElementById('mini-mode-time-total').textContent = mainTotal.textContent;\n\n  // Render queue\n  if (ttsQueue.length > 1) {\n    queueEl.innerHTML = ttsQueue.map(function(item, i) {\n      return '<div class=\"mini-mode-queue-item' + (i === ttsCurrentIndex ? ' playing' : '') + '\" onclick=\"playTTSItem(' + i + ')\">'\n        + '<span style=\"font-size:10px;color:var(--muted);width:14px;text-align:center\">' + (i === ttsCurrentIndex ? '&#9654;' : (i + 1)) + '</span>'\n        + '<span style=\"flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap\">' + escapeHtml(item.title) + '</span>'\n        + '</div>';\n    }).join('');\n  } else {\n    queueEl.innerHTML = '';\n  }\n\n  // Auto-exit mini mode when queue empties\n  if (ttsQueue.length === 0) {\n    miniMode = false;\n    document.body.classList.remove('mini-mode');\n    container.style.display = 'none';\n    localStorage.setItem('pr-mini-mode', '0');\n  }\n}\n\nvar _miniModeProgressDragInit = false;\nfunction initMiniModeProgressDrag() {\n  if (_miniModeProgressDragInit) return;\n  _miniModeProgressDragInit = true;\n\n  var wrap = document.getElementById('mini-mode-progress-wrap');\n  if (!wrap) return;\n\n  function seekFromEvent(e) {\n    if (!ttsPlaying && ttsCurrentIndex < 0) return;\n    var rect = wrap.getBoundingClientRect();\n    var clientX = e.touches ? e.touches[0].clientX : e.clientX;\n    var pct = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));\n    ttsSeek(pct);\n  }\n\n  function onMove(e) { seekFromEvent(e); }\n  function onEnd() {\n    document.removeEventListener('mousemove', onMove);\n    document.removeEventListener('mouseup', onEnd);\n    document.removeEventListener('touchmove', onMove);\n    document.removeEventListener('touchend', onEnd);\n  }\n\n  wrap.addEventListener('mousedown', function(e) {\n    e.preventDefault();\n    seekFromEvent(e);\n    document.addEventListener('mousemove', onMove);\n    document.addEventListener('mouseup', onEnd);\n  });\n\n  wrap.addEventListener('touchstart', function(e) {\n    e.preventDefault();\n    seekFromEvent(e);\n    document.addEventListener('touchmove', onMove, { passive: false });\n    document.addEventListener('touchend', onEnd);\n  }, { passive: false });\n}\n\n\n// ---- LLM Summarization ----\n\nlet llmConfigured = false;\nlet llmProvider = '';\nlet llmModel = '';\nlet lastSummaryProvider = '';\nlet lastSummaryModel = '';\n\nasync function checkLLMConfig() {\n  if (!serverMode) return;\n  try {\n    const res = await fetch('/api/settings');\n    if (res.ok) {\n      const data = await res.json();\n      var llm = data.llm || {};\n      var defProv = llm.defaultProvider || 'apple';\n      var provConfig = (llm.providers || {})[defProv] || {};\n      llmConfigured = defProv === 'apple' || !!provConfig.hasKey;\n      llmProvider = defProv;\n      llmModel = provConfig.model || '';\n    }\n  } catch {}\n}\n\nfunction providerLabel(provider) {\n  const labels = { anthropic: 'Anthropic', openai: 'OpenAI', gemini: 'Gemini', openrouter: 'OpenRouter', apple: 'Apple Intelligence' };\n  return labels[provider] || provider;\n}\n\nfunction providerBadgeColor(provider) {\n  const colors = { anthropic: 'amber', openai: 'green', gemini: 'blue', openrouter: 'purple', apple: 'indigo' };\n  return colors[provider] || 'gray';\n}\n\nfunction summaryBadgesHtml(provider, model) {\n  let html = '<span class=\"badge badge-gray\">Summary</span>';\n  if (provider) {\n    const color = providerBadgeColor(provider);\n    html += ' <span class=\"badge badge-' + color + '\">' + escapeHtml(providerLabel(provider)) + '</span>';\n  }\n  if (model) {\n    html += ' <span class=\"badge badge-gray\">' + escapeHtml(model) + '</span>';\n  }\n  return html;\n}\n\nasync function reprocessCurrentArticle(btn) {\n  if (!serverMode || !activeFile) return;\n  var origText = btn.innerHTML;\n  btn.disabled = true;\n  btn.innerHTML = '<svg class=\"icon icon-sm spin\" aria-hidden=\"true\" style=\"vertical-align:-1px;margin-right:3px\"><use href=\"#i-cloud-download\"/></svg> Re-fetching\\u2026';\n  try {\n    var res = await fetch('/api/reprocess', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ name: activeFile })\n    });\n    var data = await res.json();\n    if (!res.ok) throw new Error(data.error || 'Reprocess failed');\n    btn.innerHTML = '<svg class=\"icon icon-sm\" aria-hidden=\"true\" style=\"vertical-align:-1px;margin-right:3px\"><use href=\"#i-cloud-download\"/></svg> Done!';\n    // Reload the article content\n    setTimeout(async function() {\n      btn.innerHTML = origText;\n      btn.disabled = false;\n      // Re-fetch and render the updated article\n      try {\n        var r = await fetch('/api/file?name=' + encodeURIComponent(activeFile));\n        if (r.ok) { var text = await r.text(); renderArticle(text, activeFile); await loadAnnotations(activeFile); }\n      } catch(e) {}\n    }, 800);\n  } catch (err) {\n    btn.innerHTML = origText;\n    btn.disabled = false;\n    alert('Re-fetch failed: ' + (err.message || err));\n  }\n}\n\nasync function summarizeArticle() {\n  if (!serverMode || !activeFile) return;\n  const btn = document.getElementById('summarize-btn');\n  if (!btn) return;\n\n  btn.disabled = true;\n  btn.innerHTML = '<svg class=\"icon icon-sm\"><use href=\"#i-wand\"/></svg> Summarizing...';\n  btn.title = 'Summarizing with ' + providerLabel(llmProvider) + '...';\n\n  try {\n    const res = await fetch('/api/summarize', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ name: activeFile })\n    });\n    const data = await res.json();\n    if (data.error) {\n      btn.innerHTML = '<svg class=\"icon icon-sm\"><use href=\"#i-wand\"/></svg> Retry';\n      btn.disabled = false;\n      btn.title = data.error;\n      // Show error inline under the header\n      const content = document.getElementById('content');\n      const existingError = content.querySelector('.summary-error');\n      if (existingError) existingError.remove();\n      const errDiv = document.createElement('div');\n      errDiv.className = 'summary-error';\n      errDiv.style.cssText = 'padding:8px 12px;margin:8px 0;background:var(--border);border-radius:6px;font-size:12px;color:var(--muted)';\n      errDiv.textContent = data.error;\n      const articleHeader = content.querySelector('.article-header');\n      if (articleHeader) articleHeader.after(errDiv);\n      return;\n    }\n\n    lastSummaryProvider = data.provider || llmProvider;\n    lastSummaryModel = data.model || llmModel;\n\n    // Remove any previous error\n    const content = document.getElementById('content');\n    const existingError = content.querySelector('.summary-error');\n    if (existingError) existingError.remove();\n\n    // Insert summary into the DOM\n    const existingSummary = content.querySelector('.article-summary');\n    if (existingSummary) existingSummary.remove();\n\n    const summaryDiv = document.createElement('div');\n    summaryDiv.className = 'article-summary';\n    summaryDiv.innerHTML = '<div class=\"summary-header\"><div class=\"summary-header-left\">'\n      + summaryBadgesHtml(lastSummaryProvider, lastSummaryModel)\n      + '</div><span class=\"summary-actions\"><button onclick=\"hideSummary()\" title=\"Hide summary\"><svg class=\"icon icon-sm\"><use href=\"#i-xmark\"/></svg></button></span></div>'\n      + escapeHtml(data.summary);\n\n    const articleHeader = content.querySelector('.article-header');\n    if (articleHeader) {\n      articleHeader.after(summaryDiv);\n    } else {\n      content.prepend(summaryDiv);\n    }\n\n    btn.innerHTML = '<svg class=\"icon icon-sm\"><use href=\"#i-wand\"/></svg> Summarized';\n    btn.title = 'Summarized by ' + providerLabel(lastSummaryProvider) + ' (' + lastSummaryModel + '). Click to re-run.';\n    btn.disabled = false;\n    btn.onclick = function() { btn.onclick = null; summarizeArticle(); };\n  } catch (err) {\n    btn.innerHTML = '<svg class=\"icon icon-sm\"><use href=\"#i-wand\"/></svg> Retry';\n    btn.title = 'Summarization failed. Click to retry.';\n    btn.disabled = false;\n  }\n}\n\nfunction hideSummary() {\n  const content = document.getElementById('content');\n  const summary = content.querySelector('.article-summary');\n  if (summary) summary.remove();\n  // Reset summarize button\n  const btn = document.getElementById('summarize-btn');\n  if (btn) {\n    btn.innerHTML = '<svg class=\"icon icon-sm\"><use href=\"#i-wand\"/></svg> Summarize';\n    btn.title = 'Summarize';\n    btn.disabled = false;\n    btn.onclick = null;\n  }\n}\n\n// Modal focus management\n// ---- Sharing ----\n\nfunction getShareData() {\n  if (!activeFile) return null;\n  const file = allFiles.find(f => f.filename === activeFile);\n  if (!file || !file.url) return null;\n  return { title: file.title || '', url: file.url };\n}\n\nfunction toggleShareDropdown(e) {\n  e.stopPropagation();\n  // Close any existing share dropdown\n  const existing = document.querySelector('.share-dropdown-panel');\n  if (existing) { existing.remove(); return; }\n\n  const data = getShareData();\n  if (!data) return;\n\n  const panel = document.createElement('div');\n  panel.className = 'share-dropdown-panel';\n  panel.onclick = function(ev) { ev.stopPropagation(); };\n\n  const encodedUrl = encodeURIComponent(data.url);\n  const encodedTitle = encodeURIComponent(data.title);\n  const encodedText = encodeURIComponent(data.title + ' ' + data.url);\n\n  panel.innerHTML = `\n    <div class=\"share-group-label\">Actions</div>\n    <button onclick=\"copyArticleLink()\"><svg class=\"share-icon\" viewBox=\"0 0 640 512\"><use href=\"#i-link\"/></svg> Copy Link</button>\n    <button onclick=\"showExportMarkdownModal()\"><svg class=\"share-icon\" viewBox=\"0 0 640 512\"><use href=\"#i-cloud-download\"/></svg> Export Markdown</button>\n    <button onclick=\"startNotebookFromArticle()\"><svg class=\"share-icon\" viewBox=\"0 0 512 512\"><use href=\"#i-pen\"/></svg> Write About This</button>\n    <hr>\n    <div class=\"share-group-label\">Share to</div>\n    <a href=\"https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}\" target=\"_blank\" rel=\"noopener\"><svg class=\"share-icon\" viewBox=\"0 0 448 512\"><use href=\"#i-linkedin\"/></svg> LinkedIn</a>\n    <a href=\"https://bsky.app/intent/compose?text=${encodedText}\" target=\"_blank\" rel=\"noopener\"><svg class=\"share-icon\" viewBox=\"0 0 512 512\"><use href=\"#i-bluesky\"/></svg> Bluesky</a>\n    <a href=\"https://mastodon.social/share?text=${encodedText}\" target=\"_blank\" rel=\"noopener\"><svg class=\"share-icon\" viewBox=\"0 0 448 512\"><use href=\"#i-mastodon\"/></svg> Mastodon</a>\n    <a href=\"https://www.facebook.com/sharer/sharer.php?u=${encodedUrl}\" target=\"_blank\" rel=\"noopener\"><svg class=\"share-icon\" viewBox=\"0 0 320 512\"><use href=\"#i-facebook\"/></svg> Facebook</a>\n    <a href=\"https://www.threads.net/intent/post?text=${encodedText}\" target=\"_blank\" rel=\"noopener\"><svg class=\"share-icon\" viewBox=\"0 0 448 512\"><use href=\"#i-threads\"/></svg> Threads</a>\n    <hr>\n    <div class=\"share-group-label\">Send</div>\n    <a href=\"mailto:?subject=${encodedTitle}&body=${encodedText}\" target=\"_blank\"><svg class=\"share-icon\" viewBox=\"0 0 512 512\"><use href=\"#i-envelope\"/></svg> Email</a>\n    <a href=\"sms:&body=${encodedText}\"><svg class=\"share-icon\" viewBox=\"0 0 512 512\"><use href=\"#i-comment\"/></svg> Messages</a>\n  `;\n\n  e.target.closest('.share-dropdown').appendChild(panel);\n}\n\nfunction copyArticleLink() {\n  const data = getShareData();\n  if (!data) return;\n  navigator.clipboard.writeText(data.url).then(() => {\n    // Brief feedback\n    const existing = document.querySelector('.share-dropdown-panel');\n    if (existing) {\n      const btn = existing.querySelector('button');\n      if (btn) { const orig = btn.innerHTML; btn.innerHTML = '<span class=\"share-icon\">&#10003;</span> Copied!'; setTimeout(() => { btn.innerHTML = orig; }, 1200); }\n    }\n  });\n}\n\nfunction saveArticleLink() {\n  const data = getShareData();\n  if (!data) return;\n  // Use the Web Share API if available (for Safari reading list), otherwise just copy\n  if (navigator.share) {\n    navigator.share({ title: data.title, url: data.url }).catch(() => {});\n  } else {\n    // Fallback: open a bookmarklet-style URL for adding to reading list\n    copyArticleLink();\n  }\n  const existing = document.querySelector('.share-dropdown-panel');\n  if (existing) existing.remove();\n}\n\n// Export Markdown modal — lets user choose what to include\nfunction showExportMarkdownModal() {\n  // Close share dropdown\n  const panel = document.querySelector('.share-dropdown-panel');\n  if (panel) panel.remove();\n\n  if (!activeFile) return;\n\n  const hasHighlights = articleHighlights.length > 0;\n  const hasNotes = articleNotes.articleNote || (articleNotes.annotations && articleNotes.annotations.length > 0);\n  const file = allFiles.find(f => f.filename === activeFile);\n  const hasSummary = file && file.hasSummary;\n  const hasTags = (articleNotes.tags && articleNotes.tags.length > 0) || (articleNotes.machineTags && articleNotes.machineTags.length > 0);\n\n  const overlay = document.createElement('div');\n  overlay.className = 'modal-overlay';\n  overlay.setAttribute('role', 'dialog');\n  overlay.setAttribute('aria-modal', 'true');\n  overlay.setAttribute('aria-label', 'Export Markdown');\n  overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };\n\n  let optionsHtml = '';\n  optionsHtml += '<div class=\"export-option\"><input type=\"checkbox\" id=\"exp-summary\" checked ' + (hasSummary ? '' : 'disabled') + '><label for=\"exp-summary\">Include summary</label>' + (hasSummary ? '' : '<span class=\"export-hint\">none available</span>') + '</div>';\n  optionsHtml += '<div class=\"export-option\"><input type=\"checkbox\" id=\"exp-highlights\" checked ' + (hasHighlights ? '' : 'disabled') + '><label for=\"exp-highlights\">Include highlights</label>' + (hasHighlights ? '<span class=\"export-hint\">' + articleHighlights.length + '</span>' : '<span class=\"export-hint\">none</span>') + '</div>';\n  optionsHtml += '<div class=\"export-option\"><input type=\"checkbox\" id=\"exp-notes\" checked ' + (hasNotes ? '' : 'disabled') + '><label for=\"exp-notes\">Include notes</label>' + (hasNotes ? '' : '<span class=\"export-hint\">none</span>') + '</div>';\n  optionsHtml += '<div class=\"export-option\"><input type=\"checkbox\" id=\"exp-tags\" checked ' + (hasTags ? '' : 'disabled') + '><label for=\"exp-tags\">Include tags</label>' + (hasTags ? '<span class=\"export-hint\">' + [...(articleNotes.tags || []), ...(articleNotes.machineTags || [])].length + '</span>' : '<span class=\"export-hint\">none</span>') + '</div>';\n\n  overlay.innerHTML = `\n    <div class=\"modal-card\" onclick=\"event.stopPropagation()\" style=\"max-width:400px\">\n      <h2>Export Markdown</h2>\n      <p>Choose what to include in the exported file:</p>\n      ${optionsHtml}\n      <div class=\"modal-actions\">\n        <button class=\"btn-secondary\" onclick=\"this.closest('.modal-overlay').remove()\">Cancel</button>\n        <button class=\"btn-primary\" onclick=\"doExportMarkdown()\">Download .md</button>\n        <button class=\"btn-secondary\" onclick=\"doExportMarkdown(true)\">Copy</button>\n      </div>\n    </div>\n  `;\n  document.body.appendChild(overlay);\n}\n\nasync function doExportMarkdown(copyOnly) {\n  if (!activeFile) return;\n\n  const inclSummary = document.getElementById('exp-summary')?.checked;\n  const inclHighlights = document.getElementById('exp-highlights')?.checked;\n  const inclNotes = document.getElementById('exp-notes')?.checked;\n  const inclTags = document.getElementById('exp-tags')?.checked;\n\n  // Fetch the raw markdown\n  let rawText = '';\n  if (serverMode) {\n    const res = await fetch('/api/file?name=' + encodeURIComponent(activeFile));\n    if (res.ok) rawText = await res.text();\n  }\n  if (!rawText) return;\n\n  const { meta, body } = parseFrontmatter(rawText);\n\n  // Build export markdown\n  let md = '';\n\n  // Title\n  if (meta && meta.title) md += '# ' + meta.title + '\\n\\n';\n\n  // Source info\n  const infoParts = [];\n  if (meta && meta.author) infoParts.push('**Author:** ' + meta.author);\n  if (meta && meta.url) infoParts.push('**Source:** ' + meta.url);\n  if (meta && meta.bookmarked) infoParts.push('**Saved:** ' + meta.bookmarked.slice(0, 10));\n  if (infoParts.length) md += infoParts.join('  \\n') + '\\n\\n';\n\n  // Tags\n  if (inclTags) {\n    const allTags = [...(articleNotes.tags || []), ...(articleNotes.machineTags || [])];\n    if (allTags.length) md += '**Tags:** ' + allTags.join(', ') + '\\n\\n';\n  }\n\n  // Summary\n  if (inclSummary && meta && meta.summary) {\n    md += '> **Summary:** ' + meta.summary + '\\n\\n';\n  }\n\n  md += '---\\n\\n';\n\n  // Article body\n  md += cleanMarkdown(body).trim() + '\\n';\n\n  // Highlights section\n  if (inclHighlights && articleHighlights.length > 0) {\n    md += '\\n---\\n\\n## Highlights\\n\\n';\n    for (const hl of articleHighlights) {\n      const colorLabel = hl.color ? ' (' + hl.color + ')' : '';\n      md += '- > ' + hl.text + colorLabel + '\\n';\n      if (hl.note) md += '  - **Note:** ' + hl.note + '\\n';\n    }\n  }\n\n  // Notes section\n  if (inclNotes) {\n    const hasArticleNote = articleNotes.articleNote && articleNotes.articleNote.trim();\n    const hasAnnotations = articleNotes.annotations && articleNotes.annotations.length > 0;\n    if (hasArticleNote || hasAnnotations) {\n      md += '\\n---\\n\\n## Notes\\n\\n';\n      if (hasArticleNote) {\n        md += articleNotes.articleNote.trim() + '\\n\\n';\n      }\n      if (hasAnnotations) {\n        for (const ann of articleNotes.annotations) {\n          md += '- **\"' + ann.text + '\"** — ' + ann.note + '\\n';\n        }\n      }\n    }\n  }\n\n  if (copyOnly) {\n    await navigator.clipboard.writeText(md);\n    // Flash feedback\n    const overlay = document.querySelector('.modal-overlay');\n    if (overlay) {\n      const btn = overlay.querySelector('.btn-secondary:last-child');\n      if (btn) { const orig = btn.textContent; btn.textContent = 'Copied!'; setTimeout(() => { btn.textContent = orig; }, 1200); }\n    }\n    return;\n  }\n\n  // Download as file\n  const blob = new Blob([md], { type: 'text/markdown;charset=utf-8' });\n  const url = URL.createObjectURL(blob);\n  const a = document.createElement('a');\n  a.href = url;\n  a.download = activeFile;\n  document.body.appendChild(a);\n  a.click();\n  document.body.removeChild(a);\n  URL.revokeObjectURL(url);\n\n  // Close modal\n  const overlay = document.querySelector('.modal-overlay');\n  if (overlay) overlay.remove();\n}\n\n// Close share dropdown when clicking outside\ndocument.addEventListener('click', function(e) {\n  const panel = document.querySelector('.share-dropdown-panel');\n  if (panel && !panel.contains(e.target) && !e.target.closest('.share-dropdown')) {\n    panel.remove();\n  }\n});\n\n// Batch auto-tag all articles\nasync function batchAutotagAll(force) {\n  if (!serverMode) return;\n\n  // Show warning before proceeding\n  var msg = force\n    ? 'This will re-tag ALL articles using AI, replacing any existing machine-generated tags. User tags will be preserved. Continue?'\n    : 'This will auto-tag all untagged articles using AI. This may take a while for large libraries. Continue?';\n  if (!confirm(msg)) return;\n\n  var btn = document.getElementById('batch-tag-btn');\n  var origText = btn ? btn.innerHTML : '';\n  if (btn) {\n    btn.disabled = true;\n    btn.innerHTML = '<svg class=\"icon icon-sm\" aria-hidden=\"true\" style=\"opacity:0.5;vertical-align:-1px\"><use href=\"#i-wand\"/></svg> Tagging...';\n  }\n\n  try {\n    const res = await fetch('/api/autotag-batch', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ force: !!force })\n    });\n    const data = await res.json();\n    if (data.error) {\n      alert('Auto-tag failed: ' + data.error);\n    } else {\n      if (btn) btn.innerHTML = '<svg class=\"icon icon-sm\" aria-hidden=\"true\" style=\"opacity:0.5;vertical-align:-1px\"><use href=\"#i-wand\"/></svg> Done!';\n      // Refresh annotations index to pick up new tags\n      await loadAnnotationsIndex();\n      renderFileList();\n      // Refresh the explore page if open\n      setTimeout(function() { var ep = document.querySelector('.explore-tabs'); if (ep) showTagCloud(); }, 2000);\n    }\n  } catch (err) {\n    alert('Auto-tag request failed.');\n  }\n  if (btn) {\n    btn.disabled = false;\n    if (btn.innerHTML.includes('Tagging')) btn.innerHTML = origText;\n  }\n}\n\nlet _modalReturnFocus = null;\n\nfunction trapFocus(overlay) {\n  overlay.addEventListener('keydown', function(e) {\n    if (e.key === 'Escape') { closeModal(); return; }\n    if (e.key !== 'Tab') return;\n    const focusable = overlay.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex=\"-1\"])');\n    if (!focusable.length) return;\n    const first = focusable[0], last = focusable[focusable.length - 1];\n    if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }\n    else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }\n  });\n}\n\n\n// ---- Notebook ---- (synthesis writing surface)\nlet _notebooks = {};\nlet _activeNotebook = null;\nlet _notebookSaveTimeout = null;\nlet _notebookPreviewMode = false;\nlet _activeNoteId = null;\nconst SINGLE_NOTEBOOK_ID = 'nb-shared';\n\n// Get or create the single shared notebook\nasync function getOrCreateSingleNotebook() {\n  await loadNotebooks();\n  if (_notebooks[SINGLE_NOTEBOOK_ID]) {\n    let found = _notebooks[SINGLE_NOTEBOOK_ID];\n    // Migrate legacy content blob into discrete notes\n    if (found.content && (!found.notes || !found.notes.length)) {\n      found.notes = migrateContentToNotes(found.content, found.createdAt || new Date().toISOString());\n      found.content = '';\n      await saveNotebook(found);\n    }\n    if (!found.notes) found.notes = [];\n    return found;\n  }\n  // Migrate: if there are existing notebooks, merge them into the single notebook\n  const existing = Object.values(_notebooks).sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));\n  let content = '';\n  let sources = [];\n  let tags = [];\n  for (const nb of existing) {\n    if (nb.content) content += (content ? '\\n\\n---\\n\\n' : '') + nb.content;\n    if (nb.sources) sources = sources.concat(nb.sources);\n    if (nb.tags) tags = tags.concat(nb.tags);\n  }\n  const now = new Date().toISOString();\n  const nbCreated = existing.length ? existing[0].createdAt : now;\n  const nb = {\n    id: SINGLE_NOTEBOOK_ID,\n    title: 'Notebook',\n    content: '',\n    notes: migrateContentToNotes(content, nbCreated),\n    sources: [...new Set(sources)],\n    tags: [...new Set(tags)],\n    createdAt: nbCreated,\n    updatedAt: now\n  };\n  await saveNotebook(nb);\n  // Clean up old notebooks\n  for (const old of existing) {\n    if (old.id && old.id !== SINGLE_NOTEBOOK_ID) {\n      try { await fetch('/api/notebooks?id=' + encodeURIComponent(old.id), { method: 'DELETE' }); } catch {}\n      delete _notebooks[old.id];\n    }\n  }\n  return nb;\n}\n\nasync function loadNotebooks() {\n  try {\n    const res = await fetch('/api/notebooks');\n    if (res.ok) _notebooks = await res.json();\n  } catch {}\n}\n\nasync function saveNotebook(nb) {\n  try {\n    const res = await fetch('/api/notebooks', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify(nb)\n    });\n    if (res.ok) {\n      const data = await res.json();\n      if (!nb.id) nb.id = data.id;\n      _notebooks[nb.id] = nb;\n    }\n  } catch {}\n}\n\nfunction generateNoteId() {\n  return 'note-' + Math.random().toString(36).slice(2, 10);\n}\n\n// Split a legacy content string on --- separators into note objects\nfunction migrateContentToNotes(content, timestamp) {\n  if (!content || !content.trim()) return [];\n  var parts = content.split('\\n\\n---\\n\\n');\n  var ts = timestamp || new Date().toISOString();\n  return parts.filter(function(p) { return p.trim(); }).map(function(text) {\n    return { id: generateNoteId(), content: text.trim(), sourceArticle: '', createdAt: ts, updatedAt: ts };\n  });\n}\n\nasync function createNote(sourceArticle, initialContent) {\n  if (!_activeNotebook) {\n    _activeNotebook = await getOrCreateSingleNotebook();\n  }\n  if (!_activeNotebook.notes) _activeNotebook.notes = [];\n  var now = new Date().toISOString();\n  var note = { id: generateNoteId(), content: initialContent || '', sourceArticle: sourceArticle || '', createdAt: now, updatedAt: now };\n  _activeNotebook.notes.unshift(note);\n  _activeNotebook.updatedAt = now;\n  saveNotebook(_activeNotebook);\n  openNoteInPane(note.id);\n  renderFileList();\n  return note;\n}\n\nfunction deleteNote(noteId) {\n  if (!_activeNotebook || !_activeNotebook.notes) return;\n  _activeNotebook.notes = _activeNotebook.notes.filter(function(n) { return n.id !== noteId; });\n  _activeNotebook.updatedAt = new Date().toISOString();\n  saveNotebook(_activeNotebook);\n  if (_activeNoteId === noteId) {\n    var next = _activeNotebook.notes.length ? _activeNotebook.notes[0] : null;\n    if (next) {\n      openNoteInPane(next.id);\n    } else {\n      _activeNoteId = null;\n      openNotebookInPane(_activeNotebook.id);\n    }\n  }\n  renderFileList();\n}\n\nasync function deleteNotebook(id) {\n  try {\n    await fetch('/api/notebooks?id=' + encodeURIComponent(id), { method: 'DELETE' });\n    delete _notebooks[id];\n    _activeNotebook = null;\n    renderFileList();\n    goHome();\n  } catch {}\n}\n\n// Thin wrapper — kept for backward compatibility with callers\nfunction showNotebook(openId) {\n  getOrCreateSingleNotebook().then(function(nb) {\n    openNotebookInPane(nb.id);\n  });\n}\n\n// Initialize notebook and show first note (or empty state) in content pane\nfunction openNotebookInPane(id) {\n  const nb = _notebooks[id];\n  if (!nb) return;\n  activeFile = null;\n  _activeNotebook = nb;\n  if (!nb.notes) nb.notes = [];\n  renderFileList();\n\n  if (nb.notes.length && !_activeNoteId) {\n    openNoteInPane(nb.notes[0].id);\n  } else if (_activeNoteId) {\n    openNoteInPane(_activeNoteId);\n  } else {\n    // Empty state\n    var content = document.getElementById('content');\n    var empty = document.getElementById('empty-state');\n    empty.style.display = 'none';\n    content.style.display = 'block';\n    document.title = 'Notebook — PullRead';\n    document.getElementById('margin-notes').innerHTML = '';\n    content.innerHTML = '<div class=\"notebook-empty\"><p>No notes yet.</p>'\n      + '<p><button class=\"new-note-btn\" onclick=\"createNote()\"><svg class=\"icon icon-sm\" aria-hidden=\"true\"><use href=\"#i-plus\"/></svg> New Note</button></p></div>';\n  }\n}\n\n// Render a single note as a full-page editor in the content pane\nfunction openNoteInPane(noteId) {\n  if (!_activeNotebook) return;\n  var note = (_activeNotebook.notes || []).find(function(n) { return n.id === noteId; });\n  if (!note) return;\n\n  // Save previous note before switching\n  if (_activeNoteId && _activeNoteId !== noteId) saveActiveNoteContent();\n\n  activeFile = null;\n  _activeNoteId = noteId;\n\n  var content = document.getElementById('content');\n  var empty = document.getElementById('empty-state');\n  empty.style.display = 'none';\n  content.style.display = 'block';\n  document.getElementById('margin-notes').innerHTML = '';\n\n  var nb = _activeNotebook;\n  var firstLine = (note.content || '').split('\\n')[0].replace(/^#+\\s*/, '').trim() || 'Untitled Note';\n  document.title = firstLine + ' — PullRead';\n\n  renderFileList();\n\n  var html = '<div class=\"note-page\" data-note-id=\"' + escapeHtml(note.id) + '\">';\n\n  // Article-style header\n  html += '<div class=\"article-header\">';\n  html += '<input type=\"text\" class=\"note-title-input\" value=\"' + escapeHtml(firstLine === 'Untitled Note' ? '' : firstLine) + '\" placeholder=\"Untitled Note\" oninput=\"updateNoteTitle(this.value)\">';\n  html += '<div class=\"article-byline\">';\n  var bylineParts = ['<span>Note</span>'];\n  if (note.updatedAt) bylineParts.push('<span>' + new Date(note.updatedAt).toLocaleDateString() + '</span>');\n  if (note.sourceArticle) {\n    var srcFile = allFiles.find(function(f) { return f.filename === note.sourceArticle; });\n    var srcTitle = srcFile ? srcFile.title : note.sourceArticle;\n    bylineParts.push('<a href=\"#\" onclick=\"jumpToArticle(\\'' + escapeHtml(note.sourceArticle) + '\\');return false\">' + escapeHtml(srcTitle) + '</a>');\n  }\n  html += bylineParts.join('<span class=\"sep\">&middot;</span>');\n  html += '</div>';\n\n  // Action buttons\n  html += '<div class=\"article-actions\">';\n  var previewLabel = _notebookPreviewMode ? 'Edit' : 'Preview';\n  html += '<button onclick=\"toggleNotebookPreview()\" class=\"' + (_notebookPreviewMode ? 'active-fav' : '') + '\"><svg class=\"icon icon-sm\" aria-hidden=\"true\"><use href=\"#i-pen\"/></svg> ' + previewLabel + '</button>';\n  html += '<button onclick=\"toggleWritingFocus()\" class=\"' + (_writingFocusActive ? 'active-fav' : '') + '\"><svg class=\"icon icon-sm\" aria-hidden=\"true\"><use href=\"#i-focus\"/></svg> Focus</button>';\n  html += '<button onclick=\"showHighlightPicker()\"><svg class=\"icon icon-sm\" aria-hidden=\"true\"><use href=\"#i-pen\"/></svg> Insert Highlights</button>';\n  html += '<button onclick=\"checkNotebookGrammar()\" id=\"grammar-check-btn\"><svg class=\"icon icon-sm\" aria-hidden=\"true\"><use href=\"#i-wand\"/></svg> Grammar</button>';\n  html += '<div class=\"share-dropdown\" style=\"display:inline-block\"><button onclick=\"toggleNotebookExportDropdown(event)\"><svg class=\"icon icon-sm\" aria-hidden=\"true\"><use href=\"#i-share\"/></svg> Export\\u2026</button></div>';\n  html += '<button class=\"note-delete-btn\" onclick=\"confirmDeleteNote(\\'' + escapeHtml(note.id) + '\\')\" title=\"Delete note\"><svg class=\"icon icon-sm\" aria-hidden=\"true\"><use href=\"#i-xmark\"/></svg> Delete</button>';\n  html += '<span class=\"save-hint\" id=\"notebook-save-hint\" style=\"font-size:11px;color:var(--muted);margin-left:auto\">Saved</span>';\n  html += '</div>';\n  html += '</div>';\n\n  // Full-page editor or preview\n  if (_notebookPreviewMode) {\n    html += '<div class=\"notebook-preview\">' + sanitizeHtml(marked.parse(note.content || '*Start writing...*')) + '</div>';\n  } else {\n    html += '<div class=\"notebook-editor-wrap\"><div class=\"notebook-editor\">'\n      + '<textarea placeholder=\"Start writing... Use markdown for formatting.\">' + escapeHtml(note.content || '') + '</textarea>'\n      + '</div></div>';\n  }\n\n  // Tags row (notebook-level)\n  var nbTags = (nb.tags || []);\n  html += '<div class=\"tags-row\" style=\"margin-top:12px\">';\n  for (var ti = 0; ti < nbTags.length; ti++) {\n    var t = nbTags[ti];\n    html += '<span class=\"tag\">' + escapeHtml(t) + '<span class=\"tag-remove\" onclick=\"removeNotebookTag(\\'' + escapeHtml(t.replace(/'/g, \"\\\\'\")) + '\\')\">&times;</span></span>';\n  }\n  html += '<input type=\"text\" placeholder=\"Add tag...\" onkeydown=\"handleNotebookTagKey(event)\" style=\"flex:1;min-width:80px\">';\n  html += '</div>';\n  html += '<div id=\"nb-tag-suggestions\" class=\"nb-tag-suggestions\" style=\"display:none\"></div>';\n\n  html += '</div>';\n  content.innerHTML = html;\n\n  document.getElementById('content-pane').scrollTop = 0;\n\n  // Render diagrams in preview mode\n  if (_notebookPreviewMode) {\n    renderDiagrams();\n    applySyntaxHighlighting();\n  }\n\n  // Set up auto-grow, auto-save, focus tracking, and grammar mirror for textarea\n  var ta = content.querySelector('.note-page .notebook-editor textarea');\n  if (ta) {\n    setupGrammarMirror(ta);\n    autoGrowTextarea(ta);\n    ta.addEventListener('input', function() {\n      autoGrowTextarea(ta);\n      notebookDebounceSave();\n      updateWritingFocusLine();\n      scheduleNotebookTagSuggestion();\n      // Sync title input from first line of content\n      var firstLine = (ta.value || '').split('\\n')[0].replace(/^#+\\s*/, '').trim();\n      var titleInput = document.querySelector('.note-title-input');\n      if (titleInput) titleInput.value = firstLine;\n      var sidebarItem = document.querySelector('.note-item[data-note-id=\"' + _activeNoteId + '\"] .file-item-title');\n      if (sidebarItem) sidebarItem.textContent = firstLine || 'Empty note';\n    });\n    ta.addEventListener('click', updateWritingFocusLine);\n    ta.addEventListener('keyup', updateWritingFocusLine);\n    ta.addEventListener('scroll', updateWritingFocusLine);\n    ta.focus();\n  }\n}\n\n// Sync title input changes into the first line of the note content\nfunction updateNoteTitle(value) {\n  if (!_activeNotebook || !_activeNoteId) return;\n  var note = _activeNotebook.notes.find(function(n) { return n.id === _activeNoteId; });\n  if (!note) return;\n  var lines = (note.content || '').split('\\n');\n  if (value.trim()) {\n    var heading = '# ' + value.trim();\n    if (lines.length && /^#+\\s/.test(lines[0])) {\n      lines[0] = heading;\n    } else {\n      lines.unshift(heading);\n    }\n  } else if (lines.length && /^#+\\s/.test(lines[0])) {\n    lines.shift();\n  }\n  note.content = lines.join('\\n');\n  note.updatedAt = new Date().toISOString();\n  // Sync textarea if visible\n  var ta = document.querySelector('.note-page .notebook-editor textarea');\n  if (ta) ta.value = note.content;\n  document.title = (value.trim() || 'Untitled Note') + ' — PullRead';\n  // Update sidebar item title\n  var sidebarItem = document.querySelector('.note-item[data-note-id=\"' + _activeNoteId + '\"] .file-item-title');\n  if (sidebarItem) sidebarItem.textContent = value.trim() || 'Empty note';\n  notebookDebounceSave();\n}\n\nfunction confirmDeleteNote(noteId) {\n  if (confirm('Delete this note?')) deleteNote(noteId);\n}\n\n// Save textarea content back to the active note's slot in the array\nfunction saveActiveNoteContent() {\n  if (!_activeNotebook || !_activeNoteId) return;\n  var ta = document.querySelector('.note-page .notebook-editor textarea');\n  if (!ta) return;\n  var note = _activeNotebook.notes.find(function(n) { return n.id === _activeNoteId; });\n  if (note) {\n    note.content = ta.value;\n    note.updatedAt = new Date().toISOString();\n  }\n}\n\nfunction autoGrowTextarea(ta) {\n  ta.style.height = 'auto';\n  ta.style.height = Math.max(400, ta.scrollHeight) + 'px';\n  // Keep grammar mirror height in sync\n  var wrap = ta.closest('.notebook-editor-wrap');\n  var mirror = wrap ? wrap.querySelector('.grammar-mirror') : null;\n  if (mirror) mirror.style.height = ta.offsetHeight + 'px';\n}\n\nfunction notebookDebounceSave() {\n  const hint = document.getElementById('notebook-save-hint');\n  if (hint) hint.textContent = 'Saving...';\n  clearTimeout(_notebookSaveTimeout);\n  _notebookSaveTimeout = setTimeout(() => {\n    if (!_activeNotebook) return;\n    // Save active note content from textarea\n    if (_activeNoteId) {\n      var wfTa = document.getElementById('wf-textarea');\n      var ta = wfTa || document.querySelector('.note-page .notebook-editor textarea');\n      if (ta) {\n        var note = _activeNotebook.notes.find(function(n) { return n.id === _activeNoteId; });\n        if (note) {\n          note.content = ta.value;\n          note.updatedAt = new Date().toISOString();\n        }\n      }\n    }\n    _activeNotebook.updatedAt = new Date().toISOString();\n    saveNotebook(_activeNotebook).then(() => {\n      if (hint) hint.textContent = 'Saved';\n    });\n  }, 800);\n}\n\n// AI tag suggestions for notebook content\nlet _nbTagSuggestTimeout = null;\nlet _nbLastSuggestedContent = '';\n\nfunction scheduleNotebookTagSuggestion() {\n  clearTimeout(_nbTagSuggestTimeout);\n  if (!_activeNotebook || !serverMode) return;\n  const ta = document.querySelector('.note-page .notebook-editor textarea');\n  if (!ta) return;\n  const text = ta.value || '';\n  // Require 2+ paragraphs (split by double newline)\n  const paragraphs = text.split(/\\n\\s*\\n/).filter(p => p.trim().length > 20);\n  if (paragraphs.length < 2) return;\n  // Don't re-suggest if content hasn't changed substantially\n  if (text === _nbLastSuggestedContent) return;\n  _nbTagSuggestTimeout = setTimeout(function() {\n    _nbLastSuggestedContent = text;\n    fetchNotebookTagSuggestions(text);\n  }, 10000);\n}\n\nasync function fetchNotebookTagSuggestions(text) {\n  const container = document.getElementById('nb-tag-suggestions');\n  if (!container || !_activeNotebook) return;\n  try {\n    const res = await fetch('/api/autotag', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ text: text })\n    });\n    if (!res.ok) return;\n    const data = await res.json();\n    const suggestions = (data.machineTags || []).slice(0, 3);\n    if (!suggestions.length) { container.style.display = 'none'; return; }\n    // Filter out tags already on the notebook\n    const existing = new Set((_activeNotebook.tags || []).map(t => t.toLowerCase()));\n    const filtered = suggestions.filter(t => !existing.has(t.toLowerCase()));\n    if (!filtered.length) { container.style.display = 'none'; return; }\n    let html = '<span class=\"nb-suggest-label\">Suggested tags:</span> ';\n    for (const tag of filtered) {\n      html += '<button class=\"nb-suggest-pill\" onclick=\"acceptNotebookTagSuggestion(\\'' + escapeHtml(tag.replace(/'/g, \"\\\\'\")) + '\\',this)\">'\n        + escapeHtml(tag) + ' <span class=\"nb-suggest-accept\">+</span></button> ';\n    }\n    html += '<button class=\"nb-suggest-dismiss\" onclick=\"this.parentElement.style.display=\\'none\\'\" title=\"Dismiss\">&times;</button>';\n    container.innerHTML = html;\n    container.style.display = '';\n  } catch {}\n}\n\nfunction acceptNotebookTagSuggestion(tag, btn) {\n  if (!_activeNotebook) return;\n  if (!_activeNotebook.tags) _activeNotebook.tags = [];\n  if (!_activeNotebook.tags.includes(tag)) {\n    _activeNotebook.tags.push(tag);\n    saveNotebook(_activeNotebook);\n    if (_activeNoteId) openNoteInPane(_activeNoteId);\n  }\n}\n\n// ---- Grammar Checking (macOS NSSpellChecker — fully on-device) ----\n\nvar _grammarDebounceTimeout = null;\nvar _grammarMirrorMatches = [];\n\n// Set up a grammar mirror div behind the textarea for inline underlines\nfunction setupGrammarMirror(textarea) {\n  var wrap = textarea.closest('.notebook-editor-wrap');\n  if (!wrap || wrap.querySelector('.grammar-mirror')) return;\n\n  var mirror = document.createElement('div');\n  mirror.className = 'grammar-mirror';\n  // Insert before .notebook-editor so it renders behind the transparent textarea\n  wrap.insertBefore(mirror, wrap.firstChild);\n\n  // Sync scroll position\n  textarea.addEventListener('scroll', function() {\n    mirror.scrollTop = textarea.scrollTop;\n  });\n\n  // Run grammar on text changes (debounced)\n  textarea.addEventListener('input', function() {\n    clearTimeout(_grammarDebounceTimeout);\n    _grammarDebounceTimeout = setTimeout(function() {\n      runInlineGrammar(textarea);\n    }, 1500);\n  });\n}\n\n// Fetch grammar results and render underlines in the mirror div\nasync function runInlineGrammar(textarea) {\n  if (!textarea || !textarea.value.trim()) {\n    updateGrammarMirror(textarea, []);\n    return;\n  }\n  var text = textarea.value;\n  try {\n    var res = await fetch('/api/grammar', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ text: text })\n    });\n    if (!res.ok) return;\n    var data = await res.json();\n    var matches = (data.matches || []).map(function(m) {\n      return {\n        offset: m.offset,\n        length: m.length,\n        message: m.message || '',\n        replacements: m.replacements || []\n      };\n    });\n    _grammarMirrorMatches = matches;\n    updateGrammarMirror(textarea, matches);\n  } catch {}\n}\n\n// Render grammar errors as underlined spans in the mirror div\nfunction updateGrammarMirror(textarea, matches) {\n  var wrap = textarea ? textarea.closest('.notebook-editor-wrap') : null;\n  var mirror = wrap ? wrap.querySelector('.grammar-mirror') : null;\n  if (!mirror || !textarea) return;\n\n  // Sync mirror sizing from textarea computed styles\n  var cs = getComputedStyle(textarea);\n  mirror.style.font = cs.font;\n  mirror.style.lineHeight = cs.lineHeight;\n  mirror.style.letterSpacing = cs.letterSpacing;\n  mirror.style.padding = cs.padding;\n  mirror.style.tabSize = cs.tabSize;\n  mirror.style.width = textarea.offsetWidth + 'px';\n  mirror.style.height = textarea.offsetHeight + 'px';\n\n  var text = textarea.value;\n  if (!matches || !matches.length) {\n    mirror.textContent = text;\n    return;\n  }\n\n  // Sort matches by offset, build HTML with <mark> spans around errors\n  var sorted = matches.slice().sort(function(a, b) { return a.offset - b.offset; });\n  var html = '';\n  var pos = 0;\n  for (var i = 0; i < sorted.length; i++) {\n    var m = sorted[i];\n    if (m.offset < pos) continue; // skip overlapping\n    if (m.offset > pos) {\n      html += escapeHtml(text.substring(pos, m.offset));\n    }\n    var errorText = text.substring(m.offset, m.offset + m.length);\n    var fixes = (m.replacements || []).slice(0, 3).join('|');\n    html += '<mark class=\"grammar-underline\" data-offset=\"' + m.offset + '\" data-length=\"' + m.length\n      + '\" data-msg=\"' + escapeHtml(m.message) + '\" data-fixes=\"' + escapeHtml(fixes)\n      + '\">' + escapeHtml(errorText) + '</mark>';\n    pos = m.offset + m.length;\n  }\n  if (pos < text.length) {\n    html += escapeHtml(text.substring(pos));\n  }\n  mirror.innerHTML = html;\n  mirror.scrollTop = textarea.scrollTop;\n}\n\n// Show tooltip when clicking a grammar underline\nfunction showGrammarTooltip(mark) {\n  // Remove any existing tooltip\n  var old = document.querySelector('.grammar-tooltip');\n  if (old) old.remove();\n\n  var msg = mark.getAttribute('data-msg');\n  var fixes = mark.getAttribute('data-fixes');\n  var offset = parseInt(mark.getAttribute('data-offset'), 10);\n  var length = parseInt(mark.getAttribute('data-length'), 10);\n\n  var tip = document.createElement('div');\n  tip.className = 'grammar-tooltip';\n  var html = '<div class=\"grammar-tooltip-msg\">' + escapeHtml(msg) + '</div>';\n  if (fixes) {\n    html += '<div class=\"grammar-tooltip-fixes\">';\n    var parts = fixes.split('|');\n    for (var i = 0; i < parts.length; i++) {\n      html += '<button class=\"grammar-fix-btn\" data-offset=\"' + offset + '\" data-length=\"' + length\n        + '\" data-fix=\"' + escapeHtml(parts[i]) + '\">' + escapeHtml(parts[i]) + '</button>';\n    }\n    html += '</div>';\n  }\n  tip.innerHTML = html;\n\n  // Position relative to the mark\n  var rect = mark.getBoundingClientRect();\n  tip.style.position = 'fixed';\n  tip.style.left = rect.left + 'px';\n  tip.style.top = (rect.bottom + 4) + 'px';\n  document.body.appendChild(tip);\n\n  // Handle fix button clicks\n  tip.addEventListener('click', function(e) {\n    var btn = e.target.closest('.grammar-fix-btn');\n    if (!btn) return;\n    var fixOffset = parseInt(btn.getAttribute('data-offset'), 10);\n    var fixLength = parseInt(btn.getAttribute('data-length'), 10);\n    var fixValue = btn.getAttribute('data-fix');\n    applyGrammarFix(fixOffset, fixLength, fixValue);\n    tip.remove();\n    // Re-run inline grammar after fix\n    var ta = document.querySelector('.note-page .notebook-editor textarea');\n    if (ta) {\n      clearTimeout(_grammarDebounceTimeout);\n      _grammarDebounceTimeout = setTimeout(function() { runInlineGrammar(ta); }, 300);\n    }\n  });\n\n  // Close on click outside\n  setTimeout(function() {\n    document.addEventListener('click', function close(e) {\n      if (!tip.contains(e.target)) { tip.remove(); document.removeEventListener('click', close); }\n    });\n  }, 0);\n}\n\n// Delegate click on grammar-underline marks\ndocument.addEventListener('click', function(e) {\n  var mark = e.target.closest('.grammar-underline');\n  if (mark) {\n    e.stopPropagation();\n    showGrammarTooltip(mark);\n  }\n});\n\nasync function checkNotebookGrammar() {\n  var ta = document.querySelector('.note-page .notebook-editor textarea');\n  if (!ta || !ta.value.trim()) return;\n  var btn = document.getElementById('grammar-check-btn');\n  if (btn) btn.textContent = 'Checking\\u2026';\n\n  var text = ta.value;\n  try {\n    var res = await fetch('/api/grammar', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({ text: text })\n    });\n    if (!res.ok) {\n      var err = await res.json().catch(function() { return {}; });\n      throw new Error(err.error || 'Grammar check unavailable');\n    }\n    var data = await res.json();\n    var raw = data.matches || [];\n\n    var normalizedForMirror = raw.map(function(m) {\n      return { offset: m.offset, length: m.length, message: m.message || '', replacements: m.replacements || [] };\n    });\n    _grammarMirrorMatches = normalizedForMirror;\n    updateGrammarMirror(ta, normalizedForMirror);\n\n    // Also show the panel below\n    var matches = raw.map(function(m) {\n      return {\n        offset: m.offset,\n        length: m.length,\n        message: m.message || '',\n        context: { text: text, offset: m.offset, length: m.length },\n        replacements: (m.replacements || []).map(function(r) { return { value: r }; })\n      };\n    });\n    showGrammarResults(matches, ta);\n  } catch (err) {\n    alert('Grammar check failed: ' + err.message);\n  }\n  if (btn) btn.innerHTML = '<svg class=\"icon icon-sm\" aria-hidden=\"true\"><use href=\"#i-wand\"/></svg> Grammar';\n}\n\nfunction showGrammarResults(matches, textarea) {\n  // Remove any existing grammar panel\n  var existing = document.getElementById('grammar-results');\n  if (existing) existing.remove();\n\n  if (!matches.length) {\n    var hint = document.createElement('div');\n    hint.id = 'grammar-results';\n    hint.className = 'grammar-results';\n    hint.innerHTML = '<span style=\"color:var(--muted)\">No issues found.</span>';\n    textarea.parentElement.after(hint);\n    setTimeout(function() { hint.remove(); }, 3000);\n    return;\n  }\n\n  var panel = document.createElement('div');\n  panel.id = 'grammar-results';\n  panel.className = 'grammar-results';\n  var html = '<div class=\"grammar-header\"><span>' + matches.length + ' suggestion' + (matches.length !== 1 ? 's' : '') + '</span>'\n    + '<button onclick=\"this.parentElement.parentElement.remove()\" class=\"nb-suggest-dismiss\">&times;</button></div>';\n\n  for (var i = 0; i < Math.min(matches.length, 10); i++) {\n    var m = matches[i];\n    var context = m.context || {};\n    var before = escapeHtml((context.text || '').substring(Math.max(0, context.offset - 10), context.offset));\n    var errorText = escapeHtml((context.text || '').substring(context.offset, context.offset + context.length));\n    var after = escapeHtml((context.text || '').substring(context.offset + context.length, context.offset + context.length + 10));\n    var replacements = (m.replacements || []).slice(0, 3).map(function(r) { return escapeHtml(r.value); });\n\n    html += '<div class=\"grammar-item\">'\n      + '<div class=\"grammar-context\">' + before + '<span class=\"grammar-error\">' + errorText + '</span>' + after + '</div>'\n      + '<div class=\"grammar-message\">' + escapeHtml(m.message || '') + '</div>';\n    if (replacements.length) {\n      html += '<div class=\"grammar-fixes\">';\n      for (var j = 0; j < replacements.length; j++) {\n        html += '<button class=\"grammar-fix-btn\" onclick=\"applyGrammarFix(' + m.offset + ',' + m.length + ',\\'' + escapeJsStr(replacements[j]) + '\\')\">' + replacements[j] + '</button>';\n      }\n      html += '</div>';\n    }\n    html += '</div>';\n  }\n\n  panel.innerHTML = html;\n  textarea.parentElement.after(panel);\n}\n\nfunction applyGrammarFix(offset, length, replacement) {\n  var ta = document.querySelector('.note-page .notebook-editor textarea');\n  if (!ta || !_activeNotebook) return;\n  var text = ta.value;\n  ta.value = text.substring(0, offset) + replacement + text.substring(offset + length);\n  notebookDebounceSave();\n  // Remove grammar panel (results are stale after edit)\n  var panel = document.getElementById('grammar-results');\n  if (panel) panel.remove();\n  // Clear inline underlines (stale after edit), re-check after short delay\n  _grammarMirrorMatches = [];\n  updateGrammarMirror(ta, []);\n  clearTimeout(_grammarDebounceTimeout);\n  _grammarDebounceTimeout = setTimeout(function() { runInlineGrammar(ta); }, 500);\n}\n\nfunction openNotebookEditor(id) {\n  _notebookPreviewMode = false;\n  showNotebook(id);\n}\n\nfunction createNewNotebook() {\n  // Single-notebook model: just open the shared notebook\n  openSingleNotebook();\n}\n\nfunction toggleNotebookPreview() {\n  saveActiveNoteContent();\n  _notebookPreviewMode = !_notebookPreviewMode;\n  if (_activeNoteId) {\n    openNoteInPane(_activeNoteId);\n  }\n}\n\n// Concatenate all notes with --- separators for export\nfunction getAllNotesContent(nb) {\n  if (!nb.notes || !nb.notes.length) return '';\n  return nb.notes.map(function(n) { return n.content || ''; }).filter(function(c) { return c.trim(); }).join('\\n\\n---\\n\\n');\n}\n\nfunction exportNotebook() {\n  if (!_activeNotebook) return;\n  const nb = _activeNotebook;\n\n  // Build YAML frontmatter matching article format\n  let fm = '---\\n';\n  fm += 'title: \"' + (nb.title || 'Untitled').replace(/\"/g, '\\\\\"') + '\"\\n';\n  fm += 'type: notebook\\n';\n  if (nb.createdAt) fm += 'created: ' + nb.createdAt.slice(0, 10) + '\\n';\n  if (nb.updatedAt) fm += 'updated: ' + nb.updatedAt.slice(0, 10) + '\\n';\n  if (nb.tags && nb.tags.length) {\n    fm += 'tags:\\n';\n    for (const t of nb.tags) fm += '  - ' + t + '\\n';\n  }\n  if (nb.sources && nb.sources.length) {\n    fm += 'sources:\\n';\n    for (const s of nb.sources) {\n      const f = allFiles.find(function(f) { return f.filename === s; });\n      const title = f ? f.title : s;\n      fm += '  - \"' + title.replace(/\"/g, '\\\\\"') + '\"\\n';\n    }\n  }\n  fm += '---\\n\\n';\n\n  let md = fm;\n  if (nb.title) md += '# ' + nb.title + '\\n\\n';\n  md += getAllNotesContent(nb) + '\\n';\n\n  const blob = new Blob([md], { type: 'text/markdown;charset=utf-8' });\n  const url = URL.createObjectURL(blob);\n  const a = document.createElement('a');\n  a.href = url;\n  a.download = (nb.title || 'notebook').replace(/[^a-z0-9]+/gi, '-').toLowerCase() + '.md';\n  document.body.appendChild(a);\n  a.click();\n  document.body.removeChild(a);\n  URL.revokeObjectURL(url);\n}\n\nfunction toggleNotebookExportDropdown(e) {\n  e.stopPropagation();\n  var existing = document.querySelector('.nb-export-panel');\n  if (existing) { existing.remove(); return; }\n  var btn = e.currentTarget;\n  var panel = document.createElement('div');\n  panel.className = 'share-dropdown-panel nb-export-panel';\n  panel.onclick = function(ev) { ev.stopPropagation(); };\n  var items = '';\n  items += '<button onclick=\"exportNotebook();this.closest(\\'.nb-export-panel\\').remove()\">Export .md</button>';\n  items += '<button onclick=\"exportNotebookPdf();this.closest(\\'.nb-export-panel\\').remove()\">Export .pdf</button>';\n  panel.innerHTML = items;\n  btn.closest('.share-dropdown').appendChild(panel);\n  // Close when clicking elsewhere\n  setTimeout(function() {\n    document.addEventListener('click', function close() {\n      panel.remove();\n      document.removeEventListener('click', close);\n    }, { once: true });\n  }, 0);\n}\n\nfunction exportNotebookPdf() {\n  if (!_activeNotebook) return;\n  var nb = _activeNotebook;\n  // Render the notebook as a clean printable page and trigger print-to-PDF\n  var win = window.open('', '_blank');\n  if (!win) { alert('Please allow popups to export as PDF.'); return; }\n  var bodyHtml = sanitizeHtml(marked.parse(getAllNotesContent(nb) || ''));\n  var sources = (nb.sources || []);\n  var sourcesHtml = '';\n  if (sources.length) {\n    sourcesHtml = '<hr><p><strong>Sources:</strong></p><ul>';\n    for (var i = 0; i < sources.length; i++) {\n      var f = allFiles.find(function(ff) { return ff.filename === sources[i]; });\n      var title = f ? f.title : sources[i];\n      sourcesHtml += '<li>' + escapeHtml(title) + '</li>';\n    }\n    sourcesHtml += '</ul>';\n  }\n  var tags = (nb.tags || []);\n  var tagsHtml = tags.length ? '<p><strong>Tags:</strong> ' + tags.map(function(t) { return escapeHtml(t); }).join(', ') + '</p>' : '';\n  win.document.write('<!DOCTYPE html><html><head><meta charset=\"utf-8\"><title>' + escapeHtml(nb.title || 'Notebook') + '</title>'\n    + '<style>body{font-family:Georgia,serif;max-width:700px;margin:40px auto;padding:0 20px;line-height:1.7;color:#222}'\n    + 'h1{font-size:28px;margin-bottom:4px}h2,h3{margin-top:1.5em}'\n    + 'blockquote{border-left:3px solid #ccc;margin:1em 0;padding:0.5em 1em;color:#555}'\n    + 'code{background:#f5f5f5;padding:2px 4px;border-radius:3px;font-size:0.9em}'\n    + 'pre{background:#f5f5f5;padding:12px;border-radius:6px;overflow-x:auto}'\n    + '.meta{font-size:13px;color:#888;margin-bottom:24px}'\n    + '@media print{body{margin:0;max-width:none}}</style></head><body>'\n    + '<h1>' + escapeHtml(nb.title || 'Untitled') + '</h1>'\n    + '<div class=\"meta\">Notebook' + (nb.updatedAt ? ' &middot; Updated ' + new Date(nb.updatedAt).toLocaleDateString() : '') + '</div>'\n    + bodyHtml + sourcesHtml + tagsHtml\n    + '<script>window.onload=function(){window.print();}<\\/script>'\n    + '</body></html>');\n  win.document.close();\n}\n\nfunction showHighlightPicker() {\n  if (!_activeNotebook) return;\n\n  const overlay = document.createElement('div');\n  overlay.className = 'modal-overlay';\n  overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };\n\n  // Collect all highlights with article metadata, sorted recent-first\n  const entries = Object.entries(allHighlightsIndex).filter(function(e) { return e[1] && e[1].length > 0; });\n  var allHlItems = [];\n  for (var ei = 0; ei < entries.length; ei++) {\n    var filename = entries[ei][0];\n    var hls = entries[ei][1];\n    var f = allFiles.find(function(ff) { return ff.filename === filename; });\n    var title = f ? f.title : filename;\n    var dateStr = f && f.bookmarked ? f.bookmarked.slice(0, 10) : '';\n    for (var hi = 0; hi < hls.length; hi++) {\n      allHlItems.push({ filename: filename, title: title, date: dateStr, color: hls[hi].color || '', text: hls[hi].text });\n    }\n  }\n  // Sort by date descending (recent first)\n  allHlItems.sort(function(a, b) { return b.date.localeCompare(a.date); });\n\n  // Group by date then article\n  var dateGroups = {};\n  var dateOrder = [];\n  for (var di = 0; di < allHlItems.length; di++) {\n    var item = allHlItems[di];\n    var dk = item.date || 'Undated';\n    if (!dateGroups[dk]) { dateGroups[dk] = {}; dateOrder.push(dk); }\n    if (!dateGroups[dk][item.filename]) dateGroups[dk][item.filename] = { title: item.title, items: [] };\n    dateGroups[dk][item.filename].items.push(item);\n  }\n\n  var groupsHtml = '';\n  if (!allHlItems.length) {\n    groupsHtml = '<p style=\"color:var(--muted);text-align:center;padding:20px\">No highlights yet. Select text in an article and press <kbd>h</kbd> to highlight.</p>';\n  } else {\n    for (var gi = 0; gi < dateOrder.length; gi++) {\n      var dateKey = dateOrder[gi];\n      var articles = dateGroups[dateKey];\n      groupsHtml += '<div class=\"hl-picker-date-group\">';\n      groupsHtml += '<div class=\"hl-picker-date-header\" onclick=\"this.nextElementSibling.style.display=this.nextElementSibling.style.display===\\'none\\'?\\'block\\':\\'none\\';this.querySelector(\\'.hl-caret\\').classList.toggle(\\'collapsed\\')\">';\n      groupsHtml += '<span class=\"hl-caret\">&#9662;</span> ' + escapeHtml(dateKey);\n      groupsHtml += '</div>';\n      groupsHtml += '<div class=\"hl-picker-date-content\">';\n      var fns = Object.keys(articles);\n      for (var fi = 0; fi < fns.length; fi++) {\n        var art = articles[fns[fi]];\n        groupsHtml += '<div class=\"hl-picker-group\">';\n        groupsHtml += '<div class=\"hl-picker-group-title\">' + escapeHtml(art.title) + '</div>';\n        for (var ii = 0; ii < art.items.length; ii++) {\n          var hl = art.items[ii];\n          var colorDot = hl.color ? '<span class=\"hl-color-dot\" style=\"background:' + escapeHtml(hl.color) + '\"></span>' : '';\n          groupsHtml += '<div class=\"hl-picker-item\" data-filename=\"' + escapeHtml(hl.filename) + '\" data-text=\"' + escapeHtml(hl.text) + '\" onclick=\"this.classList.toggle(\\'selected\\')\">'\n            + colorDot\n            + '<span class=\"hl-picker-item-text\">' + escapeHtml(hl.text.slice(0, 200)) + '</span>'\n            + '</div>';\n        }\n        groupsHtml += '</div>';\n      }\n      groupsHtml += '</div></div>';\n    }\n  }\n\n  overlay.innerHTML = '<div class=\"modal-card\" onclick=\"event.stopPropagation()\" style=\"max-width:580px;max-height:80vh;display:flex;flex-direction:column\">'\n    + '<h2>Insert Highlights</h2>'\n    + '<p style=\"color:var(--muted);font-size:13px;margin-bottom:12px\">Select highlights to insert as blockquotes into your notebook.</p>'\n    + '<input type=\"text\" id=\"hl-picker-search\" placeholder=\"Search highlights...\" oninput=\"filterHighlightPicker(this.value)\" style=\"width:100%;padding:6px 10px;font-size:13px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--fg);margin-bottom:12px;font-family:inherit\">'\n    + '<div id=\"hl-picker-groups\" style=\"overflow-y:auto;flex:1\">' + groupsHtml + '</div>'\n    + '<div class=\"modal-actions\">'\n    + '<button class=\"btn-secondary\" onclick=\"this.closest(\\'.modal-overlay\\').remove()\">Cancel</button>'\n    + '<button class=\"btn-primary\" onclick=\"insertSelectedHighlights()\">Insert Selected</button>'\n    + '</div></div>';\n  document.body.appendChild(overlay);\n  overlay.querySelector('#hl-picker-search').focus();\n}\n\nfunction filterHighlightPicker(query) {\n  var q = query.toLowerCase();\n  var items = document.querySelectorAll('.hl-picker-item');\n  for (var i = 0; i < items.length; i++) {\n    var text = items[i].textContent.toLowerCase();\n    items[i].style.display = !q || text.includes(q) ? '' : 'none';\n  }\n  // Show/hide groups based on visible items\n  var groups = document.querySelectorAll('.hl-picker-group');\n  for (var g = 0; g < groups.length; g++) {\n    var visible = groups[g].querySelectorAll('.hl-picker-item:not([style*=\"display: none\"])');\n    groups[g].style.display = visible.length ? '' : 'none';\n  }\n  // Show/hide date groups\n  var dateGroups = document.querySelectorAll('.hl-picker-date-group');\n  for (var d = 0; d < dateGroups.length; d++) {\n    var visibleGroups = dateGroups[d].querySelectorAll('.hl-picker-group:not([style*=\"display: none\"])');\n    dateGroups[d].style.display = visibleGroups.length ? '' : 'none';\n  }\n}\n\nfunction insertSelectedHighlights() {\n  const overlay = document.querySelector('.modal-overlay');\n  if (!overlay) return;\n  const selected = overlay.querySelectorAll('.hl-picker-item.selected');\n  if (!selected.length) { overlay.remove(); return; }\n\n  let insertText = '';\n  const newSources = new Set(_activeNotebook.sources || []);\n  for (const item of selected) {\n    const text = item.dataset.text;\n    const filename = item.dataset.filename;\n    insertText += '\\n> ' + text + '\\n';\n    newSources.add(filename);\n  }\n\n  _activeNotebook.sources = Array.from(newSources);\n\n  const ta = document.querySelector('.note-page .notebook-editor textarea');\n  if (ta) {\n    const pos = ta.selectionStart;\n    const before = ta.value.slice(0, pos);\n    const after = ta.value.slice(pos);\n    ta.value = before + insertText + '\\n' + after;\n    autoGrowTextarea(ta);\n  }\n\n  overlay.remove();\n  notebookDebounceSave();\n}\n\nfunction startNotebookFromArticle() {\n  // Close share dropdown\n  const panel = document.querySelector('.share-dropdown-panel');\n  if (panel) panel.remove();\n\n  if (!activeFile) return;\n\n  const file = allFiles.find(f => f.filename === activeFile);\n  const title = file ? file.title : activeFile;\n\n  let snippet = '## Notes on: ' + title + '\\n\\n';\n  if (articleHighlights.length) {\n    for (const hl of articleHighlights) {\n      snippet += '> ' + hl.text + '\\n\\n';\n      if (hl.note) snippet += '*' + hl.note + '*\\n\\n';\n    }\n  }\n  if (articleNotes.articleNote) {\n    snippet += articleNotes.articleNote + '\\n\\n';\n  }\n\n  // Add as a new note in the shared notebook\n  getOrCreateSingleNotebook().then(function(nb) {\n    if (!nb.notes) nb.notes = [];\n    var now = new Date().toISOString();\n    var note = { id: generateNoteId(), content: snippet.trim(), sourceArticle: activeFile, createdAt: now, updatedAt: now };\n    nb.notes.unshift(note);\n    if (!nb.sources) nb.sources = [];\n    if (nb.sources.indexOf(activeFile) < 0) nb.sources.push(activeFile);\n    nb.updatedAt = now;\n    saveNotebook(nb).then(function() {\n      _activeNotebook = nb;\n      _notebookPreviewMode = false;\n      _sidebarView = 'notebooks';\n      syncSidebarTabs();\n      openNoteInPane(note.id);\n      renderFileList();\n    });\n  });\n}\n\n// Notebook tag handlers (uses shared handleTagInput from utils)\nfunction handleNotebookTagKey(e) {\n  if (!_activeNotebook) return;\n  handleTagInput(e,\n    function() { if (!_activeNotebook.tags) _activeNotebook.tags = []; return _activeNotebook.tags; },\n    function() { saveNotebook(_activeNotebook); if (_activeNoteId) openNoteInPane(_activeNoteId); }\n  );\n}\n\nfunction removeNotebookTag(tag) {\n  if (!_activeNotebook || !_activeNotebook.tags) return;\n  _activeNotebook.tags = _activeNotebook.tags.filter(function(t) { return t !== tag; });\n  saveNotebook(_activeNotebook);\n  if (_activeNoteId) openNoteInPane(_activeNoteId);\n}\n\n\n// ---- Tag Cloud / Explore ---- (renders as inline page like Guide)\nfunction showTagCloud() {\n  _sidebarView = 'home'; syncSidebarTabs();\n  const content = document.getElementById('content');\n  const empty = document.getElementById('empty-state');\n  empty.style.display = 'none';\n  content.style.display = 'block';\n\n  // Deselect sidebar — disables highlights/notes on this page\n  activeFile = null;\n  document.getElementById('margin-notes').innerHTML = '';\n  renderFileList();\n\n  // Collect all tags (user + machine), domain groupings, feed counts\n  const tagCounts = {};\n  const tagArticles = {};  // tag -> [articles]\n  const domainArticles = {};\n  const feedCounts = {};\n\n  for (const f of allFiles) {\n    if (f.domain && f.domain !== 'pullread') {\n      if (!domainArticles[f.domain]) domainArticles[f.domain] = [];\n      domainArticles[f.domain].push(f);\n    }\n    if (f.feed) {\n      feedCounts[f.feed] = (feedCounts[f.feed] || 0) + 1;\n    }\n    const notes = allNotesIndex[f.filename];\n    const allTags = [];\n    if (notes && notes.tags) allTags.push(...notes.tags);\n    if (notes && notes.machineTags) allTags.push(...notes.machineTags);\n    for (const tag of allTags) {\n      tagCounts[tag] = (tagCounts[tag] || 0) + 1;\n      if (!tagArticles[tag]) tagArticles[tag] = [];\n      tagArticles[tag].push(f);\n    }\n  }\n\n  const sortedDomains = Object.entries(domainArticles)\n    .sort((a, b) => b[1].length - a[1].length);\n  const sortedTags = Object.entries(tagCounts)\n    .sort((a, b) => b[1] - a[1]);\n\n  // Stats bar\n  const totalArticles = allFiles.length;\n  const totalHighlights = Object.values(allHighlightsIndex).reduce((s, h) => s + (h ? h.length : 0), 0);\n  const totalFavorites = Object.values(allNotesIndex).filter(n => n && n.isFavorite).length;\n  const totalSummaries = allFiles.filter(f => f.hasSummary).length;\n  const totalUnread = allFiles.filter(f => !readArticles.has(f.filename)).length;\n\n  let statsHtml = '<div class=\"explore-stats\">';\n  statsHtml += '<span><strong>' + totalArticles + '</strong> articles</span>';\n  statsHtml += '<span><strong>' + totalUnread + '</strong> unread</span>';\n  statsHtml += '<span><strong>' + totalHighlights + '</strong> highlights</span>';\n  statsHtml += '<span><strong>' + totalFavorites + '</strong> favorites</span>';\n  statsHtml += '<span><strong>' + totalSummaries + '</strong> summaries</span>';\n  statsHtml += '<span><strong>' + Object.keys(domainArticles).length + '</strong> sources</span>';\n  statsHtml += '</div>';\n\n  // --- Tab: Discover (quick filters + ontological connections) ---\n  const makeQf = function(label, query, variant) {\n    return '<button class=\"tag-pill' + (variant ? ' tag-pill-' + variant : '') + '\" onclick=\"document.getElementById(\\'search\\').value=\\'' + escapeJsStr(query) + '\\';filterFiles()\">' + escapeHtml(label) + '</button>';\n  };\n  let discoverHtml = '<div class=\"tag-cloud\">';\n  discoverHtml += makeQf('Favorites', 'is:favorite', 'pink');\n  discoverHtml += makeQf('Unread', 'is:unread', 'blue');\n  discoverHtml += makeQf('Has Summary', 'has:summary', 'green');\n  discoverHtml += makeQf('Has Highlights', 'has:highlights', 'amber');\n  discoverHtml += makeQf('Has Notes', 'has:notes', '');\n  discoverHtml += makeQf('Has Tags', 'has:tags', '');\n  const sortedFeeds = Object.entries(feedCounts).sort((a, b) => b[1] - a[1]).slice(0, 8);\n  for (const [feed] of sortedFeeds) {\n    discoverHtml += makeQf(escapeHtml(feed), 'feed:' + feed, '');\n  }\n  discoverHtml += '</div>';\n\n  // Auto-tag actions\n  const taggedCount = allFiles.filter(function(f) { const n = allNotesIndex[f.filename]; return n && ((n.tags && n.tags.length) || (n.machineTags && n.machineTags.length)); }).length;\n  const untaggedCount = totalArticles - taggedCount;\n  discoverHtml += '<h3 style=\"font-size:14px;font-weight:600;margin:24px 0 12px\">Auto-Tagging</h3>';\n  discoverHtml += '<p style=\"font-size:13px;color:var(--muted);margin:0 0 10px\">' + taggedCount + ' of ' + totalArticles + ' articles tagged. ';\n  if (untaggedCount > 0) discoverHtml += untaggedCount + ' remaining.';\n  else discoverHtml += 'All articles tagged!';\n  discoverHtml += '</p>';\n  discoverHtml += '<div style=\"display:flex;gap:8px;flex-wrap:wrap\">';\n  discoverHtml += '<button class=\"tag-pill\" id=\"batch-tag-btn\" onclick=\"batchAutotagAll(false)\" title=\"Tag untagged articles using AI\"><svg class=\"icon icon-sm\" aria-hidden=\"true\" style=\"vertical-align:-1px;margin-right:3px\"><use href=\"#i-wand\"/></svg> Tag Untagged</button>';\n  discoverHtml += '<button class=\"tag-pill\" onclick=\"batchAutotagAll(true)\" title=\"Re-tag all articles, replacing existing AI tags\"><svg class=\"icon icon-sm\" aria-hidden=\"true\" style=\"vertical-align:-1px;margin-right:3px\"><use href=\"#i-refresh\"/></svg> Retag All</button>';\n  discoverHtml += '</div>';\n\n  // Ontological connections: find tags shared by 2+ articles and show the clusters\n  const connectionsHtml = buildConnectionsHtml(tagArticles, sortedTags);\n  if (connectionsHtml) {\n    discoverHtml += '<h3 style=\"font-size:14px;font-weight:600;margin:24px 0 12px\">Connections</h3>';\n    discoverHtml += connectionsHtml;\n  }\n\n  // --- Tab: Most Viewed ---\n  const positions = JSON.parse(localStorage.getItem('pr-scroll-positions') || '{}');\n  const viewedArticles = allFiles\n    .filter(f => positions[f.filename] || readArticles.has(f.filename))\n    .sort((a, b) => {\n      const pctA = positions[a.filename]?.pct || 0;\n      const pctB = positions[b.filename]?.pct || 0;\n      const tsA = positions[a.filename]?.ts || 0;\n      const tsB = positions[b.filename]?.ts || 0;\n      if (Math.abs(pctB - pctA) > 0.1) return pctB - pctA;\n      return tsB - tsA;\n    })\n    .slice(0, 30);\n\n  let viewedHtml = '';\n  if (viewedArticles.length > 0) {\n    viewedArticles.forEach(function(f, i) {\n      const pct = positions[f.filename]?.pct;\n      const pctStr = pct ? Math.round(pct * 100) + '%' : 'Opened';\n      const domain = f.domain || '';\n      const favicon = domain ? '/favicons/' + encodeURIComponent(domain) + '.png' : '';\n      viewedHtml += '<div class=\"most-viewed-item\" onclick=\"jumpToArticle(\\'' + escapeJsStr(f.filename) + '\\')\">';\n      viewedHtml += '<div class=\"most-viewed-rank\">' + (i + 1) + '</div>';\n      viewedHtml += '<div class=\"most-viewed-info\">';\n      viewedHtml += '<div class=\"most-viewed-title\">' + escapeHtml(f.title) + '</div>';\n      viewedHtml += '<div class=\"most-viewed-meta\">';\n      if (favicon) viewedHtml += '<img src=\"' + escapeHtml(favicon) + '\" alt=\"\" loading=\"lazy\">';\n      if (domain) viewedHtml += '<span>' + escapeHtml(domain) + '</span>';\n      viewedHtml += '</div></div>';\n      viewedHtml += '<div class=\"most-viewed-pct\">' + pctStr + '</div>';\n      viewedHtml += '</div>';\n    });\n  } else {\n    viewedHtml = '<p style=\"color:var(--muted);font-size:13px;padding:12px 0\">No reading history yet. Articles you read will appear here.</p>';\n  }\n\n  // --- Tab: Tags ---\n  let tagsHtml = '';\n  if (sortedTags.length > 0) {\n    tagsHtml = '<div class=\"tag-cloud\">';\n    for (const [tag, count] of sortedTags) {\n      tagsHtml += '<button class=\"tag-pill\" onclick=\"document.getElementById(\\'search\\').value=\\'' + escapeJsStr(tag) + '\\';filterFiles()\">' + escapeHtml(tag) + '<span class=\"tag-count\">' + count + '</span></button>';\n    }\n    tagsHtml += '</div>';\n  } else {\n    tagsHtml = '<p style=\"color:var(--muted);font-size:13px;padding:12px 0\">No tags yet. Tag articles from the notes panel, or use auto-tagging to generate topic tags.</p>';\n  }\n\n  // --- Tab: Sources ---\n  let domainsHtml = '';\n  for (const [domain, articles] of sortedDomains.slice(0, 40)) {\n    domainsHtml += '<div class=\"domain-group\">';\n    domainsHtml += '<div class=\"domain-group-header\" onclick=\"this.nextElementSibling.style.display=this.nextElementSibling.style.display===\\'none\\'?\\'block\\':\\'none\\'\">';\n    domainsHtml += '<img class=\"file-item-favicon\" src=\"/favicons/' + encodeURIComponent(domain) + '.png\" alt=\"\" loading=\"lazy\" onerror=\"this.style.display=\\'none\\'\">';\n    domainsHtml += '<span>' + escapeHtml(domain) + '</span><span class=\"domain-group-count\">' + articles.length + ' article' + (articles.length !== 1 ? 's' : '') + '</span></div>';\n    domainsHtml += '<div class=\"domain-group-articles\" style=\"display:none\">';\n    for (const a of articles.slice(0, 10)) {\n      domainsHtml += '<a href=\"#\" onclick=\"event.preventDefault();jumpToArticle(\\'' + escapeJsStr(a.filename) + '\\')\">' + escapeHtml(a.title) + '</a>';\n    }\n    if (articles.length > 10) {\n      domainsHtml += '<a href=\"#\" onclick=\"event.preventDefault();document.getElementById(\\'search\\').value=\\'domain:' + escapeJsStr(domain) + '\\';filterFiles()\" style=\"color:var(--link)\">+ ' + (articles.length - 10) + ' more</a>';\n    }\n    domainsHtml += '</div></div>';\n  }\n\n  content.innerHTML =\n    '<div class=\"article-header\"><h1>Explore</h1></div>' +\n    statsHtml +\n    '<div class=\"explore-tabs\">' +\n      '<button class=\"explore-tab active\" data-tab=\"discover\">Discover</button>' +\n      '<button class=\"explore-tab\" data-tab=\"most-viewed\">Most Viewed</button>' +\n      '<button class=\"explore-tab\" data-tab=\"tags\">Tags</button>' +\n      '<button class=\"explore-tab\" data-tab=\"sources\">Sources</button>' +\n    '</div>' +\n    '<div id=\"explore-discover\" class=\"explore-tab-panel active\">' + discoverHtml + '</div>' +\n    '<div id=\"explore-most-viewed\" class=\"explore-tab-panel\">' + viewedHtml + '</div>' +\n    '<div id=\"explore-tags\" class=\"explore-tab-panel\">' + tagsHtml + '</div>' +\n    '<div id=\"explore-sources\" class=\"explore-tab-panel\">' + domainsHtml + '</div>';\n\n  // Wire up tab switching\n  content.querySelectorAll('.explore-tab').forEach(function(btn) {\n    btn.addEventListener('click', function() {\n      content.querySelectorAll('.explore-tab').forEach(function(b) { b.classList.remove('active'); });\n      content.querySelectorAll('.explore-tab-panel').forEach(function(p) { p.classList.remove('active'); });\n      btn.classList.add('active');\n      document.getElementById('explore-' + btn.dataset.tab).classList.add('active');\n    });\n  });\n\n  document.title = 'Explore Your Library';\n  document.getElementById('content-pane').scrollTop = 0;\n}\n\n// Build ontological connections: clusters of articles sharing the same tags\nfunction buildConnectionsHtml(tagArticles, sortedTags) {\n  // Pick tags with 2-8 articles (meaningful clusters, not too noisy)\n  const clusters = sortedTags\n    .filter(function(entry) { return entry[1] >= 2 && entry[1] <= 8; })\n    .slice(0, 12);\n  if (clusters.length === 0) return '';\n\n  let html = '';\n  for (const [tag, count] of clusters) {\n    const articles = tagArticles[tag].slice(0, 5);\n    html += '<div class=\"connection-group\">';\n    html += '<div class=\"connection-group-title\"><span class=\"conn-tag\">' + escapeHtml(tag) + '</span> <span style=\"font-size:11px;color:var(--muted);font-weight:400\">' + count + ' articles</span></div>';\n    html += '<div class=\"connection-group-articles\">';\n    for (const f of articles) {\n      const domain = f.domain || '';\n      const favicon = domain ? '/favicons/' + encodeURIComponent(domain) + '.png' : '';\n      html += '<div class=\"connection-article\" onclick=\"jumpToArticle(\\'' + escapeJsStr(f.filename) + '\\')\">';\n      if (favicon) html += '<img src=\"' + escapeHtml(favicon) + '\" alt=\"\" loading=\"lazy\">';\n      html += '<span style=\"overflow:hidden;text-overflow:ellipsis;white-space:nowrap\">' + escapeHtml(f.title) + '</span>';\n      if (domain) html += '<span class=\"conn-domain\">' + escapeHtml(domain) + '</span>';\n      html += '</div>';\n    }\n    if (tagArticles[tag].length > 5) {\n      html += '<div style=\"padding:4px 8px;font-size:11px\"><a href=\"#\" style=\"color:var(--link);text-decoration:none\" onclick=\"event.preventDefault();document.getElementById(\\'search\\').value=\\'' + escapeJsStr(tag) + '\\';filterFiles()\">View all ' + count + ' &rsaquo;</a></div>';\n    }\n    html += '</div><button class=\"dash-chevron right\" onclick=\"dashScrollRight(this)\" aria-label=\"Scroll right\">&#8250;</button></div></div>';\n  }\n  return html;\n}\n\nfunction jumpToArticle(filename) {\n  const idx = displayFiles.findIndex(f => f.filename === filename);\n  if (idx >= 0) {\n    loadFile(idx);\n  } else {\n    // File might be hidden - clear filters\n    document.getElementById('search').value = '';\n    hideRead = false;\n    document.getElementById('hide-read-toggle').classList.remove('active');\n    filterFiles();\n    const newIdx = displayFiles.findIndex(f => f.filename === filename);\n    if (newIdx >= 0) loadFile(newIdx);\n  }\n}\n\n\n// Shortcuts modal\nfunction showShortcutsModal() {\n  closeModal();\n  _modalReturnFocus = document.activeElement;\n  const overlay = document.createElement('div');\n  overlay.className = 'modal-overlay';\n  overlay.setAttribute('role', 'dialog');\n  overlay.setAttribute('aria-modal', 'true');\n  overlay.setAttribute('aria-label', 'Keyboard shortcuts');\n  overlay.onclick = function(e) { if (e.target === overlay) closeModal(); };\n  overlay.innerHTML = `\n    <div class=\"modal-card\" onclick=\"event.stopPropagation()\">\n      <h2>Keyboard Shortcuts</h2>\n      <div class=\"shortcuts-grid\">\n        <kbd>j</kbd> / <kbd>&rarr;</kbd> <span>Next article</span>\n        <kbd>k</kbd> / <kbd>&larr;</kbd> <span>Previous article</span>\n        <kbd>&uarr;</kbd> <kbd>&darr;</kbd> <span>Scroll (jumps articles at edges)</span>\n        <kbd>/</kbd> <span>Search articles</span>\n        <kbd>[</kbd> <span>Toggle sidebar</span>\n        <kbd>h</kbd> <span>Highlight selected text</span>\n        <kbd>n</kbd> <span>Toggle article notes</span>\n        <kbd>a</kbd> <span>Add article by URL</span>\n        <kbd>f</kbd> <span>Toggle focus mode</span>\n        <kbd>p</kbd> <span>Print article</span>\n        <kbd>Esc</kbd> <span>Clear search / close popover</span>\n      </div>\n      <h3 style=\"font-size:13px;margin:14px 0 6px;color:var(--muted)\">Audio Playback</h3>\n      <div class=\"shortcuts-grid\">\n        <kbd>Space</kbd> <span>Play / pause audio</span>\n        <kbd>&gt;</kbd> <span>Skip to next track</span>\n        <kbd>&lt;</kbd> <span>Skip to previous track</span>\n        <kbd>s</kbd> <span>Cycle playback speed</span>\n      </div>\n      <button class=\"modal-close\" onclick=\"closeModal()\">Done</button>\n    </div>\n  `;\n  document.body.appendChild(overlay);\n  trapFocus(overlay);\n  overlay.querySelector('.modal-close').focus();\n}\n\n// Guide — renders as an inline article in the content pane\nfunction showGuideModal() {\n  const content = document.getElementById('content');\n  const empty = document.getElementById('empty-state');\n  empty.style.display = 'none';\n  content.style.display = 'block';\n\n  // Deselect sidebar and clear overlays\n  activeFile = null;\n  document.getElementById('margin-notes').innerHTML = '';\n  renderFileList();\n\n  content.innerHTML = `\n    <div class=\"article-header\">\n      <h1>PullRead Guide</h1>\n      <div class=\"article-byline\"><span>Last updated ${new Date().toLocaleDateString(undefined, { month: 'short', year: 'numeric' })}</span></div>\n    </div>\n\n    <h2>What is PullRead?</h2>\n    <p>PullRead syncs your bookmarks and RSS feeds into clean markdown files you can read, search, highlight, and keep forever. Articles are stored locally on your Mac.</p>\n\n    <h2>Dashboard</h2>\n    <p>When you first open PullRead, the dashboard shows a personalized overview of your reading: articles you're in the middle of, recent reviews, favorites, and the latest additions. Click any card to jump straight to that article, or click the PullRead logo to return to the dashboard.</p>\n\n    <h2>How does syncing work?</h2>\n    <p>PullRead fetches new items from your configured feeds (Instapaper, Pinboard, Raindrop, RSS, etc.) and extracts the article content into markdown. You can sync manually from the menu bar, or set an automatic interval in Settings (every 30 min, 1 hour, 4 hours, or 12 hours).</p>\n\n    <h2>What are reviews?</h2>\n    <p>Reviews are AI-generated thematic summaries of your recent reading. You can schedule them daily or weekly in Settings. Daily reviews cover the past 24 hours; weekly reviews cover the past 7 days. They require a configured LLM provider (Anthropic, OpenAI, Gemini, OpenRouter, or Apple Intelligence).</p>\n\n    <h2>Search Operators</h2>\n    <p>The search bar supports powerful operators to narrow down your article list:</p>\n    <table>\n      <thead><tr><th>Operator</th><th>Description</th></tr></thead>\n      <tbody>\n        <tr><td><code>is:favorite</code></td><td>Favorited articles (also <code>is:fav</code>)</td></tr>\n        <tr><td><code>is:read</code> / <code>is:unread</code></td><td>Filter by read status</td></tr>\n        <tr><td><code>has:summary</code></td><td>Articles with AI summaries</td></tr>\n        <tr><td><code>has:highlights</code></td><td>Articles with highlights</td></tr>\n        <tr><td><code>has:notes</code></td><td>Articles with notes or annotations</td></tr>\n        <tr><td><code>has:tags</code></td><td>Articles with any tags</td></tr>\n        <tr><td><code>tag:value</code></td><td>Filter by a specific tag</td></tr>\n        <tr><td><code>feed:value</code></td><td>Filter by feed name</td></tr>\n        <tr><td><code>domain:value</code></td><td>Filter by source domain</td></tr>\n        <tr><td><code>author:value</code></td><td>Filter by author name</td></tr>\n      </tbody>\n    </table>\n    <p>Combine operators with spaces for AND logic (<code>is:fav tag:tech</code>), or use <code>OR</code> between groups (<code>tag:ai OR tag:ml</code>). Wrap multi-word searches in quotes (<code>\"machine learning\"</code>). Plain text searches title, domain, feed, and tags.</p>\n\n    <h2>Highlights &amp; Notes</h2>\n    <p>Select any text and press <strong>h</strong> to highlight it, or use the floating toolbar to choose a color. Click a highlight to add a note. Press <strong>n</strong> to open the notes panel for article-level notes, tags, and favorites.</p>\n\n    <h2>Voice Notes</h2>\n    <p>Click the microphone icon next to the notes textarea to dictate notes hands-free. Speech is transcribed in real-time using the Web Speech API and automatically saved to your article notes when you stop recording.</p>\n\n    <h2>Summaries</h2>\n    <p>Click the Summarize button on any article to generate an AI summary. Summaries display with badges showing which provider and model generated them (e.g., <span class=\"badge badge-amber\">Anthropic</span> <span class=\"badge badge-gray\">claude-haiku-4.5</span>). Summaries are saved in the article frontmatter so they persist across sessions. Supports Anthropic, OpenAI, Gemini, OpenRouter, and Apple Intelligence.</p>\n\n    <h2>Text-to-Speech</h2>\n    <p>Click the <strong>Listen</strong> button on any article to hear it read aloud. Queue multiple articles for continuous playback with speed control (0.5x&ndash;2x).</p>\n    <table>\n      <thead><tr><th>Provider</th><th>Cost</th><th>Notes</th></tr></thead>\n      <tbody>\n        <tr><td>Browser</td><td>Free</td><td>Built-in speech synthesis, works offline</td></tr>\n        <tr><td>Kokoro</td><td>Free</td><td>Local AI voice (~86MB model, auto-downloads)</td></tr>\n        <tr><td>OpenAI</td><td>~$0.15/article</td><td>Cloud API, bring your own key</td></tr>\n        <tr><td>ElevenLabs</td><td>~$1.20/article</td><td>Cloud API, bring your own key</td></tr>\n      </tbody>\n    </table>\n    <p>Configure in Voice Playback Settings (at the bottom of the audio player). Paid providers require a separate API key — never shared with your Summaries key. Audio is cached locally after first listen.</p>\n\n    <h2>Export &amp; Sharing</h2>\n    <p>Click the share icon on any article to send it to Bluesky, Threads, LinkedIn, email, or Messages. Use <strong>Export Markdown</strong> to download or copy the article as a .md file — choose which sections to include (summary, highlights, notes, tags).</p>\n\n    <h2>Notebook</h2>\n    <p>Write synthesis notes, reflections, or essays using the built-in Notebook. Click the <strong>Notebook</strong> tab in the sidebar to create and manage notebooks. Insert highlights from articles, tag notebooks, and use <strong>Focus Mode</strong> for a full-screen, distraction-free writing experience inspired by iA Writer. Export notebooks as .md files or open them directly in external editors like Obsidian or Bear.</p>\n\n    <h2>Focus Mode</h2>\n    <p>Press <strong>f</strong> or click the half-circle icon in the toolbar to enter Focus Mode. This dims all content except the paragraph you're currently reading, helping you concentrate on one section at a time.</p>\n\n    <h2>Reading Progress</h2>\n    <p>A thin progress bar at the top tracks how far you've read. Each article also shows estimated read time and word count in the header. Your reading position is automatically saved so you can pick up where you left off.</p>\n\n    <h2>Table of Contents</h2>\n    <p>On wide screens, articles with 3 or more headings show an auto-generated table of contents on the left. Click any heading to jump to that section. The active section is highlighted as you scroll.</p>\n\n    <h2>Themes &amp; Fonts</h2>\n    <p>Click the gear icon to switch between Light, Dark, Sepia, and High Contrast themes. Choose from fonts including Inter, Lora, Source Serif, Work Sans, and OpenDyslexic. Adjust text size, line height, letter spacing, and content width. Preferences are saved automatically.</p>\n\n    <h2>Machine Tags &amp; Explore</h2>\n    <p>PullRead can auto-generate topic, entity, and theme tags using your configured AI provider. Tags power relational mapping — discover connections between articles through the <strong>Explore</strong> page. Use the auto-tagging buttons on the Explore page's Discover tab, or enable auto-tagging after sync in the macOS app settings.</p>\n\n    <h2>Apple News &amp; Social Posts</h2>\n    <p>PullRead resolves Apple News links (apple.news) to their original article URLs. Social posts from X/Twitter, Bluesky, Mastodon, Reddit, and Hacker News are extracted with special handling to preserve the post structure.</p>\n\n    <h2>Browser Cookies</h2>\n    <p>Enable browser cookies in Settings to access paywalled content from sites like NYTimes or WSJ. PullRead supports <strong>Chrome, Arc, Brave, and Edge</strong>. Cookies stay on your Mac and are never uploaded.</p>\n\n    <h2>Importing Bookmarks</h2>\n    <p>Import bookmarks.html files exported from Chrome, Safari, Firefox, or Pocket directly from Settings or via the CLI with <code>pullread import &lt;file&gt;</code>.</p>\n\n    <h2>Keyboard Shortcuts</h2>\n    <table>\n      <thead><tr><th>Key</th><th>Action</th></tr></thead>\n      <tbody>\n        <tr><td><kbd>j</kbd> / <kbd>&rarr;</kbd></td><td>Next article</td></tr>\n        <tr><td><kbd>k</kbd> / <kbd>&larr;</kbd></td><td>Previous article</td></tr>\n        <tr><td><kbd>&uarr;</kbd> <kbd>&darr;</kbd></td><td>Scroll (jumps articles at edges)</td></tr>\n        <tr><td><kbd>/</kbd></td><td>Search articles</td></tr>\n        <tr><td><kbd>[</kbd></td><td>Toggle sidebar</td></tr>\n        <tr><td><kbd>h</kbd></td><td>Highlight selected text</td></tr>\n        <tr><td><kbd>n</kbd></td><td>Toggle article notes</td></tr>\n        <tr><td><kbd>f</kbd></td><td>Toggle focus mode</td></tr>\n        <tr><td><kbd>p</kbd></td><td>Print article</td></tr>\n        <tr><td><kbd>Esc</kbd></td><td>Clear search / close popover</td></tr>\n      </tbody>\n    </table>\n\n    <h3>Audio Playback (when player is visible)</h3>\n    <table>\n      <thead><tr><th>Key</th><th>Action</th></tr></thead>\n      <tbody>\n        <tr><td><kbd>Space</kbd></td><td>Play / pause audio</td></tr>\n        <tr><td><kbd>&gt;</kbd></td><td>Skip to next track</td></tr>\n        <tr><td><kbd>&lt;</kbd></td><td>Skip to previous track</td></tr>\n        <tr><td><kbd>s</kbd></td><td>Cycle playback speed</td></tr>\n      </tbody>\n    </table>\n\n    <h2>FAQ</h2>\n\n    <h3>Where are my articles stored?</h3>\n    <p>Articles are saved as markdown files in the output folder you configure in Settings (e.g., <code>~/Dropbox/Articles</code>). They're plain text files you can open in any editor. Highlights, notes, and settings are stored in <code>~/.config/pullread/</code>.</p>\n\n    <h3>Do I need an API key?</h3>\n    <p>Only for AI features (summaries, auto-tagging, reviews, and paid TTS). Reading, highlighting, searching, and browser TTS are all free with no API key. Apple Intelligence (macOS 26+) works without a key too.</p>\n\n    <h3>Is my data sent anywhere?</h3>\n    <p>Articles stay on your Mac. Data is only sent to an API when you explicitly use summaries, auto-tagging, or cloud TTS providers (OpenAI/ElevenLabs). Kokoro TTS and browser TTS are fully local. API keys are stored locally and never shared between features (your Summaries key is separate from your TTS key).</p>\n\n    <h3>Why can't PullRead extract some articles?</h3>\n    <p>Some sites use paywalls, bot detection, or JavaScript-only rendering that blocks extraction. Try enabling browser cookies in Settings to use your existing login sessions. You can also retry failed articles with <code>pullread sync --retry-failed</code>.</p>\n\n    <h3>How do I reset my reading history?</h3>\n    <p>Reading history is stored in your browser's localStorage. Clear it by opening developer tools (Cmd+Option+I), going to Application &rarr; Local Storage, and removing the <code>pr-read-articles</code> key.</p>\n\n    <h3>Can I use PullRead without the macOS app?</h3>\n    <p>Yes. The CLI works standalone on any platform with Node.js/Bun. Run <code>pullread view</code> to launch the article reader in your browser.</p>\n\n    <h3>Am I allowed to save articles?</h3>\n    <p>Pull Read is intended for personal reading and archival. You are responsible for ensuring your use complies with applicable copyright laws and the terms of service of any websites you access. Only sync content you are authorized to copy. Do not use Pull Read to redistribute or commercially exploit content you do not have rights to.</p>\n\n    <h3>What happens when I use AI summaries?</h3>\n    <p>When you click Summarize, article text is sent to your selected LLM provider (Anthropic, OpenAI, Gemini, or OpenRouter) using your own API key. Apple Intelligence processes entirely on-device. Summaries are saved locally in the article's frontmatter. The same applies to auto-tagging and weekly reviews.</p>\n\n    <h2>Open Source Licenses</h2>\n    <p>PullRead uses open-source software including <strong>Kokoro TTS</strong> (Apache 2.0, by hexgrad), <strong>ONNX Runtime</strong> (MIT, by Microsoft), <strong>Mozilla Readability</strong> (Apache 2.0), <strong>Turndown</strong> (MIT), <strong>marked</strong> (MIT), and <strong>highlight.js</strong> (BSD 3-Clause). Kokoro was trained on audio data including Koniwa (CC BY 3.0) and SIWIS (CC BY 4.0). Full license texts are included in the app bundle at <code>Contents/Resources/Licenses/</code>.</p>\n  `;\n  document.title = 'PullRead Guide';\n  document.getElementById('content-pane').scrollTop = 0;\n  generateToc();\n}\n\nfunction closeModal() {\n  const overlay = document.querySelector('.modal-overlay');\n  if (overlay) overlay.remove();\n  if (_modalReturnFocus) { _modalReturnFocus.focus(); _modalReturnFocus = null; }\n}\n\n\n// ---- Onboarding Wizard ----\nlet _obStep = 0;\nlet _obFeeds = {}; // { name: url }\nlet _obOutputPath = '~/Documents/PullRead';\nlet _obCookies = false;\nlet _obFeedLoading = false;\nconst OB_TOTAL_STEPS = 5;\n\nfunction dismissOnboarding() {\n  document.getElementById('onboarding').style.display = 'none';\n  localStorage.setItem('pr-onboarded', '1');\n}\n\nasync function showOnboardingIfNeeded() {\n  if (localStorage.getItem('pr-onboarded')) return;\n  // Check if already configured\n  try {\n    var r = await fetch('/api/config');\n    var cfg = await r.json();\n    if (cfg.configured) {\n      localStorage.setItem('pr-onboarded', '1');\n      return;\n    }\n    if (cfg.outputPath) _obOutputPath = cfg.outputPath;\n    if (cfg.feeds) _obFeeds = cfg.feeds;\n    if (cfg.useBrowserCookies) _obCookies = cfg.useBrowserCookies;\n  } catch (e) {}\n  _obStep = 0;\n  document.getElementById('onboarding').style.display = 'flex';\n  renderOnboardingStep();\n}\n\nfunction renderOnboardingStep() {\n  var card = document.getElementById('onboarding-card');\n  var progress = '<div class=\"ob-progress\">';\n  for (var i = 0; i < OB_TOTAL_STEPS; i++) {\n    progress += '<div class=\"ob-progress-bar' + (i <= _obStep ? ' active' : '') + '\"></div>';\n  }\n  progress += '</div>';\n\n  var html = progress;\n\n  if (_obStep === 0) {\n    html += '<div style=\"text-align:center;padding:12px 0\">'\n      + '<div style=\"font-size:48px;margin-bottom:12px\">&#128218;</div>'\n      + '<h2>Welcome to PullRead</h2>'\n      + '<p class=\"ob-subtitle\">Install our bookmarking shortcut or use PullRead with your favorite service. Articles are saved as clean, local markdown you can read anywhere.</p>'\n      + '<div class=\"ob-features\">'\n      + '<span class=\"ob-feature-pill\">&#128278; Bookmark sync</span>'\n      + '<span class=\"ob-feature-pill\">&#128196; Markdown files</span>'\n      + '<span class=\"ob-feature-pill\">&#10024; AI summaries</span>'\n      + '<span class=\"ob-feature-pill\">&#128228; Share Extension</span>'\n      + '</div>'\n      + '</div>';\n  } else if (_obStep === 1) {\n    html += '<h2>Choose Output Folder</h2>'\n      + '<p class=\"ob-subtitle\">Synced articles are saved as markdown here. A cloud-synced folder like Dropbox or iCloud works great.</p>'\n      + '<div class=\"ob-glass-card\">'\n      + '<label>Output path</label>'\n      + '<div style=\"display:flex;gap:8px;align-items:center\">'\n      + '<input type=\"text\" id=\"ob-output-path\" value=\"' + escapeHtml(_obOutputPath) + '\" placeholder=\"~/Documents/PullRead\" style=\"flex:1\">'\n      + '<button onclick=\"pickOutputFolder(\\'ob-output-path\\')\" style=\"white-space:nowrap;padding:7px 14px;border:1px solid var(--border);border-radius:6px;background:var(--bg);color:var(--fg);font-size:13px;cursor:pointer;font-family:inherit\">Choose\\u2026</button>'\n      + '</div>'\n      + '<div style=\"font-size:11px;color:var(--muted);margin-top:6px\">Default: ~/Documents/PullRead</div>'\n      + '</div>';\n  } else if (_obStep === 2) {\n    var feedNames = Object.keys(_obFeeds);\n    html += '<h2>Connect Your Bookmarks</h2>'\n      + '<p class=\"ob-subtitle\">Paste the RSS feed URL from your bookmark service. PullRead syncs your saved articles and converts them to markdown.</p>'\n      + '<div class=\"ob-glass-card\">';\n    if (feedNames.length > 0) {\n      html += '<ul class=\"ob-feed-list\">';\n      for (var fi = 0; fi < feedNames.length; fi++) {\n        var fn = feedNames[fi];\n        html += '<li><div><div class=\"ob-feed-name\">' + escapeHtml(fn) + '</div><div class=\"ob-feed-url\">' + escapeHtml(_obFeeds[fn]) + '</div></div>'\n          + '<button onclick=\"obRemoveFeed(\\'' + escapeHtml(fn.replace(/'/g, \"\\\\'\")) + '\\')\" title=\"Remove\">&times;</button></li>';\n      }\n      html += '</ul>';\n    }\n    html += '<div class=\"ob-feed-add\">'\n      + '<input type=\"text\" id=\"ob-feed-url\" placeholder=\"Paste bookmark feed URL or web address\\u2026\" onkeydown=\"if(event.key===\\'Enter\\')obAddFeed()\">'\n      + '<button onclick=\"obAddFeed()\" id=\"ob-add-btn\"' + (_obFeedLoading ? ' disabled' : '') + '>' + (_obFeedLoading ? 'Finding feed\\u2026' : 'Add') + '</button>'\n      + '</div>'\n      + '</div>'\n      + '<div class=\"ob-hint-list\">'\n      + '<div style=\"margin-bottom:8px;color:var(--fg);font-size:12px;font-weight:500\">Where to find your feed URL:</div>'\n      + '<div><strong>Instapaper</strong> Settings &rarr; Export &rarr; RSS Feed URL</div>'\n      + '<div><strong>Pinboard</strong> pinboard.in/feeds/u:USERNAME/</div>'\n      + '<div><strong>Raindrop</strong> Collection &rarr; Share &rarr; RSS Feed</div>'\n      + '<div><strong>Pocket</strong> getpocket.com/users/USERNAME/feed/all</div>'\n      + '</div>'\n      + '<div style=\"margin-top:14px;padding-top:12px;border-top:1px solid var(--border)\">'\n      + '<div class=\"ob-hint-list\">'\n      + '<div style=\"margin-bottom:6px;color:var(--fg);font-size:12px;font-weight:500\">You can also subscribe to newsletters and blogs:</div>'\n      + '<div><strong>Substack</strong> Paste the newsletter URL, e.g. example.substack.com</div>'\n      + '<div><strong>Ghost</strong> Paste the publication URL</div>'\n      + '<div><strong>Buttondown</strong> Paste the newsletter URL</div>'\n      + '<div><strong>WordPress</strong> Paste any blog URL \\u2014 PullRead finds the feed</div>'\n      + '</div>'\n      + '</div>'\n      + '<div style=\"display:flex;gap:8px;align-items:flex-start;margin-top:12px;padding:10px 12px;background:color-mix(in srgb, var(--fg) 4%, transparent);border-radius:8px;font-size:12px;color:var(--muted)\">'\n      + '<span style=\"flex-shrink:0;font-size:14px\">&#128196;</span>'\n      + '<span>Each new post from a feed is saved as a separate file. Bookmark services only sync articles you save; newsletters sync every post.</span>'\n      + '</div>';\n  } else if (_obStep === 3) {\n    html += '<h2>More Ways to Save</h2>'\n      + '<p class=\"ob-subtitle\">Beyond bookmark sync, there are other ways to get articles into PullRead.</p>'\n      + '<div class=\"ob-glass-card\">'\n      + '<div class=\"ob-method\"><div class=\"ob-method-icon\">&#128278;</div><div><div class=\"ob-method-title\">Bookmark Sync</div><div class=\"ob-method-desc\">Your primary source. Bookmarks from Instapaper, Pinboard, Raindrop, and Pocket sync automatically on a schedule.</div></div></div>'\n      + '<div class=\"ob-method\"><div class=\"ob-method-icon\">&#128228;</div><div><div class=\"ob-method-title\">Share Extension</div><div class=\"ob-method-desc\">In Safari or any app, tap Share &rarr; Save to PullRead. The article is fetched on next sync.</div></div></div>'\n      + '<div class=\"ob-method\"><div class=\"ob-method-icon\">&#128433;</div><div><div class=\"ob-method-title\">Services Menu</div><div class=\"ob-method-desc\">Select any URL, then right-click &rarr; Services &rarr; Save to PullRead.</div></div></div>'\n      + '<div class=\"ob-method\"><div class=\"ob-method-icon\">&#128225;</div><div><div class=\"ob-method-title\">Newsletters &amp; Blogs</div><div class=\"ob-method-desc\">Subscribe to any RSS feed \\u2014 Substack, Ghost, Buttondown, WordPress, and more.</div></div></div>'\n      + '</div>'\n      + '<div class=\"ob-glass-card\">'\n      + '<div class=\"ob-toggle-row\">'\n      + '<label><strong>Use Chrome Cookies</strong><div class=\"ob-toggle-desc\">Access paywalled sites using your Chrome login. Cookies stay local.</div></label>'\n      + '<input type=\"checkbox\" id=\"ob-cookies\"' + (_obCookies ? ' checked' : '') + ' onchange=\"_obCookies=this.checked\">'\n      + '</div>'\n      + '</div>';\n  } else if (_obStep === 4) {\n    html += '<div style=\"text-align:center;padding:12px 0\">'\n      + '<div style=\"font-size:48px;margin-bottom:12px\">&#128640;</div>'\n      + '<h2>Ready to Go</h2>'\n      + '<p class=\"ob-subtitle\">PullRead will fetch your bookmarked articles and save them as markdown. Sync anytime from the menu bar. Here are some keyboard shortcuts to get started:</p>'\n      + '</div>'\n      + '<div class=\"ob-shortcuts\">'\n      + '<kbd>j</kbd> / <kbd>&rarr;</kbd> <span>Next article</span>'\n      + '<kbd>k</kbd> / <kbd>&larr;</kbd> <span>Previous article</span>'\n      + '<kbd>/</kbd> <span>Search articles</span>'\n      + '<kbd>[</kbd> <span>Toggle sidebar</span>'\n      + '<kbd>h</kbd> <span>Highlight selected text</span>'\n      + '<kbd>n</kbd> <span>Toggle article notes</span>'\n      + '<kbd>f</kbd> <span>Toggle focus mode</span>'\n      + '<kbd>Space</kbd> <span>Play / pause audio</span>'\n      + '</div>';\n  }\n\n  // Navigation\n  html += '<div class=\"ob-nav\">';\n  if (_obStep > 0) {\n    html += '<button onclick=\"obBack()\">Back</button>';\n  } else {\n    html += '<span></span>';\n  }\n  if (_obStep < OB_TOTAL_STEPS - 1) {\n    html += '<button class=\"ob-primary\" onclick=\"obNext()\">Next</button>';\n  } else {\n    html += '<button class=\"ob-primary\" onclick=\"obFinish()\">Get Started</button>';\n  }\n  html += '</div>';\n\n  card.innerHTML = html;\n}\n\nfunction obBack() {\n  if (_obStep > 0) { _obStep--; renderOnboardingStep(); }\n}\n\nfunction obNext() {\n  // Validate output path on step 1\n  if (_obStep === 1) {\n    var pathInput = document.getElementById('ob-output-path');\n    if (pathInput) _obOutputPath = pathInput.value.trim();\n    if (!_obOutputPath) { pathInput.focus(); return; }\n  }\n  if (_obStep < OB_TOTAL_STEPS - 1) { _obStep++; renderOnboardingStep(); }\n}\n\nasync function obAddFeed() {\n  var input = document.getElementById('ob-feed-url');\n  var url = (input.value || '').trim();\n  if (!url) return;\n  if (!url.startsWith('http://') && !url.startsWith('https://')) url = 'https://' + url;\n  _obFeedLoading = true;\n  renderOnboardingStep();\n  try {\n    var r = await fetch('/api/feed-discover?url=' + encodeURIComponent(url));\n    var result = await r.json();\n    var feedUrl = result.feedUrl || url;\n    var title = result.title || feedUrl.replace(/^https?:\\/\\/(www\\.)?/, '').split('/')[0];\n    _obFeeds[title] = feedUrl;\n  } catch (e) {\n    _obFeeds[url] = url;\n  }\n  _obFeedLoading = false;\n  renderOnboardingStep();\n}\n\nfunction obRemoveFeed(name) {\n  delete _obFeeds[name];\n  renderOnboardingStep();\n}\n\nasync function obFinish() {\n  // Save config via API\n  try {\n    await fetch('/api/config', {\n      method: 'POST',\n      headers: { 'Content-Type': 'application/json' },\n      body: JSON.stringify({\n        outputPath: _obOutputPath,\n        feeds: _obFeeds,\n        useBrowserCookies: _obCookies\n      })\n    });\n  } catch (e) {\n    console.error('Failed to save onboarding config:', e);\n  }\n  dismissOnboarding();\n  // Refresh article list after config is saved\n  setTimeout(function() { refreshArticleList(); }, 500);\n}\n\n\n// Keyboard navigation\ndocument.addEventListener('keydown', e => {\n  // \"/\" focuses search\n  if (e.key === '/' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {\n    e.preventDefault();\n    const sidebar = document.getElementById('sidebar');\n    if (sidebar.classList.contains('collapsed')) toggleSidebar();\n    document.getElementById('search').focus();\n    return;\n  }\n\n  // \"[\" toggles sidebar\n  if (e.key === '[' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {\n    e.preventDefault();\n    toggleSidebar();\n    return;\n  }\n\n  // Escape clears search or dismisses popovers\n  if (e.key === 'Escape') {\n    // Close modal overlays (shortcuts, guide)\n    const modal = document.querySelector('.modal-overlay');\n    if (modal) { modal.remove(); return; }\n    // Close settings dropdown\n    const dropdown = document.querySelector('.settings-dropdown-panel');\n    if (dropdown) { dropdown.remove(); return; }\n    // Close quick-add row\n    const qaRow = document.getElementById('quick-add-row');\n    if (qaRow && qaRow.style.display !== 'none') { qaRow.style.display = 'none'; return; }\n    // Close highlight toolbar / annotation popover\n    if (hlToolbarEl || document.querySelector('.annotation-popover')) {\n      removeHlToolbar();\n      return;\n    }\n    // Clear and blur search\n    const search = document.getElementById('search');\n    if (document.activeElement === search) {\n      search.value = '';\n      filterFiles();\n      search.blur();\n      return;\n    }\n    // Blur any focused textarea/input\n    if (document.activeElement.tagName === 'TEXTAREA' || document.activeElement.tagName === 'INPUT') {\n      document.activeElement.blur();\n      return;\n    }\n  }\n\n  // h to highlight selection (yellow) — not on Guide/Explore pages\n  if (e.key === 'h' && activeFile && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {\n    const sel = window.getSelection();\n    if (sel && !sel.isCollapsed && sel.toString().trim()) {\n      e.preventDefault();\n      createHighlight('yellow');\n      return;\n    }\n  }\n\n  // a to quick-add URL\n  if (e.key === 'a' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {\n    e.preventDefault();\n    toggleQuickAdd();\n    return;\n  }\n\n  // f to toggle focus mode\n  if (e.key === 'f' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {\n    e.preventDefault();\n    toggleFocusMode();\n    return;\n  }\n\n  // p to print article\n  if (e.key === 'p' && !e.ctrlKey && !e.metaKey && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {\n    if (activeFile) {\n      e.preventDefault();\n      window.print();\n      return;\n    }\n  }\n\n  // n to scroll to annotations panel — not on Guide/Explore pages\n  if (e.key === 'n' && activeFile && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {\n    e.preventDefault();\n    toggleNotesFromHeader();\n    return;\n  }\n\n  // m to toggle mini mode (when audio is playing/queued)\n  if (e.key === 'm' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {\n    var hasAudio = ttsQueue.length > 0 || miniMode;\n    if (hasAudio) {\n      e.preventDefault();\n      toggleMiniMode();\n      return;\n    }\n  }\n\n  // j/k navigate file list (next/prev)\n  if ((e.key === 'j' || e.key === 'k') && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {\n    e.preventDefault();\n    navigateArticle(e.key === 'j' ? 1 : -1);\n    return;\n  }\n\n  // Left/Right arrow navigate prev/next article\n  if ((e.key === 'ArrowLeft' || e.key === 'ArrowRight') && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {\n    e.preventDefault();\n    navigateArticle(e.key === 'ArrowRight' ? 1 : -1);\n    return;\n  }\n\n  // Up/Down scroll the content pane; navigate articles at boundaries\n  if ((e.key === 'ArrowUp' || e.key === 'ArrowDown') && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {\n    const pane = document.getElementById('content-pane');\n    const scrollAmount = 80;\n    const atTop = pane.scrollTop <= 0;\n    const atBottom = pane.scrollTop + pane.clientHeight >= pane.scrollHeight - 2;\n\n    if (e.key === 'ArrowDown' && atBottom) {\n      e.preventDefault();\n      navigateArticle(1);\n    } else if (e.key === 'ArrowUp' && atTop) {\n      e.preventDefault();\n      navigateArticle(-1);\n    } else if (e.key === 'ArrowDown') {\n      pane.scrollTop += scrollAmount;\n    } else {\n      pane.scrollTop -= scrollAmount;\n    }\n    return;\n  }\n\n  // Enter loads current selection (when not in search)\n  if (e.key === 'Enter' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {\n    const currentIdx = displayFiles.findIndex(f => f.filename === activeFile);\n    if (currentIdx >= 0) loadFile(currentIdx);\n  }\n\n  // Audio playback shortcuts (when queue has items)\n  const audioPanel = document.getElementById('audio-player');\n  const audioVisible = ttsQueue && ttsQueue.length > 0;\n  if (audioVisible && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {\n    // Space = play/pause\n    if (e.key === ' ' && !e.ctrlKey && !e.metaKey) {\n      e.preventDefault();\n      ttsTogglePlay();\n      return;\n    }\n    // Shift+. (>) = skip next\n    if (e.key === '>' || (e.key === '.' && e.shiftKey)) {\n      e.preventDefault();\n      ttsSkipNext();\n      return;\n    }\n    // Shift+, (<) = skip prev\n    if (e.key === '<' || (e.key === ',' && e.shiftKey)) {\n      e.preventDefault();\n      ttsSkipPrev();\n      return;\n    }\n    // s to cycle playback speed\n    if (e.key === 's') {\n      e.preventDefault();\n      ttsCycleSpeed();\n      return;\n    }\n  }\n});\n\n\n// ABOUTME: Application initialization, article list refresh, and one-time data migrations.\n// ABOUTME: Handles sync status, auto-refresh polling, and restoring user preferences on load.\n\n// ---- Sync Status ----\nasync function loadSyncStatus() {\n  if (!serverMode) return;\n  try {\n    const res = await fetch('/api/sync-status');\n    if (!res.ok) return;\n    const data = await res.json();\n    const countEl = document.getElementById('file-count-text');\n    if (countEl && data.intervalMinutes) {\n      const nextSync = data.intervalMinutes + ' min';\n      countEl.title = 'Sync every ' + nextSync;\n    }\n  } catch {}\n}\n\n// ---- One-Time Migration: frontmatter annotations to JSON ----\nasync function migrateAnnotationsIfNeeded() {\n  if (!serverMode) return;\n  if (localStorage.getItem('pr-migration-v2-done')) return;\n\n  // Check each article's frontmatter for old-style annotation field\n  let migrated = 0;\n  for (const file of allFiles) {\n    try {\n      const res = await fetch('/api/file?name=' + encodeURIComponent(file.filename));\n      if (!res.ok) continue;\n      const text = await res.text();\n      const match = text.match(/^---\\n([\\s\\S]*?)\\n---/);\n      if (!match) continue;\n\n      const frontmatter = match[1];\n      const annotationMatch = frontmatter.match(/^annotation:\\s*\"?(.*?)\"?\\s*$/m);\n      if (!annotationMatch || !annotationMatch[1]) continue;\n\n      // Skip podcast/YouTube articles — their annotation field is the feed description\n      const hasEnclosure = frontmatter.match(/^enclosure_url:/m);\n      const domain = (frontmatter.match(/^domain:\\s*(.*)$/m) || [])[1] || '';\n      const isMediaArticle = hasEnclosure || domain.includes('youtube') || domain.includes('youtu.be');\n      if (isMediaArticle) continue;\n\n      // Found old-style annotation - migrate to JSON notes\n      const existingNotes = allNotesIndex[file.filename] || {};\n      if (existingNotes.articleNote) continue; // Already has notes, skip\n\n      await fetch('/api/notes', {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({\n          name: file.filename,\n          articleNote: annotationMatch[1],\n          annotations: existingNotes.annotations || [],\n          tags: existingNotes.tags || [],\n          isFavorite: existingNotes.isFavorite || false\n        })\n      });\n      migrated++;\n    } catch { continue; }\n  }\n\n  // Cleanup pass: clear articleNote that duplicates the article body (already-migrated media articles)\n  let cleaned = 0;\n  for (const file of allFiles) {\n    try {\n      const notes = allNotesIndex[file.filename];\n      if (!notes || !notes.articleNote) continue;\n      const res = await fetch('/api/file?name=' + encodeURIComponent(file.filename));\n      if (!res.ok) continue;\n      const text = await res.text();\n      const bodyStart = text.indexOf('---', text.indexOf('---') + 3);\n      if (bodyStart < 0) continue;\n      const body = text.slice(bodyStart + 3).trim();\n      const bodyPrefix = body.slice(0, 200).trim();\n      const notePrefix = notes.articleNote.slice(0, 200).trim();\n      if (notePrefix && bodyPrefix.startsWith(notePrefix)) {\n        await fetch('/api/notes', {\n          method: 'POST',\n          headers: { 'Content-Type': 'application/json' },\n          body: JSON.stringify({\n            name: file.filename,\n            articleNote: '',\n            annotations: notes.annotations || [],\n            tags: notes.tags || [],\n            isFavorite: notes.isFavorite || false\n          })\n        });\n        cleaned++;\n      }\n    } catch { continue; }\n  }\n\n  localStorage.setItem('pr-migration-v2-done', '1');\n  if (migrated > 0 || cleaned > 0) {\n    console.log('Migration: ' + migrated + ' migrated, ' + cleaned + ' duplicates cleaned');\n    await loadAnnotationsIndex(); // Refresh\n    renderFileList();\n  }\n}\n\n// Refresh article list from server\nasync function refreshArticleList(silent) {\n  if (!serverMode) return;\n  const btn = document.getElementById('refresh-btn');\n  if (!silent) btn.classList.add('spinning');\n  try {\n    const res = await fetch('/api/files');\n    if (res.ok) {\n      const prevCount = allFiles.length;\n      const prevFilenames = new Set(allFiles.map(f => f.filename));\n      allFiles = await res.json();\n      filteredFiles = allFiles;\n      await Promise.all([loadAnnotationsIndex(), loadNotebooks()]);\n      filterFiles();\n      // Highlight new articles with a fade-in effect\n      if (silent && allFiles.length > prevCount) {\n        requestAnimationFrame(() => {\n          document.querySelectorAll('.file-item').forEach(el => {\n            const fn = el.getAttribute('data-filename');\n            if (fn && !prevFilenames.has(fn)) {\n              el.classList.add('file-item-new');\n              setTimeout(() => el.classList.remove('file-item-new'), 3000);\n            }\n          });\n        });\n      }\n      // Reload current article if still in list, or refresh dashboard\n      if (activeFile) {\n        const idx = displayFiles.findIndex(f => f.filename === activeFile);\n        if (idx >= 0 && !silent) loadFile(idx);\n      } else if (!silent) {\n        renderDashboard();\n      }\n    }\n  } catch {}\n  if (!silent) btn.classList.remove('spinning');\n}\n\n// Auto-refresh: poll lightweight /api/files-changed every 5s, full refresh only when files change\nlet _autoRefreshTimer = null;\nlet _lastKnownChangeAt = 0;\nfunction startAutoRefresh() {\n  if (_autoRefreshTimer) return;\n  _autoRefreshTimer = setInterval(async () => {\n    try {\n      const res = await fetch('/api/files-changed');\n      if (!res.ok) return;\n      const data = await res.json();\n      if (data.changedAt > _lastKnownChangeAt) {\n        _lastKnownChangeAt = data.changedAt;\n        refreshArticleList(true);\n      }\n    } catch {}\n  }, 5000);\n}\nfunction stopAutoRefresh() {\n  if (_autoRefreshTimer) { clearInterval(_autoRefreshTimer); _autoRefreshTimer = null; }\n}\n\n// Init: try to load from server, fall back to standalone mode\nasync function init() {\n  // Restore preferences\n  const savedTheme = localStorage.getItem('pr-theme');\n  const savedFont = localStorage.getItem('pr-font');\n  const savedSize = localStorage.getItem('pr-size');\n  const savedSidebar = localStorage.getItem('pr-sidebar');\n  const savedLeading = localStorage.getItem('pr-leading');\n  const savedSpacing = localStorage.getItem('pr-spacing');\n  const savedWidth = localStorage.getItem('pr-width');\n\n  // Auto-detect OS dark mode on first visit\n  if (savedTheme) {\n    setTheme(savedTheme);\n  } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {\n    setTheme('dark');\n  }\n  if (savedFont) {\n    setFont(savedFont);\n  }\n  if (savedSize) setSize(savedSize);\n  if (savedLeading && savedLeading !== 'default') setLineHeight(savedLeading);\n  if (savedSpacing && savedSpacing !== 'default') setSpacing(savedSpacing);\n  if (savedWidth && savedWidth !== 'default') setWidth(savedWidth);\n  if (savedSidebar === '0' || window.innerWidth <= 768) {\n    document.getElementById('sidebar').classList.add('collapsed');\n    document.getElementById('sidebar-toggle-btn').setAttribute('aria-expanded', 'false');\n  }\n\n  // Restore mini mode\n  if (localStorage.getItem('pr-mini-mode') === '1') {\n    miniMode = true;\n    document.body.classList.add('mini-mode');\n    var miniContainer = document.getElementById('mini-mode-container');\n    if (miniContainer) miniContainer.style.display = '';\n    startMiniModeSync();\n  }\n\n  // Restore focus mode\n  if (localStorage.getItem('pr-focus') === '1') {\n    focusModeActive = true;\n    document.body.classList.add('focus-mode');\n    document.getElementById('focus-btn').classList.add('active');\n  }\n\n  // Restore hide-read\n  hideRead = localStorage.getItem('pr-hide-read') === '1';\n  document.getElementById('hide-read-toggle').classList.toggle('active', hideRead);\n\n  try {\n    const res = await fetch('/api/files');\n    if (res.ok) {\n      allFiles = await res.json();\n      serverMode = true;\n      filteredFiles = allFiles;\n\n      // Load annotations index, LLM config, and notebooks\n      await Promise.all([loadAnnotationsIndex(), checkLLMConfig(), loadNotebooks()]);\n\n      renderFileList();\n\n      // Run one-time migration and load sync status in background\n      migrateAnnotationsIfNeeded();\n      loadSyncStatus();\n\n      // Preload Kokoro TTS model if it's the selected provider\n      fetch('/api/tts-settings').then(function(r) { return r.ok ? r.json() : null; }).then(function(cfg) {\n        if (!cfg) return;\n        ttsProvider = cfg.provider || 'browser';\n        if (cfg.provider === 'kokoro') {\n          fetch('/api/kokoro-preload', { method: 'POST' }).catch(function() {});\n        }\n      }).catch(function() {});\n\n      // Show dashboard instead of auto-loading first article\n      renderDashboard();\n      showOnboardingIfNeeded();\n      // Seed the change tracker so first poll doesn't false-trigger\n      fetch('/api/files-changed').then(function(r) { return r.ok ? r.json() : null; }).then(function(d) { if (d) _lastKnownChangeAt = d.changedAt; }).catch(function() {});\n      startAutoRefresh();\n      return;\n    }\n  } catch {}\n\n  // Standalone mode - show drop hint\n  filteredFiles = [];\n  renderFileList();\n  document.getElementById('file-count').textContent = 'Drop files or use pullread view';\n}\n\ninit();\n\n</script>\n</body>\n</html>\n";
