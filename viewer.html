<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PullRead</title>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Literata:ital,wght@0,400;0,700;1,400&family=Lora:ital,wght@0,400;0,700;1,400&family=Source+Serif+4:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #ffffff;
    --fg: #1a1a1a;
    --muted: #666666;
    --border: #e0e0e0;
    --code-bg: #f5f5f5;
    --link: #1a6daa;
    --toolbar-bg: #fafafa;
    --sidebar-bg: #f7f7f7;
    --sidebar-hover: #eeeeee;
    --sidebar-active: #e4e4e4;
  }
  [data-theme="dark"] {
    --bg: #1a1a1a;
    --fg: #e0e0e0;
    --muted: #999999;
    --border: #333333;
    --code-bg: #2a2a2a;
    --link: #6db3e8;
    --toolbar-bg: #222222;
    --sidebar-bg: #1e1e1e;
    --sidebar-hover: #2a2a2a;
    --sidebar-active: #333333;
  }
  [data-theme="sepia"] {
    --bg: #f4ecd8;
    --fg: #433422;
    --muted: #7a6a52;
    --border: #d4c9b0;
    --code-bg: #ebe3cf;
    --link: #8b5e3c;
    --toolbar-bg: #efe6d0;
    --sidebar-bg: #ede4cd;
    --sidebar-hover: #e5dbc2;
    --sidebar-active: #ddd1b6;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--fg);
    transition: background 0.2s, color 0.2s;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    height: 100vh;
    overflow: hidden;
  }

  /* Layout */
  .app {
    display: flex;
    height: 100vh;
    flex-direction: column;
  }

  .toolbar {
    flex-shrink: 0;
    z-index: 10;
    background: var(--sidebar-bg);
    border-bottom: 1px solid var(--border);
    padding: 6px 12px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
  }

  .toolbar label {
    color: var(--muted);
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .toolbar-group {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .toolbar button, .toolbar select {
    background: var(--bg);
    color: var(--fg);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 3px 8px;
    font-size: 12px;
    cursor: pointer;
    line-height: 1.4;
  }
  .toolbar button:hover, .toolbar select:hover {
    border-color: var(--muted);
  }
  .toolbar button.active {
    background: var(--fg);
    color: var(--bg);
    border-color: var(--fg);
  }

  .brand {
    font-weight: 600;
    font-size: 14px;
    color: var(--fg);
    cursor: pointer;
  }

  .toolbar-spacer { flex: 1; }

  .sidebar-toggle {
    background: none !important;
    border: none !important;
    font-size: 18px !important;
    padding: 2px 6px !important;
    color: var(--fg) !important;
    cursor: pointer;
  }
  .sidebar-toggle:hover {
    color: var(--link) !important;
  }

  /* Settings dropdown (replaces many toolbar groups) */
  .settings-dropdown {
    position: relative;
  }
  .settings-dropdown-btn {
    background: none !important;
    border: 1px solid transparent !important;
    font-size: 15px !important;
    padding: 2px 6px !important;
    color: var(--muted) !important;
    cursor: pointer;
  }
  .settings-dropdown-btn:hover { color: var(--fg) !important; }
  .settings-dropdown-panel {
    position: absolute;
    top: 100%;
    right: 0;
    width: 260px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.12);
    padding: 12px;
    z-index: 55;
    animation: fadeIn 0.12s ease;
    font-size: 12px;
  }
  .settings-dropdown-panel label {
    display: block;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--muted);
    margin-bottom: 4px;
    margin-top: 10px;
  }
  .settings-dropdown-panel label:first-child { margin-top: 0; }
  .settings-dropdown-panel .setting-row {
    display: flex;
    gap: 4px;
    align-items: center;
  }
  .settings-dropdown-panel button {
    background: var(--bg);
    color: var(--fg);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 3px 8px;
    font-size: 12px;
    cursor: pointer;
  }
  .settings-dropdown-panel button:hover { border-color: var(--muted); }
  .settings-dropdown-panel button.active {
    background: var(--fg);
    color: var(--bg);
    border-color: var(--fg);
  }
  .settings-dropdown-panel select {
    flex: 1;
    padding: 4px 6px;
    border: 1px solid var(--border);
    border-radius: 4px;
    background: var(--bg);
    color: var(--fg);
    font-size: 12px;
  }
  .settings-dropdown-panel hr {
    border: none;
    border-top: 1px solid var(--border);
    margin: 10px 0;
  }

  /* Main area */
  .main {
    flex: 1;
    display: flex;
    overflow: hidden;
  }

  /* Sidebar */
  .sidebar {
    width: 300px;
    min-width: 300px;
    background: var(--sidebar-bg);
    border-right: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    transition: margin-left 0.2s ease, opacity 0.2s ease;
    overflow: hidden;
  }
  .sidebar.collapsed {
    margin-left: -300px;
    opacity: 0;
    pointer-events: none;
  }

  .sidebar-search {
    padding: 10px;
    border-bottom: 1px solid var(--border);
  }
  .sidebar-search input {
    width: 100%;
    padding: 6px 10px;
    border: 1px solid var(--border);
    border-radius: 5px;
    background: var(--bg);
    color: var(--fg);
    font-size: 13px;
    outline: none;
  }
  .sidebar-search input:focus {
    border-color: var(--link);
  }
  .sidebar-search input::placeholder {
    color: var(--muted);
  }

  .file-list {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
  }

  .file-item {
    padding: 10px 12px;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
    transition: background 0.1s;
  }
  .file-item:hover {
    background: var(--sidebar-hover);
  }
  .file-item.active {
    background: var(--sidebar-active);
  }
  .file-item-title {
    font-size: 13px;
    font-weight: 500;
    line-height: 1.3;
    margin-bottom: 3px;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }
  .file-item-meta {
    font-size: 11px;
    color: var(--muted);
    display: flex;
    gap: 6px;
  }

  .file-count {
    padding: 8px 12px;
    font-size: 11px;
    color: var(--muted);
    border-bottom: 1px solid var(--border);
  }

  /* Content pane */
  .content-pane {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    background: var(--bg);
    position: relative;
  }

  .content-wrap {
    max-width: 720px;
    margin: 0 auto;
    padding: 32px 28px 96px;
  }

  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--muted);
    text-align: center;
    gap: 12px;
  }
  .empty-state .hint {
    font-size: 18px;
  }
  .empty-state .subhint {
    font-size: 14px;
  }

  /* Typography classes */
  .font-sans .content-wrap { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, sans-serif; }
  .font-serif .content-wrap { font-family: "Georgia", "Times New Roman", "Iowan Old Style", serif; }
  .font-mono .content-wrap { font-family: "SF Mono", "Fira Code", "Menlo", monospace; }
  .font-system .content-wrap { font-family: "Charter", "Bitstream Charter", "Sitka Text", Cambria, serif; }
  .font-inter .content-wrap { font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif; }
  .font-lora .content-wrap { font-family: "Lora", "Georgia", serif; }
  .font-literata .content-wrap { font-family: "Literata", "Georgia", serif; }
  .font-source-serif .content-wrap { font-family: "Source Serif 4", "Georgia", serif; }

  .content-wrap {
    line-height: 1.7;
    font-size: 17px;
  }
  .size-small .content-wrap { font-size: 15px; }
  .size-medium .content-wrap { font-size: 17px; }
  .size-large .content-wrap { font-size: 20px; }

  /* Article content */
  .content-wrap h1 { font-size: 1.8em; margin: 0.5em 0 0.3em; line-height: 1.2; }
  .content-wrap h2 { font-size: 1.4em; margin: 1.2em 0 0.3em; line-height: 1.3; }
  .content-wrap h3 { font-size: 1.15em; margin: 1em 0 0.3em; }
  .content-wrap p { margin: 0.8em 0; }
  .content-wrap a { color: var(--link); text-decoration: none; }
  .content-wrap a:hover { text-decoration: underline; }
  .content-wrap img { max-width: 100%; height: auto; border-radius: 4px; margin: 1em 0; display: block; }
  .content-wrap blockquote {
    border-left: 3px solid var(--border);
    padding-left: 16px;
    margin: 1em 0;
    color: var(--muted);
  }
  .content-wrap pre {
    background: var(--code-bg);
    padding: 14px;
    border-radius: 6px;
    overflow-x: auto;
    margin: 1em 0;
    font-size: 14px;
    line-height: 1.5;
  }
  .content-wrap code {
    background: var(--code-bg);
    padding: 2px 5px;
    border-radius: 3px;
    font-size: 0.9em;
  }
  .content-wrap pre code { background: none; padding: 0; }
  .content-wrap ul, .content-wrap ol { padding-left: 1.5em; margin: 0.8em 0; }
  .content-wrap li { margin: 0.3em 0; }
  .content-wrap hr { border: none; border-top: 1px solid var(--border); margin: 2em 0; }
  .content-wrap table { border-collapse: collapse; width: 100%; margin: 1em 0; }
  .content-wrap th, .content-wrap td { border: 1px solid var(--border); padding: 8px 12px; text-align: left; }
  .content-wrap th { background: var(--code-bg); }

  .article-header {
    margin-bottom: 24px;
    padding-bottom: 16px;
    border-bottom: 1px solid var(--border);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  }
  .article-header h1 {
    font-size: 1.6em;
    line-height: 1.25;
    margin: 0 0 8px;
    color: var(--fg);
    font-weight: 700;
  }
  .article-byline {
    font-size: 14px;
    color: var(--muted);
    line-height: 1.5;
  }
  .article-byline a { color: var(--link); text-decoration: none; }
  .article-byline a:hover { text-decoration: underline; }
  .article-byline .author { color: var(--fg); font-weight: 500; }
  .article-byline .sep { margin: 0 6px; opacity: 0.4; }
  .article-actions {
    display: flex;
    gap: 6px;
    margin-top: 10px;
    align-items: center;
  }
  .article-actions button {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 4px 10px;
    font-size: 12px;
    border: 1px solid var(--border);
    border-radius: 4px;
    background: var(--bg);
    color: var(--muted);
    cursor: pointer;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    transition: color 0.15s, border-color 0.15s;
  }
  .article-actions button:hover { color: var(--fg); border-color: var(--muted); }
  .article-actions button.active-fav { color: #e91e63; border-color: #e91e63; }
  .article-actions button:disabled { opacity: 0.5; cursor: not-allowed; }

  /* Margin notes (Google Docs-style) */
  .margin-notes {
    position: absolute;
    top: 0;
    right: 0;
    width: 240px;
    pointer-events: none;
    z-index: 5;
  }
  .margin-note {
    position: absolute;
    right: 12px;
    width: 216px;
    padding: 8px 10px;
    background: var(--code-bg);
    border-left: 2px solid var(--link);
    border-radius: 0 4px 4px 0;
    font-size: 12px;
    line-height: 1.5;
    color: var(--fg);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    pointer-events: all;
    cursor: pointer;
    transition: box-shadow 0.15s;
  }
  .margin-note:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }
  .margin-note .mn-text {
    color: var(--muted);
    font-size: 11px;
    margin-bottom: 3px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .margin-note .mn-body {
    white-space: pre-wrap;
    word-break: break-word;
  }
  @media (max-width: 1100px) {
    .margin-notes { display: none; }
  }

  /* Keyboard nav hint */
  .nav-hint {
    font-size: 11px;
    color: var(--muted);
    padding: 8px 12px;
    border-top: 1px solid var(--border);
  }
  .nav-hint kbd {
    background: var(--code-bg);
    border: 1px solid var(--border);
    border-radius: 3px;
    padding: 1px 5px;
    font-size: 11px;
    font-family: inherit;
  }

  /* Drop file highlight */
  .drop-highlight .content-pane {
    outline: 3px dashed var(--link);
    outline-offset: -3px;
  }

  /* Onboarding overlay */
  .onboarding-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0, 0, 0, 0.55);
    z-index: 100;
    display: flex;
    align-items: center;
    justify-content: center;
    animation: fadeIn 0.3s ease;
  }
  @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
  .onboarding-card {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 32px 36px;
    max-width: 440px;
    width: 90%;
    box-shadow: 0 16px 48px rgba(0,0,0,0.2);
  }
  .onboarding-card h2 {
    font-size: 20px;
    margin-bottom: 16px;
    color: var(--fg);
  }
  .onboarding-card p {
    font-size: 14px;
    line-height: 1.6;
    color: var(--muted);
    margin-bottom: 12px;
  }
  .onboarding-shortcuts {
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 6px 14px;
    margin: 16px 0;
    font-size: 13px;
  }
  .onboarding-shortcuts kbd {
    background: var(--code-bg);
    border: 1px solid var(--border);
    border-radius: 3px;
    padding: 2px 7px;
    font-size: 12px;
    font-family: inherit;
    text-align: center;
  }
  .onboarding-shortcuts span {
    color: var(--fg);
  }
  .onboarding-dismiss {
    display: block;
    margin: 20px auto 0;
    padding: 8px 24px;
    background: var(--fg);
    color: var(--bg);
    border: none;
    border-radius: 6px;
    font-size: 14px;
    cursor: pointer;
  }
  .onboarding-dismiss:hover {
    opacity: 0.85;
  }

  /* Highlights */
  mark.pr-highlight {
    border-radius: 2px;
    padding: 1px 0;
    cursor: pointer;
    transition: opacity 0.15s;
  }
  mark.pr-highlight:hover { opacity: 0.75; }
  mark.pr-highlight.hl-yellow { background: rgba(255, 235, 59, 0.45); }
  mark.pr-highlight.hl-green { background: rgba(76, 175, 80, 0.35); }
  mark.pr-highlight.hl-blue { background: rgba(66, 165, 245, 0.3); }
  mark.pr-highlight.hl-pink { background: rgba(236, 64, 122, 0.3); }
  [data-theme="dark"] mark.pr-highlight.hl-yellow { background: rgba(255, 235, 59, 0.3); }
  [data-theme="dark"] mark.pr-highlight.hl-green { background: rgba(76, 175, 80, 0.25); }
  [data-theme="dark"] mark.pr-highlight.hl-blue { background: rgba(66, 165, 245, 0.25); }
  [data-theme="dark"] mark.pr-highlight.hl-pink { background: rgba(236, 64, 122, 0.25); }

  /* Highlight toolbar (floating) */
  .hl-toolbar {
    position: absolute;
    z-index: 50;
    display: flex;
    gap: 4px;
    padding: 5px 8px;
    background: var(--toolbar-bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    animation: fadeIn 0.15s ease;
  }
  .hl-toolbar button {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    border: 2px solid var(--border);
    cursor: pointer;
    padding: 0;
    transition: transform 0.1s;
  }
  .hl-toolbar button:hover { transform: scale(1.2); }
  .hl-toolbar .hl-yellow-btn { background: #ffeb3b; }
  .hl-toolbar .hl-green-btn { background: #4caf50; }
  .hl-toolbar .hl-blue-btn { background: #42a5f5; }
  .hl-toolbar .hl-pink-btn { background: #ec407a; }
  .hl-toolbar .hl-note-btn {
    background: var(--bg);
    width: auto;
    border-radius: 4px;
    padding: 0 8px;
    font-size: 11px;
    color: var(--fg);
  }

  /* Notes panel */
  .notes-panel {
    border-top: 1px solid var(--border);
    margin-top: 24px;
    padding-top: 16px;
  }
  .notes-panel summary {
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    color: var(--muted);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    user-select: none;
  }
  .notes-panel summary:hover { color: var(--fg); }
  .notes-panel textarea {
    width: 100%;
    min-height: 80px;
    margin-top: 10px;
    padding: 10px;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--bg);
    color: var(--fg);
    font-family: inherit;
    font-size: 14px;
    line-height: 1.6;
    resize: vertical;
    outline: none;
  }
  .notes-panel textarea:focus { border-color: var(--link); }
  .notes-save-hint {
    font-size: 11px;
    color: var(--muted);
    margin-top: 4px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  }

  /* Inline annotation indicator */
  .annotation-marker {
    display: inline-block;
    width: 14px;
    height: 14px;
    background: var(--link);
    color: var(--bg);
    border-radius: 50%;
    font-size: 9px;
    text-align: center;
    line-height: 14px;
    cursor: pointer;
    vertical-align: super;
    margin-left: 2px;
    font-family: -apple-system, sans-serif;
  }
  .annotation-marker:hover { opacity: 0.8; }

  /* Annotation popover */
  .annotation-popover {
    position: absolute;
    z-index: 51;
    width: 280px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.15);
    padding: 12px;
    animation: fadeIn 0.15s ease;
  }
  .annotation-popover textarea {
    width: 100%;
    min-height: 60px;
    padding: 8px;
    border: 1px solid var(--border);
    border-radius: 4px;
    background: var(--bg);
    color: var(--fg);
    font-family: inherit;
    font-size: 13px;
    resize: vertical;
    outline: none;
  }
  .annotation-popover textarea:focus { border-color: var(--link); }
  .annotation-popover .btn-row {
    display: flex;
    justify-content: flex-end;
    gap: 6px;
    margin-top: 8px;
  }
  .annotation-popover button {
    padding: 4px 12px;
    border: 1px solid var(--border);
    border-radius: 4px;
    background: var(--bg);
    color: var(--fg);
    font-size: 12px;
    cursor: pointer;
  }
  .annotation-popover button.primary {
    background: var(--fg);
    color: var(--bg);
    border-color: var(--fg);
  }

  /* Highlight indicator dot on sidebar items */
  .file-item-indicators {
    display: flex;
    gap: 3px;
    margin-top: 2px;
  }
  .file-item-indicators .dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
  }
  .dot-highlight { background: #ffeb3b; }
  .dot-note { background: var(--link); }
  .dot-summary { background: #ab47bc; }
  .dot-favorite { color: #e91e63; font-size: 8px; line-height: 6px; }

  /* Highlight note marker (small icon after highlighted text) */
  .hl-note-marker {
    display: inline-block;
    width: 13px;
    height: 13px;
    background: var(--muted);
    color: var(--bg);
    border-radius: 50%;
    font-size: 8px;
    text-align: center;
    line-height: 13px;
    cursor: pointer;
    vertical-align: super;
    margin-left: 1px;
    font-family: -apple-system, sans-serif;
    opacity: 0.7;
  }
  .hl-note-marker:hover { opacity: 1; }

  /* Tags input */
  .tags-row {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-top: 10px;
    flex-wrap: wrap;
  }
  .tags-row .tag {
    display: inline-flex;
    align-items: center;
    gap: 3px;
    padding: 2px 8px;
    background: var(--code-bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    font-size: 11px;
    color: var(--fg);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  }
  .tags-row .tag .tag-remove {
    cursor: pointer;
    opacity: 0.5;
    font-size: 13px;
    line-height: 1;
  }
  .tags-row .tag .tag-remove:hover { opacity: 1; }
  .tags-row input {
    border: none;
    background: transparent;
    color: var(--fg);
    font-size: 12px;
    outline: none;
    width: 100px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  }

  /* Favorite toggle */
  .favorite-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
    font-size: 13px;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  }
  .favorite-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 18px;
    padding: 0;
    line-height: 1;
    color: var(--muted);
  }
  .favorite-btn.active { color: #e91e63; }
  .favorite-btn:hover { opacity: 0.8; }

  /* Summary display */
  .article-summary {
    background: var(--code-bg);
    border-left: 3px solid #ab47bc;
    padding: 12px 16px;
    margin: 12px 0 20px;
    font-size: 14px;
    line-height: 1.6;
    color: var(--fg);
    border-radius: 0 6px 6px 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  }
  .article-summary .summary-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--muted);
    margin-bottom: 4px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .article-summary .summary-actions {
    display: flex;
    gap: 6px;
    align-items: center;
  }
  .article-summary .summary-actions button {
    background: none;
    border: none;
    color: var(--muted);
    cursor: pointer;
    font-size: 12px;
    padding: 0 2px;
    line-height: 1;
  }
  .article-summary .summary-actions button:hover { color: var(--fg); }
  .summarize-btn {
    display: inline-block;
    padding: 3px 10px;
    font-size: 12px;
    border: 1px solid var(--border);
    border-radius: 4px;
    background: var(--bg);
    color: var(--fg);
    cursor: pointer;
    margin-left: 8px;
    vertical-align: middle;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  }
  .summarize-btn:hover { border-color: #ab47bc; color: #ab47bc; }
  .summarize-btn:disabled { opacity: 0.5; cursor: not-allowed; }

  /* Inline SVG icons */
  .icon { width: 1em; height: 1em; vertical-align: -0.125em; fill: currentColor; display: inline-block; }
  .icon-sm { width: 0.85em; height: 0.85em; }
  .icon-lg { width: 1.15em; height: 1.15em; }

  /* YouTube video embed */
  .yt-embed { position: relative; width: 100%; padding-bottom: 56.25%; height: 0; overflow: hidden; margin: 1em 0; border-radius: 8px; }
  .yt-embed iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0; border-radius: 8px; }

</style>
</head>
<body data-theme="light" class="font-serif size-medium">
<!-- SVG icon sprite (FontAwesome Free solid/regular, inlined for fully offline use) -->
<svg xmlns="http://www.w3.org/2000/svg" style="display:none">
  <symbol id="i-bars" viewBox="0 0 448 512"><path d="M0 96C0 78.3 14.3 64 32 64h384c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zm0 160c0-17.7 14.3-32 32-32h384c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zm448 160c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32h384c17.7 0 32 14.3 32 32z"/></symbol>
  <symbol id="i-gear" viewBox="0 0 512 512"><path d="M495.9 166.6c3.2 8.7.5 18.4-6.4 24.6l-43.3 39.4c1.1 8.3 1.7 16.8 1.7 25.4s-.6 17.1-1.7 25.4l43.3 39.4c6.9 6.2 9.6 15.9 6.4 24.6-4.4 11.9-9.7 23.3-15.8 34.3l-4.7 8.1c-6.6 11-14 21.4-22.1 31.2-5.9 7.2-15.7 9.6-24.5 6.8l-55.7-17.7c-13.4 10.1-28.2 18.3-44 24.4l-12.5 57.1c-2 9.1-9.3 15.5-18.4 17.4-12.2 2.5-24.8 3.8-37.6 3.8s-25.5-1.3-37.6-3.8c-9.2-1.9-16.5-8.3-18.4-17.4l-12.5-57.1c-15.8-6.1-30.6-14.3-44-24.4l-55.7 17.7c-8.8 2.8-18.6.3-24.5-6.8-8.1-9.8-15.5-20.2-22.1-31.2l-4.7-8.1c-6.1-11-11.4-22.4-15.8-34.3-3.2-8.7-.5-18.4 6.4-24.6l43.3-39.4C64.6 273.1 64 264.6 64 256s.6-17.1 1.7-25.4L22.4 191.2c-6.9-6.2-9.6-15.9-6.4-24.6 4.4-11.9 9.7-23.3 15.8-34.3l4.7-8.1c6.6-11 14-21.4 22.1-31.2 5.9-7.2 15.7-9.6 24.5-6.8l55.7 17.7c13.4-10.1 28.2-18.3 44-24.4l12.5-57.1c2-9.1 9.3-15.5 18.4-17.4C226.5 1.3 239.2 0 252 0s25.5 1.3 37.6 3.8c9.2 1.9 16.5 8.3 18.4 17.4l12.5 57.1c15.8 6.1 30.6 14.3 44 24.4l55.7-17.7c8.8-2.8 18.6-.3 24.5 6.8 8.1 9.8 15.5 20.2 22.1 31.2l4.7 8.1c6.1 11 11.4 22.4 15.8 34.3zM256 336a80 80 0 1 0 0-160 80 80 0 1 0 0 160z"/></symbol>
  <symbol id="i-heart" viewBox="0 0 512 512"><path d="M47.6 300.4L228.3 469.1c7.5 7 17.4 10.9 27.7 10.9s20.2-3.9 27.7-10.9L464.4 300.4c30.4-28.3 47.6-68 47.6-109.5v-5.8c0-69.9-50.5-129.5-119.4-141C347 36.5 300.6 51.4 268 84L256 96 244 84c-32.6-32.6-79-47.5-124.6-39.9C50.5 55.6 0 115.2 0 185.1v5.8c0 41.5 17.2 81.2 47.6 109.5z"/></symbol>
  <symbol id="i-heart-o" viewBox="0 0 512 512"><path d="M225.8 468.2l-2.5-2.3L48.1 303.2C17.4 274.7 0 234.7 0 192.8v-3.3c0-70.4 50-130.8 119.2-144C158.6 37.9 198.9 47 231 69.6c9 6.3 17.3 13.6 25 21.5 7.7-7.9 16-15.2 25-21.5 32.1-22.6 72.4-31.7 111.8-24.2C461.2 58.7 512 119.1 512 189.5v3.3c0 41.9-17.4 81.9-48.1 110.4L288.7 465.9l-2.5 2.3c-8.2 7.6-19 11.9-30.2 11.9s-22-4.2-30.2-11.9zM239.1 145c-25.9-26.4-60.9-41.2-97.5-34.8-47.6 8.4-83.7 51.3-83.7 100.1v3.3c0 29.4 12.2 57.7 33.6 77.8l166.3 152.2.5.5c2.5 2.3 5.7 3.5 9 3.5s6.5-1.2 9-3.5l.5-.5 166.3-152.2c21.5-20.1 33.6-48.4 33.6-77.8v-3.3c0-48.8-36.1-91.8-83.7-100.1-36.6-6.5-71.6 8.3-97.5 34.8l-17.8 18.2-17.8-18.2z"/></symbol>
  <symbol id="i-pen" viewBox="0 0 512 512"><path d="M362.7 19.3L314.3 67.7 444.3 197.7l48.4-48.4c25-25 25-65.5 0-90.5L453.3 19.3c-25-25-65.5-25-90.5 0zm-71 71L58.6 323.5c-10.4 10.4-18 23.3-22.2 37.4L1 481.2C-1.5 489.7.8 498.8 7 505s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L421.7 220.3 291.7 90.3z"/></symbol>
  <symbol id="i-wand" viewBox="0 0 576 512"><path d="M234.7 42.7L197 56.8c-3 1.1-5 4-5 7.2s2 6.1 5 7.2l37.7 14.1L248.8 123c1.1 3 4 5 7.2 5s6.1-2 7.2-5l14.1-37.7L315 71.2c3-1.1 5-4 5-7.2s-2-6.1-5-7.2L277.3 42.7 263.2 5c-1.1-3-4-5-7.2-5s-6.1 2-7.2 5L234.7 42.7zM46.1 395.4c-18.7 18.7-18.7 49.1 0 67.9l34.6 34.6c18.7 18.7 49.1 18.7 67.9 0L529.9 116.5c18.7-18.7 18.7-49.1 0-67.9L495.3 14c-18.7-18.7-49.1-18.7-67.9 0L46.1 395.4zM484.6 82.6l-105 105-23.3-23.3 105-105 23.3 23.3zM7.5 117.2C3 118.9 0 123.2 0 128s3 9.1 7.5 10.8L64 160l21.2 56.5c1.7 4.5 6 7.5 10.8 7.5s9.1-3 10.8-7.5L128 160l56.5-21.2c4.5-1.7 7.5-6 7.5-10.8s-3-9.1-7.5-10.8L128 96 106.8 39.5C105.1 35 100.8 32 96 32s-9.1 3-10.8 7.5L64 96 7.5 117.2zm352 256c-4.5 1.7-7.5 6-7.5 10.8s3 9.1 7.5 10.8L416 416l21.2 56.5c1.7 4.5 6 7.5 10.8 7.5s9.1-3 10.8-7.5L480 416l56.5-21.2c4.5-1.7 7.5-6 7.5-10.8s-3-9.1-7.5-10.8L480 352l-21.2-56.5c-1.7-4.5-6-7.5-10.8-7.5s-9.1 3-10.8 7.5L416 352l-56.5 21.2z"/></symbol>
  <symbol id="i-globe" viewBox="0 0 512 512"><path d="M352 256c0 22.2-1.2 43.6-3.3 64H163.3c-2.2-20.4-3.3-41.8-3.3-64s1.2-43.6 3.3-64h185.4c2.2 20.4 3.3 41.8 3.3 64zm28.8-64h123.1c5.3 20.5 8.1 41.9 8.1 64s-2.8 43.5-8.1 64H380.8c2.1-20.6 3.2-42 3.2-64s-1.1-43.4-3.2-64zm112.6-32H376.7c-10-63.9-29.8-117.4-55.3-151.6C399.6 29 467.7 90.2 493.4 160zM256 16c30.6 0 66.7 56.5 82.3 144H173.7C189.3 72.5 225.4 16 256 16zM135.3 160H18.6c25.7-69.8 93.8-131 172-151.6-25.5 34.2-45.3 87.7-55.3 151.6zM8.1 192H131.2c-2.1 20.6-3.2 42-3.2 64s1.1 43.4 3.2 64H8.1C2.8 299.5 0 278.1 0 256s2.8-43.5 8.1-64zm10.5 160h116.7c10 63.9 29.8 117.4 55.3 151.6C112.4 483 44.3 421.8 18.6 352zM256 496c-30.6 0-66.7-56.5-82.3-144h164.7C322.7 439.5 286.6 496 256 496zm120.7 7.6c25.5-34.2 45.3-87.7 55.3-151.6h116.7c-25.7 69.8-93.8 131-172 151.6z"/></symbol>
  <symbol id="i-xmark" viewBox="0 0 384 512"><path d="M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3l105.4 105.3c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256l105.3-105.4z"/></symbol>
</svg>
<div class="app">

  <div class="toolbar">
    <button class="sidebar-toggle" onclick="toggleSidebar()" title="Toggle sidebar"><svg class="icon"><use href="#i-bars"/></svg></button>
    <span class="brand" onclick="toggleSidebar()">PullRead</span>

    <div class="toolbar-spacer"></div>

    <div class="settings-dropdown">
      <button class="settings-dropdown-btn" onclick="toggleSettingsDropdown()" title="Reader settings"><svg class="icon"><use href="#i-gear"/></svg></button>
    </div>
  </div>

  <div class="main">
    <div class="sidebar" id="sidebar">
      <div class="sidebar-search">
        <input type="text" id="search" placeholder="Search articles..." oninput="filterFiles()" />
      </div>
      <div class="file-count" id="file-count"></div>
      <div class="file-list" id="file-list"></div>
      <div class="nav-hint"><kbd>j</kbd><kbd>k</kbd> <kbd>&larr;</kbd><kbd>&rarr;</kbd> next/prev &middot; <kbd>&uarr;</kbd><kbd>&darr;</kbd> scroll &middot; <kbd>/</kbd> search &middot; <kbd>[</kbd> sidebar &middot; <kbd>h</kbd> highlight &middot; <kbd>n</kbd> notes</div>
    </div>

    <div class="content-pane" id="content-pane">
      <div class="empty-state" id="empty-state">
        <div class="hint">Select an article</div>
        <div class="subhint">or drop a .md file here</div>
      </div>
      <div class="content-wrap" id="content" style="display:none;"></div>
      <div class="margin-notes" id="margin-notes"></div>
    </div>
  </div>

</div>

<div class="onboarding-overlay" id="onboarding" style="display:none" onclick="dismissOnboarding(event)">
  <div class="onboarding-card" onclick="event.stopPropagation()">
    <h2>Welcome to PullRead</h2>
    <p>Browse your synced articles in a clean, distraction-free reader. Select text to highlight passages, or add notes to articles. Use the sidebar to search and select articles, or customize the theme and font above.</p>
    <div class="onboarding-shortcuts">
      <kbd>j</kbd> / <kbd>&rarr;</kbd> <span>Next article</span>
      <kbd>k</kbd> / <kbd>&larr;</kbd> <span>Previous article</span>
      <kbd>&uarr;</kbd> <kbd>&darr;</kbd> <span>Scroll (jumps articles at edges)</span>
      <kbd>/</kbd> <span>Search articles</span>
      <kbd>[</kbd> <span>Toggle sidebar</span>
      <kbd>h</kbd> <span>Highlight selected text</span>
      <kbd>n</kbd> <span>Toggle article notes</span>
      <kbd>Esc</kbd> <span>Clear search</span>
    </div>
    <button class="onboarding-dismiss" onclick="dismissOnboarding()">Got it</button>
  </div>
</div>

<script>
// State
let allFiles = [];
let filteredFiles = [];
let activeFile = null;
let serverMode = false;

// Highlights & Notes state
let articleHighlights = []; // highlights for current article
let articleNotes = { articleNote: '', annotations: [], tags: [], isFavorite: false }; // notes for current article
let allHighlightsIndex = {}; // { filename: [...] } for sidebar indicators
let allNotesIndex = {}; // { filename: { articleNote, annotations } } for sidebar indicators

// Preferences
function setTheme(theme) {
  document.body.setAttribute('data-theme', theme);
  document.querySelectorAll('[data-theme-btn]').forEach(b =>
    b.classList.toggle('active', b.getAttribute('data-theme-btn') === theme)
  );
  localStorage.setItem('pr-theme', theme);
}

function setFont(font) {
  document.body.className = document.body.className.replace(/font-[\w-]+/, 'font-' + font);
  localStorage.setItem('pr-font', font);
}

function setSize(size) {
  document.body.className = document.body.className.replace(/size-\w+/, 'size-' + size);
  document.querySelectorAll('[data-size-btn]').forEach(b =>
    b.classList.toggle('active', b.getAttribute('data-size-btn') === size)
  );
  localStorage.setItem('pr-size', size);
}

function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('collapsed');
  localStorage.setItem('pr-sidebar', document.getElementById('sidebar').classList.contains('collapsed') ? '0' : '1');
}

function toggleSettingsDropdown() {
  const existing = document.querySelector('.settings-dropdown-panel');
  if (existing) { existing.remove(); return; }

  const currentTheme = document.body.getAttribute('data-theme') || 'light';
  const currentFont = localStorage.getItem('pr-font') || 'serif';
  const currentSize = localStorage.getItem('pr-size') || 'medium';

  const panel = document.createElement('div');
  panel.className = 'settings-dropdown-panel';
  panel.onclick = function(e) { e.stopPropagation(); };
  panel.innerHTML = `
    <label>Theme</label>
    <div class="setting-row">
      <button onclick="setTheme('light');updateDropdownState()" ${currentTheme==='light'?'class="active"':''}>Light</button>
      <button onclick="setTheme('dark');updateDropdownState()" ${currentTheme==='dark'?'class="active"':''}>Dark</button>
      <button onclick="setTheme('sepia');updateDropdownState()" ${currentTheme==='sepia'?'class="active"':''}>Sepia</button>
    </div>
    <label>Font</label>
    <div class="setting-row">
      <select onchange="setFont(this.value)" id="font-select">
        <option value="serif" ${currentFont==='serif'?'selected':''}>Serif</option>
        <option value="sans" ${currentFont==='sans'?'selected':''}>Sans-serif</option>
        <option value="system" ${currentFont==='system'?'selected':''}>Charter</option>
        <option value="mono" ${currentFont==='mono'?'selected':''}>Monospace</option>
        <option value="inter" ${currentFont==='inter'?'selected':''}>Inter</option>
        <option value="lora" ${currentFont==='lora'?'selected':''}>Lora</option>
        <option value="literata" ${currentFont==='literata'?'selected':''}>Literata</option>
        <option value="source-serif" ${currentFont==='source-serif'?'selected':''}>Source Serif</option>
      </select>
    </div>
    <label>Size</label>
    <div class="setting-row">
      <button onclick="setSize('small');updateDropdownState()" ${currentSize==='small'?'class="active"':''}>A</button>
      <button onclick="setSize('medium');updateDropdownState()" ${currentSize==='medium'?'class="active"':''} style="font-size:14px">A</button>
      <button onclick="setSize('large');updateDropdownState()" ${currentSize==='large'?'class="active"':''} style="font-size:17px">A</button>
    </div>
  `;
  document.querySelector('.settings-dropdown').appendChild(panel);
}

function updateDropdownState() {
  const panel = document.querySelector('.settings-dropdown-panel');
  if (!panel) return;
  // Just close and reopen to refresh active states
  toggleSettingsDropdown();
  toggleSettingsDropdown();
}

// Close settings dropdown when clicking outside
document.addEventListener('click', function(e) {
  const panel = document.querySelector('.settings-dropdown-panel');
  if (panel && !panel.contains(e.target) && !e.target.closest('.settings-dropdown')) {
    panel.remove();
  }
});

// Frontmatter
function parseFrontmatter(text) {
  const match = text.match(/^---\n([\s\S]*?)\n---\n([\s\S]*)$/);
  if (!match) return { meta: null, body: text };
  const meta = {};
  match[1].split('\n').forEach(line => {
    const idx = line.indexOf(':');
    if (idx > 0) {
      const key = line.slice(0, idx).trim();
      const val = line.slice(idx + 1).trim().replace(/^"(.*)"$/, '$1');
      meta[key] = val;
    }
  });
  return { meta, body: match[2] };
}

function escapeHtml(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

// Clean up broken markdown patterns that marked.js can't handle
function cleanMarkdown(md) {
  // Fix image/link patterns split across lines:
  // [\n![alt](img)\n]\n(url) -> [![alt](img)](url)
  md = md.replace(/\[\s*\n\s*(!\[[^\]]*\]\([^)]*\))\s*\n\s*\]\s*\n\s*(\([^)]*\))/g, '[$1]$2');

  // Fix simpler case: [text\n](url) -> [text](url)
  md = md.replace(/\[([^\]]*?)\s*\n\s*\]\s*\n?\s*(\([^)]*\))/g, '[$1]$2');

  // Fix standalone brackets around images: [\n![alt](url)\n] without a link
  md = md.replace(/\[\s*\n(!\[[^\]]*\]\([^)]*\))\s*\n\]/g, '$1');

  // Fix image syntax broken by newlines: ![\nalt\n]\n(url) -> ![alt](url)
  md = md.replace(/!\[\s*\n?\s*([^\]]*?)\s*\n?\s*\]\s*\n\s*(\([^)]*\))/g, '![$1]$2');

  return md;
}

// Rendering
function renderArticle(text, filename) {
  const { meta, body } = parseFrontmatter(text);
  const content = document.getElementById('content');
  const empty = document.getElementById('empty-state');

  empty.style.display = 'none';
  content.style.display = 'block';

  let html = '';

  // Article header: title, author, date, domain, actions
  html += '<div class="article-header">';
  if (meta && meta.title) {
    html += '<h1>' + escapeHtml(meta.title) + '</h1>';
  }
  html += '<div class="article-byline">';
  const bylineParts = [];
  if (meta && meta.author) bylineParts.push('<span class="author">' + escapeHtml(meta.author) + '</span>');
  if (meta && meta.domain) bylineParts.push('<a href="' + escapeHtml(meta.url || '') + '" target="_blank">' + escapeHtml(meta.domain) + '</a>');
  if (meta && meta.bookmarked) bylineParts.push(escapeHtml(meta.bookmarked.slice(0, 10)));
  html += bylineParts.join('<span class="sep">&middot;</span>');
  html += '</div>';

  // Action buttons row
  html += '<div class="article-actions">';
  const isFav = articleNotes.isFavorite;
  html += '<button onclick="toggleFavoriteFromHeader(this)" class="' + (isFav ? 'active-fav' : '') + '" title="Favorite"><svg class="icon icon-sm"><use href="#i-' + (isFav ? 'heart' : 'heart-o') + '"/></svg> Favorite</button>';
  html += '<button onclick="toggleNotesFromHeader()" title="Notes"><svg class="icon icon-sm"><use href="#i-pen"/></svg> Notes</button>';
  html += '<button onclick="summarizeArticle()" id="summarize-btn" title="Summarize"><svg class="icon icon-sm"><use href="#i-wand"/></svg> Summarize</button>';
  html += '</div>';
  html += '</div>';

  // Show existing summary if present in frontmatter
  if (meta && meta.summary) {
    html += '<div class="article-summary"><div class="summary-label"><span>Summary</span><span class="summary-actions"><button onclick="hideSummary()" title="Hide summary"><svg class="icon icon-sm"><use href="#i-xmark"/></svg></button></span></div>' + escapeHtml(meta.summary) + '</div>';
  }

  // Strip the leading H1 from markdown body if it matches the title (avoid duplication)
  let articleBody = cleanMarkdown(body);
  if (meta && meta.title) {
    var h1Match = articleBody.match(/^#\s+(.+)\s*\n/);
    if (h1Match) {
      var normalize = function(s) { return s.toLowerCase().replace(/[\u2018\u2019\u201C\u201D]/g, "'").replace(/[^a-z0-9]/g, ''); };
      if (normalize(h1Match[1]) === normalize(meta.title)) {
        articleBody = articleBody.slice(h1Match[0].length);
      }
    }
  }

  html += marked.parse(articleBody);

  // Convert YouTube thumbnail links into embedded video iframes
  html = html.replace(
    /<a[^>]*href="(https?:\/\/(www\.)?youtube\.com\/watch\?v=([^"&]+)[^"]*|https?:\/\/youtu\.be\/([^"/?]+)[^"]*)"[^>]*>\s*<img[^>]*src="https:\/\/img\.youtube\.com\/vi\/[^"]*"[^>]*>\s*<\/a>/gi,
    function(match, url, _yt, id1, id2) {
      var videoId = id1 || id2;
      if (!videoId) return match;
      return '<div class="yt-embed"><iframe src="https://www.youtube.com/embed/' + videoId + '" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>';
    }
  );

  content.innerHTML = html;
  document.title = (meta && meta.title) || filename || 'PullRead';

  // Scroll to top
  document.getElementById('content-pane').scrollTop = 0;

  // Clear margin notes
  document.getElementById('margin-notes').innerHTML = '';
}

// File list
function renderFileList() {
  const list = document.getElementById('file-list');
  const count = document.getElementById('file-count');
  count.textContent = filteredFiles.length + ' article' + (filteredFiles.length !== 1 ? 's' : '');

  list.innerHTML = filteredFiles.map((f, i) => {
    const date = f.bookmarked ? f.bookmarked.slice(0, 10) : '';
    const isActive = activeFile === f.filename ? ' active' : '';
    const { hasHl, hasNote, isFavorite } = hasAnnotations(f.filename);
    const hasSummary = f.hasSummary;
    let indicators = '';
    if (hasHl || hasNote || hasSummary || isFavorite) {
      indicators = '<div class="file-item-indicators">'
        + (isFavorite ? '<span class="dot dot-favorite" title="Favorite"><svg class="icon icon-sm"><use href="#i-heart"/></svg></span>' : '')
        + (hasHl ? '<span class="dot dot-highlight" title="Has highlights"></span>' : '')
        + (hasNote ? '<span class="dot dot-note" title="Has notes"></span>' : '')
        + (hasSummary ? '<span class="dot dot-summary" title="Has summary"></span>' : '')
        + '</div>';
    }
    return '<div class="file-item' + isActive + '" data-index="' + i + '" onclick="loadFile(' + i + ')">'
      + '<div class="file-item-title">' + escapeHtml(f.title) + '</div>'
      + '<div class="file-item-meta">'
      + (date ? '<span><svg class="icon icon-sm" style="opacity:0.5"><use href="#i-calendar"/></svg> ' + date + '</span>' : '')
      + (f.domain ? '<span><svg class="icon icon-sm" style="opacity:0.5"><use href="#i-globe"/></svg> ' + escapeHtml(f.domain) + '</span>' : '')
      + '</div>'
      + indicators
      + '</div>';
  }).join('');
}

function filterFiles() {
  const q = document.getElementById('search').value.toLowerCase();
  if (!q) {
    filteredFiles = allFiles;
  } else {
    filteredFiles = allFiles.filter(f =>
      f.title.toLowerCase().includes(q) ||
      f.domain.toLowerCase().includes(q) ||
      f.feed.toLowerCase().includes(q)
    );
  }
  renderFileList();
}

async function loadFile(index) {
  const file = filteredFiles[index];
  if (!file) return;
  activeFile = file.filename;
  renderFileList();
  removeHlToolbar();

  if (serverMode) {
    // Load annotations first so favorite state is available for header render
    await preloadAnnotations(file.filename);
    const res = await fetch('/api/file?name=' + encodeURIComponent(file.filename));
    if (res.ok) {
      const text = await res.text();
      renderArticle(text, file.filename);
      applyHighlights();
      renderNotesPanel();
    }
  }
}

// Navigate to next (+1) or previous (-1) article with wrapping
function navigateArticle(direction) {
  if (!filteredFiles.length) return;
  const currentIdx = filteredFiles.findIndex(f => f.filename === activeFile);
  let next;
  if (direction > 0) {
    next = currentIdx < filteredFiles.length - 1 ? currentIdx + 1 : 0;
  } else {
    next = currentIdx > 0 ? currentIdx - 1 : filteredFiles.length - 1;
  }
  loadFile(next);
  const el = document.querySelector('.file-item[data-index="' + next + '"]');
  if (el) el.scrollIntoView({ block: 'nearest' });
}

// ---- Highlights & Notes ----

async function preloadAnnotations(filename) {
  if (!serverMode) return;
  try {
    const [hlRes, notesRes] = await Promise.all([
      fetch('/api/highlights?name=' + encodeURIComponent(filename)),
      fetch('/api/notes?name=' + encodeURIComponent(filename))
    ]);
    articleHighlights = hlRes.ok ? await hlRes.json() : [];
    const notesData = notesRes.ok ? await notesRes.json() : {};
    articleNotes = { articleNote: '', annotations: [], tags: [], isFavorite: false, ...notesData };
  } catch {
    articleHighlights = [];
    articleNotes = { articleNote: '', annotations: [], tags: [], isFavorite: false };
  }
}

async function loadAnnotations(filename) {
  await preloadAnnotations(filename);
  applyHighlights();
  renderNotesPanel();
}

async function loadAnnotationsIndex() {
  if (!serverMode) return;
  try {
    const [hlRes, notesRes] = await Promise.all([
      fetch('/api/highlights'),
      fetch('/api/notes')
    ]);
    allHighlightsIndex = hlRes.ok ? await hlRes.json() : {};
    allNotesIndex = notesRes.ok ? await notesRes.json() : {};
  } catch {
    allHighlightsIndex = {};
    allNotesIndex = {};
  }
}

function hasAnnotations(filename) {
  const hls = allHighlightsIndex[filename] || [];
  const hasHl = hls.length > 0;
  const hasHlNotes = hls.some(h => h.note);
  const notes = allNotesIndex[filename];
  const hasNote = notes && (notes.articleNote || (notes.annotations && notes.annotations.length > 0) || hasHlNotes);
  const isFavorite = notes && notes.isFavorite;
  const hasTags = notes && notes.tags && notes.tags.length > 0;
  return { hasHl, hasNote, isFavorite, hasTags };
}

async function saveHighlights() {
  if (!serverMode || !activeFile) return;
  allHighlightsIndex[activeFile] = articleHighlights;
  await fetch('/api/highlights', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name: activeFile, highlights: articleHighlights })
  });
}

async function saveNotes() {
  if (!serverMode || !activeFile) return;
  allNotesIndex[activeFile] = articleNotes;
  await fetch('/api/notes', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ name: activeFile, ...articleNotes })
  });
}

function generateId() {
  return 'h' + Math.random().toString(36).slice(2, 8);
}

function getTextContext(text, before, after) {
  // Get surrounding context for anchoring
  const content = document.getElementById('content');
  const fullText = content.textContent || '';
  const idx = fullText.indexOf(text);
  if (idx < 0) return { contextBefore: '', contextAfter: '' };
  return {
    contextBefore: fullText.slice(Math.max(0, idx - 30), idx),
    contextAfter: fullText.slice(idx + text.length, idx + text.length + 30)
  };
}

function createHighlight(color) {
  const sel = window.getSelection();
  if (!sel || sel.isCollapsed || !sel.toString().trim()) return;

  const text = sel.toString();
  const { contextBefore, contextAfter } = getTextContext(text);

  const now = new Date().toISOString();
  const highlight = {
    id: generateId(),
    text: text,
    contextBefore,
    contextAfter,
    color: color,
    note: '',
    createdAt: now,
    updatedAt: now
  };

  articleHighlights.push(highlight);
  saveHighlights();
  applyHighlights();
  removeHlToolbar();
  sel.removeAllRanges();
  renderFileList(); // update indicator dots
}

function deleteHighlight(id) {
  articleHighlights = articleHighlights.filter(h => h.id !== id);
  saveHighlights();
  applyHighlights();
  renderFileList();
}

function applyHighlights() {
  const content = document.getElementById('content');
  if (!content) return;

  // Remove existing highlights (re-render from raw HTML)
  content.querySelectorAll('mark.pr-highlight').forEach(mark => {
    const parent = mark.parentNode;
    while (mark.firstChild) parent.insertBefore(mark.firstChild, mark);
    parent.removeChild(mark);
    parent.normalize();
  });

  // Remove annotation markers and highlight note markers
  content.querySelectorAll('.annotation-marker').forEach(m => m.remove());
  content.querySelectorAll('.hl-note-marker').forEach(m => m.remove());

  // Apply each highlight
  for (const hl of articleHighlights) {
    findAndWrap(content, hl);
  }

  // Apply inline annotations
  for (const ann of (articleNotes.annotations || [])) {
    findAndMarkAnnotation(content, ann);
  }

  // Render margin notes for highlights with notes and inline annotations
  renderMarginNotes();
}

function renderMarginNotes() {
  const marginContainer = document.getElementById('margin-notes');
  if (!marginContainer) return;
  marginContainer.innerHTML = '';

  const pane = document.getElementById('content-pane');
  if (!pane) return;
  const paneRect = pane.getBoundingClientRect();

  const notes = [];

  // Collect highlight notes
  for (const hl of articleHighlights) {
    if (!hl.note) continue;
    const mark = document.querySelector('mark[data-hl-id="' + hl.id + '"]');
    if (!mark) continue;
    const rect = mark.getBoundingClientRect();
    notes.push({
      top: rect.top - paneRect.top + pane.scrollTop,
      anchorText: hl.text.slice(0, 40),
      body: hl.note,
      id: hl.id,
      type: 'highlight'
    });
  }

  // Collect inline annotation notes
  for (const ann of (articleNotes.annotations || [])) {
    const matchedMarker = document.querySelector('.annotation-marker[data-ann-id="' + ann.id + '"]');
    if (!matchedMarker) continue;
    const rect = matchedMarker.getBoundingClientRect();
    notes.push({
      top: rect.top - paneRect.top + pane.scrollTop,
      anchorText: (ann.anchorText || '').slice(0, 40),
      body: ann.note,
      id: ann.id,
      type: 'annotation'
    });
  }

  // Sort by position and spread out overlapping notes
  notes.sort((a, b) => a.top - b.top);
  let lastBottom = 0;
  for (const n of notes) {
    if (n.top < lastBottom + 8) n.top = lastBottom + 8;
    const div = document.createElement('div');
    div.className = 'margin-note';
    div.style.top = n.top + 'px';
    div.innerHTML = '<div class="mn-text">' + escapeHtml(n.anchorText) + (n.anchorText.length >= 40 ? '...' : '') + '</div>'
      + '<div class="mn-body">' + escapeHtml(n.body) + '</div>';
    div.onclick = function() {
      if (n.type === 'highlight') {
        editHighlightNote(n.id, { clientX: window.innerWidth / 2, clientY: 200 });
      } else {
        const ann = (articleNotes.annotations || []).find(a => a.id === n.id);
        if (ann) showAnnotationPopover({ clientX: window.innerWidth / 2, clientY: 200 }, ann);
      }
    };
    marginContainer.appendChild(div);
    lastBottom = n.top + div.offsetHeight;
  }
}

function findAndWrap(container, hl) {
  const searchText = hl.text;
  const fullText = container.textContent || '';

  // Find the best match position using context
  let targetGlobalIdx = -1;
  if (hl.contextBefore || hl.contextAfter) {
    // Try context-anchored search first
    const ctxBefore = (hl.contextBefore || '').slice(-15);
    const ctxAfter = (hl.contextAfter || '').slice(0, 15);
    const needle = ctxBefore + searchText + ctxAfter;
    const pos = fullText.indexOf(needle);
    if (pos >= 0) {
      targetGlobalIdx = pos + ctxBefore.length;
    }
  }
  if (targetGlobalIdx < 0) {
    targetGlobalIdx = fullText.indexOf(searchText);
  }
  if (targetGlobalIdx < 0) return;

  // Walk text nodes to find the one containing our target position
  const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT);
  let charCount = 0;
  let node;

  while (node = walker.nextNode()) {
    const nodeLen = node.textContent.length;
    if (charCount + nodeLen > targetGlobalIdx) {
      const localIdx = targetGlobalIdx - charCount;
      // Check that the text actually matches at this position
      if (node.textContent.slice(localIdx, localIdx + searchText.length) !== searchText) break;

      try {
        const range = document.createRange();
        range.setStart(node, localIdx);
        range.setEnd(node, localIdx + searchText.length);

        const mark = document.createElement('mark');
        mark.className = 'pr-highlight hl-' + hl.color;
        mark.setAttribute('data-hl-id', hl.id);
        mark.onclick = function(e) {
          e.stopPropagation();
          showHighlightContextMenu(e, hl);
        };

        range.surroundContents(mark);
      } catch {
        // surroundContents can fail if selection spans nodes; skip gracefully
        return;
      }
      return;
    }
    charCount += nodeLen;
  }
}

function findAndMarkAnnotation(container, ann) {
  if (!ann.anchorText) return;
  const walker = document.createTreeWalker(container, NodeFilter.SHOW_TEXT);
  let node;
  while (node = walker.nextNode()) {
    const idx = node.textContent.indexOf(ann.anchorText);
    if (idx < 0) continue;
    // Insert a marker after the anchor text
    const marker = document.createElement('span');
    marker.className = 'annotation-marker';
    marker.setAttribute('data-ann-id', ann.id);
    marker.textContent = 'n';
    marker.title = ann.note;
    marker.onclick = function(e) {
      e.stopPropagation();
      showAnnotationPopover(e, ann);
    };
    const textAfter = node.splitText(idx + ann.anchorText.length);
    textAfter.parentNode.insertBefore(marker, textAfter);
    return;
  }
}

// Floating highlight toolbar on text selection
let hlToolbarEl = null;

function removeHlToolbar() {
  if (hlToolbarEl) {
    hlToolbarEl.remove();
    hlToolbarEl = null;
  }
  // Only remove annotation popover if not actively focused (user is typing)
  const popover = document.querySelector('.annotation-popover');
  if (popover && !popover.contains(document.activeElement)) {
    popover.remove();
  }
}

function removeAnnotationPopover() {
  const existing = document.querySelector('.annotation-popover');
  if (existing) existing.remove();
}

function showHlToolbar(x, y) {
  removeHlToolbar();
  const bar = document.createElement('div');
  bar.className = 'hl-toolbar';
  bar.innerHTML = `
    <button class="hl-yellow-btn" title="Yellow" onclick="createHighlight('yellow')"></button>
    <button class="hl-green-btn" title="Green" onclick="createHighlight('green')"></button>
    <button class="hl-blue-btn" title="Blue" onclick="createHighlight('blue')"></button>
    <button class="hl-pink-btn" title="Pink" onclick="createHighlight('pink')"></button>
    <button class="hl-note-btn" title="Add note" onclick="addInlineNote()">+ Note</button>
  `;
  bar.style.left = x + 'px';
  bar.style.top = y + 'px';
  document.getElementById('content-pane').appendChild(bar);
  hlToolbarEl = bar;
}

function showHighlightContextMenu(e, hl) {
  removeHlToolbar();
  const bar = document.createElement('div');
  bar.className = 'hl-toolbar';
  const noteLabel = hl.note ? 'Edit Note' : 'Note';
  bar.innerHTML = `
    <button class="hl-yellow-btn" title="Yellow" onclick="changeHighlightColor('${hl.id}','yellow')"></button>
    <button class="hl-green-btn" title="Green" onclick="changeHighlightColor('${hl.id}','green')"></button>
    <button class="hl-blue-btn" title="Blue" onclick="changeHighlightColor('${hl.id}','blue')"></button>
    <button class="hl-pink-btn" title="Pink" onclick="changeHighlightColor('${hl.id}','pink')"></button>
    <button class="hl-note-btn" title="${noteLabel}" onclick="editHighlightNote('${hl.id}', event)">${noteLabel}</button>
    <button class="hl-note-btn" style="color:red;border-color:red" title="Delete" onclick="deleteHighlight('${hl.id}')">Del</button>
  `;
  const pane = document.getElementById('content-pane');
  bar.style.left = (e.clientX - pane.getBoundingClientRect().left) + 'px';
  bar.style.top = (e.clientY - pane.getBoundingClientRect().top + pane.scrollTop - 40) + 'px';
  pane.appendChild(bar);
  hlToolbarEl = bar;
}

function changeHighlightColor(id, color) {
  const hl = articleHighlights.find(h => h.id === id);
  if (hl) {
    hl.color = color;
    hl.updatedAt = new Date().toISOString();
    saveHighlights();
    applyHighlights();
  }
  removeHlToolbar();
}

function editHighlightNote(id, e) {
  removeHlToolbar();
  const hl = articleHighlights.find(h => h.id === id);
  if (!hl) return;

  const pane = document.getElementById('content-pane');
  const paneRect = pane.getBoundingClientRect();
  const popover = document.createElement('div');
  popover.className = 'annotation-popover';
  popover.style.left = (e.clientX - paneRect.left) + 'px';
  popover.style.top = (e.clientY - paneRect.top + pane.scrollTop + 10) + 'px';
  popover.innerHTML = `
    <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Note on highlight: "${escapeHtml(hl.text.slice(0, 50))}${hl.text.length > 50 ? '...' : ''}"</div>
    <textarea placeholder="Add a note to this highlight...">${escapeHtml(hl.note || '')}</textarea>
    <div class="btn-row">
      ${hl.note ? '<button style="color:red;border-color:red" onclick="clearHighlightNote(\'' + id + '\')">Remove</button>' : ''}
      <button onclick="removeAnnotationPopover()">Cancel</button>
      <button class="primary" onclick="saveHighlightNote('${id}', this)">Save</button>
    </div>
  `;
  popover.onclick = function(ev) { ev.stopPropagation(); };
  pane.appendChild(popover);
  popover.querySelector('textarea').focus();
}

function saveHighlightNote(id, btn) {
  const popover = btn.closest('.annotation-popover');
  const note = popover.querySelector('textarea').value.trim();
  const hl = articleHighlights.find(h => h.id === id);
  if (hl) {
    hl.note = note;
    hl.updatedAt = new Date().toISOString();
    saveHighlights();
    applyHighlights();
    renderNotesPanel();
    renderFileList();
  }
  removeAnnotationPopover();
}

function clearHighlightNote(id) {
  const hl = articleHighlights.find(h => h.id === id);
  if (hl) {
    hl.note = '';
    hl.updatedAt = new Date().toISOString();
    saveHighlights();
    applyHighlights();
    renderNotesPanel();
    renderFileList();
  }
  removeAnnotationPopover();
}

// Listen for text selection in content pane
document.addEventListener('mouseup', e => {
  // Don't dismiss anything if clicking inside an annotation popover or margin note
  if (e.target.closest && e.target.closest('.annotation-popover, .margin-note')) return;

  const contentEl = document.getElementById('content');
  if (!contentEl || !contentEl.contains(e.target)) {
    // Don't remove toolbar if clicking on the toolbar itself
    if (hlToolbarEl && hlToolbarEl.contains(e.target)) return;
    removeHlToolbar();
    return;
  }

  const sel = window.getSelection();
  if (!sel || sel.isCollapsed || !sel.toString().trim()) return;

  const pane = document.getElementById('content-pane');
  const range = sel.getRangeAt(0);
  const rect = range.getBoundingClientRect();
  const paneRect = pane.getBoundingClientRect();

  const x = rect.left - paneRect.left + rect.width / 2 - 70;
  const y = rect.top - paneRect.top + pane.scrollTop - 40;
  showHlToolbar(Math.max(10, x), y);
});

// Inline annotations
function addInlineNote() {
  const sel = window.getSelection();
  if (!sel || sel.isCollapsed || !sel.toString().trim()) return;
  const anchorText = sel.toString();
  const pane = document.getElementById('content-pane');
  const range = sel.getRangeAt(0);
  const rect = range.getBoundingClientRect();
  const paneRect = pane.getBoundingClientRect();

  removeHlToolbar();

  const popover = document.createElement('div');
  popover.className = 'annotation-popover';
  popover.style.left = (rect.left - paneRect.left) + 'px';
  popover.style.top = (rect.bottom - paneRect.top + pane.scrollTop + 5) + 'px';
  popover.innerHTML = `
    <div style="font-size:12px;color:var(--muted);margin-bottom:6px">Note on: "${escapeHtml(anchorText.slice(0, 50))}${anchorText.length > 50 ? '...' : ''}"</div>
    <textarea placeholder="Add your note..." autofocus></textarea>
    <div class="btn-row">
      <button onclick="removeAnnotationPopover()">Cancel</button>
      <button class="primary" onclick="saveInlineNote(this, '${escapeHtml(anchorText.replace(/'/g, "\\'"))}')">Save</button>
    </div>
  `;
  popover.onclick = function(e) { e.stopPropagation(); };
  pane.appendChild(popover);
  popover.querySelector('textarea').focus();
  sel.removeAllRanges();
}

function saveInlineNote(btn, anchorText) {
  const popover = btn.closest('.annotation-popover');
  const note = popover.querySelector('textarea').value.trim();
  if (!note) { removeAnnotationPopover(); return; }

  const { contextBefore, contextAfter } = getTextContext(anchorText);
  const now = new Date().toISOString();
  const annotation = {
    id: generateId(),
    anchorText,
    contextBefore,
    contextAfter,
    note,
    createdAt: now,
    updatedAt: now
  };
  if (!articleNotes.annotations) articleNotes.annotations = [];
  articleNotes.annotations.push(annotation);
  saveNotes();
  applyHighlights();
  removeAnnotationPopover();
  renderFileList();
}

function showAnnotationPopover(e, ann) {
  removeAnnotationPopover();
  removeHlToolbar();

  const pane = document.getElementById('content-pane');
  const paneRect = pane.getBoundingClientRect();
  const popover = document.createElement('div');
  popover.className = 'annotation-popover';
  popover.style.left = (e.clientX - paneRect.left) + 'px';
  popover.style.top = (e.clientY - paneRect.top + pane.scrollTop + 10) + 'px';
  popover.innerHTML = `
    <textarea>${escapeHtml(ann.note)}</textarea>
    <div class="btn-row">
      <button style="color:red;border-color:red" onclick="deleteAnnotation('${ann.id}')">Delete</button>
      <button onclick="removeAnnotationPopover()">Cancel</button>
      <button class="primary" onclick="updateAnnotation('${ann.id}', this)">Save</button>
    </div>
  `;
  popover.onclick = function(e) { e.stopPropagation(); };
  pane.appendChild(popover);
}

function deleteAnnotation(id) {
  articleNotes.annotations = (articleNotes.annotations || []).filter(a => a.id !== id);
  saveNotes();
  applyHighlights();
  removeAnnotationPopover();
  renderFileList();
}

function updateAnnotation(id, btn) {
  const popover = btn.closest('.annotation-popover');
  const note = popover.querySelector('textarea').value.trim();
  const ann = (articleNotes.annotations || []).find(a => a.id === id);
  if (ann) {
    ann.note = note;
    ann.updatedAt = new Date().toISOString();
    saveNotes();
  }
  removeAnnotationPopover();
}

// Article-level notes panel
function renderNotesPanel() {
  // Remove existing panel
  const existing = document.querySelector('.notes-panel');
  if (existing) existing.remove();

  const content = document.getElementById('content');
  if (!content || content.style.display === 'none') return;

  const panel = document.createElement('details');
  panel.className = 'notes-panel';
  const noteText = articleNotes.articleNote || '';
  const annCount = (articleNotes.annotations || []).length;
  const hlCount = articleHighlights.length;
  const hlNoteCount = articleHighlights.filter(h => h.note).length;

  let summaryText = 'Notes';
  const badges = [];
  if (hlCount) badges.push(hlCount + ' highlight' + (hlCount !== 1 ? 's' : '') + (hlNoteCount ? ' (' + hlNoteCount + ' with notes)' : ''));
  if (annCount) badges.push(annCount + ' annotation' + (annCount !== 1 ? 's' : ''));
  if (badges.length) summaryText += ' (' + badges.join(', ') + ')';

  const tags = articleNotes.tags || [];
  const isFav = articleNotes.isFavorite || false;
  const tagsHtml = tags.map(t => '<span class="tag">' + escapeHtml(t) + '<span class="tag-remove" onclick="removeTag(\'' + escapeHtml(t.replace(/'/g, "\\'")) + '\')">&times;</span></span>').join('');

  // Build list of highlight notes and inline annotations for display
  let hlNotesHtml = '';
  const hlsWithNotes = articleHighlights.filter(h => h.note);
  const annotations = articleNotes.annotations || [];

  if (hlsWithNotes.length || annotations.length) {
    hlNotesHtml += '<div style="margin-top:12px;font-size:12px">';

    for (const hl of hlsWithNotes) {
      const preview = hl.text.length > 60 ? hl.text.slice(0, 60) + '...' : hl.text;
      hlNotesHtml += '<div style="padding:8px 0;border-bottom:1px solid var(--border)">'
        + '<div style="color:var(--muted);font-size:11px;margin-bottom:3px">'
        + '<span class="pr-highlight hl-' + hl.color + '" style="padding:1px 4px;border-radius:2px;cursor:pointer" onclick="scrollToHighlight(\'' + hl.id + '\')">' + escapeHtml(preview) + '</span>'
        + '</div>'
        + '<div style="white-space:pre-wrap;word-break:break-word">' + escapeHtml(hl.note) + '</div>'
        + '</div>';
    }

    for (const ann of annotations) {
      const preview = (ann.anchorText || '').slice(0, 60);
      hlNotesHtml += '<div style="padding:8px 0;border-bottom:1px solid var(--border)">'
        + '<div style="color:var(--muted);font-size:11px;margin-bottom:3px">'
        + '<span style="color:var(--link);cursor:pointer">' + escapeHtml(preview) + (ann.anchorText && ann.anchorText.length > 60 ? '...' : '') + '</span>'
        + '</div>'
        + '<div style="white-space:pre-wrap;word-break:break-word">' + escapeHtml(ann.note) + '</div>'
        + '</div>';
    }

    hlNotesHtml += '</div>';
  }

  panel.innerHTML = `
    <summary>${summaryText}</summary>
    <div class="favorite-row">
      <button class="favorite-btn${isFav ? ' active' : ''}" onclick="toggleFavorite(this)" title="Mark as favorite"><svg class="icon"><use href="#i-${isFav ? 'heart' : 'heart-o'}"/></svg></button>
      <span style="color:var(--muted);font-size:12px">${isFav ? 'Favorited' : 'Mark favorite'}</span>
    </div>
    <div class="tags-row">
      ${tagsHtml}
      <input type="text" placeholder="Add tag..." onkeydown="handleTagKey(event)" />
    </div>
    <textarea placeholder="Add notes about this article...">${escapeHtml(noteText)}</textarea>
    <div class="notes-save-hint">Auto-saved</div>
    ${hlNotesHtml}
  `;

  if (noteText || isFav || tags.length || hlsWithNotes.length || annotations.length) panel.setAttribute('open', '');

  content.appendChild(panel);

  const textarea = panel.querySelector('textarea');
  let saveTimeout;
  textarea.addEventListener('input', () => {
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(() => {
      articleNotes.articleNote = textarea.value;
      saveNotes();
      renderFileList();
    }, 800);
  });
  textarea.addEventListener('blur', () => {
    articleNotes.articleNote = textarea.value;
    saveNotes();
    renderFileList();
  });
}

function toggleFavorite(btn) {
  articleNotes.isFavorite = !articleNotes.isFavorite;
  saveNotes();
  renderNotesPanel();
  renderFileList();
  updateHeaderActions();
}

function toggleFavoriteFromHeader(btn) {
  articleNotes.isFavorite = !articleNotes.isFavorite;
  saveNotes();
  renderNotesPanel();
  renderFileList();
  updateHeaderActions();
}

function toggleNotesFromHeader() {
  const panel = document.querySelector('.notes-panel');
  if (panel) {
    panel.toggleAttribute('open');
    if (panel.hasAttribute('open')) {
      panel.querySelector('textarea').focus();
    }
  }
}

function scrollToHighlight(id) {
  const mark = document.querySelector('mark[data-hl-id="' + id + '"]');
  if (mark) {
    mark.scrollIntoView({ behavior: 'smooth', block: 'center' });
    mark.style.outline = '2px solid var(--link)';
    setTimeout(() => { mark.style.outline = ''; }, 1500);
  }
}

function updateHeaderActions() {
  const actions = document.querySelector('.article-actions');
  if (!actions) return;
  const favBtn = actions.querySelector('button');
  if (favBtn) {
    favBtn.className = articleNotes.isFavorite ? 'active-fav' : '';
    favBtn.innerHTML = '<svg class="icon icon-sm"><use href="#i-' + (articleNotes.isFavorite ? 'heart' : 'heart-o') + '"/></svg> Favorite';
  }
}

function handleTagKey(e) {
  if (e.key === 'Enter' || e.key === ',') {
    e.preventDefault();
    const tag = e.target.value.trim().replace(/,/g, '');
    if (!tag) return;
    if (!articleNotes.tags) articleNotes.tags = [];
    if (!articleNotes.tags.includes(tag)) {
      articleNotes.tags.push(tag);
      saveNotes();
      renderNotesPanel();
      renderFileList();
    }
    e.target.value = '';
  }
}

function removeTag(tag) {
  if (!articleNotes.tags) return;
  articleNotes.tags = articleNotes.tags.filter(t => t !== tag);
  saveNotes();
  renderNotesPanel();
  renderFileList();
}

// ---- LLM Summarization ----

let llmConfigured = false;
let llmProvider = '';
let llmModel = '';
let lastSummaryProvider = '';
let lastSummaryModel = '';

async function checkLLMConfig() {
  if (!serverMode) return;
  try {
    const res = await fetch('/api/settings');
    if (res.ok) {
      const data = await res.json();
      llmConfigured = !!(data.llm && data.llm.hasKey);
      llmProvider = data.llm?.provider || '';
      llmModel = data.llm?.model || '';
    }
  } catch {}
}

function providerLabel(provider) {
  const labels = { anthropic: 'Anthropic', openai: 'OpenAI', gemini: 'Gemini', openrouter: 'OpenRouter', apple: 'Apple Intelligence' };
  return labels[provider] || provider;
}

async function summarizeArticle() {
  if (!serverMode || !activeFile) return;
  const btn = document.getElementById('summarize-btn');
  if (!btn) return;

  btn.disabled = true;
  btn.innerHTML = '<svg class="icon icon-sm"><use href="#i-wand"/></svg> Summarizing...';
  btn.title = 'Summarizing with ' + providerLabel(llmProvider) + '...';

  try {
    const res = await fetch('/api/summarize', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: activeFile })
    });
    const data = await res.json();
    if (data.error) {
      btn.innerHTML = '<svg class="icon icon-sm"><use href="#i-wand"/></svg> Retry';
      btn.disabled = false;
      btn.title = data.error;
      // Show error inline under the header
      const content = document.getElementById('content');
      const existingError = content.querySelector('.summary-error');
      if (existingError) existingError.remove();
      const errDiv = document.createElement('div');
      errDiv.className = 'summary-error';
      errDiv.style.cssText = 'padding:8px 12px;margin:8px 0;background:var(--border);border-radius:6px;font-size:12px;color:var(--muted)';
      errDiv.textContent = data.error;
      const articleHeader = content.querySelector('.article-header');
      if (articleHeader) articleHeader.after(errDiv);
      return;
    }

    lastSummaryProvider = data.provider || llmProvider;
    lastSummaryModel = data.model || llmModel;

    // Remove any previous error
    const content = document.getElementById('content');
    const existingError = content.querySelector('.summary-error');
    if (existingError) existingError.remove();

    // Insert summary into the DOM
    const existingSummary = content.querySelector('.article-summary');
    if (existingSummary) existingSummary.remove();

    const summaryDiv = document.createElement('div');
    summaryDiv.className = 'article-summary';
    summaryDiv.innerHTML = '<div class="summary-label"><span>Summary</span><span class="summary-actions"><button onclick="hideSummary()" title="Hide summary"><svg class="icon icon-sm"><use href="#i-xmark"/></svg></button></span></div>'
      + escapeHtml(data.summary)
      + '<div style="font-size:10px;color:var(--muted);margin-top:6px">'
      + providerLabel(lastSummaryProvider) + '  ' + escapeHtml(lastSummaryModel)
      + '</div>';

    const articleHeader = content.querySelector('.article-header');
    if (articleHeader) {
      articleHeader.after(summaryDiv);
    } else {
      content.prepend(summaryDiv);
    }

    btn.innerHTML = '<svg class="icon icon-sm"><use href="#i-wand"/></svg> Summarized';
    btn.title = 'Summarized by ' + providerLabel(lastSummaryProvider) + ' (' + lastSummaryModel + '). Click to re-run.';
    btn.disabled = false;
    btn.onclick = function() { btn.onclick = null; summarizeArticle(); };
  } catch (err) {
    btn.innerHTML = '<svg class="icon icon-sm"><use href="#i-wand"/></svg> Retry';
    btn.title = 'Summarization failed. Click to retry.';
    btn.disabled = false;
  }
}

function hideSummary() {
  const content = document.getElementById('content');
  const summary = content.querySelector('.article-summary');
  if (summary) summary.remove();
  // Reset summarize button
  const btn = document.getElementById('summarize-btn');
  if (btn) {
    btn.innerHTML = '<svg class="icon icon-sm"><use href="#i-wand"/></svg> Summarize';
    btn.title = 'Summarize';
    btn.disabled = false;
    btn.onclick = null;
  }
}

// Keyboard navigation
document.addEventListener('keydown', e => {
  // "/" focuses search
  if (e.key === '/' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
    e.preventDefault();
    const sidebar = document.getElementById('sidebar');
    if (sidebar.classList.contains('collapsed')) toggleSidebar();
    document.getElementById('search').focus();
    return;
  }

  // "[" toggles sidebar
  if (e.key === '[' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
    e.preventDefault();
    toggleSidebar();
    return;
  }

  // Escape clears search or dismisses popovers
  if (e.key === 'Escape') {
    // Close settings dropdown
    const dropdown = document.querySelector('.settings-dropdown-panel');
    if (dropdown) { dropdown.remove(); return; }
    // Close highlight toolbar / annotation popover
    if (hlToolbarEl || document.querySelector('.annotation-popover')) {
      removeHlToolbar();
      return;
    }
    // Clear and blur search
    const search = document.getElementById('search');
    if (document.activeElement === search) {
      search.value = '';
      filterFiles();
      search.blur();
      return;
    }
    // Blur any focused textarea/input
    if (document.activeElement.tagName === 'TEXTAREA' || document.activeElement.tagName === 'INPUT') {
      document.activeElement.blur();
      return;
    }
  }

  // h to highlight selection (yellow)
  if (e.key === 'h' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
    const sel = window.getSelection();
    if (sel && !sel.isCollapsed && sel.toString().trim()) {
      e.preventDefault();
      createHighlight('yellow');
      return;
    }
  }

  // n to toggle notes panel
  if (e.key === 'n' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
    const panel = document.querySelector('.notes-panel');
    if (panel) {
      e.preventDefault();
      panel.toggleAttribute('open');
      if (panel.hasAttribute('open')) {
        panel.querySelector('textarea').focus();
      }
      return;
    }
  }

  // j/k navigate file list (next/prev)
  if ((e.key === 'j' || e.key === 'k') && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
    e.preventDefault();
    navigateArticle(e.key === 'j' ? 1 : -1);
    return;
  }

  // Left/Right arrow navigate prev/next article
  if ((e.key === 'ArrowLeft' || e.key === 'ArrowRight') && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
    e.preventDefault();
    navigateArticle(e.key === 'ArrowRight' ? 1 : -1);
    return;
  }

  // Up/Down scroll the content pane; navigate articles at boundaries
  if ((e.key === 'ArrowUp' || e.key === 'ArrowDown') && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
    const pane = document.getElementById('content-pane');
    const scrollAmount = 80;
    const atTop = pane.scrollTop <= 0;
    const atBottom = pane.scrollTop + pane.clientHeight >= pane.scrollHeight - 2;

    if (e.key === 'ArrowDown' && atBottom) {
      e.preventDefault();
      navigateArticle(1);
    } else if (e.key === 'ArrowUp' && atTop) {
      e.preventDefault();
      navigateArticle(-1);
    } else if (e.key === 'ArrowDown') {
      pane.scrollTop += scrollAmount;
    } else {
      pane.scrollTop -= scrollAmount;
    }
    return;
  }

  // Enter loads current selection (when not in search)
  if (e.key === 'Enter' && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') {
    const currentIdx = filteredFiles.findIndex(f => f.filename === activeFile);
    if (currentIdx >= 0) loadFile(currentIdx);
  }
});

// Drag and drop (for standalone use)
document.addEventListener('dragover', e => {
  e.preventDefault();
  document.body.classList.add('drop-highlight');
});
document.addEventListener('dragleave', e => {
  if (!e.relatedTarget || !document.contains(e.relatedTarget)) {
    document.body.classList.remove('drop-highlight');
  }
});
document.addEventListener('drop', e => {
  e.preventDefault();
  document.body.classList.remove('drop-highlight');
  const files = Array.from(e.dataTransfer.files).filter(f =>
    f.name.endsWith('.md') || f.name.endsWith('.markdown') || f.name.endsWith('.txt')
  );
  if (files.length) {
    // Add dropped files to the sidebar list
    const reader = new FileReader();
    reader.onload = () => {
      const text = reader.result;
      const { meta } = parseFrontmatter(text);
      const file = files[0];
      // Create a virtual entry
      const entry = {
        filename: file.name,
        title: (meta && meta.title) || file.name.replace(/\.md$/, ''),
        url: (meta && meta.url) || '',
        domain: (meta && meta.domain) || '',
        bookmarked: (meta && meta.bookmarked) || '',
        feed: (meta && meta.feed) || '',
        _content: text
      };
      allFiles.unshift(entry);
      filterFiles();
      activeFile = entry.filename;
      renderFileList();
      renderArticle(text, file.name);
    };
    reader.readAsText(files[0]);
  }
});

// Onboarding overlay
function dismissOnboarding(e) {
  if (e && e.target && e.target.id !== 'onboarding' && e.target.className !== 'onboarding-dismiss') return;
  document.getElementById('onboarding').style.display = 'none';
  localStorage.setItem('pr-onboarded', '1');
}

function showOnboardingIfNeeded() {
  if (!localStorage.getItem('pr-onboarded')) {
    document.getElementById('onboarding').style.display = 'flex';
  }
}

// Init: try to load from server, fall back to standalone mode
async function init() {
  // Restore preferences
  const savedTheme = localStorage.getItem('pr-theme');
  const savedFont = localStorage.getItem('pr-font');
  const savedSize = localStorage.getItem('pr-size');
  const savedSidebar = localStorage.getItem('pr-sidebar');
  if (savedTheme) setTheme(savedTheme);
  if (savedFont) {
    setFont(savedFont);
  }
  if (savedSize) setSize(savedSize);
  if (savedSidebar === '0') document.getElementById('sidebar').classList.add('collapsed');

  try {
    const res = await fetch('/api/files');
    if (res.ok) {
      allFiles = await res.json();
      serverMode = true;
      filteredFiles = allFiles;

      // Load annotations index and LLM config
      await Promise.all([loadAnnotationsIndex(), checkLLMConfig()]);

      renderFileList();

      // Auto-load first article
      if (allFiles.length > 0) {
        loadFile(0);
      }
      showOnboardingIfNeeded();
      return;
    }
  } catch {}

  // Standalone mode - show drop hint
  filteredFiles = [];
  renderFileList();
  document.getElementById('file-count').textContent = 'Drop files or use pullread view';
}

init();
</script>
</body>
</html>
