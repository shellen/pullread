// ABOUTME: Pre-build script that embeds viewer.html + viewer.css + viewer/*.js into a TypeScript module
// ABOUTME: Reads the HTML template, CSS, and JS modules, inlines them into a single HTML string

import { readFileSync, writeFileSync, readdirSync } from 'fs';
import { join, dirname } from 'path';

const rootDir = join(dirname(process.argv[1]), '..');
const htmlPath = join(rootDir, 'viewer.html');
const cssPath = join(rootDir, 'viewer.css');
const jsDir = join(rootDir, 'viewer');
const outPath = join(rootDir, 'src', 'viewer-html.ts');

let html = readFileSync(htmlPath, 'utf-8');
const css = readFileSync(cssPath, 'utf-8');

// Read JS modules from viewer/ directory in sorted order (01-state.js, 02-utils.js, etc.)
const jsFiles = readdirSync(jsDir).filter(f => f.endsWith('.js')).sort();
const jsModules = jsFiles.map(f => readFileSync(join(jsDir, f), 'utf-8'));
const js = jsModules.join('\n');

// Inline CSS and JS into the HTML template at the marker positions
html = html.replace('/* INJECT:CSS */', () => css);
html = html.replace('/* INJECT:JS */', () => js);

// JSON.stringify safely escapes all special characters (quotes, newlines,
// backslashes, unicode, angle brackets, template literals, etc.)
const source = [
  '// Auto-generated by scripts/embed-viewer.ts â€” do not edit',
  '// Source: viewer.html + viewer.css + viewer/*.js',
  `export const VIEWER_HTML = ${JSON.stringify(html)};`,
  '',
].join('\n');

writeFileSync(outPath, source);
const moduleList = jsFiles.map(f => `  ${f} (${readFileSync(join(jsDir, f), 'utf-8').length} bytes)`).join('\n');
console.log(`Embedded viewer (${html.length} bytes) into src/viewer-html.ts`);
console.log(`  HTML template: ${readFileSync(htmlPath, 'utf-8').length} bytes`);
console.log(`  CSS: ${css.length} bytes`);
console.log(`  JS modules (${jsFiles.length} files, ${js.length} bytes total):\n${moduleList}`);
